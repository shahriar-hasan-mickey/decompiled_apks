define(["jquery","underscore","Backbone","collections/common/otpValidateCollections","collections/common/otpGenerateCollections","collections/sadad/manageAddConfirmCollections","text!views/sadad/addnewbillOTP.tpl","text!views/sadad/addbillOTPSuccess.tpl","models/validation/OTPValidationModel","collections/common/secureaccessvalidateCollections","text!views/sadad/billpaySEQ.tpl","models/validation/softOTPValidationModel"],function(e,t,i,n,o,a,s,r,c,l,d,u){var p=new EncryptedLocalStorage("secret"),m=0,h=i.View.extend({el:"#container",e1:"#menuwrapper",e2:"#mobcontent",events:{"click .smsotp":"OTPOption1","click .softToken":"OTPOption2","click #submit":"submitOTP","click #validatesubmit":"secureaccessvalidate","click #resendclick":"OTPOption"},initialize:function(){this.on("error",function(e,t){alert(t)})},update:function(){this.OTPOption();var e=p.get("questionBasketDetailDTO"),i=new Array,n=new Array;t.each(e,function(e,t){i[t]=e.id,n[t]=e.description}),p.set("Sec_Ques_Id",i),p.set("Sec_Ques_Des",n)},secureGate:function(){hideSpinner();var e=p.get("Sec_Ques_Id"),i=p.get("Sec_Ques_Des"),n=null==p.get("Sec_Quest_No")?"":p.get("Sec_Quest_No"),o="";if(o=Math.floor(5*Math.random())+1,5==n.length&&p.set("Sec_Quest_No",""),""==n||null==n||void 0==n)o+="";else{var a=!0;do o+="",-1!=n.indexOf(o)&&(o=Math.floor(5*Math.random())+1,a=!1);while(a)}var s=parseInt(o)-1,r=e[s],c=i[s];this.$("#mobcontent").html(t.template(d,{seq_id:r,seq_question:c})).i18n()},secureaccessvalidate:function(){hideSpinner();var t=e("#secques").val();if(""==t||void 0==t)return e("#showError").text(e.i18n.t("validation.forgotpassword.answernotnull")),e("#secError").show(),e("#errorimage").hide(),e("#secErrorlast").hide(),e("#secErrorfirst").hide(),!1;var i=t.charAt(0),n=t.charAt(t.length-1);if(!i.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return e("#showErrorfirst").text(e.i18n.t("app.login.firstspaceind")),e("#secErrorfirst").show(),e("#secErrorlast").hide(),!1;if(!n.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return e("#showErrorlast").text(e.i18n.t("app.login.lastspaceind")),e("#secErrorlast").show(),e("#secErrorfirst").hide(),!1;var o=e("#secquesid").val(),a=e("#secques").val(),s=this;getDeviceId();showSpinner();var r=function(e){s.addNewBills()},c=function(e){s.errorresponse()};s.collection=new l;var d=(new Date).getTime(),u=EncryptWithDynamicSalt(a,d),m=p.get("ulpID")+o+a;m=null==m?"":m,checkSumEncrypt(m);var h=localStorage.getItem("FINALCHECKSUM");getDeviceId();s.collection.fetch({data:e.param({access_token:p.get("access_token"),qstnId:o,answer:u,appchecksum:h,salt:d}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?r(e):c(e)},error:c})},update11:function(e,t,i,n,o){var a=p.get("ccpayremarks"),s=p.get("sadad_manage_profile");if("Y"==s){var r=p.get("soft_token");"Y"==r?this.editmanagebillcompile(e,t,i,a,n,o):this.OTPOption(e,t,i,a,n,o)}else this.addNewBills()},editmanagebillcompile:function(){return hideSpinner(),this.$("#mobcontent").html(t.template(s,{})).i18n(),this},editmanagebillcompile11:function(e,i,n,o,a,r){return hideSpinner(),this.$("#mobcontent").html(t.template(s,{frm:e,to:i,amount:n,rem:o,conv:a,exrate:r})).i18n(),this},OTPOption1:function(t){e(".smsotp_block").show(),e("#hidotp").val("otp"),e(".softTock").hide(),e(".smsotp").addClass("active"),e(".softToken").removeClass("active"),document.getElementById("softTockId").style.display="none",document.getElementById("smsDivId").style.display="inline",this.OTPOption(),t.preventDefault()},OTPOption2:function(){e(".smsotp_block").hide(),e("#hidotp").val("softotp"),e(".softTock").show(),e(".softToken").addClass("active"),e(".smsotp").removeClass("active"),e("#hiddotpvalue").val("Y"),document.getElementById("softTockId").style.display="inline"},OTPOption:function(){e("#secError").hide(),e("#submit").removeAttr("disabled"),e("#showError").text(""),e("#hidotp").val("otp"),e("#otp").val(""),showSpinner();var t=this,i=(p.get("ccpayremarks"),function(e){t.editmanagebillcompile()}),n=function(e){t.errorresponse()};t.collection=new o([],{}),timestamp=(new Date).getTime(),t.collection.fetch({data:e.param({access_token:p.get("access_token"),moduletype:"BILLER"}),dataType:"json",type:"POST",timeout:parseInt(p.get("calltimeout")),cache:!1,success:function(o){"0000"==ackStatus?(e("#submit").removeAttr("disabled"),"SMS"==status?i(o):"SQ"==status?t.secureGate():t.addNewBills()):(e("#submit").removeAttr("disabled"),n(o))},error:n})},OTPOptionnn:function(t,i,n,a,s,r){e("#secError").hide(),e("#submit").removeAttr("disabled"),e("#showError").text(""),e("#hidotp").val("otp"),e("#otp").val(""),showSpinner();var c=this,a=p.get("ccpayremarks"),l=function(e){c.editmanagebillcompile(t,i,n,a,s,r)},d=function(e){c.errorresponse()};c.collection=new o([],{}),timestamp=(new Date).getTime(),"en-US"==e.i18n.lng()?language="EN":"en-AR"==e.i18n.lng()&&(language="AR");var u=p.get("custno"),m="9004",h="";c.collection.fetch({data:e.param({servicetype:m,otpModule:"sadad_manage_profile",language:language,custno:u,ipaddress:h,requestid:timestamp}),dataType:"json",type:"POST",timeout:parseInt(p.get("calltimeout")),cache:!1,success:function(t){if("0000"==ackStatus){e("#hiddotpvalue").val("Y");var i=e("#isformloaded").val();"Y"==i?(document.getElementById("smsDivId").style.display="inline",hideSpinner()):l(t)}else d(t)},error:d})},securityadvicecheck:function(t){"TWOFA"==e("#securityFlag").val()?this.loginotpverification(t,e("#securityFlag").val()):"TPIN"==e("#securityFlag").val()?this.loginotpverification(t,e("#securityFlag").val()):"SQ"==e("#securityFlag").val()&&this.loginotpverification(t,e("#securityFlag").val())},submitOTP:function(e){this.ownsubmitotp()},ownsubmitotp:function(){e("#secError").hide(),e("#showError").text(""),this.model=new c({url:"json/"}),i.Validation.bind(this);var t=this.$("form").serializeObject();if(this.model.set(t,{validate:!0})){showSpinner(),this.model.clear(),i.Validation.unbind(this);var o=this,a=function(e){o.addNewBills()},s=function(e){o.errorresponse()};o.collection=new n([],{});var r=((new Date).getTime(),e("#otp").val()),l=(new Date).getTime();r=EncryptWithDynamicSalt(r,l),o.collection.fetch({data:e.param({access_token:p.get("access_token"),transactionData1:"SMS",salt:l,activationno:r}),dataType:"json",type:"POST",timeout:parseInt(p.get("calltimeout")),cache:!1,success:function(t){p.get("errorcod");if("0000"==ackStatus)a(t),startTimer("submit",!1);else{hideSpinner(),m++;var n=p.get("errordesc");e("#showError").text(n),e("#secError").show(),m>2&&(m=0,i.history.navigate("#/wrongOTPExceptionpost/sadad"),startTimer("submit",!1))}},error:s})}else this.$(".alert-error").fadeIn(),hideSpinner()},ownsoftotp:function(){this.model=new u({url:"json/"}),i.Validation.bind(this);var t=this.$("form").serializeObject();if(this.model.set(t,{validate:!0})){showSpinner(),this.model.clear(),i.Validation.unbind(this);var o=this,a=function(e){o.addNewBills()},s=function(e){o.errorresponse()};o.collection=new n([],{});var r=(new Date).getTime(),c="SOFTOTP",l=e("#softotp").val(),d=p.get("custno");o.collection.fetch({data:e.param({opttype:c,refno:p.get("token_serno"),activationno:l,customerno:d,requestid:r}),dataType:"json",type:"POST",timeout:parseInt(p.get("calltimeout")),cache:!1,success:function(e){"0000"==ackStatus?a(e):s(e)},error:s})}else this.$(".alert-error").fadeIn(),hideSpinner()},addNewBills:function(){var t=this;showSpinner();var i=function(e){t.OtpSuccess()},n=function(e){t.errorresponse()};t.collection=new a([],{}),timestamp=(new Date).getTime();var o=p.get("access_token"),s=p.get("language"),r=getDeviceId(),c=p.get("billercategoryID"),l=p.get("billerServiceId"),d=p.get("add_managebill_details"),u=d[5],m=d[4],h=m+p.get("appdynamicToken");h=CryptoJS.SHA512(h)+"",t.collection.fetch({data:e.param({appDynamicValue:h,access_token:o,serviceproviderno:m,nickname:u,validType:"Posting",billercategoryid:c,operationFlag:"A",serviceid:l,device_id:r,lang_id:s,requestid:timestamp}),dataType:"json",type:"POST",timeout:parseInt(p.get("sadadcalltimeout")),cache:!1,success:function(e){"0000"==ackStatus?i(e):n(e)},error:n})},OtpSuccess:function(){return hideSpinner(),this.$("#mobcontent").html(t.template(r)).i18n(),this},SuccessPage:function(){hideSpinner(),p.set("currentPage","transferConfirm"),i.history.navigate("#/addnewbillsuccess")},errorresponse:function(){i.history.navigate("#/exception"),hideSpinner()},disposeView:function(e){return i.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return h});