define(["jquery","underscore","Backbone","collections/sadad/billInquiryAccountCollections","collections/sadad/getLimitsFromPayModeCollections","collections/sadad/oneTimePayValidationCollections","text!views/sadad/duebillpayverify.tpl"],function(e,a,t,r,i,l,n){var s=new EncryptedLocalStorage("secret"),c=t.View.extend({el:"#container",e1:"#menuwrapper",e2:"#mobcontent",events:{"click #payduebills":"payDueBills","click #paymode":"getAvailLimits","change #acnt":"acnt1","change #ccd":"ccd1"},initialize:function(){},acnt1:function(){e("#errorFromAct").hide(),e("#errorFromCard").hide(),e("#errorAvailBal").hide(),e("#errorAvailLimit").hide(),e("#errorDailyLimit").hide(),e("#labelAccount").addClass("active"),e("#labelAccount").addClass("btn-success"),e("#labelAccount").removeClass("btn-default"),e("#labelCard").removeClass("active"),e("#labelCard").addClass("btn-default"),e("#labelCard").removeClass("btn-success")},ccd1:function(){e("#errorFromAct").hide(),e("#errorFromCard").hide(),e("#errorAvailBal").hide(),e("#errorAvailLimit").hide(),e("#errorDailyLimit").hide(),e("#labelAccount").removeClass("active"),e("#labelAccount").removeClass("btn-success"),e("#labelAccount").addClass("btn-default"),e("#labelCard").addClass("active"),e("#labelCard").removeClass("btn-default"),e("#labelCard").addClass("btn-success")},update:function(a){var t=this;showSpinner();var i=function(e){t.billverify(a)},l=function(e){t.errorresponse()};t.collection=new r([],{});var n=(new Date).getTime(),c=s.get("segmentvalue"),o="ALL",d="S",u="SADAD";t.collection.fetch({data:e.param({trans_type:"DUEBILLS",segment:c,status:"ACTIVE",serviceid:o,flag:d,paramcode:u,requestid:n}),dataType:"json",type:"POST",timeout:parseInt(s.get("sadadcalltimeout")),cache:!1,success:function(e){"0000"==ackStatus?i(e):l(e)},error:l})},billverify:function(t){hideSpinner(),this.$("#mobcontent").html(a.template(n,{totamt:t})).i18n(),e(".amtformatter").formatamount();var r,i=s.get("paymentMethoddefaultselection"),l=s.get("defaultSelectionListDetails");if(""!=l&&null!=l){"ACCOUNT"==i?r=s.get("fromaccDTO"):"CREDITCARD"==i&&(r=s.get("creditcards"));var c=0,o="",d=new Array;a.each(r,function(e,a){"ACCOUNT"==i?d[c]=e.accountNumber:"CREDITCARD"==i&&(d[c]=e.creditCardNoMasked.replace(/\-/g,"")),fromAccdefaultselection==d[c]&&(o=parseInt(a)),c++}),"ACCOUNT"==i?(e("input:radio[name=frmacno]")[o].checked=!0,e(".creditCard").hide(),e(".fromAcc").show(),e("#labelAccount").addClass("active"),e("#labelAccount").addClass("btn-success"),e("#labelAccount").removeClass("btn-default"),e("#labelCard").removeClass("active"),e("#labelCard").addClass("btn-default"),e("#labelCard").removeClass("btn-success")):"CREDITCARD"==i&&(e("input:radio[name=frmcard]")[o].checked=!0,e(".creditCard").show(),e(".fromAcc").hide(),e("#labelAccount").removeClass("active"),e("#labelAccount").removeClass("btn-success"),e("#labelAccount").addClass("btn-default"),e("#labelCard").addClass("active"),e("#labelCard").removeClass("btn-default"),e("#labelCard").addClass("btn-success")),e(".dropselect").dropselect()}},getAvailLimits:function(){var a=this;showSpinner();var t=function(e){a.errorresponse()};a.collection=new i([],{});var r=(new Date).getTime(),l=s.get("segmentvalue"),n="07";a.collection.fetch({data:e.param({segment:l,serviceid:n,requestid:r}),dataType:"json",type:"POST",timeout:parseInt(s.get("calltimeout")),cache:!1,success:function(a){if("0000"==ackStatus){var r=s.get("availlimit"),i=s.get("dailylimit"),l=s.get("transfee");e("#dailyLimit").text(i),e("#availLimit").text(r),e("#transfee").text(l),e("#hiddavaillimit").val(r),e("#hidddailylimit").val(i),e("#hiddtransfee").val(l),hideSpinner()}else t(a)},error:t})},payDueBills:function(){s.set("duemodepay",""),e("#errorFromAct").hide(),e("#errorFromCard").hide(),e("#errorAvailBal").hide(),e("#errorAvailLimit").hide(),e("#errorDailyLimit").hide();var r=e("#totamount").val(),i=e("#hiddtransfee").val(),n=s.get("dailylmt"),c=s.get("availlmt"),o=e("input[name=frmacno]:checked").val(),d=e("input[name=frmcard]:checked").val(),u=(e("input:radio[name=options]:checked").val(),"");if(u=e("#labelAccount").hasClass("btn-success")?"A":e("#labelCard").hasClass("btn-success")?"C":e("#hidPaymentMode").val(),s.set("duemodepay",u),e("#labelCard").hasClass("btn-success"))e("#errorFromAct").hide();else if("A"==u&&"undefined"==typeof o)return e("#errorFromAct").show(),!1;if(e("#labelAccount").hasClass("btn-success"))e("#errorFromCard").hide();else if("C"==u&&"undefined"==typeof d)return e("#errorFromCard").show(),!1;var m,C,v,p,f;if("A"==u)if(void 0!=o){var h=o.split("~");C=h[0],v=h[1],m=h[2],s.set("FrmAcctNoMode",v)}else C="",s.set("FrmAcctNoMode","");else if(void 0!=d){var A=d.split("~");p=A[0],f=A[1],m=A[2],s.set("FrmCardNoMode",f);var b=A[3];s.set("CCardActNo",b);var y=m;if(-1!=m.indexOf(",")&&(y=m.replace(/,/g,"")),m=y,parseFloat(r)>parseFloat(m))return e("#errorAvailBal").show(),!1}else p="",s.set("FrmCardNoMode",""),s.set("CCardActNo","");if(parseFloat(r)>parseFloat(c))return e("#errorAvailLimit").show(),!1;if(parseFloat(r)>parseFloat(n))return e("#errorDailyLimit").show(),!1;showSpinner();var g=this,w=function(e){hideSpinner(),"A"==u?t.history.navigate("#/duebillpayConfirm/"+C+"/"+r+"/ACCOUNT"):t.history.navigate("#/duebillpayConfirm/"+p+"/"+r+"/CREDITCARD")},D=function(e){g.errorresponse()};g.collection=new l([],{}),timestamp=(new Date).getTime();var S,T=new Array,F=new Array,N=new Array,L=new Array,O=new Array,k=new Array;S="A"==u?"ACCOUNT":"CREDITCARD";var I=new Array;new Array;I=s.get("BillerLists");var M=a.size(I);s.set("billersizechck",M);var E=0;a.each(I,function(e){null!=I[E]&&(T[E]=e[4],F[E]=e[9],N[E]=e[8],L[E]=e[5],O[E]=e[11],k[E]=e[10],E++)});var R=JSON.stringify(T),V=JSON.stringify(F),B=JSON.stringify(N),q=JSON.stringify(L),x=JSON.stringify(O),J=JSON.stringify(k),P=(R.replace(/"/g,""),V.replace(/"/g,"")),U=B.replace(/"/g,""),L=q.replace(/"/g,""),_=x.replace(/"/g,"");s.set("billerDueDate",_);var j=J.replace(/"/g,"");s.set("billerCode",j);var z,K,W,$,G=s.get("hidTotalAmt");"ACCOUNT"==S?(z="ACTDEB",K=s.get("FrmAcctNoMode")):(paymethodVal="CCARD",W=s.get("FrmCardNoMode"),$=s.get("CCardActNo"));var H=s.get("custno"),Q="KWD",X="",Y="",i=s.get("transfees");("undefined"==K||void 0==K)&&(K=""),("undefined"==W||void 0==W)&&(W=""),("undefined"==$||void 0==$)&&($="");var Z=getDeviceId(),ee=S+""+K+W+$+z+_+j+L+U+i+Z,ae=CryptoJS.MD5(ee);ee=ae+"";var te=s.get("id_type"),re=s.get("iqama_number");g.collection.fetch({data:e.param({appchecksum:ee,custno:H,fromcurrname:Q,paymentmode:S,processdate:X,paymethod:z,hidduedate:_,hidbillercode:j,hidbillername:L,currentdate:Y,hidpayamount:U,transfee:i,hidservicetype:P,custaccountno:K,creditcardnumber:W,creditcardacctnumber:$,totalAmount:G,otpModule:"bill_inquiry_and_payment",billingaccno:L,owneridno:re,hididtypecode:te,pmttype:"POST",requestid:timestamp}),dataType:"json",type:"POST",timeout:parseInt(s.get("sadadcalltimeout")),cache:!1,success:function(e){"0000"==ackStatus?w(e):D(e)},error:D})},errorresponse:function(){hideSpinner(),t.history.navigate("#/exception")},disposeView:function(e){return t.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return c});