define(["jquery","underscore","Backbone","collections/sadad/billPayInquiryCollections","collections/sadad/billInquiryAccountCollections","collections/creditcard/creditCardSummaryCollections","collections/sadad/oneTimePayValidationCollections","text!views/sadad/billpayInquiryverify.tpl","text!views/sadad/billpayInquiry.tpl","views/sadad/billpayInquiry"],function(e,r,t,a,i,n,l,s,c,o){var d=new EncryptedLocalStorage("secret"),u=0,m=t.View.extend({el:"#container",e1:"#menuwrapper",e2:"#mobcontent",events:{"click #paybills":"PayBills","change #acnt":"acnt1","change #ccd":"ccd1"},initialize:function(){u=0},acnt1:function(){e("#errorFromAct").hide(),e("#errorFromCard").hide(),e("#errorAvailBal").hide(),e("#errorAvailLimit").hide(),e("#errorDailyLimit").hide(),e("#labelAccount").addClass("active"),e("#labelAccount").addClass("btn-success"),e("#labelAccount").removeClass("btn-default"),e("#labelCard").removeClass("active"),e("#labelCard").addClass("btn-default"),e("#labelCard").removeClass("btn-success"),e(".fromAcc").show(),e(".creditCard").hide()},ccd1:function(){var r=d.get("totalamount");if(u>0)return!1;u=1,e("#errorFromAct").hide(),e("#errorFromCard").hide(),e("#errorAvailBal").hide(),e("#errorAvailLimit").hide(),e("#errorDailyLimit").hide(),e(".fromAcc").hide(),e(".creditCard").show();var t=this,a=function(e){t.billverify(r)},i=function(e){t.errorresponse()};t.collection=new n([],{});(new Date).getTime();t.collection.fetch({data:e.param({access_token:d.get("access_token")}),dataType:"json",type:"POST",cache:!1,success:function(r){"0000"==ackStatus?(u=0,a(r),e("#labelAccount").removeClass("active"),e("#labelAccount").removeClass("btn-success"),e("#labelAccount").addClass("btn-default"),e("#labelCard").addClass("active"),e("#labelCard").removeClass("btn-default"),e("#labelCard").addClass("btn-success"),e(".fromAcc").hide(),e(".creditCard").show()):(u=0,i(r))},error:i})},update:function(r){d.set("defaultSelectionListDetails","");var t=this;showSpinner();var a=function(e){t.billverify(r)},n=function(e){t.errorresponse()};t.collection=new i([],{});(new Date).getTime(),d.get("segmentvalue");t.collection.fetch({data:e.param({access_token:d.get("access_token")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?a(e):n(e)},error:n})},billverify:function(t){hideSpinner(),d.set("totalamount",t),this.$("#mobcontent").html(r.template(s)).i18n(),e(".amtformatter").formatamount();var a,i=d.get("paymentMethoddefaultselection"),n=d.get("defaultSelectionListDetails");if(""!=n&&null!=n){"ACCOUNT"==i?a=d.get("fromaccDTO"):"CREDITCARD"==i&&(a=d.get("creditcards"));var l=0,c="",o=new Array;r.each(a,function(e,r){"ACCOUNT"==i?o[l]=e.accountNumber:"CREDITCARD"==i&&(o[l]=e.creditCardNoMasked.replace(/\-/g,"")),fromAccdefaultselection==o[l]&&(c=parseInt(r)),l++}),"ACCOUNT"==i?(e("input:radio[name=frmacno]")[c].checked=!0,e(".creditCard").hide(),e(".fromAcc").show(),e("#labelAccount").addClass("active"),e("#labelAccount").addClass("btn-success"),e("#labelAccount").removeClass("btn-default"),e("#labelCard").removeClass("active"),e("#labelCard").addClass("btn-default"),e("#labelCard").removeClass("btn-success")):"CREDITCARD"==i&&(e("input:radio[name=frmcard]")[c].checked=!0,e(".creditCard").show(),e(".fromAcc").hide(),e("#errorFromAct").hide(),e("#labelAccount").removeClass("active"),e("#labelAccount").removeClass("btn-success"),e("#labelAccount").addClass("btn-default"),e("#labelCard").addClass("active"),e("#labelCard").removeClass("btn-default"),e("#labelCard").addClass("btn-success")),e(".dropselect").dropselect()}},back:function(){hideSpinner(),this.subview=this.disposeView(new o),this.subview.update(),this.undelegateEvents()},PayBills:function(){d.set("modepay",""),e("#errorFromAct").hide(),e("#errorFromCard").hide(),e("#errorAvailBal").hide(),e("#errorAvailLimit").hide(),e("#errorDailyLimit").hide();var a=e("#totamount").val(),i=(e("#hiddtransfee").val(),e("input[name=frmacno]:checked").val()),n=e("input[name=frmcard]:checked").val(),s=e("input:radio[name=options]:checked").val(),c="";if(c=e("#labelAccount").hasClass("btn-success")?"A":e("#labelCard").hasClass("btn-success")?"C":e("#hidPaymentMode").val(),d.set("modepay",c),"A"==c){if("undefined"==typeof i)return e("#errorFromAct").show(),!1}else if("C"==c&&"undefined"==typeof n)return e("#errorFromCard").show(),!1;if(e("#labelCard").hasClass("btn-success"))e("#errorFromAct").hide();else if("A"==c&&"undefined"==typeof i)return e("#errorFromAct").show(),!1;if(e("#labelAccount").hasClass("btn-success"))e("#errorFromCard").hide();else if("C"==c&&"undefined"==typeof n)return e("#errorFromCard").show(),!1;var o=i.split("~"),u=o[0];d.set("frmaccno",u);var i=o[1];d.set("frmacntval",i);var m=o[2];d.set("frmacntid",m);var C,f,v,h,b,p,A,y=i;if("A"==c)void 0!=i?(f=i.split("~"),C=d.get("frmaccno"),v=f[1],A=f[2],d.set("FrmAcctNoMode",v)):(C="",d.set("FrmAcctNoMode",""));else if(void 0!=n){h=n.split("~"),b=h[0],p=h[1],A=h[2],d.set("FrmCardNoMode",p);var g=h[3];d.set("CCardActNo",g);var w=A;if(-1!=A.indexOf(",")&&(w=A.replace(/,/g,"")),A=w,parseFloat(a)>parseFloat(A))return e("#errorAvailBal").show(),!1}else b="",d.set("FrmCardNoMode",""),d.set("CCardActNo","");if(parseFloat(a)>parseFloat(y))return e("#errorAvailLimit").show(),!1;showSpinner();var I=this,T=function(e){hideSpinner(),"A"==c?t.history.navigate("#/billInquiryConfirm/"+C+"/"+a+"/ACCOUNT"):t.history.navigate("#/billInquiryConfirm/"+b+"/"+a+"/CREDITCARD")},D=function(e){I.errorresponse()};I.collection=new l([],{}),timestamp=(new Date).getTime();var N,S=new Array,F=new Array,k=new Array,O=new Array,q=new Array,B=new Array,V=new Array;N="A"==c?"ACCOUNT":"CREDITCARD";var L=new Array;new Array;L=d.get("BillerLists");var P=r.size(L);d.set("billersizechck",P);var R=0;r.each(L,function(e){d.set("ConfirmBillers",e),null!=L[R]&&(S[R]=e[4],F[R]=e[9],k[R]=e[8],O[R]=e[5],q[R]=e[11],B[R]=e[10],V[R]=e[6],R++)});var E=JSON.stringify(S),M=JSON.stringify(F),_=JSON.stringify(k),J=JSON.stringify(O),U=JSON.stringify(q),x=JSON.stringify(B),j=JSON.stringify(V),O=(E.replace(/"/g,""),M.replace(/"/g,""),_.replace(/"/g,""),J.replace(/"/g,""));d.set("billerId",O);var z=U.replace(/"/g,"");d.set("billerDueDate",z);var $=x.replace(/"/g,"");d.set("billerCode",$);var G=j.replace(/"/g,"");d.set("billerCateId",G);var H=d.get("ConfirmBillers"),K=H[5];d.set("billid",K);var Q=H[6];d.set("billcate",Q);var W,X,Y,Z;"ACCOUNT"==s?(W="ACTDEB",X=d.get("FrmAcctNoMode")):(W="CCARD",Y=d.get("FrmCardNoMode"),Z=d.get("CCardActNo"));var ee=(d.get("custno"),d.get("transfees"),d.get("frmacntval")),re=(d.get("hidTotalAmt"),d.get("language"));("undefined"==X||void 0==X)&&(X=""),("undefined"==Y||void 0==Y)&&(Y=""),("undefined"==Z||void 0==Z)&&(Z="");var te,m=(getDeviceId(),d.get("id_type"),d.get("iqama_number"),d.get("frmacntid")),ae=d.get("denominationCurrency"),ie=d.get("denominationId"),ne=d.get("denominationAmount"),le=d.get("sellingPrice");te=""!=le&&"null"!=le&&null!=le&&"undefined"!=le&&void 0!=le?le:d.get("amtValchck");var se,ce=d.get("sellingCurrency");se=""!=ce&&"null"!=ce&&null!=ce&&"undefined"!=ce&&void 0!=ce?ce:d.get("basecurr"),I.collection.fetch({data:e.param({access_token:d.get("access_token"),validtype:"Validation",billerCategoryId:Q,fromAcountId:m,fromAcountbalance:ee,amount:te,billerId:K,denominationId:ie,denominationAmount:ne,denominationCurrency:ae,sellingPrice:te,sellingCurrency:se,billeruniqueId:d.get("Billeruniquid"),serviceproviderno:d.get("Billerservicesref"),remarks:"BillPayment",lang_id:re,requestid:timestamp}),dataType:"json",type:"POST",timeout:parseInt(d.get("sadadcalltimeout")),cache:!1,success:function(e){"0000"==ackStatus?T(e):D(e)},error:D})},billpayInquiry:function(e){hideSpinner(),this.$("#mobcontent").html(r.template(billpayInquiryTemplate)).i18n()},errorresponse:function(){hideSpinner(),t.history.navigate("#/exception")},disposeView:function(e){return t.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return m});