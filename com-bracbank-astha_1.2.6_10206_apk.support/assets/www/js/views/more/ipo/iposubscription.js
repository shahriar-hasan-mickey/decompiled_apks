define(["jquery","underscore","Backbone","routers/iporouter","collections/more/ipoCollections","collections/more/ipoSubscriptionCollections","collections/transfer/ownAccountTransferCollections","models/validation/transfer/ownAccountTransferValidationModel","text!views/more/ipo/iposubscription.tpl"],function(e,t,r,a,n,i,o,s,c){var l=new EncryptedLocalStorage("secret"),m=r.View.extend({el:"#container",e1:"#menuwrapper",e2:"#mobcontent",events:{"change #iponame":"transactiontemplate","click #submit":"Submit","blur  #sharespersubscriber":"convertedamount","click #clickdet":"clickDet"},initialize:function(){},render:function(){showSpinner();var t=this;timestamp=(new Date).getTime();var r=function(e){t.ipo()},a=function(e){t.errorresponse()};t.collection=new n([],{});var i="",o=l.get("lang_id");"en-US"==o?i="EN":"en-AR"==o&&(i="AR"),t.collection.fetch({data:e.param({requestid:timestamp,language:i}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(l.get("calltimeout")),success:function(e){"0000"==ackStatus?r(e):a(e)},error:a})},ipo:function(){var t=this,r=function(e){t.accttemplate()},a=function(e){t.errorresponse()};t.collection=new i([],{});var n="",o=l.get("lang_id");"en-US"==o?n="EN":"en-AR"==o&&(n="AR"),t.collection.fetch({data:e.param({status:"ACTIVE",requestid:timestamp,ipoCompanyName:l.get("ipocode")}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(l.get("calltimeout")),success:function(e){if("0000"==ackStatus)r(e);else if("9999"==ackStatus){var t=l.get("errorcode");hideSpinner(),""==t||"null"==t||null==t?r(e):a(e)}},error:a})},accttemplate:function(){var t=this;timestamp=(new Date).getTime();var r=function(e){t.subscriptiontemplate()},a=function(e){t.errorresponse()};t.collection=new o([],{});var n="",i=l.get("lang_id");"en-US"==i?n="EN":"en-AR"==i&&(n="AR"),t.collection.fetch({data:e.param({requestid:timestamp,status:"ACTIVE"}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(l.get("calltimeout")),success:function(e){if("0000"==ackStatus)r(e);else if("9999"==ackStatus){var t=l.get("errorcode");hideSpinner(),""==t||"null"==t||null==t?r(e):a(e)}},error:a})},subscriptiontemplate:function(){return hideSpinner(),this.$("#mobcontent").html(t.template(c)).i18n(),this},transactiontemplate:function(){var t=e("#iponame option:selected").val(),r=t.split("~"),a=r[0];l.set("iponame",a);var n=r[1],o=r[2],s=r[3],c=r[4],m=r[5],p=r[6],u=r[7];if(""==a||"undefined"==a||void 0==a)return e("#ipodetails").hide(),!1;e("#noofshares").html("<span>"+n+"</span>"),e("#shareprice").html("<span>KWD <span id='Sharepriceamt'>"+checkAmount(e.formatNumber(o,{format:"#,###.000",locale:"us"}))+"</span></span>"),e("#minimum").html("<span>"+s+"</span>"),e("#maximum").html("<span>"+c+"</span>"),e("#startdate").html("<span>"+m+"</span>"),e("#enddate").html("<span>"+p+"</span>"),showSpinner();var d=this;timestamp=(new Date).getTime();var h=function(e){d.depshow()},f=function(e){d.errorresponse()};d.collection=new i([],{}),timestamp=(new Date).getTime();var v="",g=l.get("lang_id");"en-US"==g?v="EN":"en-AR"==g&&(v="AR"),l.set("ipocode",u),d.collection.fetch({data:e.param({requestid:timestamp,language:v,ipoCompanyName:l.get("ipocode")}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(l.get("calltimeout")),success:function(e){if("0000"==ackStatus)h(e);else if("9999"==ackStatus){var t=l.get("errorcode");hideSpinner(),""==t||"null"==t||null==t?h(e):f(e)}},error:f})},depshow:function(){var t=l.get("ipoDependentListDTO"),r="";if(r="<table class='table'><thead><tr><th width='60%'>"+e.i18n.t("app.more.investmentipo.name")+"<th width='30%'>"+e.i18n.t("app.more.investmentipo.relationship")+"</th></tr></thead><tbody>",null!=t){if(t.length>0){for(var a=0;a<t.length;a++)r=r+"<tr  id='selrel' name='selrel' value='"+t[a].dependtName+"~"+t[a].relationship+"'><td id='relname'>"+t[a].dependtName+"</td>	<td id='relationship'>"+t[a].relationship+"</td> </tr>";r+="</tbody></table>"}}else r+="</tbody></table>",r=r+"<tr class='alert alert-info text-center'><span class='msg'>"+e.i18n.t("app.more.investmentipo.noresult")+"</span></tr>";e("#dependentList").html(r),e(".ipodetails").show(),e(".stepcontrols").show(),e("#sharespersubscriber").val(""),e("#shareamtval").text(""),e("#errorFromAct").hide(),e("#errorshares").hide(),e("#errorshareamt").hide();var n=e("#iponame option:selected").val(),i=n.split("~"),o=i[0];return""==o||"undefined"==o||void 0==o?(e("#ipodetails").hide(),!1):void hideSpinner()},convertedamount:function(){e("#errorFromAct").hide(),e("#errorshares").hide(),e("#errorshareamt").hide(),l.set("subcamtvalue","");var t=e("form#iposubscriptionform"),r=t.find("#sharespersubscriber").val(),a=e("#Sharepriceamt").text(),n=a;l.set("sharepriceamt",n);var i=l.get("lengthofdep"),o=l.get("base_currency"),s="",c="",m="",p="",u="";i>=1?(u=i+1,s=r*n*u,c=checkAmount(e.formatNumber(s,{format:"#,###.000",locale:"us"})),m=c.replace(/\,/g,""),p=o+" "+c):(s=r*n,c=checkAmount(e.formatNumber(s,{format:"#,###.000",locale:"us"})),m=c.replace(/\,/g,""),p=o+" "+c),l.set("subcamtvalue",p),l.set("subcamtvalue1",m),e("#shareamtval").text(p)},clickDet:function(){e("#arrow").hasClass("glyphicon-chevron-down")?(e("#arrow").removeClass("glyphicon-chevron-down"),e("#arrow").addClass("glyphicon-chevron-right")):e("#arrow").hasClass("glyphicon-chevron-right")&&(e("#arrow").addClass("glyphicon-chevron-down"),e("#arrow").removeClass("glyphicon-chevron-right"))},Submit:function(t){e("#errorshares").hide(),e("#errorFromAct").hide(),e("#errorshareamt").hide(),showSpinner(),this.model=new s({url:"json/"}),r.Validation.bind(this);var a=this.$("form").serializeObject();if(this.model.set(a,{validate:!0})){this.model.clear(),r.Validation.unbind(this),t.preventDefault();var n=e("#sharespersubscriber").val(),n=parseInt(n);if(l.set("sharespersubscriber",n),0==!(n%10))return e("#errorshares").show(),hideSpinner(),!1;var i=e("input[name=frmcurid]:checked").val();if(void 0==i||""==i||null==i||"undefined"==i)return e("#errorFromAct").show(),hideSpinner(),!1;frmcur=i.split("~"),frmaccno=frmcur[1],l.set("frmaccno",frmaccno),frmacname=frmcur[3],void 0==frmacname||""==frmacname||null==frmacname||"undefined"==frmacname?accfrm=frmaccno:accfrm=frmacname,l.set("accfrm",accfrm);var o=e("#iponame option:selected").val(),c=o.split("~"),m=c[7];l.set("ipoCompCode",m);var p=(l.get("ipoCompCode"),e("#shareamtval").text());l.set("shareamtval",p);var u=e("#noofshares").text();l.set("noofshares",u);var d=e("#shareprice").text();l.set("shareprice",d);var h=e("#minimum").text(),h=parseInt(h);l.set("minimum",h);var f=e("#maximum").text(),f=parseInt(f);l.set("maximum",f);var v=e("#startdate").text();l.set("startdate",v);var g=e("#enddate").text();l.set("enddate",g);var w=e("#relname").text();l.set("relname",w);var b=e("#relationship").text();if(l.set("relationship",b),h>n||n>f)return e("#errorshareamt").show(),hideSpinner(),!1;hideSpinner(),r.history.navigate("#/ipoconfirm")}else this.$(".alert-error").fadeIn(),t.preventDefault(),hideSpinner()},errorresponse:function(){hideSpinner(),r.history.navigate("#/exception")},disposeView:function(e){return r.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return m});