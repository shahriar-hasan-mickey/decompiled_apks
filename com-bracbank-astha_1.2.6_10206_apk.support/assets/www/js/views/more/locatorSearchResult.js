define(["jquery","underscore","Backbone","collections/locator/locatorResultCollections","text!views/more/locatorSearchResult.tpl","views/more/locatorSearchMap"],function(e,t,a,s,i,n){var o=new EncryptedLocalStorage("secret"),r=a.View.extend({el:"#mobcontent",events:{"click #locatorsearchmap":"locatorsearchmap"},render:function(){function t(e){var t=/iPad|iPhone|iPod/.test(navigator.userAgent);t||a.history.navigate("#/locatorview"),onGeoLocationError(e)}function i(t){hideSpinner();var a,s,i=(t.coords,o.get("app.context.path"));-1!=i.indexOf("dev")?(a="24.669170",s="46.70533"):(a=t.coords.latitude,s=t.coords.longitude);var l=o.get("srbranch"),p=o.get("distkm"),c=o.get("srselecity");timestamp=(new Date).getTime(),showSpinner(),"en-US"==e.i18n.lng()?language="EN":"en-AR"==e.i18n.lng()&&(language="AR"),n.collection.fetch({data:e.param({login_type:"postlogin",latitude:a,longitude:s,reqtype:"LOCATOR",language:language,type:l,distance:p,city:c,requestid:timestamp}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(o.get("calltimeout")),success:function(t){if("0000"==ackStatus)if(""!=proximityListDTO&&null!=proximityListDTO){e("#atmresult").show(),e("#errorResult").hide(),e("#atmresult").empty();var i=[];e.each(proximityListDTO,function(t){function n(a,s){if(s!=google.maps.DistanceMatrixStatus.OK)i.pop();else{var n,r=a.rows[0].elements,l=r[0].distance.text,p=r[0].distance.value/1e3;n="Y"==o.accept_cash_deposit?e.i18n.t("app.mpin.yes"):e.i18n.t("app.mpin.no"),i[t].accepttype=n,i[t].disMeter=p,i[t].dis=l}}var o=proximityListDTO[t];i.push(o);var r=new google.maps.LatLng(a,s),l=new google.maps.LatLng(o.latitude,o.longitude),p=new google.maps.DistanceMatrixService;p.getDistanceMatrix({origins:[r],destinations:[l],travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.METRIC,avoidHighways:!1,avoidTolls:!1},n)}),setTimeout(function(){e(".boxborderd").empty(),e("#atmresult").empty(),e.each(i,function(e){if(void 0!=i[e]){var t=i[e].disMeter;void 0==t&&i.splice(e,1)}}),i.sort(function(e,t){return e=e.disMeter,t=t.disMeter,e-t});var t=i;e.each(t,function(a){var s=t[a],i=t[a].accepttype,n=t[a].dis;(void 0==n||null==n)&&(n=""),(void 0==i||null==i)&&(i="");var r=t[a].disMeter,l=o.get("distkm");if("city"==o.get("locatorTypeCityOrAtm")){var p='<div class="boxborderd"><div class="col-lg-12"><p><strong>'+s.branchatm_name+'</strong></p><address class="small text-muted">'+s.branchatm_address+'</address><p><span class="small">'+e.i18n.t("app.locator.distance")+'</span><span class="pull-right label label-warning">'+n+'</span></p><p><span class="small">'+e.i18n.t("app.locator.atmType")+'</span><span class="pull-right text-muted small"><b>'+s.atm_type+'</b></span></p><p><span class="small">'+e.i18n.t("app.locator.acceptsCashDeposits")+'</span><span class="pull-right text-muted small"><b>'+i+'</b></span></p><div class="btn-group btn-group-sm btn-group-justified" role="group" ><a href="#/directionview/'+s.latitude+"/"+s.longitude+'" class="btn btn-success">'+e.i18n.t("app.locator.direction")+"</a></div></div></div>";e("#atmresult").append(p)}else if(r>=0&&l>=r){var p='<div class="boxborderd"><div class="col-lg-12"><p><strong>'+s.branchatm_name+'</strong></p><address class="small text-muted">'+s.branchatm_address+'</address><p><span class="small">'+e.i18n.t("app.locator.distance")+'</span><span class="pull-right label label-warning">'+n+'</span></p><p><span class="small">'+e.i18n.t("app.locator.atmType")+'</span><span class="pull-right text-muted small"><b>'+s.atm_type+'</b></span></p><p><span class="small">'+e.i18n.t("app.locator.acceptsCashDeposits")+'</span><span class="pull-right text-muted small"><b>'+i+'</b></span></p><div class="btn-group btn-group-sm btn-group-justified" role="group" ><a href="#/directionview/'+s.latitude+"/"+s.longitude+'" class="btn btn-success">'+e.i18n.t("app.locator.direction")+"</a></div></div></div>";e("#atmresult").append(p)}}),hideSpinner()},3e3)}else e("#atmresult").hide(),e("#atmresult").empty(),e("#errorResult").show(),hideSpinner();else r(t),hideSpinner()}})}var n=this;n.locatorcompile();var r=function(e){n.errorresponse()};n.collection=new s,navigator.geolocation&&(showSpinner(),navigator.geolocation.getCurrentPosition(i,t,{enableHighAccuracy:!0,timeout:1e4,maximumAge:1e4}))},locatorcompile:function(){return hideSpinner(),this.$el.html(t.template(i,{})).i18n(),this.$el.trigger("create"),this},locatorsearchmap:function(e){e.preventDefault(),this.subview=this.disposeView(new n),this.subview.$el.trigger("create"),this.subview.update()},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(e){return a.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return r});