define(["jquery","underscore","Backbone","routers/morerouter","collections/more/sweepdropdownlistCollection","collections/more/sweepValidateCollections","models/validation/more/sweepAddValidationModel","text!views/more/sweepsviewadd.tpl","text!views/more/sweepsaddconfirm.tpl"],function($,_,Backbone,moreRouter,sweepdropdownlistCollection,sweepValidateCollections,sweepAddValidationModel,sweepsviewaddTemplate,sweepsviewaddconfirmTemplate){var els=new EncryptedLocalStorage("secret"),sadadLists=Backbone.View.extend({el:"#container",e1:"#menuwrapper",e2:"#mobcontent",events:{"click #sweepsubmit":"sweepConfirm","change #sweeptype":"sweeptypeSelect","change #paymenttype":"paymenttypeSelect","click #payamt":"openNumPad","change #acnum":"currencycheck"},currencycheck:function(){var amtval=$("#payamt").val(),vall=0,acnumTextGroup=$("input[name=acnum]:checked").val(),acnumTextArr=acnumTextGroup.split("~"),curr=acnumTextArr[4];"KWD"==curr?eval(amtval)>eval(vall)&&$("#payamt").val(Number(amtval).toFixed(3)):eval(amtval)>eval(vall)&&$("#payamt").val(Number(amtval).toFixed(2));var amtval=$("#upperlmt").val(),vall=0,acnumTextGroup=$("input[name=acnum]:checked").val(),acnumTextArr=acnumTextGroup.split("~"),curr=acnumTextArr[4];"KWD"==curr?eval(amtval)>eval(vall)&&$("#upperlmt").val(Number(amtval).toFixed(3)):eval(amtval)>eval(vall)&&$("#upperlmt").val(Number(amtval).toFixed(2));var amtval=$("#lowerlmt").val(),vall=0,acnumTextGroup=$("input[name=acnum]:checked").val(),acnumTextArr=acnumTextGroup.split("~"),curr=acnumTextArr[4];"KWD"==curr?eval(amtval)>eval(vall)&&$("#lowerlmt").val(Number(amtval).toFixed(3)):eval(amtval)>eval(vall)&&$("#lowerlmt").val(Number(amtval).toFixed(2))},openNumPad:function(){var that=this;id="payamt";var iOS=/iPad|iPhone|iPod/.test(navigator.userAgent),isKeyPadNeed=els.get("isKeyPadNeed");if(iOS&&isKeyPadNeed)navigator.notification.keypadOpen($("#"+id).val(),9,function(e){$("#"+id).val(convertNumbers2English(e))},function(value){$("#"+id).val(convertNumbers2English(value));var amtval=$("#"+id).val(),vall=0,acnumTextGroup=$("input[name=acnum]:checked").val(),acnumTextArr=acnumTextGroup.split("~"),curr=acnumTextArr[4];"KWD"==curr?eval(amtval)>eval(vall)&&$("#"+id).val(Number(amtval).toFixed(3)):eval(amtval)>eval(vall)&&$("#"+id).val(Number(amtval).toFixed(2)),that.currencycheck()});else{var amtval=$("#payamt").val(),vall=0,acnumTextGroup=$("input[name=acnum]:checked").val(),acnumTextArr=acnumTextGroup.split("~"),curr=acnumTextArr[4];"KWD"==curr?eval(amtval)>eval(vall)&&$("#payamt").val(Number(amtval).toFixed(3)):eval(amtval)>eval(vall)&&$("#payamt").val(Number(amtval).toFixed(2)),that.currencycheck()}},render:function(){var e=this;showSpinner();var t=function(t){e.sweepdropdataList()},a=function(t){e.errorresponse()};e.collection=new sweepdropdownlistCollection,e.collection.fetch({data:$.param({access_token:els.get("access_token")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?t(e):a(e)},error:a})},paymenttypeSelect:function(){var e=$("#paymenttype").find(":selected").val(),t=e.split("~"),a=(t[0],t[1]);"4"==a?$("#lastpaymentDiv").show():$("#lastpaymentDiv").hide(),els.set("payidx",a)},sweeptypeSelect:function(){var e=$("#sweeptype").find(":selected").val(),t=e.split("~"),a=(t[0],t[1]);"4"==a?($("#selectacctype").html($.i18n.t("app.more.sweep.creditacsel")),$("#lowerDiv").show(),$("#upperDiv").hide()):"3"==a&&($("#selectacctype").html($.i18n.t("app.more.sweep.debitacsel")),$("#upperDiv").show(),$("#lowerDiv").hide()),els.set("nmeidx",a)},sweepdropdataList:function(){hideSpinner(),this.$("#mobcontent").html(_.template(sweepsviewaddTemplate)).i18n(),$("#lowerDiv").hide(),$("#upperDiv").hide(),$("#lastpaymentDiv").hide();var e=els.get("device.platform");"Android"==e||"Ios"==e?this.datefunc():this.datefunc()},sweepConfirm:function(){$("#errorFromAct").hide(),$("#errpaymenttype").hide(),$("#errsweeptype").hide(),$("#errcreditac").hide(),$("#errorAccremrks").hide(),$("#errorCAccremrks").hide(),$("#errorUpprlimit").hide(),$("#errorLwrlimit").hide(),$("#errorFirstpayDate").hide(),$("#errorLastpayDate").hide(),$("#errornullAmt").hide(),$("#ptoDateShouldNotBeGreaterThanCurrDate").hide(),$("#lstoDateShouldNotBeGreaterThanCurrDate").hide(),$("#ptlsDateShouldNotBeGreaterThanCurrDate").hide();var e=!1,t=$("#acnum").val(),a=$("#paymenttype").val(),r=$("#sweeptype").val(),l=$("#creditac").val(),i=$("input[name=acnum]:checked").val(),n=i.split("~"),t=n[0],s=n[5];els.set("acnumidx",s),i||($("#errorFromAct").show(),e=!0);var c=($("#paymenttype").find(":selected").val(),new Array);c[0]=t,c[1]=$("#paymenttype").find(":selected").val(),c[2]=$("#sweeptype").find(":selected").val(),c[3]=$("#creditac").find(":selected").val(),c[4]=$("#paymentdate").val(),c[5]=$("#payamt").val(),c[6]=$("#upperlmt").val(),c[7]=$("#acremarks").val(),c[8]=$("#craccremarks").val(),c[9]=$("#lowerlmt").val(),c[10]=$("#lastpaymentdate").val(),els.set("sweepConfirm",c),t===c[3]&&($("#errorsameAct").show(),e=!0),c[5]||($("#errornullAmt").show(),e=!0),a||($("#errpaymenttype").show(),e=!0),r||($("#errsweeptype").show(),e=!0),l||($("#errcreditac").show(),e=!0),c[7]||($("#errorAccremrks").show(),e=!0),c[8]||($("#errorCAccremrks").show(),e=!0),c[4]||($("#errorFirstpayDate").show(),e=!0);var o=els.get("nmeidx"),d=els.get("payidx");if("3"==o){var p="3";c[6]||($("#errorUpprlimit").show(),$("#errorLwrlimit").hide(),$("#errorLastpayDate").hide(),e=!0)}else if("4"==o){var p="4";c[9]||($("#errorLwrlimit").show(),$("#errorUpprlimit").hide(),$("#errorLastpayDate").hide(),e=!0)}"4"==d&&(c[10]||($("#errorLastpayDate").show(),$("#errorUpprlimit").hide(),$("#errorLwrlimit").hide(),e=!0));var m=$("#paymentdate").val(),v=m.split("/"),u=v[0],h=v[1],w=v[2],m=new Date(w,h,u),y=new Date,f=y.getDate(),D=y.getMonth()+1,g=y.getFullYear(),x=new Date(g,D,f);if(m.getTime()<x.getTime())return $("#ptoDateShouldNotBeGreaterThanCurrDate").show(),!1;if(e)return!1;this.model=new sweepAddValidationModel({url:"json/"}),Backbone.Validation.bind(this);var k=this.$("form").serializeObject();if(this.model.set(k,{validate:!0})){this.model.clear(),Backbone.Validation.unbind(this);var c=new Array;c[0]=t,c[1]=$("#paymenttype").find(":selected").text(),c[2]=$("#sweeptype").find(":selected").text(),c[3]=$("#creditac").find(":selected").text(),c[4]=$("#paymentdate").val(),c[5]=$("#payamt").val(),c[6]=$("#upperlmt").val(),c[7]=$("#acremarks").val(),c[8]=$("#craccremarks").val(),c[9]=$("#lowerlmt").val(),c[10]=$("#lastpaymentdate").val(),els.set("sweepConfirm",c);var T=$("#paymentdate").val(),v=T.split("/"),u=v[0],h=v[1],w=v[2],b=w+"-"+h+"-"+u,b=u+"-"+h+"-"+w,d=els.get("payidx");if("4"==d){var A=c[10],N=A.split("/"),C=N[0],S=N[1],P=N[2],F=C+"-"+S+"-"+P,V=new Date(P,S,C),y=new Date,f=y.getDate(),D=y.getMonth()+1,g=y.getFullYear(),x=new Date(g,D,f);if(V.getTime()<x.getTime())return $("#ptlsDateShouldNotBeGreaterThanCurrDate").show(),!1;if(V.getTime()<m.getTime())return $("#lstoDateShouldNotBeGreaterThanCurrDate").show(),!1}var G=$("#paymenttype").find(":selected").val(),L=G.split("~"),B=(L[0],L[1]);els.set("ldate",F),els.set("fdate",b),els.set("swpId",B),els.set("frequency",p);var o=els.get("nmeidx");if("4"==o){var M=($("#creditac").find(":selected").text(),$("#creditac").find(":selected").val()),I=M.split("~"),K=I[1];els.set("debitaccId",K)}else if("3"==o){var O=$("#creditac").find(":selected").text(),E=$("#creditac").find(":selected").val(),_=E.split("~"),j=_[1];els.set("creditacccNum",O),els.set("creditaccId",j)}var W=this,Y=function(e){W.samplelist()},q=function(e){W.errorresponse()};W.collection=new sweepValidateCollections([],{});(new Date).getTime();showSpinner(),W.collection.fetch({data:$.param({access_token:els.get("access_token"),debitAcctNumber:t,creditAcctNumber:O,upperLimit:c[6],lowerLimit:c[9],sweepPaymentType:B,debitAcctId:K,creditAcctId:j,acctId:s,senderNarrative:c[8],amount:c[5],firstPaymentDate:b,lastPaymentDate:F,frequency:p,remarks:c[7],validtype:"Validation"}),dataType:"json",type:"POST",timeout:parseInt(els.get("calltimeout")),cache:!1,success:function(e){var t=(els.get("errordesc"),els.get("errorcode"));"0000"==ackStatus?Y(e):null!=t&&"MTC-RT-0003"!=t?Y(e):q(e)},error:q})}},samplelist:function(){Backbone.history.navigate("#/sweepsaddconfirm")},datefunc:function(e){$(".nativedatepicker").focus(function(e){e.preventDefault();var t,a=$(this);if(""!==a.val()){var r=a.val(),l=/(\d+)\/(\d+)\/(\d+)/.exec(r),i=new Date(+l[3],+l[2]-1,+l[1]);t=Date.parse(i)}else e.preventDefault(),t=new Date;"number"==typeof t&&(t=new Date(t)),window.plugins.datePicker.show({date:t,mode:"date",allowOldDates:!0},function(e){if(e){var t=new Date(e),r=t.getDate(),l=t.getMonth()+1,i=t.getFullYear(),n=""+(9>=r?"0"+r:r)+"/"+(9>=l?"0"+l:l)+"/"+i;a.val(n)}a.blur()})})},showDatePicker:function(){$(".nativedatepicker").focus(function(e){e.preventDefault(),$(this).blur();var t,a=$(this);if(""!==a.val()){var r=a.val(),l=/(\d+)-(\d+)-(\d+)/.exec(r),i=new Date(+l[3],+l[2]-1,+l[1]);t=Date.parse(i)}else e.preventDefault(),t=new Date;"number"==typeof t&&(t=new Date(t));try{var n=cordova.require("cordova/plugin/datepicker"),s={date:t,mode:"date",allowOldDates:!0};s.onChange=this.onDatePickerChange,s.visibility="visible",s.onDismiss=this.onDatePickerDismiss,n.show(s)}catch(c){}})},onDatePickerChange:function(e){var t=new Date(e),a=t.getDate(),r=t.getMonth()+1,l=t.getFullYear(),i=""+(9>=a?"0"+a:a)+"-"+(9>=r?"0"+r:r)+"-"+l;$(this).val(i),$(this).blur()},onDatePickerDismiss:function(e){var t=new Date(e),a=t.getDate(),r=t.getMonth()+1,l=t.getFullYear(),i=""+(9>=a?"0"+a:a)+"-"+(9>=r?"0"+r:r)+"-"+l;$(this).val(i),$(this).blur()},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(e){return Backbone.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return sadadLists});