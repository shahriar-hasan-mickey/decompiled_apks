define(["jquery","underscore","Backbone","collections/creditcard/creditCardusagecontrolCollections","models/validation/tedallal/tedallalValidationModel","text!views/creditcard/creditCardusagecontrolrequest.tpl"],function(e,a,t,r,o,i){var c=new EncryptedLocalStorage("secret"),n="",d=t.View.extend({el:"#mobcontent",events:{"change #localCheckLabel":"localCheckHandler","change #intCheckLabel":"intCheckHandler","change #ecommCheckLabel":"ecommCheckHandler","click #validatePoints":"validatePoints","change #serviceType":"convertedamount"},update:function(){c.set("managecreditcardsubmenu","");var a=this;timestamp=(new Date).getTime();var t=function(e){n=ccusagecontrolfetchDTO,c.set("ccusagecontrolfetchDTO",n),a.requestcompile()},o=function(e){a.errorresponse()};a.collection=new r([],{});c.get("custno");showSpinner(),timestamp=(new Date).getTime();a.collection.fetch({data:e.param({}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(c.get("calltimeout")),success:function(e){"0000"==ackStatus?t(e):o(e)},error:o})},localCheckHandler:function(a){var t=e(a.currentTarget).data("index");e('#localCheckLabel[data-index="'+t+'"]').find("input:checkbox:first").is(":checked")||e('#intCheckLabel[data-index="'+t+'"]').find("input:checkbox:first").is(":checked")||e('#ecommCheckLabel[data-index="'+t+'"]').find("input:checkbox:first").is(":checked")?(e('#showDateInputStart[data-index="'+t+'"]').show(),e('#showDateInputEnd[data-index="'+t+'"]').show(),e('#showDateInputs[data-index="'+t+'"]').show()):(e('#showDateInputStart[data-index="'+t+'"]').hide(),e('#showDateInputEnd[data-index="'+t+'"]').hide(),e('#showDateInputs[data-index="'+t+'"]').hide(),e("#errorFromDate"+t).hide(),e("#errorToDate"+t).hide(),e("#errorcheckLabel"+t).hide(),e("#errorFromDatePast"+t).hide(),e("#errorToDatePast"+t).hide(),e("#errorToDateGreater"+t).hide())},intCheckHandler:function(a){var t=e(a.currentTarget).data("index");e('#localCheckLabel[data-index="'+t+'"]').find("input:checkbox:first").is(":checked")||e('#intCheckLabel[data-index="'+t+'"]').find("input:checkbox:first").is(":checked")||e('#ecommCheckLabel[data-index="'+t+'"]').find("input:checkbox:first").is(":checked")?(e('#showDateInputStart[data-index="'+t+'"]').show(),e('#showDateInputEnd[data-index="'+t+'"]').show(),e('#showDateInputs[data-index="'+t+'"]').show()):(e('#showDateInputStart[data-index="'+t+'"]').hide(),e('#showDateInputEnd[data-index="'+t+'"]').hide(),e('#showDateInputs[data-index="'+t+'"]').hide(),e("#errorFromDate"+t).hide(),e("#errorToDate"+t).hide(),e("#errorcheckLabel"+t).hide(),e("#errorFromDatePast"+t).hide(),e("#errorToDatePast"+t).hide(),e("#errorToDateGreater"+t).hide())},ecommCheckHandler:function(a){var t=e(a.currentTarget).data("index");e('#localCheckLabel[data-index="'+t+'"]').find("input:checkbox:first").is(":checked")||e('#intCheckLabel[data-index="'+t+'"]').find("input:checkbox:first").is(":checked")||e('#ecommCheckLabel[data-index="'+t+'"]').find("input:checkbox:first").is(":checked")?(e('#showDateInputStart[data-index="'+t+'"]').show(),e('#showDateInputEnd[data-index="'+t+'"]').show(),e('#showDateInputs[data-index="'+t+'"]').show()):(e('#showDateInputStart[data-index="'+t+'"]').hide(),e('#showDateInputEnd[data-index="'+t+'"]').hide(),e('#showDateInputs[data-index="'+t+'"]').hide(),e("#errorFromDate"+t).hide(),e("#errorToDate"+t).hide(),e("#errorcheckLabel"+t).hide(),e("#errorFromDatePast"+t).hide(),e("#errorToDatePast"+t).hide(),e("#errorToDateGreater"+t).hide())},requestcompile:function(){hideSpinner(),this.$el.html(a.template(i,{})).i18n(),this.$el.trigger("create");var e=c.get("device.platform");return"Android"==e||"Ios"==e?this.datefunc():this.datefunc(),this},validatePoints:function(){var a=c.get("ccusagecontrolfetchDTO"),t=!1,r=this;e("#errorcheckLabelEnd").hide(),a.forEach(function(a,t){e("#errorFromDate"+t).hide(),e("#errorToDate"+t).hide(),e("#errorcheckLabel"+t).hide(),e("#errorFromDate").hide(),e("#errorToDate").hide(),e("#errorFromDatePast"+t).hide(),e("#errorToDatePast"+t).hide(),e("#errorToDateGreater"+t).hide()});var o=new Date,i=o.getDate()+1,d=o.getMonth(),l=o.getFullYear();10>i&&(i="0"+i),10>d&&(d="0"+d);var o=i+"/"+d+"/"+l,s=new Date(l,d,i),h=new Date,f=2,g=h.getDate()+parseInt(f),m=h.getMonth(),u=h.getFullYear();10>g&&(g="0"+g),10>m&&(m="0"+m);var p=new Date(u,m,g),D=!1;a.forEach(function(o,i){if("MSI-VP-1005"!=o.ctrlfetcherrorcode){var d=e('#localCheckLabel[data-index="'+i+'"]').find("input:checkbox:first").is(":checked"),l=e('#intCheckLabel[data-index="'+i+'"]').find("input:checkbox:first").is(":checked"),h=e('#ecommCheckLabel[data-index="'+i+'"]').find("input:checkbox:first").is(":checked"),f=e('#startDate[data-index="'+i+'"]').val();if(f){var g=f.split("/"),m=g[0],u=g[1],v=g[2];o.usagestartdate=v+u+m,isNaN(o.usagestartdate)&&(o.usagestartdate=n[i].usagestartdate);var k=new Date(v,parseInt(u)-1,m)}var w=e('#endDate[data-index="'+i+'"]').val();if(w){var x=w.split("/"),b=x[0],T=x[1],C=x[2];o.usageendate=C+T+b,isNaN(o.usageendate)&&(o.usageendate=n[i].usageendate);var I=new Date(C,parseInt(T)-1,b)}if(d&&l&&h?(o.posflag="1",o.atmflag="1",o.ecommflag="1",o.motoflag="1"):d&&l&&0==h?(o.posflag="1",o.atmflag="1",o.ecommflag="0",o.motoflag="0"):d||l||1!=h?d&&h&&0==l?(o.posflag="2",o.atmflag="2",o.ecommflag="1",o.motoflag="1"):h&&l&&0==d?(o.posflag="3",o.atmflag="3",o.ecommflag="1",o.motoflag="1"):d||h||1!=l?l&&h||1!=d?d||l||h||(o.posflag="0",o.atmflag="0",o.ecommflag="0",o.motoflag="0"):(o.posflag="2",o.atmflag="2",o.ecommflag="0",o.motoflag="0"):(o.posflag="3",o.atmflag="3",o.ecommflag="0",o.motoflag="0"):(o.posflag="0",o.atmflag="0",o.ecommflag="1",o.motoflag="1"),JSON.stringify(n[i])!=JSON.stringify(o))if(D=!0,d||l||h)""==f&&(t=!0,e("#errorFromDate"+i).show()),""==w&&(t=!0,e("#errorToDate"+i).show()),k.getTime()<s.getTime()&&""!=f&&(e("#errorFromDatePast"+i).show(),t=!0),k.getTime()==I.getTime()?(e("#errorToDateGreater"+i).show(),t=!0):I.getTime()<s.getTime()&&""!=w?(e("#errorToDatePast"+i).show(),t=!0):I.getTime()<p.getTime()&&""!=w?(e("#errorToDateGreater"+i).show(),t=!0):I.getTime()>s.getTime()&&I.getTime()<k.getTime()&&""!=w?(e("#errorToDateGreater"+i).show(),t=!0):I.getTime()>p.getTime()&&I.getTime()<k.getTime()&&""!=w&&(e("#errorToDateGreater"+i).show(),t=!0),0==t&&(o.fromdate=f,o.todate=w);else{var L=new Date,N=L.getDate(),S=L.getMonth()+1,P=L.getFullYear();10>N&&(N="0"+N),10>S&&(S="0"+S);var L=N+"/"+S+"/"+P;o.usagestartdate=P+""+S+N,o.usageendate=P+""+S+N,o.fromdate=L,o.todate=L}}a.length-1==i&&(0==D&&(t=!0,e("#errorcheckLabelEnd").show()),0==t&&1==D&&(c.set("ccusagecontrolfetchDTO",a),showSpinner(),r.verificationcompile()))})},verificationcompile:function(){hideSpinner();var a=c.get("ccusagecontrolfetchDTO"),r=[];a.forEach(function(o,i){if(JSON.stringify(n[i])!=JSON.stringify(o)){var d=e('#localCheckLabel[data-index="'+i+'"]').find("input:checkbox:first").is(":checked"),l=e('#intCheckLabel[data-index="'+i+'"]').find("input:checkbox:first").is(":checked"),s=e('#ecommCheckLabel[data-index="'+i+'"]').find("input:checkbox:first").is(":checked"),h={};h.CreditCardNumber=o.creditcardnumberenc,h.hidmaskcardnumber=o.ccmaskednumber,h.hidmaskctrlfetcherrorcode=o.ctrlfetcherrorcode,h.hidmaskusagestatus=o.ctrlfetcherrordesc,h.custartdate=o.fromdate,h.cuenddate=o.todate,h.posind=o.posflag,h.atmind=o.atmflag,h.ecomind=o.ecommflag,h.motoind=o.motoflag,d&&l&&s?(h.localflagval="Y",h.interflagval="Y",h.ecomflagval="Y"):d&&l&&0==s?(h.localflagval="Y",h.interflagval="Y",h.ecomflagval="N"):d&&s&&0==l?(h.localflagval="Y",h.interflagval="N",h.ecomflagval="Y"):s&&l&&0==d?(h.localflagval="N",h.interflagval="Y",h.ecomflagval="Y"):d||l||1!=s?d||s||1!=l?l&&s||1!=d?d||l||s||(h.localflagval="N",h.interflagval="N",h.ecomflagval="N"):(h.localflagval="Y",h.interflagval="N",h.ecomflagval="N"):(h.localflagval="N",h.interflagval="Y",h.ecomflagval="N"):(h.localflagval="N",h.interflagval="N",h.ecomflagval="Y");var f=getDeviceId(),g=o.creditcardnumberenc+""+f,m=CryptoJS.MD5(g);h.appCheckSum=m+"",r.push(h)}a.length-1==i&&(c.set("creditcardcontrols",r),t.history.navigate("#/creditCardusagecontrolconfirmrequest"))})},datefunc:function(a){e(".nativedatepicker").focus(function(a){a.preventDefault();var t,r=e(this);if(""!==r.val()){var o=r.val(),i=/(\d+)\/(\d+)\/(\d+)/.exec(o),c=new Date(+i[3],+i[2]-1,+i[1]);t=Date.parse(c)}else a.preventDefault(),t=new Date;"number"==typeof t&&(t=new Date(t)),window.plugins.datePicker.show({date:t,mode:"date",allowOldDates:!0},function(e){if(e){var a=new Date(e),t=a.getDate(),o=a.getMonth()+1,i=a.getFullYear(),c=""+(9>=t?"0"+t:t)+"/"+(9>=o?"0"+o:o)+"/"+i;r.val(c)}r.blur()})})},errorresponse:function(){hideSpinner(),t.history.navigate("#/exception")}});return d});