define(["jquery","underscore","Backbone","collections/creditcard/cashOnDemandCreditCardCollections","collections/creditcard/cashOnDemandacctSummaryCollections","collections/creditcard/cashOnDemondCreditCardValidationCollections","routers/creditcardrouter","routers/requestrouter","text!views/creditcard/cashOnDemandCreditCard.tpl","models/validation/creditCardLimitValidationModel","text!views/common/queuemode.tpl"],function(e,t,a,n,r,i,c,o,s,d,l){var u=new EncryptedLocalStorage("secret"),m=a.View.extend({el:"#container",e1:"#menuwrapper",e2:"#mobcontent",events:{"click #validateCardPin":"validateCardandPin","click #frmacno":"changeCasaAccount","click #currency":"openNumPad","blur  .currency":"convertedamount"},initialize:function(){new o},openNumPad:function(){id="currency";var t=/iPad|iPhone|iPod/.test(navigator.userAgent),a=u.get("isKeyPadNeed");t&&a&&navigator.notification.keypadOpen(e("#"+id).val(),9,function(t){e("#"+id).val(convertNumbers2English(t))},function(t){e("#"+id).val(convertNumbers2English(t))})},update:function(){u.set("currentPage","");var a=u.get("queueMode");if("P"==a){var r=this,i=function(e){r.accountsummarycompil()},c=function(e){r.errorresponse()};r.collection=new n([],{}),timestamp=(new Date).getTime();showSpinner(),r.collection.fetch({data:e.param({status:"ACTIVE",requestid:timestamp}),dataType:"json",type:"POST",timeout:parseInt(u.get("calltimeout")),cache:!1,success:function(e){var t=u.get("errorcode");"0000"==ackStatus?i(e):null!=t&&"MTC-RT-0003"!=t&&""!=t?i(e):c(e)},error:c})}else u.set("queueModeModule","cashOnDemandCreditCard"),this.$("#mobcontent").html(t.template(l)).i18n()},changeCasaAccountOnLoad:function(){e("#errorAccTo").hide(),e("#validateCardPin").removeAttr("disabled");var t=e("input[name=frmacno]:checked").val(),a=t.split("~"),n=a[3],r=a[8];u.set("cardtyyppe",r);var i=a[6];u.set("islamicflag",i),u.set("cash_on_demand_t24_link_acct","");var c=u.get("cashOnDemCasa"),o="";e.each(c,function(e,t){var a=t.accountNumber;n==a&&(o=a)}),e("#toacc").show(),e("#CasaAcctLabelList").show(),""!=o?(e("#CasaAcctLabelList").html("<span>"+o+"</span>"),u.set("cash_on_demand_t24_link_acct",o),e("#validateCardPin").removeAttr("disabled")):(u.set("cash_on_demand_t24_link_acct",""),e("#validateCardPin").attr("disabled","disabled")),e("#toacc").attr("checked","checked"),e(".dropselect").dropselect()},changeCasaAccount:function(){e("#errorAccTo").hide(),e("#validateCardPin").removeAttr("disabled");var t=e("input[name=frmacno]:checked").val(),a=t.split("~"),n=a[3],r=u.get("cashOnDemCasa"),i="";e.each(r,function(e,t){var a=t.accountNumber;n==a&&(i=a)}),e("#toacc").show(),e("#CasaAcctLabelList").show(),""!=i?(e("#CasaAcctLabelList").html("<span>"+i+"</span>"),u.set("cash_on_demand_t24_link_acct",i),e("#validateCardPin").removeAttr("disabled")):(u.set("cash_on_demand_t24_link_acct",""),e("#validateCardPin").attr("disabled","disabled"))},accountsummarycompil:function(){var t=this,a=function(e){t.listcompile()},n=function(e){t.errorresponse()};t.collection=new r([],{}),timestamp=(new Date).getTime(),showSpinner(),t.collection.fetch({data:e.param({status:"ACTIVE",requestid:timestamp}),dataType:"json",type:"POST",timeout:parseInt(u.get("calltimeout")),cache:!1,success:function(e){var t=u.get("errorcode");"0000"==ackStatus?a(e):null!=t&&"MTC-RT-0003"!=t?a(e):n(e)},error:n})},listcompile:function(){hideSpinner(),this.$("#mobcontent").html(t.template(s)),e(".amtformatter").formatamount();u.get("CardListLen");this.changeCasaAccountOnLoad();var a=u.get("device.platform");return"Android"==a?this.datefunc():this.datefunc(),this},convertedamount:function(){e("#errorFromAct").hide(),e("#errorToAct").hide(),e("#payAmount").hide(),e("#displayamt").html("");var t=e("input[name=frmacno]:checked").val(),a=e("input[name=toacc]:checked").val(),n="false",r="false";if("undefined"==typeof t&&(n="true",e("#errorFromAct").show()),"undefined"==typeof a&&(r="true",e("#errorToAct").show()),"true"==n||"true"==r)return!1;var i=t.split("~"),c=i[1],o=i[2],s=a.split("~"),d=s[1],l=s[2],u=(e("#conamt").val(),e("#currency").val());if(n="false",r="false",""==c&&(n="true",e("#errorFromAct").show()),""==d&&(r="true",e("#errorToAct").show()),"true"==n||"true"==r)return!1;var m=(e("#displayamt").val(),0);u!=m&&(u=checkAmount(e.formatNumber(u,{format:"#,###.000",locale:"us"})),e("#displayamt").html("<span>"+o+"</span>"+u)),document.getElementById("hiddenfrmcurid").value=o,document.getElementById("hiddentocurid").value=l},errorresponse:function(){hideSpinner(),a.history.navigate("#/exception")},validateCardandPin:function(){e("#errorFromAct").hide(),e("#errorToAct").hide(),e("#payAmount").hide(),e("#errorAmount").hide(),e("#errremarks").hide(),u.set("CashDemandfrmActNo",""),u.set("CashDemandtoActNo",""),this.model=new d({url:"json/"}),this.$(".alert").hide(),a.Validation.bind(this);var t=this.$("form").serializeObject();if(this.model.set(t,{validate:!0})){this.model.clear(),a.Validation.unbind(this);var n=u.get("custno"),r=e("input[name=frmacno]:checked").val(),c="false",o="false",s="0.00";if("undefined"==typeof r&&(c="true",e("#errorFromAct").show()),"true"==c||"true"==o)return!1;var l=r.split("~"),m=l[0],h=l[1],f=l[4],p=l[7],v=u.get("cash_on_demand_t24_link_acct"),g=v,C=v,s="0.00",w=e("#currency").val();if("0"==w)return e("#errorAmount").show(),!1;for(var D=e("#remarks").val(),y=e("#remarks").val(),A="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890 ",k=/[\u0600-\u06FF]/,b="false",_=0;_<y.length;_++){var P=y[_];-1!=A.indexOf(P)||k.test(P)||(b="true")}if("true"==b)return e("#errremarks").show(),!1;var T=e("#payDate").val(),O=e("#currency").val();if(("undefined"==O||""==O)&&(O="0.00"),("undefined"==r||""==r)&&(r="0.00"),parseFloat(w)>parseFloat(f))return c="true",e("#payAmount").show(),!1;u.set("amount",w),u.set("conamt",O),u.set("cashremarks",D),u.set("CashDemandfrmActNo",m),u.set("credithidAccountNo",p),u.set("CashDemandtoActNo",g),u.set("frmaccmaskno",h),u.set("toaccmaskno",C),u.set("CashDemandDate",T);var S=u.get("isStaff"),N=u.get("segment"),L=l[8],V=l[6],E=this,F=function(e){E.cashOnDemandCreditCardSubmit()},q=function(e){E.errorresponse()};E.collection=new i([],{});var x=(new Date).getTime(),M="CashOnDemand",I=n,j="KWD",$="KWD",B="19";showSpinner(),E.collection.fetch({data:e.param({otpModule:"cash_on_demand",hidtranstype:M,customerno:I,hidcardno:m,hidtoacctno:g,hidtrandate:T,valuedate:T,hidamt:w,hidtransdetails:D,baseequivalent:w,transfee:s,hidexchangerate:O,fromcurr:j,tocurr:$,limitservicetype:B,creditcardaccountno:p,cctype:L,segment:N,staffflag:S,islamicflag:V,timestamp:x}),dataType:"json",type:"POST",timeout:parseInt(u.get("calltimeout")),cache:!1,success:function(e){var t=u.get("errorcode");"0000"==ackStatus?F(e):null!=t&&"MTC-RT-0003"!=t?F(e):q(e)},error:q}),this.undelegateEvents()}else this.$(".alert-error").fadeIn(),hideSpinner()},cashOnDemandCreditCardSubmit:function(e,t,n,r){u.get("amount"),u.get("conamt"),u.get("cashremarks"),u.get("CashDemandfrmActNo"),u.get("CashDemandtoActNo"),u.get("frmaccmaskno"),u.get("toaccmaskno"),u.get("CashDemandDate");showSpinner(),a.history.navigate("#/cashOnDemandCreditCardConfirm")},datefunc:function(t){e(".nativedatepicker").focus(function(t){t.preventDefault();var a,n=e(this);if(""!==n.val()){var r=n.val(),i=/(\d+)\/(\d+)\/(\d+)/.exec(r),c=new Date(+i[3],+i[2]-1,+i[1]);a=Date.parse(c)}else t.preventDefault(),a=new Date;"number"==typeof a&&(a=new Date(a)),window.plugins.datePicker.show({date:a,mode:"date",allowOldDates:!0},function(e){if(e){var t=new Date(e),a=t.getDate(),r=t.getMonth()+1,i=t.getFullYear(),c=""+(9>=a?"0"+a:a)+"/"+(9>=r?"0"+r:r)+"/"+i;n.val(c)}n.blur()}),this.undelegateEvents()})},showDatePicker:function(){e(".nativedatepicker").focus(function(t){t.preventDefault(),e(this).blur();var a,n=e(this);if(""!==n.val()){var r=n.val(),i=/(\d+)-(\d+)-(\d+)/.exec(r),c=new Date(+i[3],+i[2]-1,+i[1]);a=Date.parse(c)}else t.preventDefault(),a=new Date;"number"==typeof a&&(a=new Date(a));try{var o=cordova.require("cordova/plugin/datepicker"),s={date:a,mode:"date",allowOldDates:!0};s.onChange=this.onDatePickerChange,s.visibility="visible",s.onDismiss=this.onDatePickerDismiss,o.show(s)}catch(d){}})},errorresponse:function(){hideSpinner(),a.history.navigate("#/exception")},disposeView:function(e){return a.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return m});