define(["jquery","underscore","Backbone","backbonevalidation","collections/creditcard/tempcreditcardlimitSummaryCollections","collections/creditcard/temporaryLimitCtrlCollections","routers/creditcardrouter","routers/requestrouter","text!views/creditcard/temporarylimitcontrolrequest.tpl","collections/creditcard/temporaryLimitCtrlValidationCollections","views/creditcard/temporarylimitcontrolconfirmrequest","models/validation/creditCardLimitValidationModel"],function($,_,Backbone,backbonevalidation,tempcreditcardlimitSummaryCollections,temporaryLimitCtrlCollections,creditCardRouter,requestRouter,temporarylimitcontrolrequestTemplate,temporaryLimitCtrlValidationCollections,temporarylimitcontrolconfirmrequest,creditCardLimitValidationModel){var els=new EncryptedLocalStorage("secret"),creditCardLimitList=Backbone.View.extend({el:"#container",e1:"#menuwrapper",e2:"#mobcontent",events:{"click #validateCardPin":"validateCardandPin","change #frmacno":"currentLimit","blur  .newlimit":"limitCheck","click #newlimit":"openNumPad"},initialize:function(){new requestRouter},openNumPad:function(){var e=this;id="newlimit";var t=/iPad|iPhone|iPod/.test(navigator.userAgent),i=els.get("isKeyPadNeed");t&&i&&navigator.notification.keypadOpen($("#"+id).val(),9,function(e){$("#"+id).val(convertNumbers2English(e))},function(t){$("#"+id).val(convertNumbers2English(t)),e.limitCheck()})},update:function(){els.set("currentPage","");var e=this,t=function(t){e.ccvalidateperiod()},i=function(t){e.listcompile()},r=function(t){e.errorresponse()};e.collection=new tempcreditcardlimitSummaryCollections([],{}),showSpinner(),e.collection.fetch({data:$.param({status:"ACTIVE",cardType:"BOTH"}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(e){var a=els.get("errorcode");"0000"==ackStatus&&"0000"==a?mycreditcards.length>0?t(e):i(e):r(e)},error:r})},listcompile:function(){hideSpinner(),this.$("#mobcontent").html(_.template(temporarylimitcontrolrequestTemplate)).i18n(),$(".amtformatter").formatamount()},ccvalidateperiod:function(){els.set("currentPage","");var e=this,t=function(t){e.cclimitvalidate()},i=function(t){e.errorresponse()};e.collection=new temporaryLimitCtrlCollections([],{});var r=$("input[name=frmacno]:checked").val();if(void 0!=r){var a=r.split("~"),c=a[0],n=a[4],l=a[5];els.set("frmacntval",r),els.set("creditCardActNo",n),els.set("expirydate",l)}else{var c=els.get("acctno");els.set("frmacntval",c);var n=els.get("cccardacctno");els.set("creditCardActNo",n);var l=els.get("expirydate");els.set("expirydate",l)}var o=els.get("cccardacctno"),s=$("#acccardmaskno").val();els.set("acccardmaskno",s),"undefined"==typeof r&&(r=o);var m=(new Date).getTime();e.collection.fetch({data:$.param({requestid:m}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(e){els.get("errorcode");"0000"==ackStatus?t(e):i(e)},error:i})},cclimitvalidate:function(){els.set("currentPage","");var e=this,t=function(t){e.listcompile()},i=function(t){e.errorresponse()};e.collection=new temporaryLimitCtrlValidationCollections([],{});var r,a,c=$("input[name=frmacno]:checked").val();if(void 0!=c){var n=c.split("~");a=n[0];var l=n[2];els.set("ecurrencylimit",l),r=n[4];var o=n[5];els.set("frmacntval",a),els.set("creditCardActNo",r),els.set("expirydate",o),els.set("selectedAcct",r)}else{a=els.get("acctno"),els.set("frmacntval",a),r=els.get("cccardacctno"),els.set("creditCardActNo",r);var o=els.get("expirydate");els.set("expirydate",o),els.set("selectedAcct",r)}var s=(new Date).getTime();e.collection.fetch({data:$.param({creditcardnumber:r,requestid:s}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(e){var r=els.get("errorcode");"0000"==ackStatus?"0000"==r?(els.set("validcard",!0),t(e)):null!=r&&"MTC-RT-0003"!=r?(els.set("validcard",!1),t(e)):(els.set("validcard",!1),t(e)):null!=r&&"MTC-RT-0003"==r?i(e):(els.set("validcard",!1),t(e))},error:i})},limitCheck:function(){var e=$("#newlimit").val(),t=0;e!=t&&$("#newlimit").val(Number(e).toFixed(2))},validateCardandPin:function(){$("#errorFromAct").hide(),$("#errorLimitIncrease").hide(),$("#errorLimitminIncrease").hide(),$("#errorLimitcurIncrease").hide(),$("#errorLimit").hide(),$("#limitRequired").hide(),$("#newLimitDiv").removeClass("has-error"),$("#errincreaseLimit").hide();var currtlimit=$("#currentlimit").val(),maxvalidatlimit=els.get("ccmaxlimit"),curtempmonth=els.get("cc_temexpmonth");els.set("curtempmonth",curtempmonth);var frmcurval=$("input[name=frmacno]:checked").val(),frm_chk="false",amtval=$("#newlimit").val();if("undefined"==typeof frmcurval&&(frm_chk="true",$("#errorFromAct").show()),(""==amtval||0>=amtval||null==amtval)&&($("#limitRequired").show(),$("#errorLimitcurIncrease").hide(),$("#errorLimitminIncrease").hide(),$("#errorLimitIncrease").hide(),$("#newLimitDiv").addClass("has-error"),frm_chk="true"),eval(amtval)<eval(currtlimit))return $("#errorLimitcurIncrease").hide(),$("#errorLimitminIncrease").show(),$("#errorLimitIncrease").hide(),!1;if(eval(amtval)==eval(currtlimit))return $("#errorLimitcurIncrease").show(),$("#errorLimitminIncrease").hide(),$("#errorLimitIncrease").hide(),!1;if(eval(amtval)>eval(maxvalidatlimit))return $("#errorLimitIncrease").show(),$("#errorLimitcurIncrease").hide(),$("#errorLimitminIncrease").hide(),!1;var updcurrlmt,currtlimit=$("#curtlimitamt").text(),firstlimitval=$("#currentlimit").val();if(updcurrlmt=""!=firstlimitval&&"undefined"!=firstlimitval&&null!=firstlimitval?firstlimitval.replace("KWD",""):currtlimit.replace("KWD",""),"true"==frm_chk)return!1;this.model=new creditCardLimitValidationModel({url:"json/"}),this.$(".alert").hide(),$(".error-message").show(),Backbone.Validation.bind(this);var data=this.$("form").serializeObject();this.model.set(data,{validate:!0})?(this.model.clear(),Backbone.Validation.unbind(this),showSpinner(),this.showOTP()):this.$(".alert-error").fadeIn()},currentLimit:function(){showSpinner();var e=this;e.ccvalidateperiod()},showOTP:function(){var e=$("input[name=frmacno]:checked").val();if($("#errorFromAct").hide(),$("#limitRequired").hide(),$("#newLimitDiv").removeClass("has-error"),"undefined"==typeof e)return $("#errorFromAct").show(),!1;var t=e.split("~"),i=t[0];els.set("ccselectlim",i);var r=t[2],a=$("#increaseLimit option:selected").text(),c=$("#currentlimit").val(),n=$("#newlimit").val(),l=$("#reason").val();("undefined"==c||""==c)&&(c="0.00"),("undefined"==a||""==a)&&(a="0.00"),("undefined"==n||""==n)&&(n="0.00"),("undefined"==e||""==e)&&(c="0.00"),els.set("selectlim",i),els.set("inclimit",a),els.set("limit",c),els.set("newlimit",n),els.set("reason",l),els.set("ccode",r),hideSpinner(),this.subview=this.disposeView(new temporarylimitcontrolconfirmrequest),this.subview.$el.trigger("create"),this.subview.update(),this.undelegateEvents()},errorresponse:function(){hideSpinner(),Backbone.history.navigate("#/exception")},disposeView:function(e){return Backbone.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return creditCardLimitList});