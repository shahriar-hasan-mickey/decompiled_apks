define(["jquery","underscore","Backbone","backbonevalidation","collections/creditcard/creditCardSummaryCollections","collections/creditcard/ccPaymentCardSummaryCollections","collections/creditcard/creditCardPaymentCardValidationCollections","collections/wealth/ccStatementCollections","collections/transfer/ownAccountTransferCollections","collections/common/otpGenerateCollections","collections/transfer/TransactionLimitCollections","routers/creditcardrouter","routers/requestrouter","text!views/creditcard/creditCardPayments.tpl","models/validation/creditCardLimitValidationModel"],function($,_,Backbone,backbonevalidation,creditCardSummaryCollections,ccPaymentCardSummaryCollections,creditCardPaymentCardValidationCollections,ccStatementCollections,ownAccountTransferCollections,otpGenerateCollections,TransactionLimitCollections,creditCardRouter,requestRouter,creditCardPaymentsTemplate,creditCardLimitValidationModel){var els=new EncryptedLocalStorage("secret"),creditCardPaymentsList=Backbone.View.extend({el:"#container",e1:"#menuwrapper",e2:"#mobcontent",events:{"click #validateCardPin":"validateCardandPin","change #option3":"OtherCreditCard","change #option1":"OwnCreditCard","click #transAmt":"openNumPad","change #toacc":"minDueAmt","click #othertoacc":"changeOtherToAcc"},initialize:function(){new requestRouter},openNumPad:function(){var e=this;id="transAmt";var t=/iPad|iPhone|iPod/.test(navigator.userAgent),a=els.get("isKeyPadNeed");t&&a&&navigator.notification.keypadOpen($("#"+id).val(),9,function(e){$("#"+id).val(convertNumbers2English(e))},function(t){$("#"+id).val(convertNumbers2English(t)),e.convertedamount()})},update:function(){els.set("currentPage",""),els.set("mindueamt",""),els.set("outstandingamt",""),els.set("defaultSelectionListDetails",""),els.set("transRefNo","");var e=this;showSpinner(),e.ownActCard()},changeOtherToAcc:function(){var e=$("#othertoacc").val(),t=e.split("~"),a=t[4],r=t[5];$("#nme"+r).text(a)},OtherCreditCard:function(){$("#errorAvailBal").hide(),$("#myCards").hide(),$("#errorAvaillmt").hide(),$("#errorccAct").hide(),$("#errorToAct16").show(),$("#benedue").hide(),$("#mindueamt12").hide(),$("#errorDaillmt").hide(),$("#errorToAct").hide(),$("#errorFromAct").hide(),$("#otherCards").show(),$("#errorAmount").hide(),$("#errorAmount1").hide(),$("#payRemarks").val(""),$("#transAmt").val(""),$("#errorAmount1").hide(),$(".error-message").hide(),$(".form-group").removeClass("has-error"),$("#convDivId").hide(),els.set("outstandingamt","OTH"),$("#info").hide()},Translimitcheck:function(){var e=$("input[name=frmacc]:checked").val(),t=$("input[name=toacc]:checked").val();if(null===e||""===e||void 0===e)return!1;if(null===t||""===t||void 0===t)return!1;var a=e.split("~"),r=a[2],o=t.split("~"),n=(o[0],o[2]),c=this,i=function(e){c.limitDataInfo()},s=function(e){c.errorresponse()};c.collection=new TransactionLimitCollections([],{});(new Date).getTime();showSpinner(),c.collection.fetch({data:$.param({access_token:els.get("access_token"),toacctid:n,acctid:r,payeeType:"C",toCurrencyCode:"KWD"}),dataType:"json",type:"POST",timeout:parseInt(els.get("calltimeout")),cache:!1,success:function(e){"0000"==ackStatus?(hideSpinner(),i(e)):s(e)},error:s})},limitDataInfo:function(){var e=els.get("minAmountPerTransaction"),t=els.get("maxAmountPerTransaction"),a=els.get("dailyAvailableLimit"),r=els.get("dailyAvailableCount");$("#infoCont").show(),$("#minamt").html("KWD "+checkAmount($.formatNumber(e,{format:"#,###.000",locale:"us"}))),$("#maxamt").html("KWD "+checkAmount($.formatNumber(t,{format:"#,###.000",locale:"us"}))),$("#dailylimit").html("KWD "+checkAmount($.formatNumber(a,{format:"#,###.000",locale:"us"}))),$("#dailycount").html(r)},OwnCreditCard:function(){$(".error-message").hide(),$("#errorAvaillmt").hide(),$("#errorDaillmt").hide(),$(".form-group").removeClass("has-error"),$("#errorAvailBal").hide(),$("#otherCards").hide(),$("#errorccAct").show(),$("#errorToAct16").hide(),$("#mindueamt12").show(),$("#myCards").show(),$("#errorToAct").hide(),$("#errorFromAct").hide(),$("#errorAmount").hide(),$("#errorAmount1").hide(),$("#payRemarks").val(""),$("#transAmt").val(""),$("#convDivId").hide(),els.set("outstandingamt",""),$("#info").show();var e=els.get("cuurrcode"),t=els.get("outStandingAmount"),a=(els.get("minimumAmountDue"),$("input[name=toacc]:checked").val());a&&($("#benedue").show(),$("#mindueamt12").html("<span>"+t+" "+e+"</span>"))},minDueAmt:function(){var e=this,t=function(t){e.dueamountshow()},a=function(t){e.errorresponse()};e.collection=new ccStatementCollections([],{}),timestamp=(new Date).getTime();var r,o,n,c,i,s,l,d=$("input[name=toacc]:checked").val();if(""!=d&&"null"!=d&&null!=d&&"undefined"!=d&&void 0!=d){r=d.split("~"),o=r[0],n=r[3],c=r[4],i=r[7],s=r[6],s=r[6],l=r[2],showSpinner(),e.collection.fetch({data:$.param({access_token:els.get("access_token"),appchecksum:"",accountNumber:o,acctCategory:"CREDITCARD",acctid:l,requestid:timestamp}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(e){"0000"==ackStatus?(hideSpinner(),t(e)):a(e)},error:a})}},dueamountshow:function(){var e=els.get("cuurrcode"),t=els.get("outStandingAmount");els.get("minimumAmountDue");$("#benedue").show(),$("#mindueamt12").html("<span>"+t+" "+e+"</span>")},ownActCard:function(){var e=this,t=function(t){e.cardSummary()},a=function(t){e.errorresponse()};e.collection=new ownAccountTransferCollections([],{});(new Date).getTime();showSpinner(),e.collection.fetch({data:$.param({access_token:els.get("access_token"),benetype:"TENANT"}),dataType:"json",type:"POST",timeout:parseInt(els.get("calltimeout")),cache:!1,success:function(e){"0000"==ackStatus?t(e):a(e)},error:a})},cardSummary:function(){var e=this,t=function(t){e.listcompile()},a=function(t){e.errorresponse()};e.collection=new creditCardSummaryCollections([],{});(new Date).getTime();showSpinner(),e.collection.fetch({data:$.param({access_token:els.get("access_token")}),dataType:"json",type:"POST",timeout:parseInt(els.get("calltimeout")),cache:!1,success:function(e){var r=(els.get("errordesc"),els.get("errorcode"));"0000"==ackStatus?t(e):null!=r&&"MTC-RT-0003"!=r?t(e):a(e)},error:a})},listcompile:function(){hideSpinner();var e=els.get("transferBene");this.$("#mobcontent").html(_.template(creditCardPaymentsTemplate)),"true"==e?($("#otherCards").show(),$("#myCards").hide(),this.OtherCreditCard()):this.OwnCreditCard(),this.minDueAmt(),els.set("transferBene","false"),$(".amtformatter").formatamount();var t=els.get("device.platform");"Android"==t?this.datefunc():this.datefunc();var a=$("input[name=frmacc]:checked").val(),r=$("input[name=toacc]:checked").val();$("#myCards").is(":visible"),$("#otherCards").is(":visible");return null==a&&""==a&&void 0==a||null==r&&""==r&&void 0==r||this.Translimitcheck(),this},convertedamount:function(){$("#errorFromAct").hide(),$("#errorToAct").hide(),$("#displayamt").html(""),$("#errorAmount1").hide(),$("#errorAmount").hide(),$("#convDivId").hide(),$("#errorAvaillmt").hide(),$("#errorDaillmt").hide();var e=$("input[name=frmacc]:checked").val(),t=$("#myCards").is(":visible"),a=$("#otherCards").is(":visible"),r=void 0;1==t?r=$("input[name=toacc]:checked").val():1==a&&(r=$("#othertoacc").val(),els.set("toacc",r));var o="false",n="false";if("undefined"==typeof e&&(o="true",$("#errorFromAct").show()),("undefined"==typeof r||void 0==r)&&(n="true",$("#errorToAct").show()),"true"==o||"true"==n)return!1;var c=e.split("~"),i=c[1],s=c[1],l=(c[2],r.split("~")),d=l[1],m=(l[5],$("#transAmt").val()),u=parseFloat(m);m=-1==m.indexOf(".")?Number(m).toFixed(2):m,els.set("convamtwithoutcomma",m),o="false",n="false";var h=!1;if((isNaN(u)||"0.00"==u)&&(h=!0),1==h)return $("#transAmt").val(""),!1;if($("#transAmt").val(Number(u).toFixed(2)),""==i&&(o="true",$("#errorFromAct").show()),""==d&&(n="true",$("#errorToAct").show()),"true"==o||"true"==n)return!1;var v=0;if(m!=v){var p=checkAmount($.formatNumber(m,{format:"#,###.000",locale:"us"}));$("#displayamt").html("<span class='cur'>"+s+"</span>&nbsp;"+p)}document.getElementById("hiddenfrmcurid").value=i,document.getElementById("hiddentocurid").value=d,document.getElementById("convDivId").style.display="block"},errorresponse:function(){hideSpinner(),Backbone.history.navigate("#/exception")},validateCardandPin:function(event){$("#errorFromAct").hide(),$("#errorToAct").hide(),$("#errorAmount").hide(),$("#errorAmount1").hide(),$("#errorAvailBal").hide(),$(".error-message").show(),$("#errorAvaillmt").hide(),$("#errorDaillmt").hide(),$("#errremarks").hide(),$("#errorToAct16").hide(),$("#errorAmount").hide(),$("#errorAmount").hide(),$("#errorccAct").hide(),$("#limitminamt").hide(),$("#limitmaxamt").hide(),$("#limitdailyamt").hide(),$("#amountvalidation").hide();var amountverify=$("#transAmt").val(),remarks=$("#payRemarks").val(),myCards=$("#myCards").is(":visible"),otherCardsVisible=$("#otherCards").is(":visible"),minAmountPerTransaction=els.get("minAmountPerTransaction"),maxAmountPerTransaction=els.get("maxAmountPerTransaction"),dailyAvailableLimit=els.get("dailyAvailableLimit");if(eval(amountverify)<1)return $("#amountvalidation").show(),!1;var frm=$("input[name=frmacc]:checked").val(),to=void 0;if(1==myCards){to=$("input[name=toacc]:checked").val();var crdtype="Own Credit Card";if(""==to||void 0==to||""==to)return $("#errorccAct").show(),!1}else if(1==otherCardsVisible){acctno=$("#othertoacc").val();var crdtype="Other Credit Card";if(""==acctno||void 0==acctno)return $("#errorToAct16").show(),!1;els.set("acctno",acctno)}this.model=new creditCardLimitValidationModel({url:"json/"}),Backbone.Validation.bind(this);var data=this.$("form").serializeObject();if(this.model.set(data,{validate:!0})){this.model.clear(),Backbone.Validation.unbind(this),event.preventDefault();var frm_chk="false",to_chk="false",amountt="false",remarkss="false",amount=$("#transAmt").val();amount=-1==amount.indexOf(".")?Number(amount).toFixed(2):amount;var remarks=$("#payRemarks").val(),conv=amount,exrate=$("#exchangerate").text();els.set("ccpayremarks",remarks);var myCards=$("#myCards").is(":visible"),otherCardsVisible=$("#otherCards").is(":visible"),frm=$("input[name=frmacc]:checked").val(),to=void 0;if(1==myCards){to=$("input[name=toacc]:checked").val();var crdtype="Own Credit Card"}else if(1==otherCardsVisible){acctno=$("#othertoacc").val();var crdtype="Other Credit Card";if(""==acctno||void 0==acctno)return $("#errorToAct16").show(),!1;els.set("acctno",acctno)}if("undefined"==typeof frm&&(frm_chk="true",$("#errorFromAct").show()),(null==amountverify||""==amountverify)&&(amountt="true",$("#errorAmount").show()),(null==remarks||""==remarks)&&(remarkss="true",$("#errremarks").show()),els.set("crdtype",crdtype),"true"==frm_chk||"true"==to_chk)return!1;var frmaccarr=frm.split("~"),frmaccno=frmaccarr[0],frmaccmaskno=frmaccarr[1],frmAcctId=frmaccarr[2];els.set("frmAcctId",frmAcctId);var availableBalance=frmaccarr[3],patypecode,to,to_chk,toaccarr,acctno,toAcctId,toaccmaskno,shrtname,cartpe;if(1==myCards){if(patypecode="OUTSTANDING",cartpe="",to=void 0,to=$("input[name=toacc]:checked").val(),to_chk="false",("undefined"==typeof to||void 0==to)&&(to_chk="true",$("#errorToAct").show()),"true"==to_chk)return!1;toaccarr=to.split("~"),acctno=toaccarr[2],toAcctId=toaccarr[2],els.set("acctno",acctno),els.set("toAcctId",toAcctId),toaccno=toaccarr[0],toaccmaskno=toaccarr[1],shrtname=frmaccarr[4],els.set("Setshrtname",shrtname),els.set("frmaccpaymaskno",frmaccmaskno),els.set("toaccpaymaskno",toaccmaskno),els.set("patypecode",patypecode),els.set("cartpe",cartpe)}else if(1==otherCardsVisible){if(patypecode="OTHER",cartpe="O",toaccnounm=$("#othertoacc").val(),""==toaccnounm||void 0==toaccnounm)return $("#errorToAct16").show(),!1;var time=(new Date).getTime(),toaccnopar=EncryptWithDynamicSalt(toaccnounm,time);els.set("time",time),els.set("toaccnopar",toaccnopar);var first4=toaccnounm.substring(0,4),last4=toaccnounm.substring(12,16);mask=toaccnounm.substring(4,12).replace(/\d/g,"X"),toaccno=first4+""+mask+last4,els.set("patypecode",patypecode),els.set("cartpe",cartpe)}if("0.00"==amount||"0.0"==amount||"0"==amount)return $("#errorAmount").show(),!1;var dailylmt=els.get("dailylmtccp"),availlmt=els.get("availlmtccp");if(parseFloat(amount)>parseFloat(availlmt))return $("#errorAvaillmt").show(),!1;if(parseFloat(amount)>parseFloat(dailylmt))return $("#errorDaillmt").show(),!1;for(var paymentRemarksval=$("#payRemarks").val(),allowedTest="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890 ",allowedaraTest=/[\u0600-\u06FF]/,flag_emojo="false",i=0;i<paymentRemarksval.length;i++){var atchar=paymentRemarksval[i];-1!=allowedTest.indexOf(atchar)||allowedaraTest.test(atchar)||(flag_emojo="true")}if("true"==flag_emojo)return $("#errremarks").show(),!1;if(""==paymentRemarksval||void 0==paymentRemarksval)return $("#errremarks").show(),!1;("undefined"==conv||""==conv)&&(conv="0.00"),("undefined"==frm||""==frm)&&(frm="0.00"),("undefined"==to||""==to)&&(to="0.00"),("undefined"==remarks||""==remarks)&&(remarks="0.00"),("undefined"==amount||""==remarks)&&(amount="0.00");var paiddate="",exchangrate="1.00";els.set("paiddate",paiddate);var acctno=els.get("acctno"),that=this,onDataHandler=function(e){that.creditCardPaymentsconfirm(frmaccno,toaccno,amount,conv,exrate)},onErrorHandler=function(e){that.errorresponse()};that.collection=new creditCardPaymentCardValidationCollections([],{});var timestamp=(new Date).getTime(),hidtranstype="creditcard",productName=els.get("productName"),fromcurr="KWD",tocurr="KWD",CIF="PAYNOW",limitservicetype="19",contraacctno=acctno,hidtrandate=paiddate,hidtrantime="",valuedate="",hidconvertedamount=els.get("convamtwithoutcomma"),hidtransdetails="creditcardpayments",CCPayAmount=els.get("CashPayAmount"),transfee="0.00",creditcurrency="KWD",debitcurrency="KWD";els.set("convamtwithoutcomma",amount),els.set("toaccno",toaccno),els.set("paymentRemarksval",paymentRemarksval),showSpinner(),that.collection.fetch({data:$.param({otpModule:"card_payment",toCreditCardNumber:toaccnopar,creditCardType:cartpe,fromaccountId:frmAcctId,toaccountId:toAcctId,remarks:paymentRemarksval,transtype:CIF,paymentType:patypecode,validtype:"Validation",paydate:valuedate,salt:time,access_token:els.get("access_token"),transamount:amount,transcurrency:debitcurrency}),dataType:"json",type:"POST",timeout:parseInt(els.get("calltimeout")),cache:!1,success:function(e){els.get("errorcode");"0000"==ackStatus?onDataHandler(e):onErrorHandler(e)},error:onErrorHandler}),this.undelegateEvents()}else this.$(".alert-error").fadeIn(),event.preventDefault(),hideSpinner()},datefunc:function(e){$(".nativedatepicker").focus(function(e){e.preventDefault();var t,a=$(this);if(""!==a.val()){var r=a.val(),o=/(\d+)\/(\d+)\/(\d+)/.exec(r),n=new Date(+o[3],+o[2]-1,+o[1]);t=Date.parse(n)}else e.preventDefault(),t=new Date;"number"==typeof t&&(t=new Date(t)),window.plugins.datePicker.show({date:t,mode:"date",allowOldDates:!0},function(e){if(e){var t=new Date(e),r=t.getDate(),o=t.getMonth()+1,n=t.getFullYear(),c=""+(9>=r?"0"+r:r)+"/"+(9>=o?"0"+o:o)+"/"+n;a.val(c)}a.blur()}),this.undelegateEvents()})},showDatePicker:function(){$(".nativedatepicker").focus(function(e){e.preventDefault(),$(this).blur();var t,a=$(this);if(""!==a.val()){var r=a.val(),o=/(\d+)-(\d+)-(\d+)/.exec(r),n=new Date(+o[3],+o[2]-1,+o[1]);t=Date.parse(n)}else e.preventDefault(),t=new Date;"number"==typeof t&&(t=new Date(t));try{var c=cordova.require("cordova/plugin/datepicker"),i={date:t,mode:"date",allowOldDates:!0};i.onChange=this.onDatePickerChange,i.visibility="visible",i.onDismiss=this.onDatePickerDismiss,c.show(i)}catch(s){}})},errorresponse:function(){hideSpinner(),Backbone.history.navigate("#/exception")},creditCardPaymentsconfirm:function(e,t,a,r,o){els.set("CCpayfrmActNo",""),els.set("CCpaytoActNo",""),els.set("CCpayfrmActNo",e),els.set("CCpaytoActNo",t),els.set("CCpayamt",a),els.set("CCpayconv",r),els.set("CCpayexrate",o);var n=els.get("mindueamt");if(hideSpinner(),null==n||"undefined"==n||""==n||void 0==n||"null"==n){var c=$("#dueamount").val(),i=$("#dueamountcode").val(),s=i+"-"+c;els.set("mindueamt",s)}Backbone.history.navigate("#/creditCardPaymentsconfirm")},disposeView:function(e){return Backbone.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return creditCardPaymentsList});