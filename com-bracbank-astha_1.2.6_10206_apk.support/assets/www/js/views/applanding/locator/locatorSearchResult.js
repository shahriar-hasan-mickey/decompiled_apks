define(["jquery","underscore","Backbone","collections/locator/locatorSearchResultCollections","text!views/applanding/locator/locatorSearchResult.tpl"],function(t,e,i,a,s){var l=new EncryptedLocalStorage("secret"),r=i.View.extend({el:"#container",events:{"click #mapView":"locatorsearchmap","click #direction":"directionUI"},render:function(){function e(t){var e=/iPad|iPhone|iPod/.test(navigator.userAgent);e||i.history.navigate("#/locator"),onGeoLocationError(t)}function s(e){hideSpinner();var i,a;e.coords,l.get("app.context.path");i=e.coords.latitude,a=e.coords.longitude;getDeviceId(),l.get("atmbrn"),l.get("distkm"),l.get("srselecity");timestamp=(new Date).getTime(),showSpinner(),"en-US"==t.i18n.lng()?language="EN":"en-AR"==t.i18n.lng()&&(language="AR");var s=l.get("distkm");s=s.replace(/ +/g,""),r.collection.fetch({data:t.param({usrLat:i,usrLon:a,paramcode:l.get("atmbrn"),radius:s,city:"",searchByCity:"N"}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(l.get("calltimeout")),success:function(e){if("0000"==ackStatus)if(""!=atmBranchDetailDTO&&null!=atmBranchDetailDTO){t("#atmresult").show(),t("#errorResult").hide(),t("#atmresult").empty();var s=[];t.each(atmBranchDetailDTO,function(e){function l(i,a){if(a!=google.maps.DistanceMatrixStatus.OK)s.pop();else{var l,n=i.rows[0].elements,o=n[0].distance.text,c=n[0].distance.value/1e3;l="Y"==r.accept_cash_deposit?t.i18n.t("app.mpin.yes"):t.i18n.t("app.mpin.no"),isNull(s[e])||(s[e].accepttype=l,s[e].disMeter=c,s[e].dis=o)}}var r=atmBranchDetailDTO[e];s.push(r);var n=new google.maps.LatLng(i,a),o=new google.maps.LatLng(r.latitude,r.longitude),c=new google.maps.DistanceMatrixService;c.getDistanceMatrix({origins:[n],destinations:[o],travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.METRIC,avoidHighways:!1,avoidTolls:!1},l)}),setTimeout(function(){t(".boxborderd").empty(),t("#atmresult").empty(),t.each(s,function(t){if(void 0!=s[t]){var e=s[t].disMeter;void 0==e&&s.splice(t,1)}}),s.sort(function(t,e){return t=t.disMeter,e=e.disMeter,t-e});var e=s;t.each(e,function(i){var a=e[i],s=e[i].accepttype,r=e[i].dis,n=(e[i].disMeter,l.get("distkm"));(void 0==r||null==r)&&(r=""),(void 0==s||null==s)&&(s="");var o=isNull(r)?"":r.split(",");if("city"==l.get("locatorTypeCityOrAtm")){var c='<div class="panel panel-default"><div class="panel-body"><p><strong>'+a.branchATMName+"</strong></p>";isNull(a.branchATMAddressEnglish)&&isNull(a.area)&&isNull(a.city)||(c+='<div class="media"><div class="media-left"><i class="fa fa-map-marker" aria-hidden="true"></i></div><div class="media-body small">'+a.branchATMAddressEnglish+"&nbsp;"+a.area+"&nbsp;"+a.city+"</div></div><br/>"),isNull(r)||(c+='<div class="row"><div class="col-xs-6"><p class="small text-muted">'+t.i18n.t("app.locator.distance")+'</p></div><div class="col-xs-6"><p class="small text-right"><b>'+r+"</b></p></div></div>"),isNull(a.atmType)||(c+='<div class="row"><div class="col-xs-8"><p class="small text-muted">'+t.i18n.t("app.locator.atmType")+'</p></div><div class="col-xs-4"><p class="small text-right"><b>'+a.atmType+'</b></p></div></div><div class="row"><div class="col-xs-10"><p class="small text-muted">'+t.i18n.t("app.locator.acceptsCashDeposits")+'</p></div><div class="col-xs-2"><p class="small text-right"><b>'+a.acceptCashDeposit+'</b></p></div></div><div class="button" role="group" ><a href="#/direction/'+a.latitude+"/"+a.longitude+'" <button type="button" class="btn btn-primary btn-block">'+t.i18n.t("app.locator.direction")+"</a></div></div></div></div>"),t("#atmresult").append(c)}else if(parseInt(o)>=0&&parseInt(o)<=parseInt(n)){var c='<div class="panel panel-default"><div class="panel-body"><p><strong>'+a.branchATMName+'</strong></p><div class="media"><div class="media-left"><i class="fa fa-map-marker" aria-hidden="true"></i></div>';if("BRANCH"==l.get("atmbrn")?isNull(a.branchATMAddressEnglish)||(c+='<div class="media-body small">'+a.branchATMAddressEnglish+"</div>"):isNull(a.branchATMAddressEnglish)&&isNull(a.area)&&isNull(a.city)||(c+='<div class="media-body small">'+a.branchATMAddressEnglish+"</div>"),"BRANCH"==l.get("atmbrn")){var d=e[i].workingHours;isNull(d)||(c+='<div class="media"><div class="media-left"><i class="fa fa-clock-o" aria-hidden="true"></i></div><div class="media-body small">'+d+"</div></div>")}isNull(r)||(c+='<br/><div class="row"><div class="col-xs-6"><p class="small text-muted">'+t.i18n.t("app.locator.distance")+'</p></div><div class="col-xs-6"><p class="small text-right"><b>'+r+"</b></p></div></div>"),("ATM"==l.get("atmbrn")||"AGENT_BANKING"==l.get("atmbrn")||"SME_OUTLET"==l.get("atmbrn"))&&(isNull(a.acceptCashDeposit)||(c+='<div class="row"><div class="col-xs-10"><p class="small text-muted">'+t.i18n.t("app.locator.acceptsCashDeposits")+'</p></div><div class="col-xs-2"><p class="small text-right"><b>'+a.acceptCashDeposit+"</b></p></div></div>")),isNull(a.atmType)||(c+='<div class="row"><div class="col-xs-8"><p class="small text-muted">'+t.i18n.t("app.locator.atmType")+'</p></div><div class="col-xs-4"><p class="small text-right"><b>'+a.atmType+"</b></p></div></div>"),isNull(a.latitude)||isNull(a.longitude)||(c+='<div class="button" role="group" ><a href="#/direction/'+a.latitude+"/"+a.longitude+'" <button type="button" class="btn btn-primary btn-block">'+t.i18n.t("app.locator.direction")+"</a></div>"),c+="</div></div></div>",t("#atmresult").append(c)}}),hideSpinner()},3e3)}else t("#atmresult").hide(),t("#atmresult").empty(),t("#errorResult").show(),hideSpinner();else t("#atmresult").hide(),t("#atmresult").empty(),t("#errorResult").show(),hideSpinner()}})}var r=this;r.locatorcompile();r.collection=new a,navigator.geolocation&&(showSpinner(),navigator.geolocation.getCurrentPosition(s,e,{enableHighAccuracy:!0,timeout:1e4,maximumAge:1e4}))},locatorcompile:function(){return hideSpinner(),this.$el.html(e.template(s,{})).i18n(),this.$el.trigger("create"),this},locatorsearchmap:function(t){t.preventDefault(),i.history.fragment=null,i.history.navigate("#/mapview")},directionUI:function(t){t.preventDefault(),i.history.fragment=null,i.history.navigate("#/direction")},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(t){return i.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=t,this.currentView.delegateEvents(),this.currentView}});return r});