define(["jquery","underscore","Backbone","text!views/applanding/Registration/setPassword.tpl","models/validation/registration/setPasswordValidationModel","collections/applanding/Registration/registerUserCollections"],function(r,e,t,n,i,a){var o=new EncryptedLocalStorage("secret"),s=t.View.extend({el:"#container",events:{"click #cancelbtn":"backToLogin","click #gotoPwdSuccess":"gotoPwdSuccessPopUp","click #gotoLogin":"gotoLoginUI","keyup #password":"registerPasswordChange","keyup #confpassword":"registerConfirmPasswordChange","keyup #username":"registerUsernameChange"},render:function(){this.$el.html(e.template(n,{})),this.$el.trigger("create"),r("html").addClass("loginbg").removeClass("preloginbg")},backToLogin:function(){t.history.navigate("#/newregistration")},registerConfirmPasswordChange:function(){r("#confirmPasswordError").html("");var e=r("#confpassword").val();return""==e||null==e?(r("#confirmPasswordError").html(r.i18n.t("validation.newregistration.confpwdnotnull")),!1):void 0},registerPasswordChange:function(){r("#passwordError").html(""),r("#confirmPasswordError").html("");var e=/[0-9]/g,t=r("#password").val(),n=r("#confpassword").val(),i=o.get("pwdpolicy"),a=/[a-z\u0600-\u06FF]/g,s=/[A-Z\u0600-\u06FF]/g,l=/^[A-Z]/,d=/^[a-z]/,p=/^[0-9]/,u=/^[!@#$%^&*()-_+~.]/,h=/^[a-zA-Z]/;if(""==t||null==t)return r("#passwordError").html(r.i18n.t("validation.newregistration.pwdnotnull")),!1;if("U"===i.firstCharacterValue){if(!l.test(t))return r("#passwordError").html(r.i18n.t("app.login.errUP")),!1}else if("L"===i.firstCharacterValue){if(d.test(t))return r("#passwordError").html(r.i18n.t("app.login.errLOW")),!1}else if("N"===i.firstCharacterValue){if(p.test(t))return r("#passwordError").html(r.i18n.t("app.login.errNUM")),!1}else if("S"===i.firstCharacterValue){if(u.test(t))return r("#passwordError").html(r.i18n.t("app.login.errSpecl")),!1}else if("A"===i.firstCharacterValue&&!h.test(t))return r("#passwordError").html(r.i18n.t("First Character should be an alphabet")),!1;if(t.length<i.minimumLength)return r("#passwordError").html(r.i18n.t("app.login.pwderrlength1")+" "+i.minimumLength+" "+r.i18n.t("app.login.pwderrlength2")+" "+i.maximumLength+" "+r.i18n.t("app.login.pwderrlength3")),!1;if(t.length>i.maximumLength)return r("#passwordError").html(r.i18n.t("app.login.pwderrmaxlen")+" "+i.maximumLength+" "+r.i18n.t("app.login.pwderrlength3")),!1;var m=t.search(e);if("Y"===i.numeralsMandatory&&"-1"==m)return r("#passwordError").html(r.i18n.t("app.login.errnumber")),!1;var c=t.search(a);if("Y"===i.lowercaseMandatory&&"-1"==c)return r("#passwordError").html(r.i18n.t("app.login.errlwr")),!1;var g=t.search(s);if("Y"===i.uppercaseMandatory){if(-1==g)return r("#passwordError").html(r.i18n.t("app.login.errupr")),!1;if(0!==g)return r("#passwordError").html(r.i18n.t("app.login.errUP")),!1}if("Y"===i.specialCharactersMandatory)if(isNull(i.disallowedCharacters)){var w=!1,f=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;if(f.test(t)||(w=!0),w)return isError=!0,void r("#passwordError").html(r.i18n.t("app.login.errspc"))}else{for(var v=i.disallowedCharacters,E=!1,C=0;C<t.length;C++){var P=t[C];-1!=v.indexOf(P)&&(E=!0)}if(E)return isError=!0,void r("#passwordError").html("Entered password does not match with password policy "+i.disallowedCharacters+" are not allowed");var w=!1,f=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;if(f.test(t)||(w=!0),w)return isError=!0,void r("#passwordError").html(r.i18n.t("app.login.errspc"))}var y=t.toLowerCase();if("N"===i.repeatingValueAllowedInPwd)for(var C=0;C<y.length;C++){var P=y[C],V=y[C+1];if(P===V&&P===y[C+2])return isError=!0,void r("#passwordError").html(r.i18n.t("app.login.errcon"))}if("N"===i.seqValueAllowedInPwd){if(y.match(/([a-zA-Z0-9])\1\1+|(abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|jkl|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz|ABC|BCD|CDE|DEF|EFG|FGH|GHI|HIJ|IJK|JKL|KLM|LMN|MNO|NOP|OPQ|PQR|QRS|RST|STU|TUV|UVW|VWX|WXY|XYZ|012|123|234|345|456|567|678|789)+/g))return isError=!0,void r("#passwordError").html(r.i18n.t("app.login.errconseq"));for(var L=0,C=0;C<y.length-1;C++){var A=parseInt(y[C])+1;y[C+1]==A&&y[C]!=y[C+1]&&L++}if(4==L)return isError=!0,void r("#passwordError").html(r.i18n.t("app.login.errconseq"))}return(""!=t||null!=t)&&""==n||null==n?(r("#confirmPasswordError").html(r.i18n.t("validation.newregistration.confpwdnotnull")),!1):""!=t&&""!=n&&t!=n?(r("#confirmPasswordError").html(r.i18n.t("validation.newregistration.pwdmismatch")),!1):void 0},registerUsernameChange:function(e){r("#usernameError").html("");var t=r("#username").val(),n=r.trim(r("#username").val()),i=/^[A-Za-z]/,a=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/,o=t.charAt(0),s=t.charAt(t.length-1);return""==n||null==n?(r("#usernameError").html(r.i18n.t("validation.newregistration.usernamenotnull")),!1):i.test(n)?a.test(n)?(r("#usernameError").html(r.i18n.t("validation.newregistration.usernamenospecchar")),!1):n.length<8?(r("#usernameError").html(r.i18n.t("validation.newregistration.usernameminlengtherror")),!1):n.length>20?(r("#usernameError").html(r.i18n.t("validation.newregistration.usernamemaxlengtherror")),!1):o.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i)?s.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i)?void 0:(r("#usernameError").html(r.i18n.t("validation.newregistration.lastspaceind")),!1):(r("#usernameError").html(r.i18n.t("validation.newregistration.firstspaceind")),!1):(r("#usernameError").html(r.i18n.t("validation.newregistration.usrnamealphaerr")),!1)},gotoPwdSuccessPopUp:function(){r("#usernameError").html(""),r("#passwordError").html(""),r("#confirmPasswordError").html("");var e=this,t=/[0-9]/g,n=/^[A-Za-z]/,i=r("#password").val(),s=r("#confpassword").val(),l=o.get("pwdpolicy"),d=r("#username").val(),p=r.trim(r("#username").val()),u=/[a-z\u0600-\u06FF]/g,h=/[A-Z\u0600-\u06FF]/g,m=d.charAt(0),c=d.charAt(d.length-1),g=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/,w=/^[A-Z]/,f=/^[a-z]/,v=/^[0-9]/,E=/^[!@#$%^&*()-_+~.]/,C=/^[a-zA-Z]/,P=!1;if(""==p||null==p)P=!0,r("#usernameError").html(r.i18n.t("validation.newregistration.usernamenotnull"));else{if(!n.test(p))return P=!0,void r("#usernameError").html(r.i18n.t("validation.newregistration.usrnamealphaerr"));if(g.test(p))return P=!0,void r("#usernameError").html(r.i18n.t("validation.newregistration.usernamenospecchar"));if(p.length<8)return P=!0,void r("#usernameError").html(r.i18n.t("validation.newregistration.usernameminlengtherror"));if(p.length>20)return P=!0,void r("#usernameError").html(r.i18n.t("validation.newregistration.usernamemaxlengtherror"));if(!m.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return P=!0,void r("#usernameError").html(r.i18n.t("validation.newregistration.firstspaceind"));if(!c.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return P=!0,void r("#usernameError").html(r.i18n.t("validation.newregistration.lastspaceind"))}if((""==i||null==i)&&(P=!0,r("#passwordError").html(r.i18n.t("validation.newregistration.pwdnotnull"))),(""==s||null==s)&&(P=!0,r("#confirmPasswordError").html(r.i18n.t("validation.newregistration.confpwdnotnull"))),""==i||null==i)return P=!0,void r("#passwordError").html(r.i18n.t("validation.newregistration.pwdnotnull"));if("U"===l.firstCharacterValue){if(!w.test(i))return P=!0,void r("#passwordError").html(r.i18n.t("app.login.errUP"))}else if("L"===l.firstCharacterValue){if(f.test(i))return P=!0,void r("#passwordError").html(r.i18n.t("app.login.errLOW"))}else if("N"===l.firstCharacterValue){if(v.test(i))return P=!0,void r("#passwordError").html(r.i18n.t("app.login.errNUM"))}else if("S"===l.firstCharacterValue){if(E.test(i))return P=!0,void r("#passwordError").html(r.i18n.t("app.login.errSpecl"))}else if("A"===l.firstCharacterValue&&!C.test(i))return r("#passwordError").html(r.i18n.t("First Character should be an alphabet")),!1;if(i.length<l.minimumLength)return P=!0,void r("#passwordError").html(r.i18n.t("app.login.pwderrlength1")+" "+l.minimumLength+" "+r.i18n.t("app.login.pwderrlength2")+" "+l.maximumLength+" "+r.i18n.t("app.login.pwderrlength3"));if(i.length>l.maximumLength)return P=!0,void r("#passwordError").html(r.i18n.t("app.login.pwderrmaxlen")+" "+l.maximumLength+" "+r.i18n.t("app.login.pwderrlength3"));var y=i.search(t);if("Y"===l.numeralsMandatory&&"-1"==y)return P=!0,void r("#passwordError").html(r.i18n.t("app.login.errnumber"));var V=i.search(u);if("Y"===l.lowercaseMandatory&&"-1"==V)return P=!0,void r("#passwordError").html(r.i18n.t("app.login.errlwr"));var L=i.search(h);if("Y"===l.uppercaseMandatory){if(-1==L)return P=!0,void r("#passwordError").html(r.i18n.t("app.login.errupr"));if(0!==L)return P=!0,void r("#passwordError").html(r.i18n.t("app.login.errUP"))}if("Y"===l.specialCharactersMandatory)if(isNull(l.disallowedCharacters)){var A=!1,S=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;if(S.test(i)||(A=!0),A)return P=!0,void r("#passwordError").html(r.i18n.t("app.login.errspc"))}else{for(var F=l.disallowedCharacters,I=!1,N=0;N<i.length;N++){var U=i[N];-1!=F.indexOf(U)&&(I=!0)}if(I)return P=!0,void r("#passwordError").html("Entered password does not match with password policy "+l.disallowedCharacters+" are not allowed");var A=!1,S=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;if(S.test(i)||(A=!0),A)return P=!0,void r("#passwordError").html(r.i18n.t("app.login.errspc"))}var b=i.toLowerCase();if("N"===l.repeatingValueAllowedInPwd)for(var N=0;N<b.length;N++){var U=b[N],x=b[N+1];if(U===x&&U===b[N+2])return P=!0,void r("#passwordError").html(r.i18n.t("app.login.errcon"))}if("N"===l.seqValueAllowedInPwd){if(b.match(/([a-zA-Z0-9])\1\1+|(abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|jkl|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz|ABC|BCD|CDE|DEF|EFG|FGH|GHI|HIJ|IJK|JKL|KLM|LMN|MNO|NOP|OPQ|PQR|QRS|RST|STU|TUV|UVW|VWX|WXY|XYZ|012|123|234|345|456|567|678|789)+/g))return P=!0,void r("#passwordError").html(r.i18n.t("app.login.errconseq"));for(var M=0,N=0;N<b.length-1;N++){var D=parseInt(b[N])+1;b[N+1]==D&&b[N]!=b[N+1]&&M++}if(4==M)return P=!0,void r("#passwordError").html(r.i18n.t("app.login.errconseq"))}if((""!=i||null!=i)&&""==s||null==s)return P=!0,void r("#confirmPasswordError").html(r.i18n.t("validation.newregistration.confpwdnotnull"));if(""!=i&&""!=s&&i!=s)return P=!0,void r("#confirmPasswordError").html(r.i18n.t("validation.newregistration.pwdmismatch"));if(!P){var k,z=/iPad|iPhone|iPod/.test(navigator.userAgent);k=z?"IOSMOBILE":"ANDROIDMOBILE";var Z=(new Date).getTime(),O=o.get("customerIDs"),Z=o.get("saltreg"),$=DEcryptWithDynamicSalt(O,Z);cusId=EncryptWithDynamicSalt($,Z),i=EncryptWithDynamicSalt(i,Z);var q=EncryptWithDynamicSalt(o.get("registerCardNumber"),Z);o.set("username",p),o.set("password",i);var T=function(r){e.gotoSuccessPopup()},W=function(r){e.errorresponse()};showSpinner(),e.collection=new a;getDeviceId(),(new Date).getTime();e.collection.fetch({data:r.param({appVersion:o.get("app.versionCode"),appVersionHashing:o.get("appVersionHashing"),deviceModel:o.get("device.model"),osVersion:o.get("device.version"),platform:k,cifNo:cusId,salt:Z,passcode:i,cardtype:o.get("cardType"),cardNumber:q,acctNumber:o.get("acctNo"),loginId:o.get("username"),ibUserName:o.get("username")}),dataType:"json",type:"POST",cache:!1,success:function(r){"0000"==ackStatus?T(r):W(r)},error:W})}},gotoSuccessPopup:function(){hideSpinner(),r("#success").modal("show")},gotoLoginUI:function(){hideSpinner(),t.history.navigate("#/login")},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(r){return t.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=r,this.currentView.delegateEvents(),this.currentView}});return s});