define(["jquery","underscore","Backbone","text!views/applanding/Registration/regAccSelectAuthMode.tpl","collections/applanding/Registration/cardPinValidationCollections","collections/applanding/Registration/otpGenerationCollections","collections/applanding/Registration/otpVerificationCollections"],function(e,t,i,o,a,r,n){var s=null,l=new EncryptedLocalStorage("secret"),c=i.View.extend({el:"#container",events:{"click #regAcc_SelAuthMode_cancel_btn":"gotoPreviousPage","click #regAcc_SelAuthMode_nextBtn":"showOTPPopup","click #cancel_btn":"revokeOTPSpinner","click #close_btn":"revokeOTPSpinner","click #verifyOTP":"gotoVerifySuccessPopUp","click #gotoSetPassword":"gotoSetPassword"},render:function(){s=null,hideSpinner(),this.$el.html(t.template(o,{})),s=null,this.$el.trigger("create"),e("html").addClass("loginbg").removeClass("preloginbg"),e("#first,#second,#third,#fourth").removeAttr("disabled","disabled"),e(".first,.mid,.last").removeAttr("disabled","disabled");var i=this;i.populateAuthMode()},populateAuthMode:function(){var t=l.get("emailID");e("#regAccAuthModeDiv").html("");var i="<label for='username'>"+e.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";i+='<div class=\'custRadio_pass\'><div class="box"><div class="radio"><label><input type="radio" name="self_registration_authmode" id="self_registration_auth0" value="SMS" checked><div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs sms"></span><span class="small">'+e.i18n.t("app.transfer.managebeneficiary.sms")+"</span></div></div></label></div></div>",isNull(t)||(i+='<div class="box"><div class="radio"><label><input type="radio" name="self_registration_authmode" id="self_registration_auth1" value="EMAIL"><div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs mail"></span><span class="small">'+e.i18n.t("app.transfer.managebeneficiary.mail")+"</span></div></div></label></div></div>"),e("#regAccAuthModeDiv").html(i)},gotoPreviousPage:function(e){"object"==typeof e&&e.stopImmediatePropagation(),i.history.navigate("#/newregistration")},gotoVerifySuccessPopUp:function(){e("#otpNullError").html(""),e("#otpNullErrorDiv").hide();var t=e("#otp1").attr("data"),i=e("#otp2").attr("data"),o=e("#otp3").attr("data"),a=e("#otp4").attr("data"),r=e("#otp5").attr("data"),s=e("#otp6").attr("data");if(isNull(t)||isNull(i)||isNull(o)||isNull(a)||isNull(r)||isNull(s))return e("#otpNullErrorDiv").show(),void e("#otpNullError").html(e.i18n.t("validation.newregistration.otpnotnull"));var c=t+i+o+a+r+s,p=function(t){hideSpinner(),e("#verify").modal("hide"),e("#verifysuccess").modal("show")},d=function(t){hideSpinner(),isNull(l.get("errordesc"))||(e("#otpNullErrorDiv").show(),e("#otpNullError").html(l.get("errordesc")))},u=l.get("customerIDs"),v=l.get("saltreg"),h=DEcryptWithDynamicSalt(u,v);cusId=EncryptWithDynamicSalt(h,v);var g=this;showSpinner(),g.revokeOTPSpinner(),g.collection=new n;getDeviceId(),(new Date).getTime();g.collection.fetch({data:e.param({activationno:c,salt:v,cifId:cusId,mobileNumber:l.get("mobileNo"),email:l.get("emailID"),serviceProvider:null,servicecode:"SELF_REGISTRATION"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?p(e):d(e)},error:d})},gotoSetPassword:function(){i.history.navigate("#/setpassword"),e("div").removeClass("modal-backdrop fade in")},showOTPPopup:function(e){"object"==typeof e&&e.stopImmediatePropagation();var t=this;t.validateCardPin("N")},validateCardPin:function(t){var i=this,o="",a=e("input[name='self_registration_authmode']:checked").val();l.set("alertType",a),e("#otpNullError").html(""),e("#otpNullErrorDiv").hide();var n=function(a){hideSpinner(),"Y"==t&&(e("#OTPcontainer1").slideDown("slow"),s.set(1),s.animate(0,function(){e("#OTPcontainer1").slideUp("slow")})),e("#verify").modal("show"),setTimeout(function(){e("#otp1").focus()},500),e("#otpNullError").html(""),e("#otpNullErrorDiv").hide(),e(".inputs").on("input",function(t){t.stopImmediatePropagation();var i=t.currentTarget.id,o=e("#"+i).val();e("#"+i).attr("data",o),e("#"+i).val(o.replace(/[^\*]/,"."))}),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").removeAttr("data"),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""),"SMS"==l.get("alertType")?o=e.i18n.t("app.registration.opthelptext")+" "+maskMobile(l.get("mobileNo")):"EMAIL"==l.get("alertType")&&(o=e.i18n.t("app.registration.opthelpemailtext")+" "+maskEmailID(l.get("emailID"))),e("#otpHelpText").html(o),i.invokeOTPSpinner()},c=function(e){i.errorresponse()},p=l.get("customerIDs"),d=l.get("saltreg"),u=DEcryptWithDynamicSalt(p,d);cusId=EncryptWithDynamicSalt(u,d);var i=this;showSpinner(),i.collection=new r;getDeviceId(),(new Date).getTime();i.collection.fetch({data:e.param({salt:d,cifId:cusId,mobileNumber:l.get("mobileNo"),email:l.get("emailID"),serviceProvider:null,resendflag:t,alerttype:l.get("alertType"),servicecode:"SELF_REGISTRATION"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?n(e):c(e)},error:c})},invokeOTPSpinner:function(){var t=this;return e("#resend_btn3").hide(),e("#OTPcontainer1").show(),null!=s?(s.set(1),void s.animate(0,function(){e("#OTPcontainer1").slideUp("slow")})):(s=new ProgressBar.Circle(OTPcontainer1,{color:"#333",strokeWidth:8,trailWidth:8,easing:"linear",duration:6e4*parseInt(l.get("otpExpiryPeriod")),text:{autoStyleContainer:!1},from:{color:"#ec5f59",width:8},to:{color:"#ec5f59",width:8},step:function(t,i){i.path.setAttribute("stroke",t.color),i.path.setAttribute("stroke-width",t.width);var o=Math.round(i.value()*(60*l.get("otpExpiryPeriod")));"0"==o?(i.setText(""),e("#resend_btn3").show()):(e("#resend_btn3").hide(),i.setText(o+"s"))}}),s.text.style.fontFamily='"Raleway", Helvetica, sans-serif',s.text.style.fontSize="12px",s.text.style.fontWeight="bold",s.set(1),s.animate(0,function(){e("#OTPcontainer1").slideUp("slow")}),void e("#resend_btn3").click(function(){t.validateCardPin("Y")}))},revokeOTPSpinner:function(){null!=s&&s.stop()},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(e){return i.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return c});