define(["jquery","underscore","Backbone","text!views/applanding/Registration/debitCardRegistration.tpl","collections/applanding/Registration/cardPinValidationCollections","collections/applanding/Registration/otpGenerationCollections","collections/applanding/Registration/otpVerificationCollections"],function(t,e,i,n,r,a,o){var l=null,s=new EncryptedLocalStorage("secret"),c=i.View.extend({el:"#container",events:{"click #validate":"gotoOTPPopUp","click #cancelbtn":"backToLogin","click #reg_next_btn":"showOTPOrEmail","click #reg_cancel_btn":"backToLogin","click #verifyOTP":"gotoVerifySuccessPopUp","click #gotoSetPassword":"gotoSetPassword","click #cancel_btn":"revokeOTPSpinner","click #close_btn":"revokeOTPSpinner"},render:function(){l=null,hideSpinner(),this.$el.html(e.template(n,{})),this.$el.trigger("create"),t("html").addClass("loginbg").removeClass("preloginbg"),t("#first,#second,#third,#fourth").removeAttr("disabled","disabled"),t(".first,.mid,.last").removeAttr("disabled","disabled")},gotoOTPPopUp:function(){var e=this,i=!1;t("#otpNullError").html(""),t("#otpNullErrorDiv").hide(),t("#cardNumNullError").html(""),t(".pincode-input-error").html("");var n=t("#first").val(),a=t("#second").val(),o=t("#third").val(),l=t("#fourth").val(),c=t("#mpininput").val(),d=/[0-9]/g;if((""==n||""==a||""==o||""==l)&&(i=!0,t("#cardNumNullError").html(t.i18n.t("validation.newregistration.cardnumnotnull"))),(""==c||null==c)&&(i=!0,t(".pincode-input-error").html(t.i18n.t("validation.newregistration.pinnotnull"))),c.length<4&&(i=!0,t(".pincode-input-error").html(t.i18n.t("validation.newregistration.pinnotnull"))),""==n||""==a||""==o||""==l)return i=!0,void t("#cardNumNullError").html(t.i18n.t("validation.newregistration.validnumerrmsg"));if(n.length<t("#first").attr("maxlength")||a.length<t("#second").attr("maxlength")||o.length<t("#third").attr("maxlength")||l.length<t("#fourth").attr("maxlength"))return i=!0,void t("#cardNumNullError").html(t.i18n.t("validation.newregistration.validnumerrmsg"));if(!(n.match(d)&&a.match(d)&&o.match(d)&&l.match(d)))return i=!0,void t("#cardNumNullError").html(t.i18n.t("validation.newregistration.cardnumberonly"));if(c.length<4)return i=!0,void t(".pincode-input-error").html(t.i18n.t("validation.newregistration.pinnotnull"));if(!c.match(d))return i=!0,void t(".pincode-input-error").html(t.i18n.t("validation.newregistration.pinnumberonly"));var p=n+a+o+l,u=(new Date).getTime();s.set("saltreg",u),s.set("registerCardNumber",p),ccnum=EncryptWithDynamicSalt(p,u),ccpinnum=EncryptWithDynamicSalt(c,u),s.set("enccardnum",ccnum);var m=function(i){hideSpinner(),t("#first, #second, #third, #fourth").attr("disabled","disabled"),t(".first,.mid,.last").attr("disabled","disabled"),e.populateAuthModeDiv()},h=function(t){e.errorresponse()};showSpinner(),e.collection=new r;getDeviceId(),(new Date).getTime();e.collection.fetch({data:t.param({ccno:ccnum,ccpinno:ccpinnum,salt:u,cardtype:s.get("cardType"),flag:"R"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?m(e):(h(e),t("form")[0].reset())},error:h})},populateAuthModeDiv:function(){var e=s.get("emailID");t("#registrationAuthModeDiv").html("");var i="<label for='username'>"+t.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";i+='<div class=\'custRadio_pass\'><div class="box"><div class="radio"><label><input type="radio" name="self_registration_authmode" id="self_registration_auth0" value="SMS" checked><div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs sms"></span><span class="small">'+t.i18n.t("app.transfer.managebeneficiary.sms")+"</span></div></div></label></div></div>",isNull(e)||(i+='<div class="box"><div class="radio"><label><input type="radio" name="self_registration_authmode" id="self_registration_auth1" value="EMAIL"><div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs mail"></span><span class="small">'+t.i18n.t("app.transfer.managebeneficiary.mail")+"</span></div></div></label></div></div>"),t("#self_reg_nextbtn").show(),t("#self_reg_validatebtn").hide(),t("#registrationAuthModeDiv").html(i)},backToLogin:function(){i.history.navigate("#/newregistration")},showOTPOrEmail:function(){var t=this;t.validateCardPin("N")},validateCardPin:function(e){var i=this,n="",r=t("input[name='self_registration_authmode']:checked").val();s.set("alertType",r),t("#otpNullError").html(""),t("#otpNullErrorDiv").hide();var o=function(r){hideSpinner(),"Y"==e&&(t("#OTPcontainer1").slideDown("slow"),l.set(1),l.animate(0,function(){t("#OTPcontainer1").slideUp("slow")})),t("#verify").modal("show"),setTimeout(function(){t("#otp1").focus()},500),t("#otpNullError").html(""),t("#otpNullErrorDiv").hide(),t(".inputs").on("input",function(e){e.stopImmediatePropagation();var i=e.currentTarget.id,n=t("#"+i).val();t("#"+i).attr("data",n),t("#"+i).val(n.replace(/[^\*]/,"."))}),t("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").removeAttr("data"),t("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""),"SMS"==s.get("alertType")?n=t.i18n.t("app.registration.opthelptext")+" "+maskMobile(s.get("mobileNo")):"EMAIL"==s.get("alertType")&&(n=t.i18n.t("app.registration.opthelpemailtext")+" "+maskEmailID(s.get("emailID"))),t("#otpHelpText").html(n),i.invokeOTPSpinner()},c=function(t){i.errorresponse()},d=s.get("customerIDs"),p=s.get("saltreg"),u=DEcryptWithDynamicSalt(d,p);cusId=EncryptWithDynamicSalt(u,p);var i=this;showSpinner(),i.collection=new a;getDeviceId(),(new Date).getTime();i.collection.fetch({data:t.param({salt:p,cifId:cusId,mobileNumber:s.get("mobileNo"),email:s.get("emailID"),serviceProvider:null,resendflag:e,alerttype:s.get("alertType"),servicecode:"SELF_REGISTRATION"}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?o(t):c(t)},error:c})},gotoVerifySuccessPopUp:function(){t("#otpNullError").html(""),t("#otpNullErrorDiv").hide();var e=t("#otp1").attr("data"),i=t("#otp2").attr("data"),n=t("#otp3").attr("data"),r=t("#otp4").attr("data"),a=t("#otp5").attr("data"),l=t("#otp6").attr("data");if(isNull(e)||isNull(i)||isNull(n)||isNull(r)||isNull(a)||isNull(l))return t("#otpNullErrorDiv").show(),void t("#otpNullError").html(t.i18n.t("validation.newregistration.otpnotnull"));var c=e+i+n+r+a+l,d=function(e){hideSpinner(),t("#verify").modal("hide"),t("#verifysuccess").modal("show")},p=function(e){hideSpinner(),isNull(s.get("errordesc"))||(t("#otpNullErrorDiv").show(),t("#otpNullError").html(s.get("errordesc")))},u=s.get("customerIDs"),m=s.get("saltreg"),h=DEcryptWithDynamicSalt(u,m);cusId=EncryptWithDynamicSalt(h,m);var v=this;showSpinner(),v.revokeOTPSpinner(),v.collection=new o;getDeviceId(),(new Date).getTime();v.collection.fetch({data:t.param({activationno:c,salt:m,cifId:cusId,mobileNumber:s.get("mobileNo"),email:s.get("emailID"),serviceProvider:null,servicecode:"SELF_REGISTRATION"}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?d(t):p(t)},error:p})},gotoSetPassword:function(){i.history.navigate("#/setpassword"),t("div").removeClass("modal-backdrop fade in")},invokeOTPSpinner:function(){var e=this;return t("#resend_btn3").hide(),t("#OTPcontainer1").show(),null!=l?(l.set(1),void l.animate(0,function(){t("#OTPcontainer1").slideUp("slow")})):(l=new ProgressBar.Circle(OTPcontainer1,{color:"#333",strokeWidth:8,trailWidth:8,easing:"linear",duration:6e4*parseInt(s.get("otpExpiryPeriod")),text:{autoStyleContainer:!1},from:{color:"#ec5f59",width:8},to:{color:"#ec5f59",width:8},step:function(e,i){i.path.setAttribute("stroke",e.color),i.path.setAttribute("stroke-width",e.width);var n=Math.round(i.value()*(60*s.get("otpExpiryPeriod")));"0"==n?(i.setText(""),t("#resend_btn3").show()):(t("#resend_btn3").hide(),i.setText(n+"s"))}}),l.text.style.fontFamily='"Raleway", Helvetica, sans-serif',l.text.style.fontSize="12px",l.text.style.fontWeight="bold",l.set(1),l.animate(0,function(){t("#OTPcontainer1").slideUp("slow")}),void t("#resend_btn3").click(function(){e.validateCardPin("Y")}))},revokeOTPSpinner:function(){null!=l&&l.stop()},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(t){return i.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=t,this.currentView.delegateEvents(),this.currentView}});return c});