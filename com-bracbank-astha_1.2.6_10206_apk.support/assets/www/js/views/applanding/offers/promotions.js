define(["jquery","underscore","Backbone","collections/locator/PromotionCollections","text!views/applanding/offers/offerandpromo.tpl","text!views/applanding/offers/promotions.tpl"],function(e,t,n,o,i,a){var r=new EncryptedLocalStorage("secret"),s=n.View.extend({el:"#preloginmobcontent",events:{"click #offersshow":"offersshow"},update:function(){var t=this,n=(getDeviceId(),function(e){t.showpromotionTemplate()}),i=function(e){t.errorresponse()};showSpinner(),t.collection=new o([],{}),timestamp=(new Date).getTime(),"en-US"==e.i18n.lng()?language="EN":"en-AR"==e.i18n.lng()&&(language="AR"),t.collection.fetch({data:e.param({paramcode:"PROMO",language:language,promotodisp:"P"}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(r.get("calltimeout")),success:function(e){"0000"==ackStatus?n(e):i(e)},error:i})},offersearchmap:function(e){e.preventDefault(),n.history.fragment=null,n.history.navigate("#/offersearchmap")},promotiondet:function(){var t=r.get("promotionsListDTO");""!=t&&e.each(t,function(e){var o=(t[e],parseInt(e));r.set("index",o),e>=0&&(n.history.fragment=null,n.history.navigate("#/promotiondetails/"+e))})},sliderNear:function(){function n(e){onGeoLocationError(e)}function o(t){var n,o,i=r.get("app.context.path");-1!=i.indexOf("dev")?(n="24.669170",o="46.70533"):(n=t.coords.latitude,o=t.coords.longitude);var l=(new google.maps.LatLng(n,o),getDeviceId());"en-US"==e.i18n.lng()?language="EN":"en-AR"==e.i18n.lng()&&(language="AR");var c=e(".showslideval").text(),g=c.substring(0,2);showSpinner(),timestamp=(new Date).getTime(),a.collection.fetch({data:e.param({login_type:"prelogin",latitude:n,longitude:o,reqtype:"OFFERS",device_id:l,language:language,type:"1",distance:g,city:"",requestid:timestamp}),dataType:"json",type:"POST",cache:!1,success:function(t){var i=r.get("offersListDTO");if("0000"==ackStatus)if(""!=i){e("#offersresult").empty();var a="";e.each(i,function(t){function r(n,o){if(o!=google.maps.DistanceMatrixStatus.OK);else{var i=n.rows[0].elements,r=i[0].distance.text;a='<li class="list-group-item"><a href="#/offersDetailsPage/'+t+"/"+s.location_latitude+"/"+s.location_longitude+'"><div class="pull-left imgholder"><img src="data:image/jpg;base64,'+s.merchant_logo+'" width="40" height="40"/></div><span class="pull-right glyphicon glyphicon-chevron-right"></span><h4 class="list-group-item-heading">'+s.offer_text+'</h4><p class="list-group-item-text">'+s.merchant_name+'&nbsp;<span class="label label-warning">'+r+"</span></p></a></li>",e("#offersresult").append(a)}}var s=i[t],l=new google.maps.LatLng(n,o),c=new google.maps.LatLng(s.location_latitude,s.location_longitude),g=new google.maps.DistanceMatrixService;g.getDistanceMatrix({origins:[l],destinations:[c],travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.METRIC,avoidHighways:!1,avoidTolls:!1},r)}),hideSpinner()}else e("#offersresult").empty(),hideSpinner();else s(t),hideSpinner()}})}var a=this;a.$el.html(t.template(i,{})).i18n();var s=function(e){a.errorresponse()};a.collection=new locatorResultCollections,navigator.geolocation&&(showSpinner(),navigator.geolocation.getCurrentPosition(o,n,{enableHighAccuracy:!0}))},promotions:function(){var t=this,n=getDeviceId();"en-US"==e.i18n.lng()?language="EN":"en-AR"==e.i18n.lng()&&(language="AR");var i=function(e){t.showpromotionTemplate()},a=function(e){t.errorresponse()};t.collection=new o([],{}),timestamp=(new Date).getTime(),t.collection.fetch({data:e.param({login_type:"prelogin",paramcode:"PROMO",device_id:n,language:language,requestid:timestamp}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(r.get("calltimeout")),success:function(e){"0000"==ackStatus?i(e):a(e)},error:a})},showpromotionTemplate:function(){return this.$el.html(t.template(a,{})).i18n(),this.$el.trigger("create"),hideSpinner(),this},offersshow:function(e){e.preventDefault(),n.history.fragment=null,n.history.navigate("#/offers",!0)},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(e){return n.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return s});