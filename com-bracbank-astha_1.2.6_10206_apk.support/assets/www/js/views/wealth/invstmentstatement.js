define(["jquery","underscore","Backbone","models/validation/wealthValidationModel","collections/wealth/accStatementCollections","collections/wealth/accNicknameCollections","collections/wealth/acctDownloadCollections","collections/common/emailAdviceCollections","collections/common/emailAdviceCollections","text!views/wealth/invstmentstatement.tpl","views/wealth/getstatement","views/errors/exception"],function($,_,Backbone,wealthValidation,accStatementCollections,accNicknameCollections,acctDownloadCollections,emailAdviceCollections,emailAdviceCollections,investmentstatementTPL,getstatement,exception){var els=new EncryptedLocalStorage("secret"),accStatementView=Backbone.View.extend({el:"#mobcontent",events:{"submit #detailstatement":"getdetailStatement","submit #searchby":"gotodate","click #editname":"savenickname","click #pdfdownload":"PDFDownload","click #xlsdownload":"XLSdownload","click #emailadvice":"EmailAdvice","click #getstatement":"getdepositstatement","change #amtabove":"amtabovelen","change #amtbelow":"amtbelowlen","change #lasttrns":"lasttrns","click #startDate":"startDate"},lasttrns:function(){$("#getstatement").attr("disabled","disabled"),$("#startDateNull").hide(),$("#endDateNull").hide(),$("#lasttransval").hide(),$("#amtabovelength").hide(),$("#amtbelowlength").hide();var e=$("#lasttrns").val();return""==e?($("#lasttransval").show(),$("#getstatement").attr("disabled","disabled"),!1):e>50?($("#lasttransval").show(),$("#getstatement").attr("disabled","disabled"),!1):void $("#getstatement").removeAttr("disabled")},startDate:function(){$("#getstatement").attr("disabled","disabled"),$("#startDateNull").hide(),$("#endDateNull").hide(),$("#amtabovelength").hide(),$("#amtbelowlength").hide(),$("#lasttransval").hide();var e=$("#startDate").val(),t=$("#endtDate").val();return""==e&&""!=t?($("#startDateNull").show(),$("#endDateNull").hide(),$("#getstatement").attr("disabled","disabled"),!1):""!=e&&""==t?($("#startDateNull").hide(),$("#endDateNull").show(),$("#getstatement").attr("disabled","disabled"),!1):void $("#getstatement").removeAttr("disabled")},endtDate:function(){$("#getstatement").attr("disabled","disabled"),$("#startDateNull").hide(),$("#endDateNull").hide(),$("#amtabovelength").hide(),$("#amtbelowlength").hide(),$("#lasttransval").hide();var e=$("#startDate").val(),t=$("#endtDate").val();return""==e&&""==t?($("#startDateNull").show(),$("#endDateNull").show(),$("#getstatement").attr("disabled","disabled"),!1):void $("#getstatement").removeAttr("disabled")},amtabovelen:function(){$("#getstatement").attr("disabled","disabled"),$("#startDateNull").hide(),$("#endDateNull").hide(),$("#amtabovelength").hide(),$("#amtbelowlength").hide(),$("#lasttransval").hide();var e=$("#amtabove").val(),t=$("#amtbelow").val();if(""==e&&""==t)return $("#amtabovelength").show(),$("#getstatement").attr("disabled","disabled"),!1;if(""!=e&&""==t)return $("#amtbelowlength").show(),$("#getstatement").attr("disabled","disabled"),!1;if(""==e&&""!=t)return $("#amtabovelength").show(),$("#getstatement").attr("disabled","disabled"),!1;if($("#getstatement").removeAttr("disabled"),e.length>10&&t.length>10)return $("#amtabovelength").show(),$("#amtbelowlength").show(),$("#getstatement").attr("disabled","disabled"),!1;$("#getstatement").attr("disabled","disabled");var a=$("#lasttrns").val();return""==a&&a.length>0?($("#lasttransval").show(),$("#getstatement").attr("disabled","disabled"),!1):void $("#getstatement").removeAttr("disabled")},amtbelowlen:function(){$("#getstatement").attr("disabled","disabled"),$("#startDateNull").hide(),$("#endDateNull").hide(),$("#amtabovelength").hide(),$("#amtbelowlength").hide(),$("#lasttransval").hide();var e=$("#amtabove").val(),t=$("#amtbelow").val(),a=$("#startDate").val(),n=$("#endtDate").val();if(""==e&&""==t)return $("#amtabovelength").show(),$("#amtbelowlength").show(),$("#getstatement").attr("disabled","disabled"),!1;if(e.length>10&&t.length>10)return $("#amtabovelength").show(),$("#amtbelowlength").show(),$("#getstatement").attr("disabled","disabled"),!1;$("#getstatement").attr("disabled","disabled");var i=$("#lasttrns").val();""==i&&""!=a&&""!=n?$("#getstatement").removeAttr("disabled"):""!=i&&""==a&&""==n?$("#getstatement").removeAttr("disabled"):$("#getstatement").attr("disabled","disabled")},update:function(e){$("#amtabovelength").hide(),$("#amtbelowlength").hide(),showSpinner();var t=this,a=function(a){t.statementcompile(e)},n=function(e){t.errorresponse()};t.collection=new accStatementCollections([],{id:e}),timestamp=(new Date).getTime(),els.set("accountNumber",e);var i=els.get("depositid"),l=els.get("mydeposit"),o=l[i].id,s=(l[i].accountNumber,getDeviceId()),r=e+""+s,d=CryptoJS.MD5(r);r=d+"";var c=o+"DEPOSIT";c=null==c?"":c,checkSumEncrypt(c);var m=localStorage.getItem("FINALCHECKSUM");t.collection.fetch({data:$.param({access_token:els.get("access_token"),appchecksum:m,acctCategory:"DEPOSIT",acctid:o,requestid:timestamp}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(e){"0000"==ackStatus?a(e):n(e)},error:n})},statementcompile:function(e){this.$el.html(_.template(investmentstatementTPL,{collection:this.collection.models,accid:e})).i18n(),this.$el.trigger("create"),$(".amtformatter").formatamount(),hideSpinner();var t=els.get("device.platform");return"Android"==t||"Ios"==t?this.datefunc():this.datefunc(),this},EmailAdvice:function(){showSpinner();var e=this,t=function(t){e.emailadvicecompile()},a=function(t){e.errorresponse()};e.collection=new emailAdviceCollections([],{});var n,i=(new Date).getTime(),l=$("#ftno").val(),o=els.get("accountNumber"),s=els.get("ttype");"ACCOUNT"==s?n="ACCOUNT":"CARD"==s?n="CARD":"TRANSFER"==s&&(n="TRANSFER");var r=els.get("emailid"),d=(els.get("loginid"),els.get("custno"));els.get("lang_id");e.collection.fetch({data:$.param({ftrefno:l,transfertype:n,accountNumber:o,custmailid:r,custuserid:d,requestid:i}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(e){"0000"==ackStatus?t(e):a(e)},error:a})},emailadvicecompile:function(){return els.set("backReqFromEmail","1"),this.$el.empty(),Backbone.history.navigate("#/emailAdviceSuccessPage"),hideSpinner(),this},gotodate:function(e){this.model=new wealthValidation({url:"json/"}),this.$(".alert").hide(),Backbone.Validation.bind(this);var t=this.$("form").serializeObject();if(this.model.set(t,{validate:!0})){this.model.clear(),Backbone.Validation.unbind(this),e.preventDefault(),showSpinner();var a=this,n=function(t){a.verificationcompile(e)},i=function(e){a.errorresponse()};a.collection=new accStatementCollections([],{});var l=$("form").serialize();timestamp=(new Date).getTime(),a.collection.fetch({data:$.param({requestid:timestamp})+"&"+l,dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(e){"0000"==ackStatus?n(e):i(e)},error:i})}else this.$(".alert-error").fadeIn(),e.preventDefault(),hideSpinner(),$("select#fromAccountId").selectmenu("refresh")},getdepositstatement:function(event){$("#startDateNull").hide(),$("#endDateNull").hide(),$("#toDateShouldNotBeGreaterThanCurrDate").hide(),$("#toDateShouldBeGreaterThanFromDate").hide(),$("#lasttransval").hide(),$("#amtabovelength").hide(),$("#amtbelowlength").hide(),$("#startDateoldyear").hide(),$("#startDateValid").hide(),$("#startDateNull").hide(),$("#endDateNull").hide(),$("#amtabovelength").hide(),$("#amtbelowlength").hide(),$("#amtbelowgreater").hide(),$("#lasttransval").hide(),this.$(".alert").hide();var data=this.$("form").serializeObject();event.preventDefault();var form=$("form#searchby"),frmdate=form.find("#startDate").val(),todate=form.find("#endtDate").val(),frmdatesplitted=frmdate.split("/"),frmdateday=frmdatesplitted[0],frmdatemnt=frmdatesplitted[1],frmdateyear=frmdatesplitted[2],FromDate=new Date(frmdateyear,frmdatemnt-1,frmdateday),todatesplitted=todate.split("/"),todateday=todatesplitted[0],todatemnt=todatesplitted[1],todateyear=todatesplitted[2],ToDate1=new Date(todateyear,todatemnt-1,todateday),CurrentDate=new Date,dd=CurrentDate.getDate(),mm=CurrentDate.getMonth()+1,yyyy=CurrentDate.getFullYear();10>dd&&(dd="0"+dd),10>mm&&(mm="0"+mm);var currentdate=dd+"/"+mm+"/"+yyyy,currDate=new Date(yyyy,mm,dd),diff=new Date(ToDate1.getTime()-FromDate.getTime()),diff2=new Date(ToDate1.getTime()-CurrentDate.getTime()),days=diff/1e3/60/60/24,vallu=90,amtaboveleng=$("#amtabove").val(),amtbelowleng=$("#amtbelow").val();if(""==amtaboveleng&&""!=amtbelowleng)return $("#amtabovelength").show(),!1;if(""!=amtaboveleng&&""==amtbelowleng)return $("#amtbelowlength").show(),!1;if(+amtaboveleng>+amtbelowleng)return $("#amtbelowgreater").show(),$("#greatamt").html($.i18n.t("validation.wealth.amountgreater")+" "+amtaboveleng),!1;if(amtaboveleng.length>10)return $("#amtabovelength").show(),!1;if(amtbelowleng.length>10)return $("#amtbelowlength").show(),!1;var n=$("#lasttrns").val();if(n>50)return $("#lasttransval").show(),!1;els.set("lastntrans",n);var cdbflag=$("input[name='options']:checked").val();cdbflag=null==cdbflag?"B":cdbflag,els.set("cdbflag",cdbflag);var pastDate=new Date,pastdd=CurrentDate.getDate(),pastmm=CurrentDate.getMonth(),pastyyyy=CurrentDate.getFullYear()-1,pastyrdate=pastdd+"/"+pastmm+"/"+pastyyyy,givfrmdate=form.find("#startDate").val(),oneDay=864e5,differnt=0;differnt=Math.round(Math.abs((pastDate.getTime()-FromDate.getTime())/oneDay));var pst=days_of_a_year(pastyyyy),noy=pst;if(""==frmdate&&""!=todate)return $("#startDateNull").show(),!1;if(""!=frmdate&&""==todate)return $("#endDateNull").show(),!1;if(""!=frmdate&&""!=todate){var DaysDifftc=diff2/864e5;if(eval(DaysDifftc)>eval(0))return $("#toDateShouldNotBeGreaterThanfutureDate").show(),$("#startDateoldyear").hide(),$("#startDateValid").hide(),!1;if(eval(differnt)>=eval(noy))return $("#toDateShouldNotBeGreaterThanCurrDate").hide(),$("#startDateoldyear").show(),$("#startDateValid").hide(),$("#fromDateShouldNotBeGreaterThanfutureDate").hide(),$("#toDateShouldNotBeGreaterThanCurrDate").hide(),!1;var DaysDiff=diff/864e5;if(eval(DaysDiff)>eval(90))return $("#toDateShouldNotBeGreaterThanCurrDate").hide(),$("#startDateValid").show(),$("#startDateoldyear").hide(),$("#fromDateShouldNotBeGreaterThanfutureDate").hide(),!1}if(ToDate1.getTime()>currDate.getTime())return $("#toDateShouldNotBeGreaterThanCurrDate").show(),!1;if(ToDate1.getTime()<=FromDate.getTime()&&ToDate1.getTime()<=currDate.getTime())return $("#toDateShouldBeGreaterThanFromDate").show(),!1;var accountNumber=form.find("#accno").val();els.set("accno",accno);var frmamt=form.find("#amtabove").val();els.set("frmamtdep",frmamt);var toamt=form.find("#amtbelow").val();els.set("toamtdep",toamt),""==frmamt&&(frmamt="0"),""==toamt&&(toamt="0"),els.set("accMinStmtFrmDate",frmdate),els.set("accMinStmtToDate",todate);var payflag=$("#selectbutton  label.active input").val();els.set("payflag",payflag),Backbone.history.navigate("#/getdepositstatement/"+accountNumber+"/"+frmamt+"/"+toamt,{trigger:!0});var backtostatement=accountNumber+"/"+frmamt+"/"+toamt;els.set("getstatmentback",backtostatement),hideSpinner(),this.undelegateEvents()},verificationcompile:function(e){this.subview=this.disposeView(new getstatement),this.subview.$el.trigger("create"),$.mobile.loading("hide"),hideSpinner(),this.undelegateEvents()},editname:function(){var e=_.template(getstatement);this.$el.html(e).trigger("create"),$.mobile.loading("hide"),hideSpinner()},getdetailStatement:function(e){this.model=new wealthValidation({url:"json/"}),this.$(".alert").hide(),Backbone.Validation.bind(this);var t=this.$("form").serializeObject();if(this.model.set(t,{validate:!0})){this.model.clear(),Backbone.Validation.unbind(this),e.preventDefault(),$("#spinner").hide(),showSpinner();var a=$("form#detailstatement"),n=a.find("#fromDate").val(),i=a.find("#toDate").val(),l=a.attr("action");Backbone.history.navigate(l+"/"+n+"/"+i,{trigger:!1}),this.undelegateEvents()}else this.$(".alert-error").fadeIn(),e.preventDefault(),hideSpinner()},getstatement:function(e){this.$(".alert").hide();this.$("form").serializeObject();e.preventDefault(),showSpinner();var t=$("form#searchby"),a=t.find("#startDate").val(),n=t.find("#endtDate").val(),i=t.find("#accno").val(),l=t.find("#amtabove").val(),o=t.find("#amtbelow").val();""==l&&(l="0"),""==o&&(o="0"),els.set("accMinStmtFrmDate",a),els.set("accMinStmtToDate",n),Backbone.history.navigate("/getstatement/"+i+"/"+l+"/"+o,{trigger:!0});var s=i+"/"+l+"/"+o;els.set("getstatmentback",s),hideSpinner(),this.undelegateEvents()},savenickname:function(e){var t=this,a=function(e){t.errorresponse()};t.collection=new accNicknameCollections([],{});var n=($("form#editname"),els.get("custno"),$("#accountno").val(),$("#nicknameid").val()),i=($("#NickNameService").val(),els.get("depositid")),l=els.get("mydeposit"),o=l[i].id,s=$("#checknicknametype").val();s=""==s?"NickNameAdd":"NickNameUpdate";if(timestamp=(new Date).getTime(),""!=n){showSpinner(),t.collection.fetch({data:$.param({access_token:els.get("access_token"),nickname:n,appchecksum:"",acctid:o}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(e){"0000"==ackStatus?($("#updname").text(n),hideSpinner()):a(e)},error:a})}else $("#nickerror").show();hideSpinner()},nicknamecompile:function(e){this.$el.html(_.template(investmentstatementTPL,{collection:this.collection.models})).i18n(),this.$el.trigger("create"),$("#spinner").hide(),hideSpinner(),this.update(accountnumber)},PDFDownload:function(e){var t="",a=els.get("app.context.path");t=a+"account/ministatement/download.pdf";var n=els.get("access_token"),i=(els.get("device_id"),els.get("lang_id"),$("#accountno").val(),els.get("depositid")),l=els.get("mydeposit"),o=l[i].id,s="",r="",d="",c="",m="",h="",u=(getDeviceId(),""),v="accountID="+o+"&fromDate="+s+"&toDate="+r+"&fromAmount="+c+"&toAmount="+m+"&lastnTxn="+d+"&emailRequired="+h+"&appchecksum="+u+"&access_token="+n+"&download=PDF&type=DEPOSIT",g=encodeURI(v);fileDownLoadAndViewer(t,g,1,n)},pdfdownloadcompile:function(){hideSpinner()},XLSdownload:function(e){var t="",a=els.get("app.context.path");t=a+"account/ministatement/download.xls";var n=els.get("access_token"),i=(els.get("device_id"),els.get("lang_id"),$("#accountno").val(),els.get("depositid")),l=els.get("mydeposit"),o=l[i].id,s="",r="",d="",c="",m="",h="",u=(getDeviceId(),""),v="accountID="+o+"&fromDate="+s+"&toDate="+r+"&fromAmount="+c+"&toAmount="+m+"&lastnTxn="+d+"&emailRequired="+h+"&appchecksum="+u+"&access_token="+n+"&download=XLS&type=DEPOSIT",g=encodeURI(v);fileDownLoadAndViewer(t,g,2,n)},xlsdownloadcompile:function(){hideSpinner()},datefunc:function(e){$(".nativedatepicker").focus(function(e,t){e.preventDefault();var a,n=$(this),i=t||{};i.min||0,i.max||0;if(""!==n.val()){var l=n.val(),o=/(\d+)\/(\d+)\/(\d+)/.exec(l),s=new Date(+o[3],+o[2]-1,+o[1]);a=Date.parse(s)}else e.preventDefault(),a=new Date;"number"==typeof a&&(a=new Date(a)),window.plugins.datePicker.show({date:a,mode:"date",allowOldDates:!0,maxDate:Date.parse(new Date)},function(e){if(e){var t=new Date(e),a=t.getDate(),i=t.getMonth()+1,l=t.getFullYear(),o=""+(9>=a?"0"+a:a)+"/"+(9>=i?"0"+i:i)+"/"+l;n.val(o)}n.blur()})})},errorresponse:function(){hideSpinner(),openErrorPopup()},showDatePicker:function(){$(".nativedatepicker").focus(function(e){e.preventDefault(),$(this).blur();var t,a=$(this);if(""!==a.val()){var n=a.val(),i=/(\d+)-(\d+)-(\d+)/.exec(n),l=new Date(+i[3],+i[2]-1,+i[1]);t=Date.parse(l)}else e.preventDefault(),t=new Date;"number"==typeof t&&(t=new Date(t));try{var o=cordova.require("cordova/plugin/datepicker"),s={date:t,mode:"date",allowOldDates:!0};s.onChange=this.onDatePickerChange,s.visibility="visible",s.onDismiss=this.onDatePickerDismiss,o.show(s)}catch(r){}})},onDatePickerChange:function(e){var t=new Date(e),a=t.getDate(),n=t.getMonth()+1,i=t.getFullYear(),l=""+(9>=a?"0"+a:a)+"/"+(9>=n?"0"+n:n)+"/"+i;$(this).val(l),$(this).blur()},onDatePickerDismiss:function(e){var t=new Date(e),a=t.getDate(),n=t.getMonth()+1,i=t.getFullYear(),l=""+(9>=a?"0"+a:a)+"-"+(9>=n?"0"+n:n)+"-"+i;$(this).val(l),$(this).blur()},disposeView:function(e){return Backbone.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return accStatementView});