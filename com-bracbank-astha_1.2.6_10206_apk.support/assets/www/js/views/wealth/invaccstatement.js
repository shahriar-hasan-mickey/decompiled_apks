define(["jquery","underscore","Backbone","models/validation/wealthValidationModel","collections/wealth/accStatementCollections","collections/wealth/accNicknameCollections","text!views/wealth/accstatement.tpl","views/wealth/getstatement","views/common/exception"],function($,_,Backbone,wealthValidation,accStatementCollections,accNicknameCollections,accStatementTemplate,getstatement,exception){var els=new EncryptedLocalStorage("secret"),accStatementView=Backbone.View.extend({el:"#mobcontent",events:{"submit #detailstatement":"getdetailStatement","submit #searchby":"gotodate","click #getstatement":"getstatement","click #editname":"savenickname"},update:function(accid){showSpinner(),els.set("accountNumber",accid),els.set("accoutDetailType","invest");var that=this,onDataHandler=function(e){that.statementcompile(accid)},onErrorHandler=function(e){that.errorresponse()};that.collection=new accStatementCollections([],{id:accid}),timestamp=(new Date).getTime();var my_device_id=getDeviceId(),appCheckSum=accid+""+my_device_id,hashing=CryptoJS.MD5(appCheckSum);appCheckSum=hashing+"",that.collection.fetch({data:$.param({appchecksum:appCheckSum,accountNumber:accid,requestid:timestamp}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(data){if("0000"==ackStatus){var map=new Array;for(i=0;i<ministatement.length;i++){narr=ministatement[i].narration,-1!=narr.indexOf("-")&&(narr=narr.substring(0,narr.indexOf("-")));var mapcnt=0;void 0==map[narr]?mapcnt=1:(mapcnt=eval(map[narr]),mapcnt+=1),map[narr]=mapcnt}var graphKey=new Array,graphVal=new Array,x=0;for(var i in map)graphKey[x]=i,graphVal[x]=map[i],x++;els.set("graphKey",graphKey),els.set("graphVal",graphVal),onDataHandler(data)}else onErrorHandler(data)},error:onErrorHandler});var dataerror=function(e){alert(e)}},statementcompile:function(e){this.$el.html(_.template(accStatementTemplate,{collection:this.collection.models,accid:e})).i18n(),this.$el.trigger("create"),hideSpinner();var t=els.get("device.platform");return"Android"==t?this.datefunc():this.datefunc(),this},gotodate:function(e){this.model=new wealthValidation({url:"json/"}),this.$(".alert").hide(),Backbone.Validation.bind(this);var t=this.$("form").serializeObject();if(this.model.set(t,{validate:!0})){this.model.clear(),Backbone.Validation.unbind(this),e.preventDefault(),showSpinner();var a=this,n=function(t){a.verificationcompile(e)},i=function(e){a.errorresponse()};a.collection=new accStatementCollections([],{});var r=$("form").serialize();timestamp=(new Date).getTime(),a.collection.fetch({data:$.param({requestid:timestamp})+"&"+r,dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(e){"0000"==ackStatus?n(e):i(e)},error:i})}else this.$(".alert-error").fadeIn(),e.preventDefault(),hideSpinner(),$("select#fromAccountId").selectmenu("refresh")},verificationcompile:function(e){this.subview=this.disposeView(new getstatement),this.subview.$el.trigger("create"),hideSpinner(),this.undelegateEvents()},editname:function(){var e=_.template(getstatement);this.$el.html(e).trigger("create"),hideSpinner()},getdetailStatement:function(e){this.model=new wealthValidation({url:"json/"}),Backbone.Validation.bind(this);var t=this.$("form").serializeObject();if(this.model.set(t,{validate:!0})){this.model.clear(),Backbone.Validation.unbind(this),e.preventDefault(),showSpinner();var a=$("form#detailstatement"),n=a.find("#fromDate").val(),i=a.find("#toDate").val(),r=a.attr("action");Backbone.history.navigate(r+"/"+n+"/"+i,{trigger:!1}),this.undelegateEvents()}else this.$(".alert-error").fadeIn(),e.preventDefault(),hideSpinner()},getstatement:function(e){$("#startDateNull").hide(),$("#endDateNull").hide(),$("#toDateShouldNotBeGreaterThanCurrDate").hide(),$("#toDateShouldBeGreaterThanFromDate").hide();this.$("form").serializeObject();e.preventDefault();var t=$("form#searchby"),a=t.find("#startDate").val(),n=t.find("#endtDate").val(),i=a.split("/"),r=i[0],c=i[1],o=i[2],s=new Date(o,c,r),l=n.split("/"),m=l[0],d=l[1],h=l[2],u=new Date(h,d,m),p=new Date,v=p.getDate(),f=p.getMonth()+1,g=p.getFullYear();10>v&&(v="0"+v),10>f&&(f="0"+f);var w=new Date(g,f,v);if(""==a&&""==n)$("#startDateNull").show(),$("#endDateNull").show();else if(""==a)$("#startDateNull").show();else if(""==n)$("#endDateNull").show();else if(u.getTime()>w.getTime())$("#toDateShouldNotBeGreaterThanCurrDate").show();else if(u.getTime()<=s.getTime()&&u.getTime()<=w.getTime())$("#toDateShouldBeGreaterThanFromDate").show();else{var D=t.find("#accno").val(),k=t.find("#amtabove").val(),S=t.find("#amtbelow").val();""==k&&(k="0"),""==S&&(S="0"),els.set("accMinStmtFrmDate",a),els.set("accMinStmtToDate",n),Backbone.history.navigate("/getstatement/"+D+"/"+k+"/"+S,{trigger:!0});var b=D+"/"+k+"/"+S;els.set("getstatmentback",b),this.undelegateEvents()}},savenickname:function(e){var t=this,a=function(e){t.errorresponse()};t.collection=new accNicknameCollections([],{});var n=($("form#editname"),els.get("custno")),i=$("#accountno").val(),r=$("#nicknameid").val(),c=($("#NickNameService").val(),$("#checknicknametype").val());c=""==c?"NickNameAdd":"NickNameUpdate";var o="",s=els.get("lang_id");if("en-US"==s?o="EN":"en-AR"==s&&(o="AR"),timestamp=(new Date).getTime(),""!=r){showSpinner(),t.collection.fetch({data:$.param({accountnumber:i,customerno:n,nickname:r,hidservicename:c,language:o,requestid:timestamp}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(e){"0000"==ackStatus?($("#updname").text(r),hideSpinner()):a(e)},error:a})}else $("#nickerror").show();hideSpinner()},nicknamecompile:function(e){this.$el.html(_.template(accStatementTemplate,{collection:this.collection.models})).i18n(),this.$el.trigger("create"),hideSpinner(),this.update(accountnumber)},datefunc:function(e){$(".nativedatepicker").focus(function(e){e.preventDefault();var t,a=$(this);if(""!==a.val()){var n=a.val(),i=/(\d+)-(\d+)-(\d+)/.exec(n),r=new Date(+i[3],+i[2]-1,+i[1]);t=Date.parse(r)}else e.preventDefault(),t=new Date;"number"==typeof t&&(t=new Date(t)),window.plugins.datePicker.show({date:t,mode:"date",allowOldDates:!0},function(e){if(e){var t=new Date(e),n=t.getDate(),i=t.getMonth()+1,r=t.getFullYear(),c=""+(9>=n?"0"+n:n)+"/"+(9>=i?"0"+i:i)+"/"+r;a.val(c)}a.blur()})})},errorresponse:function(){hideSpinner(),openErrorPopup()},showDatePicker:function(){$(".nativedatepicker").focus(function(e){e.preventDefault(),$(this).blur();var t,a=$(this);if(""!==a.val()){var n=a.val(),i=/(\d+)-(\d+)-(\d+)/.exec(n),r=new Date(+i[3],+i[2]-1,+i[1]);t=Date.parse(r)}else e.preventDefault(),t=new Date;"number"==typeof t&&(t=new Date(t));try{var c=cordova.require("cordova/plugin/datepicker"),o={date:t,mode:"date",allowOldDates:!0};o.onChange=this.onDatePickerChange,o.visibility="visible",o.onDismiss=this.onDatePickerDismiss,c.show(o)}catch(s){}})},onDatePickerChange:function(e){var t=new Date(e),a=t.getDate(),n=t.getMonth()+1,i=t.getFullYear(),r=""+(9>=a?"0"+a:a)+"-"+(9>=n?"0"+n:n)+"-"+i;$(this).val(r),$(this).blur()},onDatePickerDismiss:function(e){var t=new Date(e),a=t.getDate(),n=t.getMonth()+1,i=t.getFullYear(),r=""+(9>=a?"0"+a:a)+"-"+(9>=n?"0"+n:n)+"-"+i;$(this).val(r),$(this).blur()},disposeView:function(e){return Backbone.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return accStatementView});