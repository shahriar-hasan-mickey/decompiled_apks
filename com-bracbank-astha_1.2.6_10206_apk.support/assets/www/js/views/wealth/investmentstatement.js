define(["jquery","underscore","Backbone","models/validation/wealthValidationModel","collections/wealth/investmentStatementCollections","collections/wealth/ccMINIStatementCollections","collections/wealth/accNicknameCollections","collections/wealth/acctDownloadCollections","collections/common/emailAdviceCollections","collections/common/emailAdviceCollections","text!views/wealth/CCcurrentLoad.tpl","text!views/wealth/CCPendingLoad.tpl","text!views/wealth/investmentstatement.tpl","views/wealth/getprepaidstatement","views/errors/exception"],function($,_,Backbone,wealthValidation,accStatementCollections,ccMINIStatementCollections,accNicknameCollections,acctDownloadCollections,emailAdviceCollections,emailAdviceCollections,currentstatementTPL,pendingstatementTPL,investmentstatementTPL,getprepaidstatement,exception){var els=new EncryptedLocalStorage("secret"),investmentStatementView=Backbone.View.extend({el:"#mobcontent",events:{"submit #detailstatement":"getdetailStatement","submit #searchby":"gotodate","click #getstatement":"getprepaidstatement","click #currentbtn":"currentcompile","click #pendingbtn":"pendingcompile","click #editname":"savenickname","click #editname":"savenickname","click #editname":"savenickname","click #pdfdownload":"PDFDownload","click #xlsdownload":"XLSdownload","click #emailadvice":"EmailAdvice","change #lasttrns":"getprepaidstatement"},update:function(e){showSpinner();var t=this,a=function(e){t.currentcompile()},n=function(e){t.errorresponse()};t.collection=new accStatementCollections([],{id:e}),timestamp=(new Date).getTime(),els.set("accountNumber",e);var i=els.get("paramList"),c=els.get("prepaidCardAccountList"),o=c[i].id,s=c[i].accountNumber,r=getDeviceId(),l=e+""+r,d=CryptoJS.MD5(l);l=d+"",t.collection.fetch({data:$.param({access_token:els.get("access_token"),appchecksum:"",accountNumber:s,acctCategory:"PREPAIDCARD",acctid:o,requestid:timestamp}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(e){"0000"==ackStatus?a(e):n(e)},error:n})},currentcompile:function(){showSpinner();var e=this,t=function(t){e.statementcompile(),e.currentcompilebtn()},a=function(t){e.errorresponse()};e.collection=new ccMINIStatementCollections([],{id:c}),timestamp=(new Date).getTime(),els.set("accountNumber",c);var n=els.get("paramList"),i=els.get("prepaidCardAccountList"),c=i[n].id,o=i[n].accountNumber,s=getDeviceId(),r=c+""+s,l=CryptoJS.MD5(r);r=l+"",e.collection.fetch({data:$.param({access_token:els.get("access_token"),appchecksum:"",flag:"PC",type:"NORMAL",accountNumber:o,acctCategory:"PREPAIDCARD",accountId:c,requestid:timestamp}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(e){"0000"==ackStatus?t(e):a(e)},error:a})},pendingcompile:function(){showSpinner();var e=this,t=function(t){e.pendingcompilebtn()},a=function(t){e.errorresponse()};e.collection=new ccMINIStatementCollections([],{id:c}),timestamp=(new Date).getTime(),els.set("accountNumber",c);var n=els.get("paramList"),i=els.get("prepaidCardAccountList"),c=i[n].id,o=i[n].accountNumber,s=getDeviceId(),r=c+""+s,l=CryptoJS.MD5(r);r=l+"",e.collection.fetch({data:$.param({access_token:els.get("access_token"),appchecksum:"",flag:"PC",type:"PENDING",accountNumber:o,acctCategory:"PREPAIDCARD",accountId:c,requestid:timestamp}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(e){"0000"==ackStatus?t(e):a(e)},error:a})},currentcompilebtn:function(){$("#currentbtn").addClass("active"),$("#pendingbtn").removeClass("active"),$("#pendingstatement").hide(),$("#currentstatement").show(),this.$("#currentstatement").html(_.template(currentstatementTPL)),hideSpinner()},pendingcompilebtn:function(){$("#pendingbtn").addClass("active"),$("#currentbtn").removeClass("active"),$("#currentstatement").hide(),$("#pendingstatement").show(),this.$("#pendingstatement").html(_.template(pendingstatementTPL)),hideSpinner()},statementcompile:function(){this.$el.html(_.template(investmentstatementTPL,{collection:this.collection.models})).i18n(),this.$el.trigger("create"),$("#currentbtn").addClass("active"),$(".amtformatter").formatamount(),hideSpinner();var e=els.get("device.platform");return"Android"==e||"Ios"==e?this.datefunc():this.showDatePicker(),this},EmailAdvice:function(){showSpinner();var e=this,t=function(t){e.emailadvicecompile()},a=function(t){e.errorresponse()};e.collection=new emailAdviceCollections([],{});var n,i=(new Date).getTime(),c=($("#ftno").val(),els.get("accountNumber"),els.get("ttype"));"ACCOUNT"==c?n="ACCOUNT":"CARD"==c?n="CARD":"TRANSFER"==c&&(n="TRANSFER");var o=(els.get("emailid"),els.get("loginid"),els.get("custno"),els.get("lang_id"),els.get("paramList")),s=els.get("prepaidCardAccountList"),r=s[o].id,l=s[o].accountNumber;e.collection.fetch({data:$.param({access_token:els.get("access_token"),accountNumber:l,acctCategory:"PCSTMI",acctid:r,appchecksum:"",requestid:i}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(e){"0000"==ackStatus?t(e):a(e)},error:a})},emailadvicecompile:function(){return els.set("backReqFromEmail","3"),this.$el.empty(),Backbone.history.navigate("#/emailAdviceSuccessPage"),hideSpinner(),this},gotodate:function(e){this.model=new wealthValidation({url:"json/"}),this.$(".alert").hide(),Backbone.Validation.bind(this);var t=this.$("form").serializeObject();if(this.model.set(t,{validate:!0})){this.model.clear(),Backbone.Validation.unbind(this),e.preventDefault(),showSpinner();var a=this,n=function(t){a.verificationcompile(e)},i=function(e){a.errorresponse()};a.collection=new accStatementCollections([],{});var c=$("form").serialize();timestamp=(new Date).getTime(),a.collection.fetch({data:$.param({requestid:timestamp})+"&"+c,dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(e){"0000"==ackStatus?n(e):i(e)},error:i})}else this.$(".alert-error").fadeIn(),e.preventDefault(),hideSpinner(),$("select#fromAccountId").selectmenu("refresh")},verificationcompile:function(e){this.subview=this.disposeView(new getprepaidstatement),this.subview.$el.trigger("create"),$.mobile.loading("hide"),hideSpinner(),this.undelegateEvents()},editname:function(){var e=_.template(getprepaidstatement);this.$el.html(e).trigger("create"),$.mobile.loading("hide"),hideSpinner()},getdetailStatement:function(e){this.model=new wealthValidation({url:"json/"}),this.$(".alert").hide(),Backbone.Validation.bind(this);var t=this.$("form").serializeObject();if(this.model.set(t,{validate:!0})){this.model.clear(),Backbone.Validation.unbind(this),e.preventDefault(),$("#spinner").hide(),showSpinner();var a=$("form#detailstatement"),n=a.find("#fromDate").val(),i=a.find("#toDate").val(),c=a.attr("action");Backbone.history.navigate(c+"/"+n+"/"+i,{trigger:!1}),this.undelegateEvents()}else this.$(".alert-error").fadeIn(),e.preventDefault(),hideSpinner()},getprepaidstatement:function(event){$("#startDateNull").hide(),$("#endDateNull").hide(),$("#toDateShouldNotBeGreaterThanCurrDate").hide(),$("#toDateShouldBeGreaterThanFromDate").hide(),$("#lasttransval").hide(),this.$(".alert").hide();var data=this.$("form").serializeObject();event.preventDefault();var form=$("form#searchby"),frmdate=form.find("#startDate").val(),todate=form.find("#endtDate").val(),frmdatesplitted=frmdate.split("/"),frmdateday=frmdatesplitted[0],frmdatemnt=frmdatesplitted[1],frmdateyear=frmdatesplitted[2],FromDate=new Date(frmdateyear,frmdatemnt,frmdateday),todatesplitted=todate.split("/"),todateday=todatesplitted[0],todatemnt=todatesplitted[1],todateyear=todatesplitted[2],ToDate1=new Date(todateyear,todatemnt,todateday),CurrentDate=new Date,dd=CurrentDate.getDate(),mm=CurrentDate.getMonth()+1,yyyy=CurrentDate.getFullYear();10>dd&&(dd="0"+dd),10>mm&&(mm="0"+mm);var currentdate=dd+"/"+mm+"/"+yyyy,currDate=new Date(yyyy,mm,dd),diff=new Date(ToDate1.getTime()-FromDate.getTime()),days=diff/1e3/60/60/24,vallu=90,n=$("#lasttrns").val();if(n>50)return $("#lasttransval").show(),!1;els.set("lastntrans",n);var cdbflag=$("input[name='options']:checked").val();if(cdbflag=null==cdbflag?"B":cdbflag,els.set("cdbflag",cdbflag),""==frmdate&&""==todate)$("#startDateNull").show(),$("#endDateNull").show();else if(""==frmdate)$("#startDateNull").show();else if(""==todate)$("#endDateNull").show();else if(eval(days)>eval(vallu))$("#startDateValid").show();else if(ToDate1.getTime()>currDate.getTime())$("#toDateShouldNotBeGreaterThanCurrDate").show();else if(ToDate1.getTime()<=FromDate.getTime()&&ToDate1.getTime()<=currDate.getTime())$("#toDateShouldBeGreaterThanFromDate").show();else{var accountNumber=form.find("#accno").val();els.set("accno",accno);var frmamt=form.find("#amtabove").val(),toamt=form.find("#amtbelow").val();""==frmamt&&(frmamt="0"),""==toamt&&(toamt="0"),els.set("accMinStmtFrmDate",frmdate),els.set("accMinStmtToDate",todate);var payflag=$("#selectbutton  label.active input").val();els.set("payflag",payflag),Backbone.history.navigate("#/getprepaidstatement/"+accountNumber+"/"+frmamt+"/"+toamt,{trigger:!0});var backtostatement=accountNumber+"/"+frmamt+"/"+toamt;els.set("getstatmentback",backtostatement),hideSpinner(),this.undelegateEvents()}},savenickname:function(e){var t=this,a=function(e){t.errorresponse()};t.collection=new accNicknameCollections([],{});var n=($("form#editname"),els.get("custno")),i=$("#accountno").val(),c=$("#nicknameid").val(),o=($("#NickNameService").val(),$("#checknicknametype").val());o=""==o?"NickNameAdd":"NickNameUpdate";var s="EN",r=els.get("acccid"),l=els.get("myaccounts"),d=(l[r].id,getDeviceId()),m=c.split(" ").join("+")+""+d,u=CryptoJS.MD5(m);if(m=u+"",m="E-"+m,timestamp=(new Date).getTime(),timestamp=(new Date).getTime(),""!=c){showSpinner(),t.collection.fetch({data:$.param({accountnumber:i,customerno:n,nickname:c,hidservicename:o,language:s,requestid:timestamp}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(e){"0000"==ackStatus?($("#updname").text(c),hideSpinner()):a(e)},error:a})}else $("#nickerror").show();hideSpinner()},nicknamecompile:function(e){this.$el.html(_.template(accStatementTemplate,{collection:this.collection.models})).i18n(),this.$el.trigger("create"),$("#spinner").hide(),hideSpinner(),this.update(accountnumber)},PDFDownload:function(e){var t="",a=els.get("app.context.path");t=a+"account/ministatement/download.pdf";var n=els.get("appSessionId"),i=els.get("device_id"),c=els.get("lang_id"),o=$("#accountno").val(),s=getDeviceId(),r=o+""+s,l=CryptoJS.MD5(r);r=l+"";var d="device_id="+i+"&appchecksum="+r+"&lang_id="+c+"&accountNumber="+o+"&download=PDF&cardoract=CARD",m=encodeURI(d);fileDownLoadAndViewer(t,m,1,n)},pdfdownloadcompile:function(){hideSpinner()},XLSdownload:function(e){var t="",a=els.get("app.context.path");t=a+"account/ministatement/download.xls";var n=els.get("appSessionId"),i=els.get("device_id"),c=els.get("lang_id"),o=$("#accountno").val(),s=getDeviceId(),r=o+""+s,l=CryptoJS.MD5(r);r=l+"";var d="device_id="+i+"&appchecksum="+r+"&lang_id="+c+"&accountNumber="+o+"&download=XLS&cardoract=CARD",m=encodeURI(d);fileDownLoadAndViewer(t,m,2,n)},xlsdownloadcompile:function(){hideSpinner()},datefunc:function(e){$(".nativedatepicker").focus(function(e){e.preventDefault();var t,a=$(this);if(""!==a.val()){var n=a.val(),i=/(\d+)\/(\d+)\/(\d+)/.exec(n),c=new Date(+i[3],+i[2]-1,+i[1]);t=Date.parse(c)}else e.preventDefault(),t=new Date;"number"==typeof t&&(t=new Date(t)),window.plugins.datePicker.show({date:t,mode:"date",allowOldDates:!0},function(e){if(e){var t=new Date(e),n=t.getDate(),i=t.getMonth()+1,c=t.getFullYear(),o=""+(9>=n?"0"+n:n)+"/"+(9>=i?"0"+i:i)+"/"+c;a.val(o)}a.blur()})})},errorresponse:function(){hideSpinner(),openErrorPopup()},showDatePicker:function(){$(".nativedatepicker").focus(function(e){e.preventDefault(),$(this).blur();var t,a=$(this);if(""!==a.val()){var n=a.val(),i=/(\d+)-(\d+)-(\d+)/.exec(n),c=new Date(+i[3],+i[2]-1,+i[1]);t=Date.parse(c)}else e.preventDefault(),t=new Date;"number"==typeof t&&(t=new Date(t));try{var o=cordova.require("cordova/plugin/datepicker"),s={date:t,mode:"date",allowOldDates:!0};s.onChange=this.onDatePickerChange,s.visibility="visible",s.onDismiss=this.onDatePickerDismiss,o.show(s)}catch(r){}})},onDatePickerChange:function(e){var t=new Date(e),a=t.getDate(),n=t.getMonth()+1,i=t.getFullYear(),c=""+(9>=a?"0"+a:a)+"/"+(9>=n?"0"+n:n)+"/"+i;$(this).val(c),$(this).blur()},onDatePickerDismiss:function(e){var t=new Date(e),a=t.getDate(),n=t.getMonth()+1,i=t.getFullYear(),c=""+(9>=a?"0"+a:a)+"-"+(9>=n?"0"+n:n)+"-"+i;$(this).val(c),$(this).blur()},disposeView:function(e){return Backbone.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return investmentStatementView});