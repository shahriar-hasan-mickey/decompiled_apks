define(["jquery","underscore","Backbone","text!views/login/loginOTP.tpl","collections/common/otpGenerateCollections","collections/common/otpValidateCollections","collections/common/mobileNumberUpdateCollection","models/validation/OTPValidationModel","collections/logout/logoutCollections","models/validation/softOTPValidationModel","collections/wealth/kycInputCollections"],function(e,t,i,n,o,a,r,c,s,l,d){var g=new EncryptedLocalStorage("secret"),p=i.View.extend({el:"#container",e1:"#preloginmobcontent",events:{"click .smsotp":"OTPOption1","click .softToken":"OTPOption2","click #loginotpclick":"submitOTP","click #resendclick":"ResendClick","click #cancel":"Cancel"},update:function(){this.otpflagcheck()},updateMobileNumber:function(){showSpinner();var t=this,i=function(e){t.otpflagcheck()},n=function(e){t.errorresponse()};t.collection=new r([],{});var o=(new Date).getTime(),a=g.get("actual_mob_no"),c=g.get("custnoenc"),c=g.get("custnoenc"),s=g.get("timeStampharse"),l=DEcryptuser(c,s),d=getDeviceId(),p=c+""+d,u=CryptoJS.MD5(p);p=u+"";var m=l,h=Encryptuser(l,o),v=h,f=Encryptuser(m,o);t.collection.fetch({data:e.param({custno:v,mobilenumber:a,timeenv:f,timephrase:o,requestid:o}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(g.get("calltimeout")),success:function(e){"0000"==ackStatus?i(e):n(e)},error:n})},OTPOption1:function(t){e("#hidotp").val("otp"),e(".smsotp").addClass("active"),e(".softToken").removeClass("active"),document.getElementById("smsDivId").style.display="inline",document.getElementById("softTockId").style.display="none",this.generateOTP(),t.preventDefault()},OTPOption2:function(){e("#hidotp").val("softotp"),e(".smsotp_block").hide(),document.getElementById("softTockId").style.display="inline",e(".softTock").show(),document.getElementById("softTockId").style.display="inline",e(".softToken").addClass("active"),e(".smsotp").removeClass("active"),e("#hiddotpvalue").val("Y")},otpflagcheck:function(){hideSpinner(),this.generateOTP()},generateOTP:function(){e("#resenddiv").hide(),e("#loginotpclick").removeAttr("disabled"),showSpinner();var t=this,i=function(e){t.loginotpcompiler()},n=function(e){t.errorresponse()};t.collection=new o([],{});(new Date).getTime();"en-US"==e.i18n.lng()?language="EN":"en-AR"==e.i18n.lng()&&(language="AR");var a=getDeviceId();t.collection.fetch({data:e.param({deviceid:a,access_token:g.get("access_token"),ulpid:g.get("ulpID"),servicecode:"LOGIN"}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(g.get("calltimeout")),success:function(o){"0000"==ackStatus?(e("#loginotpclick").removeAttr("disabled"),e("#loginotpclick").removeAttr("disabled"),e("#resendclick").attr("disabled",!0),"SMS"==status?i(o):t.loginaskverify()):(e("#loginotpclick").removeAttr("disabled"),n(o))},error:n})},ResendClick:function(){hideSpinner(),e("#resendclick").parents(".form-group").find(".optwrap").removeClass("input-group"),e("#resendclick").parent(".input-group-btn").addClass("hidden"),e("#secError").hide(),this.generateOTP()},loginotpcompiler:function(){return hideSpinner(),this.$el.html(t.template(n)),this},securityadvicecheck:function(t){"TWOFA"==e("#securityFlag").val()?this.loginotpverification(t,e("#securityFlag").val()):"TPIN"==e("#securityFlag").val()?this.loginotpverification(t,e("#securityFlag").val()):"SQ"==e("#securityFlag").val()&&this.loginotpverification(t,e("#securityFlag").val())},submitOTP:function(e){this.verifyOTP()},verifyOTP:function(){e("#secError").hide(),e("#resenddiv").hide(),this.model=new c({url:"json/"}),i.Validation.bind(this);var t=this.$("form").serializeObject();if(this.model.set(t,{validate:!0})){this.model.clear(),i.Validation.unbind(this),showSpinner();var n=this,o=function(e){n.loginaskverify()},r=function(e){n.errorresponse()};n.collection=new a([],{}),timestamp=(new Date).getTime();var s=getDeviceId(),l=e("#otp").val(),d=(new Date).getTime();l=EncryptWithDynamicSalt(l,d),n.collection.fetch({data:e.param({deviceid:s,access_token:g.get("access_token"),ulpId:g.get("ulpID"),servicecode:"LOGIN",transactionData1:"SMS",salt:d,activationno:l,device_id:s}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(g.get("calltimeout")),success:function(t){if("0000"==ackStatus)o(t),startTimer("loginotpclick",!1);else{hideSpinner();var i=g.get("errordesc");e("#showError").text(i),e("#loginform")[0].reset(),e("#secError").show(),e("#resenddiv").show()}},error:r})}else this.$(".alert-error").fadeIn(),hideSpinner()},verifySoftToken:function(){this.model=new l({url:"json/"}),i.Validation.bind(this);var t=this.$("form").serializeObject();if(this.model.set(t,{validate:!0})){showSpinner(),this.model.clear(),i.Validation.unbind(this);var n=this,o=function(e){n.loginaskverify()},r=function(e){n.errorresponse()};n.collection=new a([],{});var c=(new Date).getTime(),s="SOFTOTP",d=e("#softotp").val(),p=(g.get("custnoenc"),g.get("custnoenc")),u=g.get("timeStampharse"),m=DEcryptuser(p,u),h=getDeviceId(),v=p+""+h,f=CryptoJS.MD5(v);v=f+"";var y=m,k=Encryptuser(m,c),S=k,T=Encryptuser(y,c);n.collection.fetch({data:e.param({opttype:s,refno:g.get("token_serno"),activationno:d,customerno:S,timeenv:T,timephrase:c,requestid:c}),dataType:"json",type:"POST",timeout:parseInt(g.get("calltimeout")),cache:!1,success:function(e){"0000"==ackStatus?o(e):r(e)},error:r})}else this.$(".alert-error").fadeIn()},loginaskverify:function(){hideSpinner();var e=g.get("forceflag"),t="NO";try{t=window.localStorage.getItem("FirstTimeLoginChk")}catch(n){t="NO"}var o=g.get("mpincheck_server"),a="";try{a=g.get("mpincheck_local")}catch(n){a="NO"}g.get("mpinStatus");"DONE"!=t?i.history.navigate("#/loginask",{trigger:!0,replace:!0}):"Y"==e?i.history.navigate("#/forgotPasswordMsg",{trigger:!0,replace:!0}):i.history.navigate("#/landing",{trigger:!0,replace:!0});var r="N";"mpinch"==a&&(r="Y");var c="N";"mpinch"==o&&(c="Y")},loginaskverify11:function(){hideSpinner();var t="NO";try{t=window.localStorage.getItem("FirstTimeLoginChk")}catch(n){t="NO"}var o=g.get("mpincheck_server"),a="";try{a=g.get("mpincheck_local")}catch(n){a="NO"}g.get("mpinStatus");if("DONE"!=t)i.history.navigate("#/loginask",{trigger:!0,replace:!0});else{var r=this,c=function(e){r.onWealthResponse()},s=function(e){r.errorresponse()};r.collection=new d([],{});var l,p=(new Date).getTime(),u=g.get("iqama_number"),m=(g.get("iqama_id"),g.get("iqama_id"),g.get("iqnumid")),h=g.get("dateChanged");h=h.substring(3,10),l=2==m?g.get("birthmonthyear"):g.get("birthdateyear");var v=g.get("idexpdate"),f=g.get("custno");g.get("kyconetimeprocess");showSpinner(),r.collection.fetch({data:e.param({iqamaNumber:u,id:m,dateOfBirth:l,username:"",custId:f,expDate:v,requestid:p}),dataType:"json",type:"POST",timeout:parseInt(g.get("calltimeout")),cache:!1,success:function(e){if("0000"==ackStatus){var t=g.get("usrlogincount"),n=g.get("noOfDays"),o=new Date,a=o.getDate(),r=o.getMonth()+1,l=o.getFullYear();10>a&&(a="0"+a),10>r&&(r="0"+r);var o=a+"/"+r+"/"+l,d=g.get("idexpdate"),p=d.substring(0,4),u=d.substring(4,6),m=d.substring(6,8);d=m+"/"+u+"/"+p,o==d&&n>90&&n>=0?(g.set("kyconetimeprocess",""),g.set("KYCUpdated",""),i.history.navigate("#/kyc")):c(""!=t||void 0!=t||null!=t||"null"!=t||""!=n||void 0!=n||null!=n?e:e)}else s(e)},error:s})}var y="N";"mpinch"==a&&(y="Y");var k="N";"mpinch"==o&&(k="Y")},onWealthResponse:function(){var e=(g.get("kyconetimeprocess"),g.get("usrlogincount")),t=g.get("noOfDays"),n=g.get("iqnumid");n>=3?i.history.navigate("#/landing",{trigger:!0,replace:!0}):t>90?(hideSpinner(),i.history.navigate("#/landing",{trigger:!0,replace:!0})):!(""==e&&void 0==e&&null==e&&"null"==e||"1"!=e&&"2"!=e)?(hideSpinner(),i.history.navigate("#/landing",{trigger:!0,replace:!0})):(hideSpinner(),i.history.navigate("#/kyc"))},Cancel:function(){showSpinner();var t=g.get("device.platform");"Android"==t&&stopSMSListening();var i=this,n=function(e){i.cancelcompile()},o=function(e){i.errorresponse()};i.collection=new s([],{});var a=(new Date).getTime();i.collection.fetch({data:e.param({usersession:g.get("access_token"),access_token:g.get("access_token"),requestid:a}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?n(e):o(e)},error:o})},cancelcompile:function(){hideSpinner(),i.history.fragment=null,i.history.navigate("#/login",{trigger:!0,replace:!0})},errorresponse:function(e){hideSpinner(),openErrorPopup()}});return p});