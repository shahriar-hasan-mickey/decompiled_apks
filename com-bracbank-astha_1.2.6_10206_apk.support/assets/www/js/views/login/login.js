define(["jquery","underscore","Backbone","text!views/login/login.tpl","text!views/login/mpin.tpl","models/validation/login/loginValidationModel","collections/login/preLoginAuthCollections","collections/login/securelogintokenCollections","collections/login/secureloginCollections","collections/login/forcepassCollections","collections/login/frequentMigratedUserCollections"],function(e,t,i,n,o,a,r,s,c,l,d){var p=null,g=new EncryptedLocalStorage("secret"),u=i.View.extend({el:"#container",events:{"click #mpin_tab":"loadMpinUI","click #login_tab":"loadLoginUI","click #locator":"loadLocatorUI","click #login":"preloginverification","click #newReg":"gotoNewRegistration","click #forgot_Mpin":"loadForgotMpinUI","click #forgot_username":"loadForgotUsernameUI","click #forgot_password":"loadForgotPasswordUI","click #userloginTouchtmp":"userormpintouchreg","click #login_cancelbtn":"backToTouchIDUI"},initialize:function(){e("div").removeClass("modal-backdrop fade in")},render:function(i){return p=null,hideSpinner(),g.set("isLogin",!1),g.set("sessionTimeOut",0),g.set("defaultSessionTimeOut",""),g.set("timeoutFlagsessioncount",""),this.$el.html(t.template(n)),this.$el.trigger("create"),void e("html").removeClass().addClass("loginbg")},userormpintouchreg:function(){var e=this,t=g.get("touchIdReg"),n=/iPhone|iPod|iPad/.test(navigator.userAgent),o=/Android/.test(navigator.userAgent);if(n)try{window.plugins.touchid.isAvailable(function(){i.history.navigate("#/touchidreg")},function(e){i.history.navigate("#/touchidregException")})}catch(a){}else if(o)try{Fingerprint.isAvailable(function(e){i.history.navigate("#/touchidreg")},function(e){g.set("touchIdReg",""),i.history.navigate("#/touchidregException")})}catch(a){}else"A"==t?e.touchIDLogin():i.history.navigate("#/touchidreg",{trigger:!0,replace:!0})},touchIDLoginReg:function(){var n=this,o=g.get("touchIdReg"),a=/iPhone|iPod|iPad/.test(navigator.userAgent);if(a&&"A"==o){g.set("isFirstTimeForTouch","false");try{window.plugins.touchid.isAvailable(function(){var i=!1;if(void 0!=navigator.network){var o=navigator.connection.type;o!=Connection.UNKNOWN&&o!=Connection.NONE&&(i=!0)}i?window.plugins.touchid.verifyFingerprintWithCustomPasswordFallback(e.i18n.t("app.touchid.loginScan"),function(e){g.set("isFirstTimeForTouch","false"),n.touchIDLogin()},function(i){var o=g.get("BiometricType"),a=i,r=!1,s="",c="",l="";if(a.code){if(-2==a.code?(r=!1,n.$el.html(t.template(login_tmpTemplate)),e("html").addClass("loginbg"),n.mpinCheck()):-8==a.code?(r=!0,"FID"==o?(s=e.i18n.t("app.faceid.faceUserFallback"),c=e.i18n.t("app.faceid.faceIDLocked")):(s=e.i18n.t("app.touchid.touchUserFallback"),c=e.i18n.t("app.touchid.touchIDLocked")),n.$el.html(t.template(login_tmpTemplate)),e("html").addClass("loginbg"),n.mpinCheck()):-3==a.code?(r=!0,"FID"==o?(c=e.i18n.t("app.faceid.faceIdInvalid"),s=e.i18n.t("app.faceid.faceUserFallback")):(c=e.i18n.t("app.touchid.touchIdInvalid"),s=e.i18n.t("app.touchid.touchUserFallback"))):-1==a.code&&(r=!0,c="FID"==o?e.i18n.t("app.faceid.faceIdInvalid"):e.i18n.t("app.touchid.touchIdInvalid"),s=e.i18n.t("app.touchid.touchIdTryLogin")),-2!=a.code){if("FID"==o)var l=e.i18n.t("app.faceid.notifaceLoginFailed");else var l=e.i18n.t("app.touchid.notiTouchLoginFailed");pushLocalNotification(l+" "+g.get("device_name")),n.touchIDLoginFailure()}}else{if("FID"==o)var l=e.i18n.t("app.faceid.notifaceLoginFailed");else var l=e.i18n.t("app.touchid.notiTouchLoginFailed");pushLocalNotification(l+" "+g.get("device_name")),n.touchIDLoginFailure(),-1!=a.indexOf("locked")&&(r=!0,"FID"==o?(s=e.i18n.t("app.faceid.faceUserFallback"),c=e.i18n.t("app.faceid.faceIDLocked")):(s=e.i18n.t("app.touchid.touchUserFallback"),c=e.i18n.t("app.touchid.touchIDLocked")),n.$el.html(t.template(login_tmpTemplate)),e("html").addClass("loginbg"),n.mpinCheck())}g.get("isFirstTimeForTouch");g.set("isFirstTimeForTouch","false"),r&&("mpinch"==g.get("mpincheck_local")&&(s="FID"==o?e.i18n.t("app.faceid.faceUserFallbackDesc"):e.i18n.t("app.touchid.touchUserFallbackDesc")),navigator.notification.alert(s,null,c,e.i18n.t("app.mpin.cancel")))}):(g.set("errordesc",""),n.errorresponse())},function(t){if(-8!=t.code)g.set("touchIdReg",""),i.history.navigate("#/touchidregException");else{t="";var n=g.get("BiometricType");"FID"==n?(t=e.i18n.t("app.faceid.faceUserFallback"),title=e.i18n.t("app.faceid.faceIDLocked")):(t=e.i18n.t("app.touchid.touchUserFallback"),title=e.i18n.t("app.touchid.touchIDLocked")),"mpinch"==g.get("mpincheck_local")&&(t="FID"==n?e.i18n.t("app.faceid.faceUserFallbackDesc"):e.i18n.t("app.touchid.touchUserFallbackDesc")),navigator.notification.alert(t,null,title,e.i18n.t("app.mpin.cancel"))}})}catch(r){}}else try{window.plugins.touchid.isAvailable(function(){i.history.navigate("#/touchidreg")},function(e){i.history.navigate("#/touchidregException")})}catch(r){}},loadLoginUI:function(){i.history.navigate("#/login")},loadMpinUI:function(e){},forceUpdateNewVersion:function(){function t(e){if(null!=n.url&&void 0!=n.url&&""!=n.url){var t=/iPad|iPhone|iPod/.test(navigator.userAgent);t?window.location.href=n.url:window.open(n.url,"_system","location=no")}}function t(e){if(1==e&&null!=n.url&&void 0!=n.url&&""!=n.url){var t=/iPad|iPhone|iPod/.test(navigator.userAgent);t?window.location.href=n.url:window.open(n.url,"_system","location=no")}}var n=g.get("appInfoDTO");if(!isNull(n)){var o=n.isUpdate,a=n.msg_eng;g.set("allowAppAccessFlag","false"),g.set("allowOnConfirmAppAccessFlag","true"),"M"==o||""==o?(i.history.navigate("#/InternetException"),g.get("promptFired")||(navigator.notification.confirm(a,t,"",[e.i18n.t("app.login.okButton")]),g.set("promptFired",!0))):"O"==o&&(g.get("promptFired")||(navigator.notification.confirm(a,t,"",[e.i18n.t("app.mpin.yes"),e.i18n.t("app.mpin.no")]),g.set("promptFired",!0)))}},afterDownTime:function(){var t=this,n=e("#username").val(),o=g.get("appInfoDTO");e.parseJSON(window.localStorage.getItem("downTimeMsg"));isNull(o)||"M"!=o.isUpdate&&"O"!=o.isUpdate?(isNull(n)?g.set("preloginUsername",""):g.set("preloginUsername",n),g.set("userID",n),"CARDPIN"==g.get("userstatus")?(hideSpinner(),i.history.navigate("#/migratedusercardtype")):t.securesystimeencuserLogin()):(hideSpinner(),t.forceUpdateNewVersion())},preloginverification:function(t){var n=/iPhone|iPod|iPad|Android/.test(navigator.userAgent);if(void 0==navigator.network&&n)g.set("errorcode","9999"),g.set("errordesc",e.i18n.t("app.login.nointernet2")),openErrorPopup();else{var o=navigator.connection.type,r={};if(r[Connection.UNKNOWN]="Unknown connection",r[Connection.ETHERNET]="Ethernet connection",r[Connection.WIFI]="WiFi connection",r[Connection.CELL_2G]="Cell 2G connection",r[Connection.CELL_3G]="Cell 3G connection",r[Connection.CELL_4G]="Cell 4G connection",r[Connection.NONE]="No network connection",o!=Connection.UNKNOWN&&o!=Connection.NONE||!n){var s=this;e("#usernameError").html("");var c=(new Array,getDeviceId(),e.trim(e("#username").val()));c.charAt(0),c.charAt(c.length-1);this.model=new a({url:"json/"}),this.$(".alert").hide(),i.Validation.bind(this);var l=this.$("form").serializeObject();this.model.set(l,{validate:!0})?(t.preventDefault(),showSpinner(),s.validateLogin()):(this.$(".alert-error").fadeIn(),hideSpinner(),i.Validation.unbind(t))}else g.set("errorcode","9999"),g.set("errordesc",e.i18n.t("app.login.nointernet2")),openErrorPopup()}},validateLogin:function(){var t=this,n="",o="";if(n=window.localStorage.getItem("loginuserid"),null!=n){var a=n.split("~");o=a[0],n=a[1]}else n=e.trim(e("#username").val());var s=function(n){var o=e("#username").val(),a=g.get("appInfoDTO"),r=e.parseJSON(window.localStorage.getItem("downTimeMsg"));!isNull(r)&&r.length>0?(hideSpinner(),openDownTimePopup(),setTimeout(function(){e("#downtime_popup_close_btn").click(function(){t.afterDownTime(),e("#downTimePopUp").modal("hide")})},100)):isNull(a)||"M"!=a.isUpdate&&"O"!=a.isUpdate?(isNull(o)?g.set("preloginUsername",""):g.set("preloginUsername",o),g.set("userID",o),"CARDPIN"==g.get("userstatus")?(hideSpinner(),i.history.navigate("#/migratedusercardtype")):t.securesystimeencuserLogin()):(hideSpinner(),t.forceUpdateNewVersion())},c=function(i){var n=/iPhone|iPod|iPad|Android/.test(navigator.userAgent);n?e.ajax({url:"https://www.google.com/",type:"GET",timeout:9e4,datatype:"json",success:function(e){hideSpinner(),t.errorresponse()},error:function(t){hideSpinner(),g.set("errorcode","9999"),g.set("errordesc",e.i18n.t("app.login.nointernet2")),openErrorPopup()}}):t.errorresponse()};t.collection=new r([],{});for(var l=e.trim(e("#username").val()),d="",p=e.trim(e("#username").val()),u=0;u<p.length;u++)d+=u<p.length-3?"X":p[u];var n="",o="";try{n=window.localStorage.getItem("loginuserid");var a=n.split("~");o=a[0],n=a[1]}catch(h){n=""}var f=!1,m=!1;p==o&&(f=!0),p==n&&(m=!0),(f||m)&&(p=n);g.set("loginuser_id",p);var v=(e.trim(e("#password").val()),d+"~"+p);e("#rememberuser").prop("checked")?window.localStorage.setItem("loginuserid",v):(window.localStorage.setItem("loginuserid",""),window.localStorage.removeItem("loginuserid"));var I=g.get("device.platform");l="Android"==I?p:p;var w=(new Date).getTime(),y=EncryptWithDynamicSalt(l,w),D=null==l?"":l;checkSumEncrypt(D);var k,C=localStorage.getItem("FINALCHECKSUM"),F=getDeviceId(),T=/iPad|iPhone|iPod/.test(navigator.userAgent);k=T?"IOSMOBILE":"ANDROIDMOBILE",g.set("loginType","Userlogin"),t.collection.fetch({data:e.param({userId:y,appchecksum:C,deviceid:F,platform:k,biometriclogintype:"login",appVersion:g.get("app.versionCode"),userflag:"Y",salt:w}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(g.get("calltimeout")),success:function(e){"0000"==ackStatus?s(e):c(e)},error:c})},securesystimeencuserLogin:function(){var t=this,i=(getDeviceId(),getDeviceId(),function(e){"OTP"==g.get("userstatus")?t.frequentMigratedUser():t.securesystimeencuser()}),n=function(e){t.errorresponse()};t.collection=new s,t.collection.fetch({data:e.param({ulpId:g.get("ulpID")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?i(e):n(e)},error:n})},securesystimeencuser:function(){this.model=new a({url:"json/"}),this.$(".alert").hide(),i.Validation.bind(this);var t=this.$("form").serializeObject();if(this.model.set(t,{validate:!0})){var n=this,o=getDeviceId(),r=e("#password").val(),s=r.charAt(r.length-1);" "===s&&(r=r.trim()),g.set("oldpasswrd",r);var l=g.get("loginuser_id"),d=(new Date).getTime(),p=EncryptWithDynamicSalt(l,d);rand=Math.floor(9e4*Math.random())+1e5,d=rand+"";var u=g.get("ulpID");r.length>0&&(plainText=u+r,checkSumEncryptlogin(plainText),finalHash=localStorage.getItem("LOGINCHECKSUM"));var h=g.get("dynamicToken"),f=g.get("timepassphrase"),m=DEcryptWithDynamicSalt(h,f),v="BRAC"+o+l+finalHash+"~"+m,I=CryptoJS.SHA512(v)+"";showSpinner();var w,y=function(e){n.forcePass()},D=function(e){n.errorresponse()},k=(e.param({deviceid:o,lang_id:g.get("language"),ulpId:g.get("ulpID"),client_id:g.get("ulpID"),allowedIp:"true",j_username:p,j_password:finalHash,username:g.get("ulpID"),password:finalHash,scope:"read,write",grant_type:"password",response_type:"token",userflag:"Y",salt:d}),/iPad|iPhone|iPod/.test(navigator.userAgent));w=k?"IOSMOBILE":"ANDROIDMOBILE";var C=g.get("networkproviderip"),d=(new Date).getTime(),F=isNull(g.get("data_registrationId"))?"N":!isNull(g.get("data_registrationId"))&&isNull(g.get("isNotificationEnable"))?"Y":g.get("isNotificationEnable");C=EncryptWithDynamicSalt(C,d),n.collection=new c,n.collection.fetch({data:e.param({cliIp:C,salt:d,push_flg:F,device_token:g.get("data_registrationId"),mtc_token:I,deviceid:o,lang_id:g.get("language"),ulpId:g.get("ulpID"),client_id:g.get("ulpID"),allowedIp:"true",j_username:"xxxxxxxx",j_password:finalHash,username:g.get("ulpID"),password:finalHash,scope:"read,write",grant_type:"password",response_type:"token",osversion:g.get("device.version"),paltform:w,appversion:g.get("app.versionCode"),model:g.get("device.model"),userflag:"Y"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?y(e):D(e)},error:D})}else this.$(".alert-error").fadeIn(),i.Validation.unbind(event)},forcePass:function(){var t=this,n=((new Date).getTime(),function(e){"Y"==g.get("forceflag")?(hideSpinner(),g.set("isCardlessCustomer","false"),i.history.navigate("#/cardlessuser")):t.loginaskverify()}),o=function(e){t.errorresponse()};t.collection=new l([],{}),t.collection.fetch({data:e.param({flag:"",access_token:g.get("access_token")}),dataType:"json",type:"POST",timeout:parseInt(g.get("calltimeout")),cache:!1,success:function(e){"0000"==ackStatus?(n(e),g.set("activate_user","force")):o(e)},error:o})},loginaskverify:function(){var e=this,t=g.get("forceflag"),n="NO";try{n=window.localStorage.getItem("FirstTimeLoginChk")}catch(o){n="NO"}var a=g.get("mpincheck_server"),r="";try{r=g.get("mpincheck_local")}catch(o){r="NO"}var s=(g.get("mpinStatus"),g.get("userstatus"));"DONE"!=n?"ACT"==s?(g.set("isFABData","false"),g.set("isExpiryPopup","false"),g.set("isWalletCCPCData","false"),g.set("isCreditCardData","false"),g.set("isPrepaidCardData","false"),g.set("isDepositDetailsDTO","false"),g.set("isCreditPrepaidCardData","false"),g.set("isFromLogin","true"),"I"==g.get("intermediateFlag")?i.history.navigate("#/fullrightsnotification",{trigger:!0,replace:!0}):i.history.navigate("#/landinglayout",{trigger:!0,replace:!0})):"FAC"==s?(hideSpinner(),g.set("isCardlessCustomer","true"),i.history.navigate("#/cardlessuser",{trigger:!0,replace:!0})):"OTP"==s?e.frequentMigratedUser():(hideSpinner(),i.history.navigate("#/setsecureques",{trigger:!0,replace:!0})):"Y"==t?i.history.navigate("#/forgotPasswordMsg",{trigger:!0,replace:!0}):(g.set("isFABData","false"),g.set("isExpiryPopup","false"),g.set("isCreditCardData","false"),g.set("isWalletCCPCData","false"),g.set("isPrepaidCardData","false"),g.set("isDepositDetailsDTO","false"),g.set("isCreditPrepaidCardData","false"),g.set("isFromLogin","true"),"I"==g.get("intermediateFlag")?i.history.navigate("#/fullrightsnotification",{trigger:!0,replace:!0}):i.history.navigate("#/landinglayout",{trigger:!0,replace:!0}));var c="N";"mpinch"==r&&(c="Y");var l="N";"mpinch"==a&&(l="Y")},frequentMigratedUser:function(){var t=this,n=((new Date).getTime(),(new Date).getTime()),o=e("#password").val(),a=EncryptWithDynamicSalt(o,n),r=function(e){hideSpinner(),i.history.navigate("#/migratedsetpassword")},s=function(e){t.errorresponse()};t.collection=new d([],{}),t.collection.fetch({data:e.param({userId:g.get("loginuser_id"),pwd:a,salt:n,deviceid:getDeviceId()}),dataType:"json",type:"POST",timeout:parseInt(g.get("calltimeout")),cache:!1,success:function(e){"0000"==ackStatus?r(e):s(e)},error:s})},gotoDashboard:function(e){this.model=new a({url:"json/"}),i.Validation.bind(this);var t=this.$("form").serializeObject();this.model.set(t,{validate:!0})?(this.model.clear(),i.Validation.unbind(this),showSpinner(),i.history.navigate("#/secureques")):(this.$(".has-error").fadeIn(),e.preventDefault())},loadForgotUsernameUI:function(){g.set("isforgotUsername","true"),i.history.navigate("#/forgotusername")},loadForgotPasswordUI:function(){var t=e("#username").val();""!==t||null!==t?g.set("preloginUsername",t):g.set("preloginUsername",""),g.set("isforgotUsername","false"),i.history.navigate("#/forgotpasswordnew")},loadForgotMpinUI:function(){i.history.navigate("#/forgotMpin")},gotoNewRegistration:function(){i.history.navigate("#/reginfo")},loadLocatorUI:function(){loadGoogleMapJS()},backToTouchIDUI:function(){i.history.navigate("#/landing")},errorresponse:function(e){hideSpinner(),openErrorPopup()}});return u});