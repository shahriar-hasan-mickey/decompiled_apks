define(["jquery","underscore","Backbone","collections/login/forgotPasswordOTPCollections","collections/applanding/Registration/cardPinValidationCollections","collections/login/generateSoftTokenCollections","collections/applanding/Registration/otpGenerationCollections","collections/applanding/Registration/otpVerificationCollections","collections/applanding/Registration/getAuthModeCollections","text!views/login/forgotpasswordconfirm.tpl"],function(t,e,o,i,n,r,a,l,s,c){var p=null,d=new EncryptedLocalStorage("secret"),u=o.View.extend({el:"#container",events:{"click #verify_btn":"gotoVerifySuccessPopUp","click #next_btn":"verifyOTP","click #cancel_btn":"backToLogin","click #popup_cancel_btn":"revokeOTPSpinner","click #close_btn":"revokeOTPSpinner"},initialize:function(){},update:function(){var t=this;p=null,t.getAuthmode()},getAuthmode:function(){var e=this;d.set("IsAuthMode","false"),t("#Forgot_alert_authmodeDiv").html("");var o=function(t){hideSpinner();var o=d.get("securitySettingList");!isNull(o)&&o.length>0?d.set("IsAuthMode","true"):(d.set("alertType",null),d.set("IsAuthMode","false")),e.populateAuthMode()},i=function(t){hideSpinner(),d.set("IsAuthMode","false"),e.populateAuthMode()};showSpinner(),e.collection=new s,e.collection.fetch({data:t.param({access_token:d.get("access_token"),transactionAmount:null,tenantServiceCode:"FORGOT_PASSWORD",ulpId:d.get("ulpID")}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?o(t):i(t)},error:i})},populateAuthMode:function(){var o="",i="",n=this;n.$el.html(e.template(c)),t("#accCardNumberLabel").html("Account Number");var r=d.get("securitySettingList"),a="<label for='username'>"+t.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";a+="<div class='custRadio_pass'>",!isNull(r)&&r.length>0?(t("#Forgot_alert_authmodeDiv").html(""),t.each(r,function(e,n){"SMS"==n?(o="sms",i=t.i18n.t("app.transfer.managebeneficiary.sms")):"EMAIL"==n?(o="mail",i=t.i18n.t("app.transfer.managebeneficiary.mail")):"TOKEN"==n?(o="fScan",i=t.i18n.t("app.transfer.managebeneficiary.token")):"ESIGN"==n&&(o="esign",i=t.i18n.t("app.transfer.managebeneficiary.esign")),a+='<div class="box"><div class="radio"><label>',a+=0==e?'<input type="radio" name="forgot_psw_authmode" id="optionsRadios'+e+'" value="'+n+'" checked>':'<input type="radio" name="forgot_psw_authmode" id="optionsRadios'+e+'" value="'+n+'">',a+='<div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs '+o+'"></span><span class="small">'+i+"</span></div></div></label></div></div>"}),t("#Forgot_alert_authmodeDiv").html(a)):t("#Forgot_alert_authmodeDiv").html("")},verifyOTP:function(){t("#error_card").html(""),t("#error_pin").html(""),t("#otpNullError").html(""),t("#otpNullErrorDiv").hide();var e=this,o=/[0-9]/g,i=t("#card_number").val(),n=t("#mpininput").val();return""==i?("DC"==d.get("cardType")&&(2==d.get("isInputVisible")?t("#error_card").html(t.i18n.t("Please enter the second 4 digit of your debit card number")):t("#error_card").html(t.i18n.t("Please enter the third 4 digit of your debit card number"))),void("CC"==d.get("cardType")&&(2==d.get("isInputVisible")?t("#error_card").html(t.i18n.t("Please enter the second 4 digit of your credit card number")):t("#error_card").html(t.i18n.t("Please enter the third 4 digit of your credit card number"))))):i.length<4?("DC"==d.get("cardType")&&(2==d.get("isInputVisible")?t("#error_card").html(t.i18n.t("Please enter the second 4 digit of your debit card number")):t("#error_card").html(t.i18n.t("Please enter the third 4 digit of your debit card number"))),void("CC"==d.get("cardType")&&(2==d.get("isInputVisible")?t("#error_card").html(t.i18n.t("Please enter the second 4 digit of your credit card number")):t("#error_card").html(t.i18n.t("Please enter the third 4 digit of your credit card number"))))):i.match(o)?n.length<4?void t(".pincode-input-error").html(t.i18n.t("app.forgotpassword.errvalpin")):n.match(o)?void e.cardPinValidation():void t(".pincode-input-error").html(t.i18n.t("validation.newregistration.pinnumberonly")):void t("#error_card").html(t.i18n.t("validation.newregistration.cardnumberonly"))},cardPinValidation:function(){for(var e=t("#card_number").val(),o=t("#mpininput").val(),i=[],r=d.get("cardnumber"),a=0,l=r.length;l>a;a+=4)i.push(r.substring(a,a+4));var s=d.get("isInputVisible");2==s?cardnum=i[0]+e+"****"+i[3]:cardnum=i[0]+"****"+e+i[3];var c=this,p=d.get("shadowAccountNumber"),u=(new Date).getTime();d.set("saltreg",u),ccnum=EncryptWithDynamicSalt(cardnum,u),ccpinnum=EncryptWithDynamicSalt(o,u),shadowacntnum=EncryptWithDynamicSalt(p,u);var h=function(t){hideSpinner(),c.validateCardPin()},g=function(t){hideSpinner(),c.errorresponse()};showSpinner(),c.collection=new n;getDeviceId(),(new Date).getTime();c.collection.fetch({data:t.param({ccno:ccnum,ccpinno:ccpinnum,shadowAccountNumber:shadowacntnum,salt:u,cardtype:d.get("cardtype"),flag:"FP"}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?h(t):g(t)},error:g})},validateCard:function(e){var o="",i="",n="";t(".otp_msg_txt").html("");var r=t("input[name='forgot_psw_authmode']:checked").val();d.set("alertType",r),"SMS"==r?(i=d.get("mobileNo"),o=null):"EMAIL"==r&&(i=null,o=d.get("emailID")),d.set("mobilenum",i),d.set("eMailId",o);var l=this,s=function(o){hideSpinner(),"Y"==e&&(t("#OTPcontainer1").slideDown("slow"),p.set(1),p.animate(0,function(){t("#OTPcontainer1").slideUp("slow")})),t("#verify").modal("show"),t("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").removeAttr("data"),"SMS"==d.get("alertType")?(t("#titleAuth").html(t.i18n.t("app.registration.opthelptext")+" "+maskMobile(d.get("mobilenum"))),t("#myModalLabel").html(t.i18n.t("app.registration.otpothersheadertext")),t("#challengeText").html(""),t("#OTPcontainer1").show(),t("#resend_forgot_btn").show()):"EMAIL"==d.get("alertType")?(t("#titleAuth").html(t.i18n.t("app.registration.opthelpemailtext")+" "+maskEmailID(d.get("emailID"))),t("#myModalLabel").html(t.i18n.t("app.registration.otpothersheadertext")),t("#challengeText").html(""),t("#OTPcontainer1").show(),t("#resend_forgot_btn").show()):"TOKEN"==d.get("alertType")?(t("#titleAuth").html(t.i18n.t("app.registration.opthelptokentext")),t("#myModalLabel").html(t.i18n.t("app.registration.otptokenheadertext")),t("#challengeText").html(""),t("#OTPcontainer1").hide(),t("#resend_forgot_btn").hide()):"ESIGN"==d.get("alertType")&&(t("#titleAuth").html(t.i18n.t("app.registration.otphelpesigntext")),t("#myModalLabel").html(t.i18n.t("app.registration.otpothersheadertext")),t("#challengeText").html(t.i18n.t("app.transferss.genratedTocn")+" "+d.get("otpCode")),t("#OTPcontainer1").hide(),t("#resend_forgot_btn").hide()),setTimeout(function(){t("#otp1").focus()},500),t("#otpNullError").html(""),t("#otpNullErrorDiv").hide(),t(".inputs").on("input",function(e){e.stopImmediatePropagation();var o=e.currentTarget.id,i=t("#"+o).val();t("#"+o).attr("data",i),t("#"+o).val(i.replace(/[^\*]/,"."))}),t("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""),"SMS"==d.get("alertType")?n=t.i18n.t("app.registration.opthelptext")+" "+maskMobile(d.get("mobileNo")):"EMAIL"==d.get("alertType")&&(n=t.i18n.t("app.registration.opthelpemailtext")+" "+maskEmailID(d.get("emailID"))),t(".otp_msg_txt").html(n),("SMS"==d.get("alertType")||"EMAIL"==d.get("alertType"))&&l.invokeOTPSpinner()},c=function(t){l.errorresponse()},u=d.get("customerIDs"),h=d.get("saltreg"),g=DEcryptWithDynamicSalt(u,h);cusId=EncryptWithDynamicSalt(g,h);var l=this;showSpinner(),l.collection=new a;getDeviceId(),(new Date).getTime();l.collection.fetch({data:t.param({salt:h,cifId:cusId,mobileNumber:d.get("mobilenum"),email:d.get("eMailId"),serviceProvider:null,resendflag:e,alerttype:d.get("alertType"),servicecode:"FORGOT_PASSWORD"}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?s(t):c(t)},error:c})},invokeOTPSpinner:function(){var e=this;return t("#resend_forgot_btn").hide(),t("#OTPcontainer1").show(),t("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""),null!=p?(p.set(1),void p.animate(0,function(){t("#OTPcontainer1").slideUp("slow")})):(p=new ProgressBar.Circle(OTPcontainer1,{color:"#333",strokeWidth:8,trailWidth:8,easing:"linear",duration:6e4*parseInt(d.get("otpExpiryPeriod")),text:{autoStyleContainer:!1},from:{color:"#ec5f59",width:8},to:{color:"#ec5f59",width:8},step:function(e,o){o.path.setAttribute("stroke",e.color),o.path.setAttribute("stroke-width",e.width);var i=Math.round(o.value()*(60*d.get("otpExpiryPeriod")));"0"==i?(o.setText(""),t("#resend_forgot_btn").show()):(t("#resend_forgot_btn").hide(),o.setText(i+"s"))}}),p.text.style.fontFamily='"Raleway", Helvetica, sans-serif',p.text.style.fontSize="12px",p.text.style.fontWeight="bold",p.set(1),p.animate(0,function(){t("#OTPcontainer1").slideUp("slow")}),void t("#resend_forgot_btn").click(function(){e.validateCard("Y")}))},revokeOTPSpinner:function(){null!=p&&p.stop()},validateCardPin:function(){var e=this,o=d.get("securitySettingList");if(!isNull(o)&&o.length>0){d.set("IsAuthMode","true");var i=t("input[name='forgot_psw_authmode']:checked").val();d.set("authmode",i),"SMS"==i||"EMAIL"==i||"ESIGN"==i?e.validateCard("N"):"TOKEN"==i&&(d.set("otpCode",""),d.set("alertType",i),t("#verify").modal("show"),t("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").removeAttr("data"),"TOKEN"==d.get("alertType")&&(t("#titleAuth").html(t.i18n.t("app.registration.opthelptokentext")),t("#myModalLabel").html(t.i18n.t("app.registration.otptokenheadertext")),t("#challengeText").html(""),t("#OTPcontainer1").hide(),t("#resend_forgot_btn").hide()),t("#otpNullError").html(""),t("#otpNullErrorDiv").hide(),t(".inputs").on("input",function(e){e.stopImmediatePropagation();var o=e.currentTarget.id,i=t("#"+o).val();t("#"+o).attr("data",i),t("#"+o).val(i.replace(/[^\*]/,"."))}),t("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""))}else d.set("alertType",null),d.set("IsAuthMode","false"),e.gotoResetPasswordPage()},gotoVerifySuccessPopUp:function(){t("#otpNullError").html(""),t("#otpNullErrorDiv").hide();var e=t("#otp1").attr("data"),o=t("#otp2").attr("data"),i=t("#otp3").attr("data"),n=t("#otp4").attr("data"),r=t("#otp5").attr("data"),a=t("#otp6").attr("data");if(isNull(e)||isNull(o)||isNull(i)||isNull(n)||isNull(r)||isNull(a))return t("#otpNullErrorDiv").show(),void t("#otpNullError").html(t.i18n.t("validation.newregistration.otpnotnull"));var s=e+o+i+n+r+a,c=this,p=function(e){t("#verify").modal("hide"),c.revokeOTPSpinner(),c.gotoResetPasswordPage()},u=function(e){hideSpinner(),isNull(d.get("errordesc"))||(t("#otpNullErrorDiv").show(),t("#otpNullError").html(d.get("errordesc")))},h=d.get("customerIDs"),g=d.get("saltreg"),m=DEcryptWithDynamicSalt(h,g);cusId=EncryptWithDynamicSalt(m,g);var c=this;showSpinner(),c.revokeOTPSpinner(),c.collection=new l;getDeviceId(),(new Date).getTime();c.collection.fetch({data:t.param({activationno:s,salt:g,cifId:cusId,mobileNumber:d.get("mobilenum"),email:d.get("eMailId"),serviceProvider:null,servicecode:"FORGOT_PASSWORD",uniqueId:d.get("otpCode"),twoFAType:d.get("alertType")}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?p(t):u(t)},error:u})},generateToken:function(){var e=this,o=function(o){hideSpinner(),t("#verify").modal("show"),t("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").removeAttr("data"),setTimeout(function(){t("#otp1").focus()},500),e.invokeOTPSpinner()},i=function(t){e.errorresponse()};showSpinner();var n=d.get("customerIDs"),a=d.get("saltreg"),l=DEcryptWithDynamicSalt(n,a),s=EncryptWithDynamicSalt(l,a);e.collection=new r;getDeviceId();e.collection.fetch({data:t.param({cifNo:s,salt:a,tokenType:"SOFT",ulpId:d.get("ulpID")}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?o(t):i(t)},error:i})},gotoResetPasswordPage:function(){hideSpinner(),o.history.navigate("#/forgotpasswordsuccess")},backToLogin:function(){o.history.navigate("#/login")},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(t){return o.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=t,this.currentView.delegateEvents(),this.currentView}});return u});