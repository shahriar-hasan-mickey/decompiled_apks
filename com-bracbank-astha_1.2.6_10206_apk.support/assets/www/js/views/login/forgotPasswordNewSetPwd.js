define(["jquery","underscore","Backbone","text!views/login/forgotPasswordNewSetPwd.tpl","collections/applanding/Registration/getAuthModeCollections","collections/applanding/Registration/otpGenerationCollections","collections/applanding/Registration/otpVerificationCollections","collections/login/forgotPasswordSuccessCollections"],function(t,e,r,o,a,i,n,s){var l=null,p=new EncryptedLocalStorage("secret"),d=r.View.extend({el:"#container",events:{"keyup #password":"forgotPasswordChange","keyup #confpassword":"forgotConfirmPasswordChange","click #forgotPwd_next_btn":"gotoOTPGeneration","click #verify_btn":"gotoVerifySuccessPopUp","click #login_btn":"backToLogin","click #forgotPwd_cancel_btn":"gotoPreviousPage"},initialize:function(){},update:function(){l=null;var t=this;t.getAuthMode()},getAuthMode:function(r){"object"==typeof r&&r.stopImmediatePropagation();var i=this;p.set("IsAuthMode","false"),t("#forgotPassword_AuthModeDiv").html("");var n=function(r){hideSpinner(),i.$el.html(e.template(o)),t("div").removeClass("modal-backdrop fade in");var a=p.get("securitySettingList");!isNull(a)&&a.length>0?p.set("IsAuthMode","true"):(p.set("alertType",null),p.set("IsAuthMode","false")),i.populateAuthMode()},s=function(t){hideSpinner(),p.set("IsAuthMode","false"),i.populateAuthMode()};showSpinner(),i.collection=new a,i.collection.fetch({data:t.param({access_token:p.get("access_token"),transactionAmount:null,tenantServiceCode:"FORGOT_PASSWORD",ulpId:p.get("forgotPwdUlpID")}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?n(t):s(t)},error:s})},populateAuthMode:function(){var e="",r="",o=p.get("securitySettingList"),a="<label for='username'>"+t.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";a+="<div class='custRadio_pass'>",!isNull(o)&&o.length>0?(t("#forgotPassword_AuthModeDiv").html(""),t.each(o,function(o,i){"SMS"==i?(e="sms",r=t.i18n.t("app.transfer.managebeneficiary.sms")):"EMAIL"==i?(e="mail",r=t.i18n.t("app.transfer.managebeneficiary.mail")):"TOKEN"==i?(e="fScan",r=t.i18n.t("app.transfer.managebeneficiary.token")):"ESIGN"==i&&(e="esign",r=t.i18n.t("app.transfer.managebeneficiary.esign")),a+='<div class="box"><div class="radio"><label>',a+=0==o?'<input type="radio" name="forgot_psw_authmode" id="optionsRadios'+o+'" value="'+i+'" checked>':'<input type="radio" name="forgot_psw_authmode" id="optionsRadios'+o+'" value="'+i+'">',a+='<div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs '+e+'"></span><span class="small">'+r+"</span></div></div></label></div></div>"}),t("#forgotPassword_AuthModeDiv").html(a)):t("#forgotPassword_AuthModeDiv").html("")},forgotPasswordChange:function(){t("#passwordError").html(""),t("#confirmPasswordError").html("");var e=/[0-9]/g,r=t("#password").val(),o=t("#confpassword").val(),a=p.get("pwdpolicy"),i=/[a-z\u0600-\u06FF]/g,n=/[A-Z\u0600-\u06FF]/g,s=/^[A-Z]/,l=/^[a-z]/,d=/^[0-9]/,c=/^[!@#$%^&*()-_+~.]/,u=/^[a-zA-Z]/;if(""==r||null==r)return t("#passwordError").html(t.i18n.t("validation.newregistration.pwdnotnull")),!1;if("U"===a.firstCharacterValue){if(!s.test(r))return t("#passwordError").html(t.i18n.t("app.login.errUP")),!1}else if("L"===a.firstCharacterValue){if(l.test(r))return t("#passwordError").html(t.i18n.t("app.login.errLOW")),!1}else if("N"===a.firstCharacterValue){if(d.test(r))return t("#passwordError").html(t.i18n.t("app.login.errNUM")),!1}else if("S"===a.firstCharacterValue){if(c.test(r))return t("#passwordError").html(t.i18n.t("app.login.errSpecl")),!1}else if("A"===a.firstCharacterValue&&!u.test(r))return t("#passwordError").html(t.i18n.t("First Character should be an alphabet")),!1;if(r.length<a.minimumLength)return t("#passwordError").html(t.i18n.t("app.login.pwderrlength1")+" "+a.minimumLength+" "+t.i18n.t("app.login.pwderrlength2")+" "+a.maximumLength+" "+t.i18n.t("app.login.pwderrlength3")),!1;if(r.length>a.maximumLength)return t("#passwordError").html(t.i18n.t("app.login.pwderrmaxlen")+" "+a.maximumLength+" "+t.i18n.t("app.login.pwderrlength3")),!1;var h=r.search(e);if("Y"===a.numeralsMandatory&&"-1"==h)return t("#passwordError").html(t.i18n.t("app.login.errnumber")),!1;var g=r.search(i);if("Y"===a.lowercaseMandatory&&"-1"==g)return t("#passwordError").html(t.i18n.t("app.login.errlwr")),!1;var m=r.search(n);if("Y"===a.uppercaseMandatory)if("U"===a.firstCharacterValue){if(-1==m||0!==m)return t("#passwordError").html(t.i18n.t("app.login.errupr")),!1}else if(-1==m)return t("#passwordError").html(t.i18n.t("app.login.errupr")),!1;if("Y"===a.specialCharactersMandatory)if(isNull(a.disallowedCharacters)){var f=!1,w=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;if(w.test(r)||(f=!0),f)return isError=!0,void t("#passwordError").html(t.i18n.t("app.login.errspc"))}else{for(var v=a.disallowedCharacters,E=!1,y=0;y<r.length;y++){var P=r[y];-1!=v.indexOf(P)&&(E=!0)}if(E)return isError=!0,void t("#passwordError").html("Entered password does not match with password policy "+a.disallowedCharacters+" are not allowed");var f=!1,w=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;if(w.test(r)||(f=!0),f)return isError=!0,void t("#passwordError").html(t.i18n.t("app.login.errspc"))}var S=r.toLowerCase();if("N"===a.repeatingValueAllowedInPwd)for(var y=0;y<S.length;y++){var P=S[y],T=S[y+1];if(P===T&&P===S[y+2])return isError=!0,void t("#passwordError").html(t.i18n.t("app.login.errcon"))}if("N"===a.seqValueAllowedInPwd){if(S.match(/([a-zA-Z0-9])\1\1+|(abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|jkl|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz|ABC|BCD|CDE|DEF|EFG|FGH|GHI|HIJ|IJK|JKL|KLM|LMN|MNO|NOP|OPQ|PQR|QRS|RST|STU|TUV|UVW|VWX|WXY|XYZ|012|123|234|345|456|567|678|789)+/g))return isError=!0,void t("#passwordError").html(t.i18n.t("app.login.errconseq"));for(var b=0,y=0;y<S.length-1;y++){var I=parseInt(S[y])+1;S[y+1]==I&&S[y]!=S[y+1]&&b++}if(4==b)return isError=!0,void t("#passwordError").html(t.i18n.t("app.login.errconseq"))}return(""!=r||null!=r)&&""==o||null==o?(t("#confirmPasswordError").html(t.i18n.t("validation.newregistration.confpwdnotnull")),!1):""!=r&&""!=o&&r!=o?(t("#confirmPasswordError").html(t.i18n.t("validation.newregistration.pwdmismatch")),!1):void 0},forgotConfirmPasswordChange:function(){t("#confirmPasswordError").html("");var e=t("#confpassword").val();return""==e||null==e?(t("#confirmPasswordError").html(t.i18n.t("validation.newregistration.confpwdnotnull")),!1):void 0},gotoOTPGeneration:function(e){"object"==typeof e&&e.stopImmediatePropagation(),t("#passwordError").html(""),t("#confirmPasswordError").html("");var r=/[0-9]/g,o=this,a=!1,i=t("#password").val(),n=t("#confpassword").val(),s=p.get("pwdpolicy"),l=/[a-z\u0600-\u06FF]/g,d=/[A-Z\u0600-\u06FF]/g,c=/^[A-Z]/,u=/^[a-z]/,h=/^[0-9]/,g=/^[!@#$%^&*()-_+~.]/,m=/^[a-zA-Z]/;if((""==i||null==i)&&(a=!0,t("#passwordError").html(t.i18n.t("validation.newregistration.pwdnotnull"))),(""==n||null==n)&&(a=!0,t("#confirmPasswordError").html(t.i18n.t("validation.newregistration.confpwdnotnull"))),""==i||null==i)return a=!0,void t("#passwordError").html(t.i18n.t("validation.newregistration.pwdnotnull"));if("U"===s.firstCharacterValue){if(!c.test(i))return a=!0,void t("#passwordError").html(t.i18n.t("app.login.errUP"))}else if("L"===s.firstCharacterValue){if(u.test(i))return a=!0,void t("#passwordError").html(t.i18n.t("app.login.errLOW"))}else if("N"===s.firstCharacterValue){if(h.test(i))return a=!0,t("#passwordError").html(t.i18n.t("app.login.errNUM")),!1}else if("S"===s.firstCharacterValue){if(g.test(i))return a=!0,t("#passwordError").html(t.i18n.t("app.login.errSpecl")),!1}else if("A"===s.firstCharacterValue&&!m.test(i))return t("#passwordError").html(t.i18n.t("First Character should be an alphabet")),!1;if(i.length<s.minimumLength)return a=!0,void t("#passwordError").html(t.i18n.t("app.login.pwderrlength1")+" "+s.minimumLength+" "+t.i18n.t("app.login.pwderrlength2")+" "+s.maximumLength+" "+t.i18n.t("app.login.pwderrlength3"));if(i.length>s.maximumLength)return a=!0,void t("#passwordError").html(t.i18n.t("app.login.pwderrmaxlen")+" "+s.maximumLength+" "+t.i18n.t("app.login.pwderrlength3"));var f=i.search(r);if("Y"===s.numeralsMandatory&&"-1"==f)return a=!0,void t("#passwordError").html(t.i18n.t("app.login.errnumber"));var w=i.search(l);if("Y"===s.lowercaseMandatory&&"-1"==w)return a=!0,void t("#passwordError").html(t.i18n.t("app.login.errlwr"));var v=i.search(d);if("Y"===s.uppercaseMandatory)if("U"===s.firstCharacterValue){if(-1==v||0!==v)return t("#passwordError").html(t.i18n.t("app.login.errupr")),!1}else if(-1==v)return t("#passwordError").html(t.i18n.t("app.login.errupr")),!1;if("Y"===s.specialCharactersMandatory)if(isNull(s.disallowedCharacters)){var E=!1,y=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;if(y.test(i)||(E=!0),E)return a=!0,void t("#passwordError").html(t.i18n.t("app.login.errspc"))}else{for(var P=s.disallowedCharacters,S=!1,T=0;T<i.length;T++){var b=i[T];-1!=P.indexOf(b)&&(S=!0)}if(S)return a=!0,void t("#passwordError").html("Entered password does not match with password policy "+s.disallowedCharacters+" are not allowed");var E=!1,y=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;if(y.test(i)||(E=!0),E)return a=!0,void t("#passwordError").html(t.i18n.t("app.login.errspc"))}var I=i.toLowerCase();if("N"===s.repeatingValueAllowedInPwd)for(var T=0;T<I.length;T++){var b=I[T],M=I[T+1];if(b===M&&b===I[T+2])return a=!0,void t("#passwordError").html(t.i18n.t("app.login.errcon"))}if("N"===s.seqValueAllowedInPwd){if(I.match(/([a-zA-Z0-9])\1\1+|(abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|jkl|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz|ABC|BCD|CDE|DEF|EFG|FGH|GHI|HIJ|IJK|JKL|KLM|LMN|MNO|NOP|OPQ|PQR|QRS|RST|STU|TUV|UVW|VWX|WXY|XYZ|012|123|234|345|456|567|678|789)+/g))return a=!0,void t("#passwordError").html(t.i18n.t("app.login.errconseq"));for(var _=0,T=0;T<I.length-1;T++){var C=parseInt(I[T])+1;I[T+1]==C&&I[T]!=I[T+1]&&_++}if(4==_)return a=!0,void t("#passwordError").html(t.i18n.t("app.login.errconseq"))}return(""!=i||null!=i)&&""==n||null==n?(a=!0,void t("#confirmPasswordError").html(t.i18n.t("validation.newregistration.confpwdnotnull"))):""!=i&&""!=n&&i!=n?(a=!0,void t("#confirmPasswordError").html(t.i18n.t("validation.newregistration.pwdmismatch"))):void(a||o.generateOTP(e))},generateOTP:function(e){"object"==typeof e&&e.stopImmediatePropagation();var r=this,o=p.get("securitySettingList");if(!isNull(o)&&o.length>0){p.set("IsAuthMode","true");var a=t("input[name='forgot_psw_authmode']:checked").val();p.set("authmode",a),"SMS"==a||"EMAIL"==a||"ESIGN"==a?r.validateCard("N"):"TOKEN"==a&&(p.set("otpCode",""),p.set("alertType",a),t("#verify").modal("show"),t("#verify_btn").attr("disabled",!1),t("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").removeAttr("data"),"TOKEN"==p.get("alertType")&&(t("#titleAuth").html(t.i18n.t("app.registration.opthelptokentext")),t("#myModalLabel").html(t.i18n.t("app.registration.otptokenheadertext")),t("#challengeText").html(""),t("#OTPcontainer1").hide(),t("#resend_forgot_btn").hide()),t("#otpNullError").html(""),t("#otpNullErrorDiv").hide(),t(".inputs").on("input",function(e){e.stopImmediatePropagation();var r=e.currentTarget.id,o=t("#"+r).val();t("#"+r).attr("data",o),t("#"+r).val(o.replace(/[^\*]/,"."))}),t("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""))}else p.set("alertType",null),p.set("IsAuthMode","false"),r.forgotPasswordChangeSuccess()},gotoVerifySuccessPopUp:function(){t("#otpNullError").html(""),t("#otpNullErrorDiv").hide();var e=t("#otp1").attr("data"),r=t("#otp2").attr("data"),o=t("#otp3").attr("data"),a=t("#otp4").attr("data"),i=t("#otp5").attr("data"),s=t("#otp6").attr("data");if(isNull(e)||isNull(r)||isNull(o)||isNull(a)||isNull(i)||isNull(s))return t("#otpNullErrorDiv").show(),void t("#otpNullError").html(t.i18n.t("validation.newregistration.otpnotnull"));var l=e+r+o+a+i+s,d=this,c=function(e){t("#verify").modal("hide"),d.revokeOTPSpinner(),d.forgotPasswordChangeSuccess(event)},u=function(e){hideSpinner(),isNull(p.get("errordesc"))||(t("#otpNullErrorDiv").show(),t("#otpNullError").html(p.get("errordesc")),"Maximum OTP tries exceeded;"==p.get("errordesc")&&t("#verify_btn").attr("disabled",!0))},h=p.get("customerIDs"),g=p.get("saltreg"),m=DEcryptWithDynamicSalt(h,g);cusId=EncryptWithDynamicSalt(m,g);var d=this;showSpinner(),d.revokeOTPSpinner(),d.collection=new n;getDeviceId(),(new Date).getTime();d.collection.fetch({data:t.param({activationno:l,salt:g,cifId:cusId,mobileNumber:p.get("mobilenum"),email:p.get("eMailId"),serviceProvider:null,servicecode:"FORGOT_PASSWORD",uniqueId:p.get("otpCode"),twoFAType:p.get("alertType")}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?c(t):u(t)},error:u})},forgotPasswordChangeSuccess:function(e){"object"==typeof e&&e.stopImmediatePropagation();var o=t("#password").val(),a=(new Date).getTime();o=EncryptWithDynamicSalt(o,a);var i=function(e){hideSpinner(),"Y"==p.get("isMigUser")?(p.set("migratedPassword",t("#password").val()),p.set("isMigUserForgotpassword","true"),r.history.navigate("#/migratedauthmode")):t("#success").modal("show")},n=function(t){hideSpinner(),l.errorresponse()},l=this;showSpinner(),l.collection=new s;var d=p.get("userName"),c=EncryptWithDynamicSalt(d,a);checkSumEncrypt(p.get("userName")+o),l.collection.fetch({data:t.param({newpassword:o,salt:a,userLogin:c,ulpId:p.get("forgotUserNameUlpID"),userflag:"Y"}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?i(t):n(t)},error:n})},validateCard:function(e){var r="",o="",a="";t(".otp_msg_txt").html("");var n=t("input[name='forgot_psw_authmode']:checked").val();p.set("alertType",n),"SMS"==n?(o=p.get("mobileNo"),r=null):"EMAIL"==n&&(o=null,r=p.get("emailID")),p.set("mobilenum",o),p.set("eMailId",r);var s=this,d=function(r){hideSpinner(),"Y"==e&&(t("#OTPcontainer1").slideDown("slow"),l.set(1),l.animate(0,function(){t("#OTPcontainer1").slideUp("slow")})),t("#verify").modal("show"),t("#verify_btn").attr("disabled",!1),t("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").removeAttr("data"),"SMS"==p.get("alertType")?(t("#titleAuth").html(t.i18n.t("app.registration.opthelptext")+" "+maskMobile(p.get("mobilenum"))),t("#myModalLabel").html(t.i18n.t("app.registration.otpothersheadertext")),t("#challengeText").html(""),t("#OTPcontainer1").show(),t("#resend_forgot_btn").show()):"EMAIL"==p.get("alertType")?(t("#titleAuth").html(t.i18n.t("app.registration.opthelpemailtext")+" "+maskEmailID(p.get("emailID"))),t("#myModalLabel").html(t.i18n.t("app.registration.otpothersheadertext")),t("#challengeText").html(""),t("#OTPcontainer1").show(),t("#resend_forgot_btn").show()):"TOKEN"==p.get("alertType")?(t("#titleAuth").html(t.i18n.t("app.registration.opthelptokentext")),t("#myModalLabel").html(t.i18n.t("app.registration.otptokenheadertext")),t("#challengeText").html(""),t("#OTPcontainer1").hide(),t("#resend_forgot_btn").hide()):"ESIGN"==p.get("alertType")&&(t("#titleAuth").html(t.i18n.t("app.registration.otphelpesigntext")),t("#myModalLabel").html(t.i18n.t("app.registration.otpothersheadertext")),t("#challengeText").html(t.i18n.t("app.transferss.genratedTocn")+" "+p.get("otpCode")),t("#OTPcontainer1").hide(),t("#resend_forgot_btn").hide()),setTimeout(function(){t("#otp1").focus()},500),t("#otpNullError").html(""),t("#otpNullErrorDiv").hide(),t(".inputs").on("input",function(e){e.stopImmediatePropagation();var r=e.currentTarget.id,o=t("#"+r).val();t("#"+r).attr("data",o),t("#"+r).val(o.replace(/[^\*]/,"."))}),t("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""),"SMS"==p.get("alertType")?a=t.i18n.t("app.registration.opthelptext")+" "+maskMobile(p.get("mobileNo")):"EMAIL"==p.get("alertType")&&(a=t.i18n.t("app.registration.opthelpemailtext")+" "+maskEmailID(p.get("emailID"))),t(".otp_msg_txt").html(a),("SMS"==p.get("alertType")||"EMAIL"==p.get("alertType"))&&s.invokeOTPSpinner()},c=function(t){s.errorresponse()},u=p.get("customerIDs"),h=p.get("saltreg"),g=DEcryptWithDynamicSalt(u,h);cusId=EncryptWithDynamicSalt(g,h);var s=this;showSpinner(),s.collection=new i;getDeviceId(),(new Date).getTime();s.collection.fetch({data:t.param({salt:h,cifId:cusId,mobileNumber:p.get("mobilenum"),email:p.get("eMailId"),serviceProvider:null,resendflag:e,alerttype:p.get("alertType"),servicecode:"FORGOT_PASSWORD"}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?d(t):c(t)},error:c})},invokeOTPSpinner:function(){var e=this;return t("#resend_forgot_btn").hide(),t("#OTPcontainer1").show(),t("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""),null!=l?(l.set(1),void l.animate(0,function(){t("#OTPcontainer1").slideUp("slow")})):(l=new ProgressBar.Circle(OTPcontainer1,{color:"#333",strokeWidth:8,trailWidth:8,easing:"linear",duration:6e4*parseInt(p.get("otpExpiryPeriod")),text:{autoStyleContainer:!1},from:{color:"#ec5f59",width:8},to:{color:"#ec5f59",width:8},step:function(e,r){r.path.setAttribute("stroke",e.color),r.path.setAttribute("stroke-width",e.width);var o=Math.round(r.value()*(60*p.get("otpExpiryPeriod")));"0"==o?(r.setText(""),t("#resend_forgot_btn").show()):(t("#resend_forgot_btn").hide(),r.setText(o+"s"))}}),l.text.style.fontFamily='"Raleway", Helvetica, sans-serif',l.text.style.fontSize="12px",l.text.style.fontWeight="bold",l.set(1),l.animate(0,function(){t("#OTPcontainer1").slideUp("slow")}),void t("#resend_forgot_btn").click(function(){e.validateCard("Y")}))},revokeOTPSpinner:function(){null!=l&&l.stop()},backToLogin:function(){t("#success").modal("hide"),r.history.navigate("#/login")},gotoPreviousPage:function(t){t.stopImmediatePropagation(),r.history.navigate("#/forgotpasswordnew")},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(t){return r.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=t,this.currentView.delegateEvents(),this.currentView}});return d});