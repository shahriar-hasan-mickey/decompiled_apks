define(["jquery","underscore","Backbone","text!views/login/accForgotUsername.tpl","collections/applanding/Registration/cardPinValidationCollections","collections/login/forgotUsernameConfirmCollections","collections/applanding/Registration/otpGenerationCollections","collections/applanding/Registration/otpVerificationCollections","collections/applanding/Registration/getAuthModeCollections"],function(e,t,o,r,a,n,i,l,s){var c=null,u=!1,p=new EncryptedLocalStorage("secret"),m=o.View.extend({el:"#container",events:{"click #home_btn":"backToHome","click #forgotUsername_validate_btn":"gotoOTPPopUp","click #forgot_user_next_btn":"showOTPOrEmail","click #verifyOTP":"gotoVerifySuccessPopUp","click #otp_success_btn":"gotoLoginPage","click #cancel_btn":"revokeOTPSpinner","click #close_btn":"revokeOTPSpinner","change .cardoptions":"changeLabel"},initialize:function(){},update:function(){c=null,this.$el.html(t.template(r)),u=!1,e("#cardNumberDiv").show(),e("#cardPinDiv").show(),e("#forgot_username_label").html(e.i18n.t("app.registration.enterdebitcardnum")),e("#accCardNumberLabel").html("Account Number"),e("#first,#second,#third,#fourth").removeAttr("disabled","disabled"),e(".first,.mid,.last").removeAttr("disabled","disabled")},getAuthmode:function(){var t=this;p.set("IsAuthMode","false"),e("#Forgot_username_alert_authmodeDiv").html("");var o=function(e){hideSpinner();var o=p.get("securitySettingList");!isNull(o)&&o.length>0?p.set("IsAuthMode","true"):(p.set("alertType",null),p.set("IsAuthMode","false")),t.populateAuthMode()},r=function(e){hideSpinner(),p.set("IsAuthMode","false"),t.populateAuthMode()};showSpinner(),t.collection=new s,t.collection.fetch({data:e.param({access_token:p.get("access_token"),transactionAmount:null,tenantServiceCode:"FORGOT_USERID",ulpId:p.get("forgotUserNameUlpID")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?o(e):r(e)},error:r})},populateAuthMode:function(){var t="",o="";e("#forgot_user_nextBtnDiv").show(),e("#forgot_user_validateBtnDiv").hide();var r=p.get("securitySettingList"),a="<label for='username'>"+e.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";a+="<div class='custRadio_pass'>",!isNull(r)&&r.length>0?(e("#Forgot_username_alert_authmodeDiv").html(""),e.each(r,function(r,n){"SMS"==n?(t="sms",o=e.i18n.t("app.transfer.managebeneficiary.sms")):"EMAIL"==n?(t="mail",o=e.i18n.t("app.transfer.managebeneficiary.mail")):"TOKEN"==n?(t="fScan",o=e.i18n.t("app.transfer.managebeneficiary.token")):"ESIGN"==n&&(t="esign",o=e.i18n.t("app.transfer.managebeneficiary.esign")),a+='<div class="box"><div class="radio"><label>',a+=0==r?'<input type="radio" name="forgot_username_authmode" id="optionsRadios'+r+'" value="'+n+'" checked>':'<input type="radio" name="forgot_username_authmode" id="optionsRadios'+r+'" value="'+n+'">',a+='<div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs '+t+'"></span><span class="small">'+o+"</span></div></div></label></div></div>"}),e("#Forgot_username_alert_authmodeDiv").html(a)):e("#Forgot_username_alert_authmodeDiv").html("")},changeLabel:function(t){var o=t.target.value;"DC"==o?(e("#cardNumberDiv").show(),e("#cardPinDiv").show(),e("#forgot_username_label").html(e.i18n.t("app.registration.enterdebitcardnum"))):"CC"==o?(e("#cardNumberDiv").show(),e("#cardPinDiv").show(),e("#forgot_username_label").html(e.i18n.t("app.registration.entercreditcardnum"))):"account"==o&&(e("#cardNumberDiv").hide(),e("#cardPinDiv").hide())},gotoAccForgotUsernamePage:function(e){e.stopImmediatePropagation(),o.history.navigate("#/accforgotusername")},gotoOTPPopUp:function(){var t=this;u=!1,e("#forgotUsernameAccNumError").html(""),e("#forgotUsernameMobNumError").html(""),e("#otpNullError").html(""),e("#otpNullErrorDiv").hide(),e("#usrname").html("");var o=e("#forgotUsernameAccNum").val(),r=e("#forgotUsernameMobNum").val();if(isNull(o)&&(u=!0,e("#forgotUsernameAccNumError").html("Please enter the account number")),isNull(o)||(o.length<13&&(u=!0,e("#forgotUsernameAccNumError").html("Account Number should be minimum of 13 characters")),o.length>16&&(u=!0,e("#forgotUsernameAccNumError").html("Account Number should be maximum of 16 characters")),13!=o.length&&16!=o.length&&(u=!0,e("#forgotUsernameAccNumError").html("Account Number should be either 13/16 characters"))),isNull(r)&&(u=!0,e("#forgotUsernameMobNumError").html("Please enter the mobile number")),isNull(r)||r.length>16&&(u=!0,e("#forgotUsernameMobNumError").html("Mobile Number should be maximum of 16 characters")),!u){var n=(new Date).getTime();p.set("saltreg",n);var i=p.get("cardType");o=EncryptWithDynamicSalt(o,n);var l=EncryptWithDynamicSalt(r,n);p.set("enccardnum",o);var s=function(e){hideSpinner(),t.getAuthmode()},c=function(o){e("#forgotUsernameAccNum").val(""),e("#forgotUsernameMobNum").val(""),t.errorresponse()};showSpinner(),t.collection=new a;getDeviceId(),(new Date).getTime();t.collection.fetch({data:e.param({ccno:o,ccpinno:l,salt:n,cardtype:i,flag:"FU"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?s(e):c(e)},error:c})}},showOTPOrEmail:function(){var e=this;"false"==p.get("IsAuthMode")?e.getUsername():e.validateCard()},validateCard:function(){var t=this,o=e("input[name='forgot_username_authmode']:checked").val();p.set("authmode",o),"SMS"==o||"EMAIL"==o||"ESIGN"==o?t.validateCardPin("N"):"TOKEN"==o&&(p.set("otpCode",""),p.set("alertType",o),e("#verify").modal("show"),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").removeAttr("data"),"TOKEN"==p.get("alertType")&&(e("#titleAuth").html(e.i18n.t("app.registration.opthelptokentext")),e("#myModalLabel").html(e.i18n.t("app.registration.otptokenheadertext")),e("#challengeText").html(""),e("#OTPcontainer1").hide(),e("#resend_btn1").hide()),e("#otpNullError").html(""),e("#otpNullErrorDiv").hide(),e(".inputs").on("input",function(t){t.stopImmediatePropagation();var o=t.currentTarget.id,r=e("#"+o).val();e("#"+o).attr("data",r),e("#"+o).val(r.replace(/[^\*]/,"."))}),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""))},validateCardPin:function(t){var o="",r="";e(".otp_msg_txt").html("");var a=e("input[name='forgot_username_authmode']:checked").val();p.set("alertType",a),"SMS"==a?(r=p.get("mobileNo"),o=null):"EMAIL"==a&&(r=null,o=p.get("emailID")),p.set("mobilenum",r),p.set("eMailId",o);var n=this,l=function(o){hideSpinner(),"Y"==t&&(e("#OTPcontainer1").slideDown("slow"),c.set(1),c.animate(0,function(){e("#OTPcontainer1").slideUp("slow")})),e("#verify").modal("show"),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").removeAttr("data"),"SMS"==p.get("alertType")?(e("#titleAuth").html(e.i18n.t("app.registration.opthelptext")+" "+maskMobile(p.get("mobilenum"))),e("#myModalLabel").html(e.i18n.t("app.transferss.verfici")),e("#challengeText").html(""),e("#OTPcontainer1").show(),e("#resend_btn1").show()):"EMAIL"==p.get("alertType")?(e("#titleAuth").html(e.i18n.t("app.registration.opthelptext")+" "+maskEmailID(p.get("emailID"))),e("#myModalLabel").html(e.i18n.t("app.transferss.verfici")),e("#challengeText").html(""),e("#OTPcontainer1").show(),e("#resend_btn1").show()):"ESIGN"==p.get("alertType")&&(e("#titleAuth").html(e.i18n.t("app.registration.otphelpesigntext")),e("#myModalLabel").html(e.i18n.t("app.transferss.verfici")),e("#challengeText").html(e.i18n.t("app.transferss.genratedTocn")+" "+p.get("otpCode")),e("#OTPcontainer1").hide(),e("#resend_btn1").hide()),setTimeout(function(){e("#otp1").focus()},500),e("#otpNullError").html(""),e("#otpNullErrorDiv").hide(),e(".inputs").on("input",function(t){t.stopImmediatePropagation();var o=t.currentTarget.id,r=e("#"+o).val();e("#"+o).attr("data",r),e("#"+o).val(r.replace(/[^\*]/,"."))}),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""),("SMS"==p.get("alertType")||"EMAIL"==p.get("alertType"))&&n.invokeOTPSpinner()},s=function(e){n.errorresponse()},u=p.get("customerIDs"),m=p.get("saltreg"),d=DEcryptWithDynamicSalt(u,m);cusId=EncryptWithDynamicSalt(d,m);var n=this;showSpinner(),n.collection=new i;getDeviceId(),(new Date).getTime();n.collection.fetch({data:e.param({salt:m,cifId:cusId,mobileNumber:p.get("mobilenum"),email:p.get("eMailId"),serviceProvider:null,resendflag:t,alerttype:p.get("alertType"),servicecode:"FORGOT_USERID"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?l(e):s(e)},error:s})},invokeOTPSpinner:function(){var t=this;return e("#resend_btn1").hide(),e("#OTPcontainer1").show(),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""),null!=c?(c.set(1),void c.animate(0,function(){e("#OTPcontainer1").slideUp("slow")})):(c=new ProgressBar.Circle(OTPcontainer1,{color:"#333",strokeWidth:8,trailWidth:8,easing:"linear",duration:6e4*parseInt(p.get("otpExpiryPeriod")),text:{autoStyleContainer:!1},from:{color:"#ec5f59",width:8},to:{color:"#ec5f59",width:8},step:function(t,o){o.path.setAttribute("stroke",t.color),o.path.setAttribute("stroke-width",t.width);var r=Math.round(o.value()*(60*p.get("otpExpiryPeriod")));"0"==r?(o.setText(""),e("#resend_btn1").show()):(e("#resend_btn1").hide(),o.setText(r+"s"))}}),c.text.style.fontFamily='"Raleway", Helvetica, sans-serif',c.text.style.fontSize="12px",c.text.style.fontWeight="bold",c.set(1),c.animate(0,function(){e("#OTPcontainer1").slideUp("slow")}),void e("#resend_btn1").click(function(){t.validateCardPin("Y")}))},revokeOTPSpinner:function(){null!=c&&c.stop()},gotoVerifySuccessPopUp:function(){var t="",o="";e("#otpNullError").html(""),e("#otpNullErrorDiv").hide();var r=e("#otp1").attr("data"),a=e("#otp2").attr("data"),n=e("#otp3").attr("data"),i=e("#otp4").attr("data"),s=e("#otp5").attr("data"),c=e("#otp6").attr("data");if(isNull(r)||isNull(a)||isNull(n)||isNull(i)||isNull(s)||isNull(c))return e("#otpNullErrorDiv").show(),void e("#otpNullError").html(e.i18n.t("validation.newregistration.otpnotnull"));var u=r+a+n+i+s+c,m=e("input[name='forgot_username_authmode']:checked").val();"SMS"==m?(o=p.get("mobileNo"),t=null):"EMAIL"==m&&(o=null,t=p.get("emailId"));var d=this,h=function(e){d.revokeOTPSpinner(),d.getUsername()},g=function(t){hideSpinner(),isNull(p.get("errordesc"))||(e("#otpNullErrorDiv").show(),e("#otpNullError").html(p.get("errordesc")))},f=p.get("customerIDs"),v=p.get("saltreg"),b=DEcryptWithDynamicSalt(f,v);cusId=EncryptWithDynamicSalt(b,v);var d=this;showSpinner(),d.collection=new l;getDeviceId(),(new Date).getTime();d.collection.fetch({data:e.param({activationno:u,salt:v,cifId:cusId,mobileNumber:o,email:t,serviceProvider:null,twoFAType:p.get("alertType"),servicecode:"FORGOT_USERID"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?h(e):g(e)},error:g})},getUsername:function(){var t=this,r=function(e){"true"==p.get("isforgotUsername")?t.gotoSuccessPopup():o.history.navigate("#/forgotpasswordnewsetpwd")},a=function(o){e("#forgotUsernameAccNum").val(""),e("#forgotUsernameMobNum").val(""),t.errorresponse()};showSpinner(),t.collection=new n;var i=(getDeviceId(),(new Date).getTime()),l=p.get("customerIDs"),i=p.get("transId");DEcryptWithDynamicSalt(l,i);t.collection.fetch({data:e.param({salt:i,cifNo:l}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?r(e):a(e)},error:a})},gotoSuccessPopup:function(){hideSpinner();var t=p.get("userName");e("#verify").modal("hide"),e("#success").modal("show"),e("#usrname").html(t)},backToHome:function(){o.history.navigate("#/login")},gotoLoginPage:function(){o.history.navigate("#/login")},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(e){return o.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return m});