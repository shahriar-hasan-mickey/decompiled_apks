define(["jquery","underscore","Backbone","text!views/login/landing.tpl","collections/login/MPINLoginCollections","collections/login/preLoginAuthCollections","collections/touchid/touchIDLoginCollections","collections/login/forcepassCollections","collections/login/getFAPCollections","collections/wealth/accSummaryCollections"],function(e,t,i,n,o,a,r,s,c,l){var p=new EncryptedLocalStorage("secret"),g=i.View.extend({el:"#container",events:{"click #userloginTouch":"touchIDLoginReg"},initialize:function(){},render:function(i){p.set("isLanding","true"),e("html").removeClass().addClass("landing"),this.$el.html(t.template(n))},forceUpdateNewVersion:function(){function t(e){if(null!=n.url&&void 0!=n.url&&""!=n.url){var t=/iPad|iPhone|iPod/.test(navigator.userAgent);t?window.location.href=n.url:window.open(n.url,"_system","location=no")}}function t(e){if(1==e&&null!=n.url&&void 0!=n.url&&""!=n.url){var t=/iPad|iPhone|iPod/.test(navigator.userAgent);t?window.location.href=n.url:window.open(n.url,"_system","location=no")}}var n=p.get("appInfoDTO");if(!isNull(n)){var o=n.isUpdate,a=n.msg_eng;p.set("allowAppAccessFlag","false"),p.set("allowOnConfirmAppAccessFlag","true"),"M"==o||""==o?(i.history.navigate("#/InternetException"),p.get("promptFired")||(navigator.notification.confirm(a,t,"",[e.i18n.t("app.login.okButton")]),p.set("promptFired",!0))):"O"==o&&(p.get("promptFired")||(navigator.notification.confirm(a,t,"",[e.i18n.t("app.mpin.yes"),e.i18n.t("app.mpin.no")]),p.set("promptFired",!0)))}},afterLoginTouchIDDownTime:function(){var e=this,t=p.get("appInfoDTO");isNull(t)||"M"!=t.isUpdate&&"O"!=t.isUpdate?e.touchIDLogin():(hideSpinner(),e.forceUpdateNewVersion())},preLogin:function(){var t=this,i=function(i){var n=p.get("appInfoDTO"),o=e.parseJSON(window.localStorage.getItem("downTimeMsg"));!isNull(o)&&o.length>0?(hideSpinner(),openDownTimePopup(),setTimeout(function(){e("#downtime_popup_close_btn").click(function(){t.afterLoginTouchIDDownTime(),e("#downTimePopUp").modal("hide")})},100)):isNull(n)||"M"!=n.isUpdate&&"O"!=n.isUpdate?t.touchIDLogin():(hideSpinner(),t.forceUpdateNewVersion())},n=function(i){var n=/iPhone|iPod|iPad|Android/.test(navigator.userAgent);n?e.ajax({url:"https://www.google.com/",type:"GET",timeout:9e4,datatype:"json",success:function(e){hideSpinner(),t.errorresponse()},error:function(t){hideSpinner(),p.set("errorcode","9999"),p.set("errordesc",e.i18n.t("app.login.nointernet2")),openErrorPopup()}}):t.errorresponse()},o=p.get("touchIDRegUsername"),r=(new Date).getTime(),s=EncryptWithDynamicSalt(o,r);t.collection=new a([],{});var c=null==o?"":o;checkSumEncrypt(c);var l,g=localStorage.getItem("FINALCHECKSUM"),u=getDeviceId(),d=/iPad|iPhone|iPod/.test(navigator.userAgent);l=d?"IOSMOBILE":"ANDROIDMOBILE",p.set("loginType","Biometric"),t.collection.fetch({data:e.param({userId:s,appchecksum:g,deviceid:u,platform:l,biometriclogintype:p.get("BiometricType"),appVersion:p.get("app.versionCode"),mpinflag:p.get("BiometricType"),userflag:"Y",salt:r}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(p.get("calltimeout")),success:function(e){"0000"==ackStatus?i(e):n(e)},error:n})},touchIDLoginReg:function(){var t=this,i=/iPhone|iPod|iPad|Android/.test(navigator.userAgent);if(void 0==navigator.network&&i)p.set("errorcode","9999"),p.set("errordesc",e.i18n.t("app.login.nointernet2")),openErrorPopup();else{var n=navigator.connection.type,o={};o[Connection.UNKNOWN]="Unknown connection",o[Connection.ETHERNET]="Ethernet connection",o[Connection.WIFI]="WiFi connection",o[Connection.CELL_2G]="Cell 2G connection",o[Connection.CELL_3G]="Cell 3G connection",o[Connection.CELL_4G]="Cell 4G connection",o[Connection.NONE]="No network connection",n!=Connection.UNKNOWN&&n!=Connection.NONE||!i?(showSpinner(),t.validateTIDOrFIDLogin()):(p.set("errorcode","9999"),p.set("errordesc",e.i18n.t("app.login.nointernet2")),openErrorPopup())}},validateTIDOrFIDLogin:function(){var t=this,n=p.get("touchIdReg"),o=/iPhone|iPod|iPad/.test(navigator.userAgent),a=/Android/.test(navigator.userAgent);if(o&&"A"==n){p.set("isFirstTimeForTouch","false");try{window.plugins.touchid.isAvailable(function(){var i=!1;if(void 0!=navigator.network){var n=navigator.connection.type;n!=Connection.UNKNOWN&&n!=Connection.NONE&&(i=!0)}i?window.plugins.touchid.verifyFingerprintWithCustomPasswordFallback(e.i18n.t("app.touchid.loginScan"),function(e){p.set("isFirstTimeForTouch","false"),t.preLogin()},function(e){t.touchIDLoginFailure()}):(p.set("errordesc",""),t.errorresponse())},function(t){if(-8!=t.code)p.set("touchIdReg",""),i.history.navigate("#/login");else{t="";var n=p.get("BiometricType");"FID"==n?(t=e.i18n.t("app.faceid.faceUserFallback"),title=e.i18n.t("app.faceid.faceIDLocked")):(t=e.i18n.t("app.touchid.touchUserFallback"),title=e.i18n.t("app.touchid.touchIDLocked")),t="FID"==n?e.i18n.t("app.faceid.faceUserFallbackDesc"):e.i18n.t("app.touchid.touchUserFallbackDesc"),navigator.notification.alert(t,null,title,e.i18n.t("app.mpin.cancel"))}})}catch(r){}}else if(a&&"A"==n)try{Fingerprint.isAvailable(function(e){function i(){p.set("isFirstTimeForTouch","false"),t.preLogin()}function n(e){t.touchIDLoginFailure(),p.set("isFirstTimeForTouch","false")}var o=!1;if(void 0!=navigator.network){var a=navigator.connection.type;a!=Connection.UNKNOWN&&a!=Connection.NONE&&(o=!0)}o?Fingerprint.show({clientId:"Fingerprint-BRAC",clientSecret:"bractouch",disableBackup:"true"},i,n):(p.set("errordesc",""),t.errorresponse())},function(e){p.set("touchIdReg",""),i.history.navigate("#/login")})}catch(r){}},touchIDLogin:function(){var t,n,a,r,s;s=getDeviceId(),p.set("device_id",s),p.set("lang_id",e.i18n.lng()),n=Math.floor(9e4*Math.random())+1e5,t=n+"",p.set("saltvaluee",t);var c=s+"",l=CryptoJS.MD5(c)+"";a=CryptoJS.MD5(l+t)+"";var g=CryptoJS.SHA512(c)+"";r=CryptoJS.SHA512(g+t)+"";var u,d=((new Date).getTime(),/iPad|iPhone|iPod/.test(navigator.userAgent));/BlackBerry | IEMobile| Windows Phone | Win32NT/.test(navigator.userAgent);u=d?"IOSMOBILE":"ANDROIDMOBILE",mpinval="123456";var g,f=mpinval,h=getDeviceId(),m=p.get("ulpIDmpin");plainText=m+f,checkSumEncryptlogin(plainText),finalHash=localStorage.getItem("LOGINCHECKSUM");var v=p.get("dynamicToken"),D=p.get("timepassphrase"),I=DEcryptWithDynamicSalt(v,D),y="BRAC"+h+f+"~"+I,C=CryptoJS.SHA512(y)+"",w=this,T=function(e){w.forcePassTIDFID()},S=function(e){w.errorresponse()};w.collection=new o([],{});var P=(p.get("custno"),isNull(p.get("data_registrationId"))?"N":!isNull(p.get("data_registrationId"))&&isNull(p.get("isNotificationEnable"))?"Y":p.get("isNotificationEnable")),F=p.get("networkproviderip"),t=(new Date).getTime();F=EncryptWithDynamicSalt(F,t),showSpinner(),w.collection.fetch({data:e.param({cliIp:F,salt:t,push_flg:P,device_token:p.get("data_registrationId"),biometriclogintype:p.get("BiometricType"),mtc_token:C,deviceid:h,client_secret:finalHash,lang_id:p.get("language"),ulpId:p.get("ulpIDreg"),client_id:p.get("ulpIDreg"),allowedIp:"true",j_username:p.get("ulpIDreg"),j_password:finalHash,username:p.get("ulpIDreg"),password:finalHash,scope:"read,write",grant_type:"password",response_type:"token",appversion:p.get("app.versionCode"),model:p.get("device.model"),osversion:p.get("device.version"),paltform:u}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(p.get("calltimeout")),success:function(e){p.get("BiometricType");"0000"==ackStatus?T(e):"60003"==p.get("errorCode")?(hideSpinner(),i.history.fragment=null,window.location.href=""):S(e)},error:S})},forcePassTIDFID:function(t){var n=this,o=((new Date).getTime(),function(e){var t=p.get("userstatus"),n=p.get("forceflag");"ACT"==t?"Y"==n?(hideSpinner(),p.set("isCardlessCustomer","false"),i.history.navigate("#/cardlessuser")):(hideSpinner(),p.set("isFABData","false"),p.set("isExpiryPopup","false"),p.set("isWalletCCPCData","false"),p.set("isCreditCardData","false"),p.set("isPrepaidCardData","false"),p.set("isDepositDetailsDTO","false"),p.set("isCreditPrepaidCardData","false"),p.set("isFromLogin","true"),"I"==p.get("intermediateFlag")?i.history.navigate("#/fullrightsnotification",{trigger:!0,replace:!0}):i.history.navigate("#/landinglayout",{trigger:!0,replace:!0})):(hideSpinner(),i.history.navigate("#/setsecureques",{trigger:!0,replace:!0}))}),a=p.get("BiometricType"),r=function(e){n.errorresponse()};n.collection=new s([],{}),n.collection.fetch({data:e.param({flag:a,access_token:p.get("access_token")}),dataType:"json",type:"POST",timeout:parseInt(p.get("calltimeout")),cache:!1,success:function(e){"0000"==ackStatus?o(e):r(e)},error:r})},getFAPList:function(){var t=this,i=function(e){t.getCasaAccountList()},n=function(e){t.errorresponse()};t.collection=new c,t.collection.fetch({data:e.param({access_token:p.get("access_token")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?i(e):n(e)},error:n})},getCasaAccountList:function(){var t=this,n=function(e){hideSpinner(),p.set("isFABData","false"),p.set("isExpiryPopup","false"),p.set("isWalletCCPCData","false"),p.set("isCreditCardData","false"),p.set("isPrepaidCardData","false"),p.set("isCreditPrepaidCardData","false"),p.set("isDepositDetailsDTO","false"),p.set("isFromLogin","true"),i.history.navigate("#/landinglayout",{trigger:!0,replace:!0})},o=function(e){t.errorresponse()};t.collection=new l,t.collection.fetch({data:e.param({access_token:p.get("access_token"),userflag:"Y"}),dataType:"json",type:"POST",cache:!1,success:function(e){if("0000"==ackStatus){p.get("errorcode");n(e)}else n(e)},error:o})},touchIDLoginFailure:function(){var t=getDeviceId();p.set("device_id",t);var n=p.get("BiometricType")+""+t,o=(CryptoJS.MD5(n)+"",this);o.collection=new r([],{}),o.collection.fetch({data:e.param({appchecksum:"",ulpId:p.get("ulpID"),flag:p.get("BiometricType")}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(p.get("calltimeout")),success:function(e){i.history.navigate("#/login")},error:function(){i.history.navigate("#/login")}})},errorresponse:function(e){hideSpinner(),openErrorPopup()}});return g});