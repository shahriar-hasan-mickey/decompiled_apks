define(["jquery","underscore","Backbone","text!views/login/resetsecureaccessOTP.tpl","collections/login/forgotOTPGenerateCollections","collections/login/forgotOTPValidateCollections","collections/common/mobileNumberUpdateCollection","models/validation/forgotPasswordValidationModel","collections/login/forgotPasswordSuccessCollections","models/validation/softOTPValidationModel"],function(e,t,i,s,o,n,r,c,a,l){var u=new EncryptedLocalStorage("secret"),d=0,p=i.View.extend({el:"#container",events:{"click #submitOTP":"submitOTP","click .smsotp":"OTPOption1","click .softToken":"OTPOption2","click #resendclick":"ResendClick"},initialize:function(){this.on("error",function(e,t){alert(t)})},update:function(){this.otpflagcheck()},updateMobileNumber:function(){showSpinner();var t=this,i=function(e){t.otpflagcheck()},s=function(e){t.errorresponse()};t.collection=new r([],{});var o=(new Date).getTime(),n=u.get("pinMobile"),c=u.get("customernumber"),c=u.get("customernumber"),a=u.get("timeStampharse"),l=DEcryptuser(c,a),d=getDeviceId(),p=c+""+d,m=CryptoJS.MD5(p);p=m+"";var h=l,f=Encryptuser(l,o),g=f,v=Encryptuser(h,o);t.collection.fetch({data:e.param({custno:g,mobilenumber:n,timeenv:v,timephrase:o,requestid:o}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(u.get("calltimeout")),success:function(e){"0000"==ackStatus?i(e):s(e)},error:s})},OTPOption1:function(t){e("#hidotp").val("otp"),e(".smsotp_block").show(),e(".softTock").hide(),e(".smsotp").addClass("active"),e(".softToken").removeClass("active"),document.getElementById("softTockId").style.display="none",document.getElementById("smsDivId").style.display="inline",this.generateOTP(),t.preventDefault()},OTPOption2:function(){e("#hidotp").val("softotp"),e(".smsotp_block").hide(),e(".softTock").show(),e(".softToken").addClass("active"),e(".smsotp").removeClass("active"),e("#hiddotpvalue").val("Y"),document.getElementById("softTockId").style.display="inline"},otpflagcheck:function(){hideSpinner(),this.generateOTP()},generateOTP:function(){showSpinner();var t=this;e("#submitOTP").removeAttr("disabled");var i=function(e){t.forgotPasswordOTP()},s=function(e){t.errorresponse()};t.collection=new o([],{}),timestamp=(new Date).getTime();var n=getDeviceId();t.collection.fetch({data:e.param({deviceid:n,access_token:u.get("access_token"),userId:u.get("loginuser_id"),ulpid:u.get("ulpID"),servicecode:"CHNG_SECIMG"}),dataType:"json",type:"POST",cache:!1,success:function(o){"0000"==ackStatus?(e("#submitOTP").removeAttr("disabled"),"SMS"==status?i(o):t.OtpSuccess()):(e("#submitOTP").removeAttr("disabled"),s(o))},error:s})},forgotPasswordOTP:function(){return hideSpinner(),e(this.el).html(t.template(s)).i18n(),e(this.el).trigger("create"),this},submitOTP:function(e){this.verifyOTP()},verifyOTP:function(t){e("#secError").hide(),e("#resenddiv").hide(),this.model=new c({url:"json/"}),i.Validation.bind(this);var s=this.$("form").serializeObject();if(this.model.set(s,{validate:!0})){this.model.clear(),i.Validation.unbind(this),showSpinner();var o=(e("#otp").val(),this),r=function(e){o.OtpSuccess()},a=function(e){o.errorresponse()};o.collection=new n([],{}),timestamp=(new Date).getTime();var l=e("#otp").val(),p=(new Date).getTime();l=EncryptWithDynamicSalt(l,p);var m=getDeviceId();o.collection.fetch({data:e.param({deviceid:m,access_token:u.get("access_token"),userId:u.get("loginuser_id"),ulpid:u.get("ulpID"),transactionData1:"SMS",salt:p,activationno:l,servicecode:"CHNG_SECIMG",device_id:m}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(u.get("calltimeout")),success:function(t){u.get("errorcod");if("0000"==ackStatus)r(t),startTimer("submitOTP",!1);else{d++;var s=u.get("errordesc");e("#showError").text(s),e("#loginform")[0].reset(),e("#secError").show(),e("#resenddiv").show(),d>2&&(d=0,i.history.navigate("#/wrongOTPException/forgotsecureaccess")),hideSpinner()}},error:a})}else this.$(".alert-error").fadeIn(),t.preventDefault(),hideSpinner()},verifySoftToken:function(){this.model=new l({url:"json/"}),i.Validation.bind(this);var t=this.$("form").serializeObject();if(this.model.set(t,{validate:!0})){showSpinner(),this.model.clear(),i.Validation.unbind(this);var s=this,o=function(e){s.OtpSuccess()},r=function(e){s.errorresponse()};s.collection=new n([],{});var c=(new Date).getTime(),a="SOFTOTP",d=e("#softotp").val(),p=(u.get("customernumber"),u.get("customernumber")),m=u.get("timeStampharse"),h=DEcryptuser(p,m),f=getDeviceId(),g=p+""+f,v=CryptoJS.MD5(g);g=v+"";var T=h,S=Encryptuser(h,c),w=S,y=Encryptuser(T,c);s.collection.fetch({data:e.param({opttype:a,refno:u.get("token_serno"),activationno:d,customerno:w,timeenv:y,timephrase:c,requestid:c}),dataType:"json",type:"POST",timeout:parseInt(u.get("calltimeout")),cache:!1,success:function(e){"0000"==ackStatus?o(e):r(e)},error:r})}else this.$(".alert-error").fadeIn()},OtpSuccess:function(){hideSpinner();var e=u.get("act_user_without_pass");"YES"==e?this.activateUser():i.history.navigate("#/resetsecureaccessSuccess")},activateUser:function(){var t=u.get("customernumber"),i=u.get("timeStampharse"),s=DEcryptuser(t,i),o=u.get("acctno"),n=u.get("iqno"),r=u.get("atmcardd"),c=u.get("act_user_without_pass"),l="",d=this;timestamp=(new Date).getTime();var p=Encryptuser(s,timestamp),m=p,h=Encryptuser(s,timestamp),f=function(e){d.resultpageSuccess()},g=function(e){d.errorresponse()};d.collection=new a([],{}),showSpinner(),d.collection.fetch({data:e.param({userid:m,timeenv:h,timephrase:timestamp,channelid:"MTC",atmcard:r,accountnumber:o,niniqama:n,loginpassword:l,confirmpassword:l,activateuser:c}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(u.get("calltimeout")),success:function(e){"0000"==ackStatus?f(e):g(e)},error:g})},ResendClick:function(){hideSpinner(),e("#resendclick").parents(".form-group").find(".optwrap").removeClass("input-group"),e("#resendclick").parent(".input-group-btn").addClass("hidden"),e("#secError").hide(),this.generateOTP()},resultpageSuccess:function(){hideSpinner(),i.history.navigate("#/resetsecureaccessSuccess",{trigger:!0,replace:!0})},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(e){return i.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return p});