define(["jquery","underscore","Backbone","text!views/login/forgotPasswordNew.tpl","collections/applanding/Registration/cardPinValidationCollections","collections/login/forgotUsernameConfirmCollections","collections/applanding/Registration/getAuthModeCollections"],function(e,t,r,o,a,n,i){var c=null,s=new EncryptedLocalStorage("secret"),l=r.View.extend({el:"#container",events:{"click #forgotPasswordCancelBtn":"backToHome","click #forgotPasswordNextBtn":"gotoNextPage","change .forgotPassword_cardoptions":"changeLabel"},initialize:function(){},update:function(){c=null,this.$el.html(t.template(o)),e("#cardNumberDiv").show(),e("#cardPinDiv").show(),e("#accNumDiv").hide(),e("#mobNumDiv").hide(),e("#forgotPasswordLabel").html("Enter Card Number"),e("#accCardNumberLabel").html("Account Number"),e("#first,#second,#third,#fourth").removeAttr("disabled","disabled"),e(".first,.mid,.last").removeAttr("disabled","disabled")},getAuthmode:function(){var t=this;s.set("IsAuthMode","false"),e("#Forgot_username_alert_authmodeDiv").html("");var r=function(e){hideSpinner();var r=s.get("securitySettingList");!isNull(r)&&r.length>0?s.set("IsAuthMode","true"):(s.set("alertType",null),s.set("IsAuthMode","false")),t.populateAuthMode()},o=function(e){hideSpinner(),s.set("IsAuthMode","false"),t.populateAuthMode()};showSpinner(),t.collection=new i,t.collection.fetch({data:e.param({access_token:s.get("access_token"),transactionAmount:null,tenantServiceCode:"FORGOT_USERID",ulpId:s.get("forgotUserNameUlpID")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?r(e):o(e)},error:o})},populateAuthMode:function(){var t="",r="",o=s.get("securitySettingList"),a="<label for='username'>"+e.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";a+="<div class='custRadio_pass'>",!isNull(o)&&o.length>0?(e("#Forgot_username_alert_authmodeDiv").html(""),e.each(o,function(o,n){"SMS"==n?(t="sms",r=e.i18n.t("app.transfer.managebeneficiary.sms")):"EMAIL"==n?(t="mail",r=e.i18n.t("app.transfer.managebeneficiary.mail")):"TOKEN"==n?(t="fScan",r=e.i18n.t("app.transfer.managebeneficiary.token")):"ESIGN"==n&&(t="esign",r=e.i18n.t("app.transfer.managebeneficiary.esign")),a+='<div class="box"><div class="radio"><label>',a+=0==o?'<input type="radio" name="forgot_username_authmode" id="optionsRadios'+o+'" value="'+n+'" checked>':'<input type="radio" name="forgot_username_authmode" id="optionsRadios'+o+'" value="'+n+'">',a+='<div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs '+t+'"></span><span class="small">'+r+"</span></div></div></label></div></div>"}),e("#Forgot_username_alert_authmodeDiv").html(a)):e("#Forgot_username_alert_authmodeDiv").html("")},changeLabel:function(t){var r=t.target.value;"DC"==r?(e("#cardNumberDiv").show(),e("#cardPinDiv").show(),e("#accNumDiv").hide(),e("#mobNumDiv").hide(),e("#forgotPasswordLabel").html("Enter Card Number"),e("#forgotPassword_cardNumNullError").html(""),e(".pincode-input-error").html(""),e("#first, #second, #third, #fourth").val(""),e("#cardPinInput").pincodeInput().data("plugin_pincodeInput").clear()):"CC"==r?(e("#cardNumberDiv").show(),e("#cardPinDiv").show(),e("#accNumDiv").hide(),e("#mobNumDiv").hide(),e("#forgotPasswordLabel").html("Enter Card Number"),e("#forgotPassword_cardNumNullError").html(""),e(".pincode-input-error").html(""),e("#first, #second, #third, #fourth").val(""),e("#cardPinInput").pincodeInput().data("plugin_pincodeInput").clear()):"account"==r&&(e("#cardNumberDiv").hide(),e("#forgotPassword_cardNumNullError").html(""),e(".pincode-input-error").html(""),e("#first, #second, #third, #fourth").val(""),e("#cardPinInput").pincodeInput().data("plugin_pincodeInput").clear(),e("#cardPinDiv").hide(),e("#accNumDiv").show(),e("#mobNumDiv").show())},gotoNextPage:function(t){"object"==typeof t&&t.stopImmediatePropagation();var r=this,o=e("input[name='choice']:checked").val();"account"==o?(s.set("cardType","A"),r.validateAccNumberDetails(t)):(s.set("cardType",""),r.forgotPasswordValidateCardDetails())},validateAccNumberDetails:function(t){t.stopImmediatePropagation();var r=this;isError=!1,e("#forgotUsernameAccNumError").html(""),e("#forgotUsernameMobNumError").html(""),e("#otpNullError").html(""),e("#otpNullErrorDiv").hide(),e("#usrname").html("");var o=e("#forgotUsernameAccNum").val(),n=e("#forgotUsernameMobNum").val();if(isNull(o)&&(isError=!0,e("#forgotUsernameAccNumError").html("Please enter the account number")),isNull(o)||(o.length<13&&(isError=!0,e("#forgotUsernameAccNumError").html("Account Number should be minimum of 13 characters")),o.length>16&&(isError=!0,e("#forgotUsernameAccNumError").html("Account Number should be maximum of 16 characters")),13!=o.length&&16!=o.length&&(isError=!0,e("#forgotUsernameAccNumError").html("Account Number should be either 13/16 characters"))),isNull(n)&&(isError=!0,e("#forgotUsernameMobNumError").html("Please enter the mobile number")),isNull(n)||n.length>16&&(isError=!0,e("#forgotUsernameMobNumError").html("Mobile Number should be maximum of 16 characters")),!isError){var i=(new Date).getTime();s.set("saltreg",i);var c=s.get("cardType");o=EncryptWithDynamicSalt(o,i);var l=EncryptWithDynamicSalt(n,i);s.set("enccardnum",o);var u=function(e){hideSpinner(),r.getUsername()},d=function(t){e("#forgotUsernameAccNum").val(""),e("#forgotUsernameMobNum").val(""),r.errorresponse()};showSpinner(),r.collection=new a;getDeviceId(),(new Date).getTime();r.collection.fetch({data:e.param({ccno:o,ccpinno:l,salt:i,cardtype:c,flag:"FU"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?u(e):d(e)},error:d})}},gotoAccForgotUsernamePage:function(e){e.stopImmediatePropagation(),r.history.navigate("#/accforgotusername")},forgotPasswordValidateCardDetails:function(t){"object"==typeof t&&t.stopImmediatePropagation();var r=this;e("#forgotPassword_cardNumNullError").html(""),e("#pinNullError").html(""),e("#otpNullError").html(""),e("#otpNullErrorDiv").hide(),e("#usrname").html(""),e(".pincode-input-error").html("");var o=e("#first").val(),n=e("#second").val(),i=e("#third").val(),c=e("#fourth").val(),l=e("#cardPinInput").val(),u=/[0-9]/g;if(""==o||""==n||""==i||""==c)return void e("#forgotPassword_cardNumNullError").html(e.i18n.t("validation.newregistration.cardnumnotnull"));if(o.length<e("#first").attr("maxlength")||n.length<e("#second").attr("maxlength")||i.length<e("#third").attr("maxlength")||c.length<e("#fourth").attr("maxlength"))return void e("#forgotPassword_cardNumNullError").html(e.i18n.t("validation.newregistration.validnumerrmsg"));if(!(o.match(u)&&n.match(u)&&i.match(u)&&c.match(u)))return void e("#forgotPassword_cardNumNullError").html(e.i18n.t("validation.newregistration.cardnumberonly"));if(l.length<4)return void e(".pincode-input-error").html(e.i18n.t("app.forgotpassword.errvalpin"));if(!l.match(u))return void e(".pincode-input-error").html(e.i18n.t("validation.newregistration.pinnumberonly"));var d=e("input[name='choice']:checked").val(),m=o+n+i+c,h=(new Date).getTime();s.set("saltreg",h),ccnum=EncryptWithDynamicSalt(m,h),ccpinnum=EncryptWithDynamicSalt(l,h);var p=function(o){hideSpinner(),e(".pincode-input-error").html(""),r.getUsername(t)},g=function(e){r.errorresponse()};showSpinner(),r.collection=new a;getDeviceId(),(new Date).getTime();r.collection.fetch({data:e.param({ccno:ccnum,ccpinno:ccpinnum,salt:h,cardtype:d,flag:"FU"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?p(e):g(e)},error:g})},showOTPOrEmail:function(){var e=this;"false"==s.get("IsAuthMode")?e.getUsername():e.validateCard()},validateCard:function(){var t=this,r=e("input[name='forgot_username_authmode']:checked").val();s.set("authmode",r),"SMS"==r||"EMAIL"==r||"ESIGN"==r?t.validateCardPin("N"):"TOKEN"==r&&(s.set("otpCode",""),s.set("alertType",r),e("#verify").modal("show"),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").removeAttr("data"),"TOKEN"==s.get("alertType")&&(e("#titleAuth").html(e.i18n.t("app.registration.opthelptokentext")),e("#myModalLabel").html(e.i18n.t("app.registration.otptokenheadertext")),e("#challengeText").html(""),e("#OTPcontainer1").hide(),e("#resend_btn1").hide()),e("#otpNullError").html(""),e("#otpNullErrorDiv").hide(),e(".inputs").on("input",function(t){t.stopImmediatePropagation();var r=t.currentTarget.id,o=e("#"+r).val();e("#"+r).attr("data",o),e("#"+r).val(o.replace(/[^\*]/,"."))}),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""))},getUsername:function(){var t=this,o=function(e){hideSpinner(),r.history.navigate("#/forgotpasswordnewsetpwd")},a=function(e){t.errorresponse()};showSpinner(),t.collection=new n;var i=(getDeviceId(),(new Date).getTime()),c=s.get("customerIDs"),i=s.get("transId");DEcryptWithDynamicSalt(c,i);t.collection.fetch({data:e.param({salt:i,cifNo:c}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?o(e):a(e)},error:a})},backToHome:function(){r.history.navigate("#/login")},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(e){return r.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return l});