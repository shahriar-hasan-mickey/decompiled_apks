define(["jquery","underscore","Backbone","text!views/login/loginOTP.tpl","collections/common/otpGenerateCollections","collections/common/otpValidateCollections","collections/common/mobileNumberUpdateCollection","models/validation/OTPValidationModel","collections/logout/logoutCollections","collections/wealth/kycInputCollections","models/validation/softOTPValidationModel"],function(e,t,i,n,o,r,c,a,s,l,p){var d=new EncryptedLocalStorage("secret"),g=i.View.extend({el:"#container",e1:"#preloginmobcontent",events:{"click .smsotp":"OTPOption1","click .softToken":"OTPOption2","click #loginotpclick":"submitOTP","click #resendclick":"ResendClick","click #cancel":"Cancel"},update:function(){this.otpflagcheck()},updateMobileNumber:function(){showSpinner();var t=this,i=function(e){t.otpflagcheck()},n=function(e){t.errorresponse()};t.collection=new c([],{});var o=(new Date).getTime(),r=d.get("actual_mob_no"),a=d.get("custnoenc"),a=d.get("custnoenc"),s=d.get("timeStampharse"),l=DEcryptuser(a,s),p=getDeviceId(),g=a+""+p,u=CryptoJS.MD5(g);g=u+"";var h=l,m=Encryptuser(l,o),v=m,f=Encryptuser(h,o);t.collection.fetch({data:e.param({custno:v,mobilenumber:r,timeenv:f,timephrase:o,requestid:o}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(d.get("calltimeout")),success:function(e){"0000"==ackStatus?i(e):n(e)},error:n})},OTPOption1:function(t){e("#hidotp").val("otp"),e(".smsotp_block").show(),e(".softTock").hide(),e(".smsotp").addClass("active"),e(".softToken").removeClass("active"),document.getElementById("softTockId").style.display="none",document.getElementById("smsDivId").style.display="inline",this.generateOTP(),t.preventDefault()},OTPOption2:function(){e("#hidotp").val("softotp"),e(".smsotp_block").hide(),e(".softTock").show(),e(".softToken").addClass("active"),e(".smsotp").removeClass("active"),e("#hiddotpvalue").val("Y"),document.getElementById("softTockId").style.display="inline"},otpflagcheck:function(){hideSpinner(),this.generateOTP()},generateOTP:function(){e("#resenddiv").hide(),e("#loginotpclick").removeAttr("disabled"),showSpinner();var t=this,i=function(e){t.loginotpcompiler()},n=function(e){t.errorresponse()};t.collection=new o([],{});(new Date).getTime();"en-US"==e.i18n.lng()?language="EN":"en-AR"==e.i18n.lng()&&(language="AR"),t.collection.fetch({data:e.param({access_token:d.get("access_token"),ulpid:d.get("ulpID"),servicecode:"LOGIN"}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(d.get("calltimeout")),success:function(o){"0000"==ackStatus?(e("#loginotpclick").removeAttr("disabled"),"SMS"==status?i(o):t.loginaskverify()):(e("#loginotpclick").removeAttr("disabled"),n(o))},error:n})},ResendClick:function(){hideSpinner(),e("#resendclick").parents(".form-group").find(".optwrap").removeClass("input-group"),e("#resendclick").parent(".input-group-btn").addClass("hidden"),e("#secError").hide(),this.generateOTP()},loginotpcompiler:function(){return hideSpinner(),this.$el.html(t.template(n)),this},securityadvicecheck:function(t){"TWOFA"==e("#securityFlag").val()?this.loginotpverification(t,e("#securityFlag").val()):"TPIN"==e("#securityFlag").val()?this.loginotpverification(t,e("#securityFlag").val()):"SQ"==e("#securityFlag").val()&&this.loginotpverification(t,e("#securityFlag").val())},submitOTP:function(e){this.verifyOTP()},verifyOTP:function(t){e("#secError").hide(),e("#resenddiv").hide(),this.model=new a({url:"json/"}),i.Validation.bind(this);var n=this.$("form").serializeObject();if(this.model.set(n,{validate:!0})){this.model.clear(),i.Validation.unbind(this),showSpinner();var o=this,c=function(e){o.loginaskverify()},s=function(e){o.errorresponse()};o.collection=new r([],{}),timestamp=(new Date).getTime();var l=e("#otp").val(),p=(new Date).getTime();l=EncryptWithDynamicSalt(l,p);var g=getDeviceId();o.collection.fetch({data:e.param({access_token:d.get("access_token"),ulpid:d.get("ulpID"),servicecode:"LOGIN",transactionData1:"SMS",salt:p,activationno:l,device_id:g}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(d.get("calltimeout")),success:function(t){d.get("errorcod");if("0000"==ackStatus)c(t),startTimer("loginotpclick",!1);else{var i=d.get("errordesc");e("#showError").text(i),e("#loginform")[0].reset(),e("#secError").show(),e("#resenddiv").show(),hideSpinner()}},error:s})}else this.$(".alert-error").fadeIn(),hideSpinner()},verifySoftToken:function(){this.model=new p({url:"json/"}),i.Validation.bind(this);var t=this.$("form").serializeObject();if(this.model.set(t,{validate:!0})){showSpinner(),this.model.clear(),i.Validation.unbind(this);var n=this,o=function(e){n.loginaskverify()},c=function(e){n.errorresponse()};n.collection=new r([],{});var a=(new Date).getTime(),s="SOFTOTP",l=e("#softotp").val(),g=(d.get("custnoenc"),d.get("custnoenc")),u=d.get("timeStampharse"),h=DEcryptuser(g,u),m=getDeviceId(),v=g+""+m,f=CryptoJS.MD5(v);v=f+"";var y=h,k=Encryptuser(h,a),S=k,T=Encryptuser(y,a);n.collection.fetch({data:e.param({opttype:s,refno:d.get("token_serno"),activationno:l,customerno:S,timeenv:T,timephrase:a,requestid:a}),dataType:"json",type:"POST",timeout:parseInt(d.get("calltimeout")),cache:!1,success:function(e){"0000"==ackStatus?o(e):c(e)},error:c})}else this.$(".alert-error").fadeIn()},loginaskverify:function(){hideSpinner();var e=d.get("forceflag");"Y"==e?(hideSpinner(),i.history.navigate("#/forgotPasswordMsg",{trigger:!0,replace:!0})):i.history.navigate("#/landing",{trigger:!0,replace:!0})},loginaskverify_old:function(){hideSpinner();var e="NO";try{e=window.localStorage.getItem("FirstTimeLoginChk")}catch(t){e="NO"}var n=d.get("mpincheck_server"),o="";try{o=d.get("mpincheck_local")}catch(t){o="NO"}d.get("mpinStatus");"DONE"!=e&&i.history.navigate("#/loginask",{trigger:!0,replace:!0});var r="N";"mpinch"==o&&(r="Y");var c="N";"mpinch"==n&&(c="Y")},onWealthResponse:function(){var e=(d.get("kyconetimeprocess"),d.get("usrlogincount")),t=d.get("noOfDays"),n=d.get("iqnumid");n>=3?i.history.navigate("#/landing",{trigger:!0,replace:!0}):t>90?(hideSpinner(),i.history.navigate("#/landing",{trigger:!0,replace:!0})):!(""==e&&void 0==e&&null==e&&"null"==e||"1"!=e&&"2"!=e)?(hideSpinner(),i.history.navigate("#/landing",{trigger:!0,replace:!0})):(hideSpinner(),i.history.navigate("#/kyc"))},Cancel:function(){showSpinner();var t=d.get("device.platform");"Android"==t&&stopSMSListening();var i=this,n=function(e){i.cancelcompile()},o=function(e){i.errorresponse()};i.collection=new s([],{});var r=(new Date).getTime();i.collection.fetch({data:e.param({usersession:d.get("access_token"),access_token:d.get("access_token"),requestid:r}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?n(e):o(e)},error:o})},cancelcompile:function(){hideSpinner(),i.history.fragment=null,i.history.navigate("#/login",{trigger:!0,replace:!0})},errorresponse:function(e){hideSpinner(),openErrorPopup()}});return g});