define(["jquery","underscore","Backbone","text!views/login/cardlessCustomer.tpl","collections/login/cardlessCustomerCollections"],function(r,e,s,a,t){var n=new EncryptedLocalStorage("secret"),i=s.View.extend({el:"#container",events:{"click #cardless_cancelbtn":"backToLogin","click #cardless_gotoPwdSuccess":"gotoPwdSuccessPopUp","click #cardless_gotoLogin":"gotoLoginUI","keyup #cardless_password":"registerPasswordChange","keyup #cardless_confpassword":"registerConfirmPasswordChange"},update:function(){this.$el.html(e.template(a,{})),this.$el.trigger("create"),r("html").addClass("loginbg").removeClass("preloginbg"),"false"==n.get("isCardlessCustomer")?(r("#cardless_username").attr("disabled",!0),"Userlogin"==n.get("loginType")?r("#cardless_username").val(n.get("userLogin")):r("#cardless_username").val(n.get("userLogin"))):(r("#cardless_username").val(""),r("#cardless_username").attr("disabled",!1))},backToLogin:function(){s.history.navigate("#/login")},registerConfirmPasswordChange:function(){r("#cardlessconfirmPasswordError").html("");var e=r("#cardless_confpassword").val();return""==e||null==e?(r("#cardlessconfirmPasswordError").html(r.i18n.t("validation.newregistration.confpwdnotnull")),!1):void 0},registerPasswordChange:function(){r("#cardlesspasswordError").html(""),r("#cardlessconfirmPasswordError").html("");var e=/[0-9]/g,s=r("#cardless_password").val(),a=r("#cardless_confpassword").val(),t=n.get("pwdpolicy"),i=/[a-z\u0600-\u06FF]/g,o=/[A-Z\u0600-\u06FF]/g,l=/^[A-Z]/,d=/^[a-z]/,c=/^[0-9]/,p=/^[!@#$%^&*()-_+~.]/,u=/^[a-zA-Z]/;if(""==s||null==s)return r("#cardlesspasswordError").html(r.i18n.t("validation.newregistration.pwdnotnull")),!1;if("U"===t.firstCharacterValue){if(!l.test(s))return r("#cardlesspasswordError").html(r.i18n.t("app.login.errUP")),!1}else if("L"===t.firstCharacterValue){if(d.test(s))return r("#cardlesspasswordError").html(r.i18n.t("app.login.errLOW")),!1}else if("N"===t.firstCharacterValue){if(c.test(s))return r("#cardlesspasswordError").html(r.i18n.t("app.login.errNUM")),!1}else if("S"===t.firstCharacterValue){if(p.test(s))return r("#cardlesspasswordError").html(r.i18n.t("app.login.errSpecl")),!1}else if("A"===t.firstCharacterValue&&!u.test(s))return r("#cardlesspasswordError").html(r.i18n.t("First Character should be an alphabet")),!1;if(s.length<t.minimumLength)return r("#cardlesspasswordError").html(r.i18n.t("app.login.pwderrlength1")+" "+t.minimumLength+" "+r.i18n.t("app.login.pwderrlength2")+" "+t.maximumLength+" "+r.i18n.t("app.login.pwderrlength3")),!1;if(s.length>t.maximumLength)return r("#cardlesspasswordError").html(r.i18n.t("app.login.pwderrmaxlen")+" "+t.maximumLength+" "+r.i18n.t("app.login.pwderrlength3")),!1;var h=s.search(e);if("Y"===t.numeralsMandatory&&"-1"==h)return r("#cardlesspasswordError").html(r.i18n.t("app.login.errnumber")),!1;var w=s.search(i);if("Y"===t.lowercaseMandatory&&"-1"==w)return r("#cardlesspasswordError").html(r.i18n.t("app.login.errlwr")),!1;var m=s.search(o);if("Y"===t.uppercaseMandatory)if("U"===t.firstCharacterValue){if(-1==m||0!==m)return r("#passwordError").html(r.i18n.t("app.login.errupr")),!1}else if(-1==m)return r("#passwordError").html(r.i18n.t("app.login.errupr")),!1;if("Y"===t.specialCharactersMandatory)if(isNull(t.disallowedCharacters)){var g=!1,f=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;if(f.test(s)||(g=!0),g)return isError=!0,void r("#passwordError").html(r.i18n.t("app.login.errspc"))}else{for(var v=t.disallowedCharacters,E=!1,C=0;C<s.length;C++){var y=s[C];-1!=v.indexOf(y)&&(E=!0)}if(E)return isError=!0,void r("#passwordError").html("Entered password does not match with password policy "+t.disallowedCharacters+" are not allowed");var g=!1,f=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;if(f.test(s)||(g=!0),g)return isError=!0,void r("#passwordError").html(r.i18n.t("app.login.errspc"))}var P=s.toLowerCase();if("N"===t.repeatingValueAllowedInPwd)for(var C=0;C<P.length;C++){var y=P[C],L=P[C+1];if(y===L&&y===P[C+2])return isError=!0,void r("#cardlesspasswordError").html(r.i18n.t("app.login.errcon"))}if("N"===t.seqValueAllowedInPwd){if(P.match(/([a-zA-Z0-9])\1\1+|(abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|jkl|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz|ABC|BCD|CDE|DEF|EFG|FGH|GHI|HIJ|IJK|JKL|KLM|LMN|MNO|NOP|OPQ|PQR|QRS|RST|STU|TUV|UVW|VWX|WXY|XYZ|012|123|234|345|456|567|678|789)+/g))return isError=!0,void r("#cardlesspasswordError").html(r.i18n.t("app.login.errconseq"));for(var V=0,C=0;C<P.length-1;C++){var S=parseInt(P[C])+1;P[C+1]==S&&P[C]!=P[C+1]&&V++}if(4==V)return isError=!0,void r("#cardlesspasswordError").html(r.i18n.t("app.login.errconseq"))}return(""!=s||null!=s)&&""==a||null==a?(r("#cardlessconfirmPasswordError").html(r.i18n.t("validation.newregistration.confpwdnotnull")),!1):""!=s&&""!=a&&s!=a?(r("#cardlessconfirmPasswordError").html(r.i18n.t("validation.newregistration.pwdmismatch")),!1):void 0},gotoPwdSuccessPopUp:function(){r("#cardlessusernameError").html(""),r("#cardlesspasswordError").html(""),r("#cardlessconfirmPasswordError").html("");var e=this,s=!1,a=/[0-9]/g,i=/^[A-Za-z]/,o=r("#cardless_password").val(),l=r("#cardless_confpassword").val(),d=n.get("pwdpolicy"),c=r("#cardless_username").val(),p=r.trim(r("#cardless_username").val()),u=/[a-z\u0600-\u06FF]/g,h=/[A-Z\u0600-\u06FF]/g,w=c.charAt(0),m=c.charAt(c.length-1),g=/^[A-Z]/,f=/^[a-z]/,v=/^[0-9]/,E=/^[!@#$%^&*()-_+~.]/,C=/^[a-zA-Z]/;if(""==p||null==p)s=!0,r("#cardlessusernameError").html(r.i18n.t("validation.newregistration.usernamenotnull"));else{if(!i.test(p))return s=!0,void r("#cardlessusernameError").html(r.i18n.t("validation.newregistration.usrnamealphaerr"));if(p.length>20)return s=!0,void r("#cardlessusernameError").html(r.i18n.t("validation.newregistration.usernamemaxlengtherror"));if(!w.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return s=!0,void r("#cardlessusernameError").html(r.i18n.t("validation.newregistration.firstspaceind"));if(!m.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return s=!0,void r("#cardlessusernameError").html(r.i18n.t("validation.newregistration.lastspaceind"))}if((""==o||null==o)&&(s=!0,r("#cardlesspasswordError").html(r.i18n.t("validation.newregistration.pwdnotnull"))),(""==l||null==l)&&(s=!0,r("#cardlessconfirmPasswordError").html(r.i18n.t("validation.newregistration.confpwdnotnull"))),""==o||null==o)return s=!0,void r("#cardlesspasswordError").html(r.i18n.t("validation.newregistration.pwdnotnull"));if("U"===d.firstCharacterValue){if(!g.test(o))return s=!0,void r("#cardlesspasswordError").html(r.i18n.t("app.login.errUP"))}else if("L"===d.firstCharacterValue){if(f.test(o))return s=!0,void r("#cardlesspasswordError").html(r.i18n.t("app.login.errLOW"))}else if("N"===d.firstCharacterValue){if(v.test(o))return s=!0,void r("#cardlesspasswordError").html(r.i18n.t("app.login.errNUM"))}else if("S"===d.firstCharacterValue){if(E.test(o))return s=!0,void r("#cardlesspasswordError").html(r.i18n.t("app.login.errSpecl"))}else if("A"===d.firstCharacterValue&&!C.test(o))return r("#cardlesspasswordError").html(r.i18n.t("First Character should be an alphabet")),!1;if(o.length<d.minimumLength)return s=!0,void r("#cardlesspasswordError").html(r.i18n.t("app.login.pwderrlength1")+" "+d.minimumLength+" "+r.i18n.t("app.login.pwderrlength2")+" "+d.maximumLength+" "+r.i18n.t("app.login.pwderrlength3"));if(o.length>d.maximumLength)return s=!0,void r("#cardlesspasswordError").html(r.i18n.t("app.login.pwderrmaxlen")+" "+d.maximumLength+" "+r.i18n.t("app.login.pwderrlength3"));var y=o.search(a);if("Y"===d.numeralsMandatory&&"-1"==y)return s=!0,void r("#cardlesspasswordError").html(r.i18n.t("app.login.errnumber"));var P=o.search(u);if("Y"===d.lowercaseMandatory&&"-1"==P)return s=!0,void r("#cardlesspasswordError").html(r.i18n.t("app.login.errlwr"));var L=o.search(h);if("Y"===d.uppercaseMandatory)if("U"===d.firstCharacterValue){if(-1==L||0!==L)return r("#passwordError").html(r.i18n.t("app.login.errupr")),!1}else if(-1==L)return r("#passwordError").html(r.i18n.t("app.login.errupr")),!1;if("Y"===d.specialCharactersMandatory)if(isNull(d.disallowedCharacters)){var V=!1,S=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;if(S.test(o)||(V=!0),V)return s=!0,void r("#passwordError").html(r.i18n.t("app.login.errspc"))}else{for(var _=d.disallowedCharacters,A=!1,F=0;F<o.length;F++){var b=o[F];-1!=_.indexOf(b)&&(A=!0)}if(A)return s=!0,void r("#passwordError").html("Entered password does not match with password policy "+d.disallowedCharacters+" are not allowed");var V=!1,S=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;if(S.test(o)||(V=!0),V)return s=!0,void r("#passwordError").html(r.i18n.t("app.login.errspc"))}var x=o.toLowerCase();if("N"===d.repeatingValueAllowedInPwd)for(var F=0;F<x.length;F++){var b=x[F],U=x[F+1];if(b===U&&b===x[F+2])return s=!0,void r("#cardlesspasswordError").html(r.i18n.t("app.login.errcon"))}if("N"===d.seqValueAllowedInPwd){if(x.match(/([a-zA-Z0-9])\1\1+|(abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|jkl|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz|ABC|BCD|CDE|DEF|EFG|FGH|GHI|HIJ|IJK|JKL|KLM|LMN|MNO|NOP|OPQ|PQR|QRS|RST|STU|TUV|UVW|VWX|WXY|XYZ|012|123|234|345|456|567|678|789)+/g))return s=!0,void r("#cardlesspasswordError").html(r.i18n.t("app.login.errconseq"));for(var k=0,F=0;F<x.length-1;F++){var N=parseInt(x[F])+1;x[F+1]==N&&x[F]!=x[F+1]&&k++}if(4==k)return s=!0,void r("#cardlesspasswordError").html(r.i18n.t("app.login.errconseq"))}if((""!=o||null!=o)&&""==l||null==l)return s=!0,void r("#cardlessconfirmPasswordError").html(r.i18n.t("validation.newregistration.confpwdnotnull"));if(""!=o&&""!=l&&o!=l)return s=!0,void r("#cardlessconfirmPasswordError").html(r.i18n.t("validation.newregistration.pwdmismatch"));if(!s){var M=(new Date).getTime();encryptusername=EncryptWithDynamicSalt(p,M),encryptpwd=EncryptWithDynamicSalt(o,M),encryptconpwd=EncryptWithDynamicSalt(l,M);var I=function(r){e.gotoSuccessPopup()},q=function(r){e.errorresponse()};showSpinner();var z="false"==n.get("isCardlessCustomer")?"N":"Y";e.collection=new t;getDeviceId(),(new Date).getTime();e.collection.fetch({data:r.param({access_token:n.get("access_token"),salt:M,flag:z,newpwd:encryptpwd,userid:encryptusername,confpwd:encryptconpwd}),dataType:"json",type:"POST",cache:!1,success:function(r){"0000"==ackStatus?I(r):q(r)},error:q})}},gotoSuccessPopup:function(){hideSpinner(),r("#cardlesssuccess").modal("show")},gotoLoginUI:function(){hideSpinner(),s.history.navigate("#/login")},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(r){return s.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=r,this.currentView.delegateEvents(),this.currentView}});return i});