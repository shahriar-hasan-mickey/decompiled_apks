define(["jquery","underscore","Backbone","collections/transfer/getAccountBalanceCollections","collections/transfer/getIDTPLimitCollections","collections/transfer/getIdtpAccountsCollections","collections/transfer/validateVIDCollections","collections/transfer/getAmountInWordsCollections","text!views/transfer/binimoyDirectPayInitiate.tpl"],function(t,e,a,r,i,n,c,l,o){var s=new EncryptedLocalStorage("secret"),u=!1,d=a.View.extend({el:"#container",events:{"click .acccardnum_directPay":"directPaySelectedFromAcc","click #directPayFromAcc":"directPayOpenFromAccDropdown","click #directPayInitProceedBtn":"gotoDirectPayVerifyPage","click #directPayInitCancelBtn":"gotoDirectPayBeneSelectPage","blur #directPayInitToVID":"directPayValidateVID","blur #directPayAliasName":"validateAliasName","keyup #directPayAmount":"validateDirectPayAmount","click #binimoyDPTAndCPopup":"openBinimoyDPPopup"},initialize:function(){},update:function(){var t=this;t.getDirectPayTransactionLimit()},getDirectPayTransactionLimit:function(){var e=this,a=function(t){hideSpinner(),e.getIDTPTaggedAccounts()},r=function(t){e.errorresponse()};showSpinner(),e.collection=new i,e.collection.fetch({data:t.param({access_token:s.get("access_token")}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?a(t):r(t)},error:r})},getIDTPTaggedAccounts:function(){var e=this,a=function(t){hideSpinner(),e.loadTemplate()},r=function(t){e.errorresponse()};showSpinner(),e.collection=new n,e.collection.fetch({data:t.param({access_token:s.get("access_token")}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?a(t):r(t)},error:r})},loadTemplate:function(){for(var a=s.get("idtpAccounts"),r=getAccountDTO(),i=[],n=0;n<a.length;n++)for(var c=0;c<r.length;c++)r[c].accountNumber==a[n]&&i.push(r[c]);s.set("filteredIDTPTagAccounts",i),this.$el.html(e.template(o)),t("html").removeClass().addClass("app"),s.set("directPayFromAccId",null),s.set("directPayFromAccInd",null),s.set("directPayFromAccType",null),s.set("directPayFromAccCur",null),s.set("directPayFromAccType",null),s.set("IDTPTransferToVID",null),s.set("IDTPTransferAmount",null),s.set("IDTPTransferRemarks",null),s.set("IDTPTransferReference",null),s.set("IDTPTransferAliasName",null),t("#vidName").html("");var l=this,r=s.get("filteredIDTPTagAccounts"),u=[],d=s.get("defaultDebitAccount");u=r.filter(function(t){return t.accountNumber==d});var m=u[0].id;s.set("directPayFromAccId",m);var h="CASA";s.set("directPayFromAccType",h);var p=u[0].accountNumber;s.set("directPayFromAccNum",p);var v='<div class="qr_acc_outer">\n <ul class="list-unstyled m0">\n <li class="list-group-item">\n <div class="col-xs-2 first-col">\n<span class="menu_icon account"></span>\n</div>\n <div class="col-xs-10">\n<p class="acc_txt"> '+u[0].accountShortName+'</p>\n<p class="acc_cat"> <span class="selectAccNumber"> '+u[0].accountNumber+" </span></p>\n</div>\n </li>\n </ul>\n </div>";t("#seltpayval").html(v),t('li.acccardnum_directPay[accide="'+m+'"]').find("input").attr("checked","checked"),l.directPayGetFromAccountBalacne(),"true"==s.get("isFromRecentVID")?(t("#directPayInitToVID").val(s.get("selectedRecentVID")),l.directPayValidateVID()):t("#directPayInitToVID").val("")},directPayOpenFromAccDropdown:function(e){"object"==typeof e&&(e.preventDefault(),e.stopImmediatePropagation()),t("#card_account").modal("show")},directPaySelectedFromAcc:function(e){"object"==typeof e&&(e.preventDefault(),e.stopImmediatePropagation()),s.set("isFromDropdownSelect","true");var a=this,r=t(e.target).closest("li.acccardnum_directPay").attr("Accide");s.set("directPayFromAccId",r);var i=t(e.target).closest("li.acccardnum_directPay").attr("id");s.set("directPayFromAccInd",i);var n=t(e.target).closest("li.acccardnum_directPay").attr("acctype");s.set("directPayFromAccType",n);var c=t(e.target).closest("li.acccardnum_directPay").attr("accNum");s.set("directPayFromAccNum",c);var l=t(e.target).closest("li.acccardnum_directPay").attr("data");s.set("directPayFromAccCur",l),s.set("directPayFromAccType",n),a.directPayGetFromAccountBalacne(e),t('li.acccardnum_directPay[accide="'+r+'"]').find("input").attr("checked","checked");var o=t(e.target).closest("li.acccardnum_directPay").find(".row").clone().html(),u='<div class="qr_acc_outer">\n <ul class="list-unstyled m0">\n <li class="list-group-item">\n'+o+"</li>\n </ul>\n </div>";t("#seltpayval").html(u),t("#card_account .close").trigger("click")},directPayGetFromAccountBalacne:function(e){"object"==typeof e&&(e.preventDefault(),e.stopImmediatePropagation()),t("#acntNumErr").html("");var a=s.get("directPayFromAccId");if(""==a)return t("#availbal").html(""),void t("#availBalDiv").hide();var i=this,n=function(e){hideSpinner(),t("#availBalDiv").hide(),t("#availbal").html("");var a,r,i=s.get("availableBalance"),n=parseFloat(i.slice(0,-2)),c=null==s.get("accountCurrency")||""==s.get("accountCurrency")?"":s.get("accountCurrency"),l=s.get("directPayFromAccType");s.set("directPayFromAccType",l),"CASA"==l&&(a=checkAmount(t.formatNumber(n,{format:"#,###.00",locale:"us"})),r=a+" "+c,s.set("directPayFromAcntAvailBal",n)),t("#availbal").html(r),t("#availBalDiv").show()},c=function(e){i.errorresponse(),t("#card_account .close").trigger("click")};showSpinner(),i.collection=new r,i.collection.fetch({data:t.param({access_token:s.get("access_token"),accountId:a,accountType:s.get("directPayFromAccType"),beneficiaryInstructionId:null}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?n(t):c(t)},error:c})},directPayValidateVID:function(e){"object"==typeof e&&e.stopImmediatePropagation(),t("#vidNullError").html("");var a=t("#directPayInitToVID").val().toLowerCase(),r=s.get("registerdDevice").toLowerCase();if(isNull(a))return void t("#vidNullError").html("Please enter a BINIMOY VID");if(!isNull(a)){var i=a.charAt(0),n=a.charAt(a.length-1);if(a==r)return void t("#vidNullError").html("The Sender VID and the Receiver VID cannot be the same");if(!i.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return void t("#vidNullError").html(t.i18n.t("validation.newregistration.firstspaceind"));if(!n.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return void t("#vidNullError").html(t.i18n.t("validation.newregistration.lastspaceind"))}showSpinner();var l=this,o=function(e){hideSpinner(),t("#vidName").html(s.get("virtualIdName")),s.set("IDTPTransferToVID",a),s.set("isValidBinimoyVID","true")},u=function(e){hideSpinner(),t("#vidName").html(""),s.set("IDTPTransferToVID",a),s.set("isValidBinimoyVID","false"),l.errorresponse()};showSpinner(),l.collection=new c,l.collection.fetch({data:t.param({access_token:s.get("access_token"),virtual_id:a,service_flag:"DP"}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?o(t):u(t)},error:u})},openBinimoyDPPopup:function(t){t.stopImmediatePropagation(),s.set("tandctype","binimoyDP"),openTermsAndConditionsPopup()},validateDirectPayAmount:function(e){e.stopImmediatePropagation(),t("#acntNumErr").html(""),t("#amountNullErr").html("");var a=s.get("directPayFromAcntAvailBal"),r=s.get("directPayFromAccId"),i=t("#directPayAmount").val().replace(/,/g,"");if(!isNull(i)){if(isNull(r)||isNull(a))return void t("#acntNumErr").html("Please select a From Account");if(!isNull(i)){i>a&&(u=!0,t("#amountNullErr").html(t.i18n.t("validation.transfer.nobal")));var n=parseFloat(s.get("idtpMin")),c=parseFloat(s.get("idtpMax"));if(n>i)return void t("#amountNullErr").html(t.i18n.t("validation.sadad.amtgreaterthanminamt"));if(i>c)return void t("#amountNullErr").html(t.i18n.t("validation.sadad.amtlessthanmaxamt"))}}},gotoDirectPayVerifyPage:function(e){"object"==typeof e&&e.stopImmediatePropagation(),t("#vidNullError").html(""),t("#amountNullErr").html(""),t("#remarksNullErr").html(""),t("#acntNumErr").html(""),t("#referenceNullErr").html(""),t("#aliasNameNullErr").html(""),t("#binimoyDPTandCErr").html(""),u=!1;var a=t("#directPayInitToVID").val().toLowerCase(),r=(t("#directPayAmount").val(),t("#directPayAmount").val().replace(/,/g,"")),i=t("#directPayRemarks").val(),n=t("#directPayRefID").val(),c=t("#directPayAliasName").val(),l=s.get("registerdDevice").toLowerCase(),o=s.get("directPayFromAcntAvailBal"),d=t("#binimoyDPTandC").prop("checked");if(isNull(s.get("directPayFromAccId"))&&(u=!0,t("#acntNumErr").html("Please select a From Account")),isNull(a)&&(u=!0,t("#vidNullError").html("Please enter a VID")),!isNull(a)){var m=a.charAt(0),h=a.charAt(a.length-1);if("false"==s.get("isValidBinimoyVID")&&(u=!0,t("#vidNullError").html("Please enter a valid BINIMOY VID")),a.length>24&&(u=!0,t("#vidNullError").html("The To VID should contain maximum of 24 characters")),a==l&&(u=!0,t("#vidNullError").html("The Sender VID and the Receiver VID cannot be the same")),!m.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return t("#vidNullError").html(t.i18n.t("validation.newregistration.firstspaceind")),!1;if(!h.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return t("#vidNullError").html(t.i18n.t("validation.newregistration.lastspaceind")),!1}if(!isNull(c)){var m=c.charAt(0),h=c.charAt(c.length-1);if(c.length>24&&(u=!0,t("#aliasNameNullErr").html("The Alias name should contain maximum of 24 characters")),!m.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return t("#aliasNameNullErr").html(t.i18n.t("validation.newregistration.firstspaceind")),!1;if(!h.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return t("#aliasNameNullErr").html(t.i18n.t("validation.newregistration.lastspaceind")),!1}if(isNull(r)&&(u=!0,t("#amountNullErr").html("Please enter a amount")),!isNull(r)){r>o&&(u=!0,t("#amountNullErr").html(t.i18n.t("validation.transfer.nobal")));var p=parseFloat(s.get("minAmountPerTransaction")),v=parseFloat(s.get("maxAmountPerTransaction")),f=parseFloat(s.get("dailyAvailableLimit")),y=s.get("dailyAvailableCount"),P=s.get("monthlyAvailableCount");if(p>r)return void t("#amountNullErr").html(t.i18n.t("validation.sadad.amtgreaterthanminamt"));if(r>v)return void t("#amountNullErr").html(t.i18n.t("validation.sadad.amtlessthanmaxamt"));if(r>f)return void t("#amountNullErr").html(t.i18n.t("validation.transfer.notra"));if("0"==y)return void t("#amountNullErr").html("You have exceeded your daily transaction count.");if("0"==P)return void t("#amountNullErr").html("Transaction count exceeded Monthly Available Count.")}if(isNull(i)&&(u=!0,t("#remarksNullErr").html("Please enter a remarks")),!isNull(i)){var m=i.charAt(0),h=i.charAt(i.length-1);if(i.length>24&&(u=!0,t("#remarksNullErr").html("The Remarks should contain maximum of 24 characters")),!m.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return t("#remarksNullErr").html(t.i18n.t("validation.newregistration.firstspaceind")),!1;if(!h.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return t("#remarksNullErr").html(t.i18n.t("validation.newregistration.lastspaceind")),!1}if(isNull(n)||n.length>24&&(u=!0,t("#referenceNullErr").html("The Reference ID should contain maximum of 24 characters")),d||(u=!0,t("#binimoyDPTandCErr").html("Please check the Terms and Conditions")),!u){s.set("IDTPTransferToVID",a),s.set("IDTPTransferAmount",r),s.set("IDTPTransferRemarks",i),s.set("IDTPTransferReference",n),s.set("IDTPTransferAliasName",c);var g=this;g.getAmountInWords(e)}},getAmountInWords:function(e){e.stopImmediatePropagation();var r=this;showSpinner();var r=this,i=function(t){hideSpinner(),a.history.navigate("#/binimoydirectpayverify")},n=function(t){hideSpinner(),r.errorresponse()};showSpinner(),r.collection=new l,r.collection.fetch({data:t.param({access_token:s.get("access_token"),amount:s.get("IDTPTransferAmount")}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?i(t):n(t)},error:n})},gotoDirectPayBeneSelectPage:function(t){t.stopImmediatePropagation(),a.history.navigate("#/binimoybeneselect")},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(t){return a.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=t,this.currentView.delegateEvents(),this.currentView}});return d});