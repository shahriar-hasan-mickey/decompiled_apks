define(["jquery","underscore","Backbone","collections/transfer/getTransactionLimitCollections","collections/transfer/getAccountBalanceCollections","collections/transfer/ownAccountTransferCollections","collections/transfer/currencyListsCollections","collections/wealth/prepaidcardCollections","collections/transfer/getAuthModeCollections","models/validation/transfer/withinAccountrepeatTransferValidationModel","text!views/transfer/ownaccountinitiate.tpl"],function(t,e,a,r,n,o,i,s,c,l,d){var u=new EncryptedLocalStorage("secret"),m=a.View.extend({el:"#container",events:{"click #OA_confirmButton":"submitPay","click #OwnAccPayNow":"showPayNowDiv","click #OwnAccPayLater":"showPayLaterDiv","click #OwnAccRepeat":"showRepeatDiv","click #OwnAcc_Init_BackBtn":"gotoPreviousPage","change #OwnAcc_FromAccNum":"getAccountBalance","blur #ownpaymentAmount":"getOwnAccountAuthMode","click #ownAccTandCPopup":"ownAccOpenTandCPopup"},initialize:function(){},update:function(){var e=this,a=function(t){hideSpinner(),e.getPrepaidCardList()},n=function(t){e.errorresponse()};showSpinner(),e.collection=new r,e.collection.fetch({data:t.param({access_token:u.get("access_token"),payeeType:"OA"}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?a(t):n(t)},error:n})},getPrepaidCardList:function(){var e=this;if("false"==u.get("isPrepaidCardData")){var a=function(t){hideSpinner(),e.loadTemplate(),u.set("isPrepaidCardData","true")},r=function(t){e.errorresponse()};showSpinner(),e.collection=new s([],{});getDeviceId();e.collection.fetch({data:t.param({newversion:"Y",access_token:u.get("access_token")}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?a(t):r(t)},error:r})}else hideSpinner(),e.loadTemplate()},loadTemplate:function(){t("html").removeClass().addClass("app"),this.$el.html(e.template(d)),t("#payLater").hide(),t("#repeat").hide(),t("#availBalDiv").hide(),t("#othersDiv").hide(),t("#ownAccShortNotesUIDiv").hide();var a=t.parseJSON(window.localStorage.getItem("shortNotesObj"));isNull(a.OWNACCT)||(t("#ownAccShortNotesUIDiv").show(),t("#ownAccShortNotesDiv").html(a.OWNACCT))},showPayNowDiv:function(e){e.stopImmediatePropagation(),t("#payLater").hide(),t("#repeat").hide(),t("#pdate").val(""),t("#payDateError").html(""),t("#pdate").attr("disabled",!0),t("#payDateError").attr("disabled",!0),t("#sdate").val(""),t("#fre").val(""),t("#not").val(""),t("#startDateErr").html(""),t("#FreqErr").html(""),t("#NoOfTimesErr").html(""),t("#sdate").attr("disabled",!0),t("#startDateErr").attr("disabled",!0),t("#fre").attr("disabled",!0),t("#FreqErr").attr("disabled",!0),t("#not").attr("disabled",!0),t("#NoOfTimesErr").attr("disabled",!0)},showPayLaterDiv:function(e){e.stopImmediatePropagation(),t("#payLater").show(),t("#repeat").hide(),t("#pdate").attr("disabled",!1),t("#payDateError").attr("disabled",!1),t("#sdate").val(""),t("#fre").val(""),t("#not").val(""),t("#startDateErr").html(""),t("#FreqErr").html(""),t("#NoOfTimesErr").html(""),t("#sdate").attr("disabled",!0),t("#startDateErr").attr("disabled",!0),t("#fre").attr("disabled",!0),t("#FreqErr").attr("disabled",!0),t("#not").attr("disabled",!0),t("#NoOfTimesErr").attr("disabled",!0)},showRepeatDiv:function(e){e.stopImmediatePropagation(),t("#payLater").hide(),t("#repeat").show(),t("#pdate").val(""),t("#payDateError").html(""),t("#pdate").attr("disabled",!0),t("#payDateError").attr("disabled",!0),t("#sdate").attr("disabled",!1),t("#startDateErr").attr("disabled",!1),t("#fre").attr("disabled",!1),t("#FreqErr").attr("disabled",!1),t("#not").attr("disabled",!1),t("#NoOfTimesErr").attr("disabled",!1)},gotoPreviousPage:function(t){t.stopImmediatePropagation(),a.history.navigate("#/ownaccviewbene")},getAccountBalance:function(e){e.stopImmediatePropagation();var a=t("#OwnAcc_FromAccNum").val();if(""==a)return t("#availbal").html(""),void t("#availBalDiv").hide();var r=t("#OwnAcc_FromAccNum option:selected").attr("acctype");"PC"==r?u.set("typeOfTransfer","PC"):"CASA"==r&&u.set("typeOfTransfer","CASA");var o=this,i=function(a){hideSpinner(),t("#acntNumErr").html(""),t("#availBalDiv").show();var n,i,s=u.get("availableBalance"),c=parseFloat(s.slice(0,-2)),l=u.get("accountCurrency");"CASA"==r?(n=checkAmount(t.formatNumber(c,{format:"#,###.00",locale:"us"})),i=n+" "+l,u.set("fromAcntAvailBal",c)):"PC"==r&&(n=checkAmount(t.formatNumber(s,{format:"#,###.00",locale:"us"})),i=n+" "+l,u.set("fromAcntAvailBal",s)),t("#availbal").html(i);var l=t("#OwnAcc_FromAccNum option:selected").attr("data");u.get("toAcntCurr");"BDT"==l?(o.populateBDT(e),u.set("fromAcntCurr","BDT")):(o.getCurrencyList(e),u.set("fromAcntCurr",l))},s=function(t){o.errorresponse()};showSpinner(),o.collection=new n,o.collection.fetch({data:t.param({access_token:u.get("access_token"),accountId:a,accountType:u.get("typeOfTransfer"),beneficiaryInstructionId:null}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?i(t):s(t)},error:s})},getCurrencyList:function(e){var a=this;e.stopImmediatePropagation();var r=function(t){hideSpinner(),a.populateCurrencyDropDown()},n=function(t){a.errorresponse()};showSpinner(),a.collection=new i,a.collection.fetch({data:t.param({access_token:u.get("access_token")}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?r(t):n(t)},error:n})},getOwnAccountAuthMode:function(e){var r=this;e.stopImmediatePropagation(),this.model=new l({url:"json/"}),a.Validation.bind(this);var n=this.$("form").serializeObject();this.model.set(n,{validate:!0})?(this.model.clear(),a.Validation.unbind(this)):this.$(".has-error").fadeIn(),t("#transAmountError").html("");var o=t("#ownpaymentAmount").val().replace(/,/g,""),i=new RegExp("^[0-9.,]+$");if(u.set("IsAuthMode","false"),u.set("authModeFlag","false"),t("#transAmountError").html(""),t("#OA_AuthModeDiv").html(""),u.set("transferType","OwnAcc"),!isNull(o)){if(!isNull(o)&&!i.test(o))return void t("#transAmountError").html(t.i18n.t("validation.transfer.validamount"));var o=parseFloat(t("#ownpaymentAmount").val().replace(/,/g,"")),s=parseFloat(u.get("minAmountPerTransaction")),d=parseFloat(u.get("maxAmountPerTransaction"));if(s>o&&"BDT"==u.get("fromAcntCurr"))return void t("#transAmountError").html(t.i18n.t("validation.sadad.amtgreaterthanminamt"));if(o>d&&"BDT"==u.get("fromAcntCurr"))return void t("#transAmountError").html(t.i18n.t("validation.sadad.amtlessthanmaxamt"));var m=function(t){hideSpinner();var a=u.get("securitySettingList");!isNull(a)&&a.length>0?u.set("IsAuthMode","true"):(u.set("alertType",null),u.set("IsAuthMode","false")),r.populateAuthMode(e),r.submitPay(e)},p=function(e){hideSpinner(),u.set("authModeFlag","true"),t("#ownpaymentAmount").val(""),r.errorresponse()};showSpinner(),r.collection=new c,r.collection.fetch({data:t.param({access_token:u.get("access_token"),transactionAmount:o,tenantServiceCode:"O"}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?m(t):p(t)},error:p})}},populateAuthMode:function(e){e.stopImmediatePropagation();var a="",r="",n=u.get("securitySettingList"),o="<label for='username'>"+t.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";o+="<div class='custRadio_pass'>",!isNull(n)&&n.length>0?(t("#OA_AuthModeDiv").html(""),t.each(n,function(e,n){"SMS"==n?(a="sms",r=t.i18n.t("app.transfer.managebeneficiary.sms")):"EMAIL"==n?(a="mail",r=t.i18n.t("app.transfer.managebeneficiary.mail")):"TOKEN"==n?(a="fScan",r=t.i18n.t("app.transfer.managebeneficiary.token")):"ESIGN"==n&&(a="esign",r=t.i18n.t("app.transfer.managebeneficiary.esign")),o+='<div class="box"><div class="radio"><label>',o+=0==e?'<input type="radio" name="ownAccount_AuthMode" id="optionsRadios'+e+'" value="'+n+'" checked>':'<input type="radio" name="ownAccount_AuthMode" id="optionsRadios'+e+'" value="'+n+'">',o+='<div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs '+a+'"></span><span class="small">'+r+"</span></div></div></label></div></div>"}),t("#OA_AuthModeDiv").html(o)):t("#OA_AuthModeDiv").html("")},populateCurrencyDropDown:function(){var e=u.get("currencyLists");t("#currency").empty();var a="",r=u.get("fromAcntCurr");u.get("toAcntCurr");t.each(e,function(t,e){e.code==r&&(a+="<option value='"+e.code+"' selected>"+e.code+"</option>")}),t("#currency").append(a)},populateBDT:function(e){e.stopImmediatePropagation(),t("#currency").empty();var a="";a+="<option value='BDT' selected>BDT</option>",t("#currency").append(a)},submitPay:function(e){e.stopImmediatePropagation(),t("#tandcErr").html(""),t("#error_amount").html(""),t("#payDateError").html(""),t("#startDateErr").html(""),t("#FreqErr").html(""),t("#NoOfTimesErr").html(""),t("#transAmountError").html(""),t("#otherRemaksNullError").html("");var r=new RegExp("^[0-9.,]+$"),n=new RegExp("^[A-Za-z0-9 ]+$"),o=t("#OA_OtherRemarks").val(),i=t("#ownpaymentAmount").val().replace(/,/g,""),s=this;this.model=new l({url:"json/"}),a.Validation.bind(this);var c=this.$("form").serializeObject();if(this.model.set(c,{validate:!0})){this.model.clear(),a.Validation.unbind(this);var d=t("#currency option:selected").val();if(u.get("fromAcntCurr")==d){var m=u.get("fromAcntAvailBal"),p=parseFloat(t("#ownpaymentAmount").val().replace(/,/g,""));if(p>m)return void t("#transAmountError").html(t.i18n.t("validation.transfer.nobal"));var h=t("#termsand").prop("checked");if(!h)return void t("#tandcErr").html("Please check the Terms and Conditions")}if(!isNull(i)&&!r.test(i))return void t("#transAmountError").html(t.i18n.t("validation.transfer.validamount"));if(!isNull(o)&&o.length>16)return void t("#otherRemaksNullError").html("The Remarks should contain maximum of 16 characters");if(!isNull(o)&&!n.test(o))return void t("#otherRemaksNullError").html(t.i18n.t("validation.managebene.remarksspecialchar"));if("BDT"==u.get("fromAcntCurr")&&"BDT"==u.get("toAcntCurr")){var f=parseFloat(u.get("minAmountPerTransaction")),v=parseFloat(u.get("maxAmountPerTransaction")),A=parseFloat(u.get("dailyAvailableLimit")),p=parseFloat(t("#ownpaymentAmount").val().replace(/,/g,"")),g=u.get("dailyAvailableCount"),y=u.get("monthlyAvailableCount");if(f>p)return t("#transAmountError").html(t.i18n.t("validation.sadad.amtgreaterthanminamt")),!1;if(p>v)return t("#transAmountError").html(t.i18n.t("validation.sadad.amtlessthanmaxamt")),!1;if(p>A)return void t("#transAmountError").html(t.i18n.t("validation.transfer.notra"));if("0"==g)return void t("#transAmountError").html("You have exceeded your daily transaction count.");if("0"==y)return void t("#transAmountError").html("Transaction count exceeded Monthly Available Count.")}var w="paynow";"paynow"==w&&u.set("payType","PAYNOW");var T=new Date,b=T.getDate(),E=T.getMonth()+1,D=T.getFullYear(),P=new Date(D,E,b),C=("00"+b.toString()).slice(-2)+"/"+("00"+E.toString()).slice(-2)+"/"+("0000"+D.toString()).slice(-4);if(u.set("payDate",C),"paylater"==w){u.set("payType","LATER");var O=t("#pdate").val();if(""==O)return void t("#payDateError").html("Please enter the Payment Date");var S=O.split("-"),N=S[2],k=S[1],F=S[0],I=new Date(N,k,F);if(I.getTime()<P.getTime())return void t("#payDateError").html(t.i18n.t("validation.transfer.greaterdate"))}else if("schpay"==w){u.set("payType","REPEAT");var _=t("#sdate").val(),B=t("#freoption:selected").val(),M=t("#not option:selected").val();if(""==_)return void t("#startDateErr").html(t.i18n.t("validation.transfer.startdate"));if(""==B)return void t("#FreqErr").html(t.i18n.t("validation.transfer.freqList"));if(""==M)return void t("#NoOfTimesErr").html(t.i18n.t("validation.transfer.not"));if(""!==_){var L=_.split("-"),R=L[2],x=L[1],V=L[0],j=new Date(R,x,V);if(j.getTime()<P.getTime())return void t("#startDateErr").html(t.i18n.t("validation.transfer.greaterdate"))}}if("true"==u.get("authModeFlag"))return;s.beneconfrom(e)}else this.$(".has-error").fadeIn(),e.preventDefault()},beneconfrom:function(e){e.stopImmediatePropagation();var a=t("#OwnAcc_FromAccNum option:selected").attr("id");u.set("fromAccountIndex",a);var r=t("#OwnAcc_FromAccNum option:selected").val();u.set("fromAcntId",r);var n=t("#ownpaymentAmount").val().replace(/,/g,"");u.set("transferAmount",n);var o=t("#OA_OtherRemarks").val();u.set("transferReason",o);var i=t("#OwnAcc_FromAccNum option:selected").attr("acctype");"CASA"==i?u.set("transferType","A2A"):"PC"==i&&u.set("transferType","P2A");var s=t("#OwnAcc_FromAccNum option:selected").attr("frmname");u.set("fromAccountName",s);var c=t("#OwnAcc_FromAccNum option:selected").html();u.set("fromAccountNumber",c);var l=t("#currency option:selected").val();u.set("transCurrency",l);var d=t("input[name='ownAccount_AuthMode']:checked").val();u.set("alertType",d);var m=this;m.gotoVerifyPage(e)},gotoVerifyPage:function(e){e.stopImmediatePropagation(),t("#transAmountError").html("");var r=this,n=function(e){if("BDT"!==u.get("fromAcntCurr")||"BDT"!==u.get("toAcntCurr")){hideSpinner();var r=parseFloat(u.get("paymentAmount")),n=parseFloat(u.get("minAmountPerTransaction")),o=parseFloat(u.get("maxAmountPerTransaction")),i=parseFloat(u.get("dailyAvailableLimit"));if(n>r)return t("#transAmountError").html(t.i18n.t("validation.sadad.amtgreaterthanminamt")),!1;if(r>o)return t("#transAmountError").html(t.i18n.t("validation.sadad.amtlessthanmaxamt")),!1;if(r>i)return void t("#transAmountError").html(t.i18n.t("validation.transfer.notra"));u.set("beneSuccessFlag","true"),a.history.navigate("#/ownaccountverify")}else hideSpinner(),u.set("beneSuccessFlag","true"),a.history.navigate("#/ownaccountverify")},i=function(t){r.errorresponse()};showSpinner(),r.collection=new o,r.collection.fetch({data:t.param({access_token:u.get("access_token"),fromaccountId:u.get("fromAcntId"),paymentdate:u.get("payDate"),transtype:u.get("payType"),validtype:"Validation",beneAcctType:"CASA",currSelection:"F",transcurrency:u.get("transCurrency"),toaccountId:u.get("toAccountId"),remarks:u.get("transferReason"),trnasfertype:u.get("transferType"),uniqueId:null,globalId:null,totalDebitAmount:u.get("transferAmount"),transamount:u.get("transferAmount")}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?n(t):i(t)},error:i})},ownAccOpenTandCPopup:function(t){t.stopImmediatePropagation(),u.set("tandctype","ownaccount"),openTermsAndConditionsPopup()},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(t){return a.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=t,this.currentView.delegateEvents(),this.currentView}});return m});