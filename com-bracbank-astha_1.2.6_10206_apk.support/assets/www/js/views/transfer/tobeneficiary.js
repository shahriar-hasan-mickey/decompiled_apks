define(["jquery","underscore","Backbone","collections/transfer/getTransactionLimitCollections","collections/transfer/getAccountBalanceCollections","collections/transfer/withinBankTransferProcessCollection","collections/transfer/currencyListsCollections","collections/transfer/getAuthModeCollections","models/validation/transfer/withinAccountrepeatTransferValidationModel","models/validation/transfer/withinAccountTransferValidationModel","models/validation/transfer/ownAccountTransferrepeatValidationModel","text!views/transfer/tobeneficiary.tpl"],function(e,t,a,n,r,i,o,s,c,l,u,m){var p=!1,h=new EncryptedLocalStorage("secret"),d=a.View.extend({el:"#container",events:{"click #WB_ToBene_InitConfirm":"submitPay","click #WithinBank_PayNow":"paynowshow","click #WithinBank_PayLater":"paylatershow","click #WithinBank_Repeat":"payrepeat","blur #within_to_paymentAmount":"getWithinToAuthMode","change #WithinBank_ToBene_FromAcc":"getAccountBalance","change #purposetransfer":"showOthersDiv","click #withinBankToBeneTandCPopup":"toBeneOpenTandCPopup"},initialize:function(){},update:function(){var t=this,a=function(e){hideSpinner(),t.loadtemplet()},r=function(e){t.errorresponse()};showSpinner(),t.collection=new n,t.collection.fetch({data:e.param({access_token:h.get("access_token"),payeeType:"WITHIN_BANK"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?a(e):r(e)},error:r})},getWithinToAuthMode:function(t){var n=this;t.stopImmediatePropagation();var r=e("#within_to_paymentAmount").val().replace(/,/g,"");h.set("IsAuthMode","false"),h.set("authModeFlag","false"),e("#transfermountError").html(""),e("#within_tobebe_transferDiv").html("");var i=new RegExp("^[0-9.,]+$");this.model=new c({url:"json/"}),a.Validation.bind(this);var o=this.$("form").serializeObject();if(this.model.set(o,{validate:!0})?(this.model.clear(),a.Validation.unbind(this)):this.$(".has-error").fadeIn(),h.set("transferType","withinToBene"),!isNull(r)){if(!isNull(r)&&!i.test(r))return void e("#transfermountError").html(e.i18n.t("validation.transfer.validamount"));var r=parseFloat(e("#within_to_paymentAmount").val().replace(/,/g,"")),l=parseFloat(h.get("minAmountPerTransaction")),u=parseFloat(h.get("maxAmountPerTransaction"));if(l>r)return void e("#transfermountError").html(e.i18n.t("validation.sadad.amtgreaterthanminamt"));if(r>u)return void e("#transfermountError").html(e.i18n.t("validation.sadad.amtlessthanmaxamt"));var m=function(e){hideSpinner();var a=h.get("securitySettingList");!isNull(a)&&a.length>0?h.set("IsAuthMode","true"):(h.set("alertType",null),h.set("IsAuthMode","false")),n.populateAuthMode(t),n.submitPay(t)},p=function(t){hideSpinner(),h.set("authModeFlag","true"),e("#within_to_paymentAmount").val(""),n.errorresponse()};showSpinner(),n.collection=new s,n.collection.fetch({data:e.param({access_token:h.get("access_token"),transactionAmount:r,tenantServiceCode:"W"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?m(e):p(e)},error:p})}},populateAuthMode:function(t){t.stopImmediatePropagation();var a="",n="",r=h.get("securitySettingList"),i="<label for='username'>"+e.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";i+="<div class='custRadio_pass'>",!isNull(r)&&r.length>0?(e("#within_tobebe_transferDiv").html(""),e.each(r,function(t,r){"SMS"==r?(a="sms",n=e.i18n.t("app.transfer.managebeneficiary.sms")):"EMAIL"==r?(a="mail",n=e.i18n.t("app.transfer.managebeneficiary.mail")):"TOKEN"==r?(a="fScan",n=e.i18n.t("app.transfer.managebeneficiary.token")):"ESIGN"==r&&(a="esign",n=e.i18n.t("app.transfer.managebeneficiary.esign")),i+='<div class="box"><div class="radio"><label>',i+=0==t?'<input type="radio" name="within_tobebe_transfer" id="optionsRadios'+t+'" value="'+r+'" checked>':'<input type="radio" name="within_tobebe_transfer" id="optionsRadios'+t+'" value="'+r+'">',i+='<div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs '+a+'"></span><span class="small">'+n+"</span></div></div></label></div></div>"}),e("#within_tobebe_transferDiv").html(i)):e("#within_tobebe_transferDiv").html("")},loadtemplet:function(){e("html").removeClass().addClass("app"),this.$el.html(t.template(m)),e("#withinBeneShortNotesUIDiv").hide();var a=e.parseJSON(window.localStorage.getItem("shortNotesObj"));isNull(a.WITHINBENE)||(e("#withinBeneShortNotesUIDiv").show(),e("#withinBeneShortNotesDiv").html(a.WITHINBENE)),e("#availBalDiv").hide()},paynowshow:function(t){t.stopImmediatePropagation(),e("#payLater").hide(),e("#schPay").hide()},paylatershow:function(t){t.stopImmediatePropagation(),e("#payLater").show(),e("#schPay").hide()},payrepeat:function(t){t.stopImmediatePropagation(),e("#payLater").hide(),e("#schPay").show()},showOthersDiv:function(t){t.stopImmediatePropagation();var a=e("#purposetransfer option:selected").val();"others"==a?e("#othersDiv").show():e("#othersDiv").hide()},getAccountBalance:function(t){t.stopImmediatePropagation();var a=e("#WithinBank_ToBene_FromAcc option:selected").attr("Accide");if(""==a)return e("#availbalance").html(""),void e("#availBalDiv").hide();var n=e("#WithinBank_ToBene_FromAcc option:selected").attr("frName");h.set("fromname",n),h.set("accountID",a);var i=h.get("beneficiaryDTO"),o=h.get("selectid1"),s=e("#WithinBank_ToBene_FromAcc option:selected").attr("acctype"),c=i[o].imAccountType;"account"==c?h.set("Benetyptrans1","CASA"):"CREDITCARD"==c&&h.set("Benetyptrans1","CC"),"CASA"==s&&"account"==c?h.set("tYpeOfTransAcc","A2A"):"PC"==s&&"CREDITCARD"==c?h.set("tYpeOfTransAcc","P2C"):"PC"==s&&"account"==c?h.set("tYpeOfTransAcc","P2A"):"CASA"==s&&"CREDITCARD"==c&&h.set("tYpeOfTransAcc","A2C");var l=h.get("noindex1"),i=h.get("beneficiaryDTO"),u=i[l].beneInstId,m=this,d=function(t){hideSpinner(),e("#error_acc").html(""),e("#availBalDiv").show(),p=!1;var a,n,r=h.get("availableBalance"),i=parseFloat(r.slice(0,-2)),o=h.get("accountCurrency");"CASA"==s?(a=checkAmount(e.formatNumber(i,{format:"#,###.00",locale:"us"})),n=a+" "+o,h.set("fromAcntAvailBal",i)):"PC"==s&&(a=checkAmount(e.formatNumber(r,{format:"#,###.00",locale:"us"})),n=a+" "+o,h.set("fromAcntAvailBal",r)),e("#availbalance").html(n);var o=e("#WithinBank_ToBene_FromAcc option:selected").attr("data");"BDT"==o?(m.populateBDT(),h.set("fromAccCur","BDT")):(m.getCurrencyList(),h.set("fromAccCur",o))},f=function(e){p=!0,m.errorresponse()};showSpinner(),m.collection=new r,m.collection.fetch({data:e.param({access_token:h.get("access_token"),accountId:a,accountType:s,beneficiaryInstructionId:u}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?d(e):f(e)},error:f})},populateBDT:function(){e("#currency").empty();var t="";t+="<option value='BDT' selected>BDT</option>",e("#currency").append(t)},getCurrencyList:function(){var t=this,a=function(e){hideSpinner(),t.populateCurrencyDropDown()},n=function(e){t.errorresponse()};showSpinner(),t.collection=new o,t.collection.fetch({data:e.param({access_token:h.get("access_token")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?a(e):n(e)},error:n})},populateCurrencyDropDown:function(){var t=h.get("currencyLists");e("#currency").empty();var a="",n=h.get("fromAccCur");e.each(t,function(e,t){t.code==n&&(a+="<option value='"+t.code+"' selected>"+t.code+"</option>")}),e("#currency").append(a)},loadviewBeneficiaryUI:function(){a.history.navigate("#/viewbeneficiary")},submitPay:function(t){t.stopImmediatePropagation(),e("#tandcErr").html(""),e("#transfermountError").html(""),e("#otherRemaksNullError").html("");var n=e("#within_to_paymentAmount").val().replace(/,/g,""),r=new RegExp("^[0-9.,]+$"),i=new RegExp("^[A-Za-z0-9 ]+$"),o=e("#WBToBene_OtherRemarks").val(),s="PAYNOW",m=e("input[name='within_tobebe_transfer']:checked").val();if(h.set("alertType",m),h.set("paymentType",s),h.set("toAccCurr","BDT"),!isNull(n)&&!r.test(n))return void e("#transfermountError").html(e.i18n.t("validation.transfer.validamount"));if(!isNull(o)&&o.length>16)return void e("#otherRemaksNullError").html("The Remarks should contain maximum of 16 characters");if(!isNull(o)&&!i.test(o))return void e("#otherRemaksNullError").html(e.i18n.t("validation.managebene.remarksspecialchar"));if("PAYNOW"==s){var d=this;this.model=new c({url:"json/"}),a.Validation.bind(this);var f=this.$("form").serializeObject();if(this.model.set(f,{validate:!0})){this.model.clear(),a.Validation.unbind(this);var v=e("#currency option:selected").val(),y=e("#termsand").prop("checked");if(!y)return void e("#tandcErr").html("Please check the Terms and Conditions");if(h.get("fromAccCur")==v){var g=h.get("fromAcntAvailBal"),A=parseFloat(e("#within_to_paymentAmount").val().replace(/,/g,""));if(A>g)return e("#transfermountError").html(e.i18n.t("validation.transfer.nobal")),!1}if("BDT"==h.get("fromAccCur")&&"BDT"==h.get("toAccCurr")){var b=parseFloat(h.get("dailyAvailableLimit")),T=parseFloat(h.get("minAmountPerTransaction")),w=parseFloat(h.get("maxAmountPerTransaction")),_=h.get("dailyAvailableCount"),B=h.get("monthlyAvailableCount"),A=parseFloat(e("#within_to_paymentAmount").val().replace(/,/g,""));if(T>A)return e("#transfermountError").html(e.i18n.t("validation.sadad.amtgreaterthanminamt")),!1;if(A>b)return e("#transfermountError").html(e.i18n.t("validation.transfer.notra")),!1;if(A>w)return e("#transfermountError").html(e.i18n.t("validation.sadad.amtlessthanmaxamt")),!1;if("0"==_)return void e("#transfermountError").html("You have exceeded your daily transaction count.");if("0"==B)return void e("#transfermountError").html("Transaction count exceeded Monthly Available Count.")}e("#purposetransfer option:selected").val();if("true"==h.get("authModeFlag"))return;d.beneconfrom(t)}else this.$(".has-error").fadeIn(),t.preventDefault()}else if("PAYLATER"==s){e("#error_amount").html("");var d=this;this.model=new l({url:"json/"}),a.Validation.bind(this);var f=this.$("form").serializeObject();if(this.model.set(f,{validate:!0})){this.model.clear(),a.Validation.unbind(this);var g=(e("#within_to_paymentAmount").val().replace(/,/g,""),h.get("fromAcntAvailBal")),b=h.get("dailyAvailableLimit"),A=e("#within_to_paymentAmount").val().replace(/,/g,"");if(A>g)return e("#transfermountError").html("There is no sufficient balance to perform this transaction"),!1;if(A>b)return e("#transfermountError").html("The transaction amount exceeds the available limit balance. Please contact bank for limit enhancement"),!1;d.beneconfrom(t)}else this.$(".has-error").fadeIn(),t.preventDefault()}else if("REPEAT"==s){e("#error_amount").html("");var d=this;this.model=new u({url:"json/"}),a.Validation.bind(this);var f=this.$("form").serializeObject();if(this.model.set(f,{validate:!0})){this.model.clear(),a.Validation.unbind(this);var g=(e("#within_to_paymentAmount").val().replace(/,/g,""),h.get("fromAcntAvailBal")),b=h.get("dailyAvailableLimit"),A=e("#within_to_paymentAmount").val().replace(/,/g,"");if(A>g)return e("#transfermountError").html("There is no sufficient balance to perform this transaction"),!1;if(A>b)return e("#transfermountError").html("The transaction amount exceeds the available limit balance. Please contact bank for limit enhancement"),!1;if(p)return void e("#accountNoErr").html(e.i18n.t("app.transfer.managebeneficiary.withinaccounterror"));d.beneconfrom(t)}else this.$(".has-error").fadeIn(),t.preventDefault()}},beneconfrom:function(t){t.stopImmediatePropagation();var a="PAYNOW";if("REPEAT"==a){var n=e("#freqList").val();h.set("freqList",n);var r=e("#sdate").val();h.set("startdate",r)}if("PAYLATER"==a){var i=e("#payDate").val(),o=i.split("-");o[0],o[1],o[2];h.set("transDate",transDate)}else if("PAYNOW"==a){var s=getDatemonthToday();h.set("transDate",s)}var c=(e("#purposetransfer option:selected").html(),e("#WBToBene_OtherRemarks").val());h.set("purposetransfer",c);var l=e("#currency option:selected").val();h.set("transCurr",l);var u=e("#WithinBank_ToBene_FromAcc").val();h.set("Fromaccno",u);var m=e("#within_to_paymentAmount").val().replace(/,/g,"");h.set("withinBankPaymentAmount",m);var p=this;p.gotoVerifyPage(t)},gotoVerifyPage:function(t){t.stopImmediatePropagation();var n=this,r=(h.get("paymentType"),h.get("beneficiaryDTO")),o=h.get("selectid1"),s=(h.get("transDate"),r[o].beneInstId),c=function(t){if("BDT"!==h.get("fromAccCur")||"BDT"!==h.get("toAccCurr")){hideSpinner();var n=parseFloat(h.get("paymentAmount")),r=parseFloat(h.get("dailyAvailableLimit")),i=parseFloat(h.get("minAmountPerTransaction")),o=parseFloat(h.get("maxAmountPerTransaction"));if(i>n)return e("#transfermountError").html(e.i18n.t("validation.sadad.amtgreaterthanminamt")),!1;if(n>r)return e("#transfermountError").html(e.i18n.t("validation.transfer.notra")),!1;if(n>o)return e("#transfermountError").html(e.i18n.t("validation.sadad.amtlessthanmaxamt")),!1;h.set("beneSuccessFlag","true"),a.history.navigate("#/tobeneficiaryverify")}else hideSpinner(),h.set("beneSuccessFlag","true"),a.history.navigate("#/tobeneficiaryverify")},l=function(e){n.errorresponse()};showSpinner(),n.collection=new i([],{}),n.collection.fetch({data:e.param({access_token:h.get("access_token"),fromaccountId:h.get("accountID"),paydate:h.get("transDate"),transtype:h.get("paymentType"),validtype:"Validation",beneAcctType:h.get("Benetyptrans1"),currSelection:"F",transcurrency:h.get("transCurr"),toaccountId:s,remarks:h.get("purposetransfer"),trnasfertype:h.get("tYpeOfTransAcc"),transamount:h.get("withinBankPaymentAmount"),uniqueId:null,globalId:null,totalDebitAmount:h.get("withinBankPaymentAmount"),onetimepay:"FALSE",benetype:"TENANT",limitId:h.get("id")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?c(e):l(e)},error:l})},errorresponse:function(){hideSpinner(),openErrorPopup()},toBeneOpenTandCPopup:function(e){e.stopImmediatePropagation(),h.set("tandctype","withinbene"),openTermsAndConditionsPopup()},disposeView:function(e){return a.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return d});