define(["jquery","underscore","Backbone","routers/wealthrouter","routers/transferrouter","collections/bills/cardSummaryCollections","collections/transfer/getAccountBalanceCollections","collections/transfer/getTransactionLimitCollections","collections/transfer/walletTransferCollections","collections/transfer/getAuthModeCollections","models/validation/transfer/withinAccountrepeatTransferValidationModel","text!views/transfer/mobileWallet/walletToBeneInit.tpl","views/errors/exception"],function(e,t,a,r,n,l,o,i,s,c,d,m,p){var u=new EncryptedLocalStorage("secret"),h=a.View.extend({el:"#container",events:{"click #walletInitCancelBtn":"goBackToViewBeneficiary","click #walletInitNextBtn":"gotoVerifyPage","click #walletPayNow":"showPayNowDiv","click #walletPayLater":"showPayLaterDiv","click #walletRepeat":"showRepeatDiv","click #walletFromAcc":"openFromAccDropdown","click .acccardnumtype":"getWalletFromAccountBalance","change #purposetransfer":"showOthersDiv","blur #walletTopaymentAmount":"getAuthMode","click #walletToBeneTandCPopup":"walletToBeneOpenTandCPopup"},initialize:function(){new r,new n;e("html").removeClass("state"),e("html").attr("class","app")},render:function(){var t=this;if("false"==u.get("isWalletCCPCData")){var a=function(e){hideSpinner(),t.getTransactionLimit(),u.set("isWalletCCPCData","true")},r=function(e){t.errorresponse()};showSpinner(),t.collection=new l([],{});getDeviceId();t.collection.fetch({data:e.param({newversion:"Y",paytype:"WALLET",ctrycode:"BD",currcode:"BDT",access_token:u.get("access_token")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?a(e):r(e)},error:r})}else hideSpinner(),t.getTransactionLimit()},getTransactionLimit:function(){var t=this,a="";"iPay"==u.get("walletType")?(a="IP",u.set("tenantServiceCode","IPAY"),u.set("walletToBeneTransferType","IPAY")):"OK Wallet"==u.get("walletType")?(a="OK",u.set("tenantServiceCode","OKW"),u.set("walletToBeneTransferType","OKWALLET")):"Cashbaba"==u.get("walletType")?(a="CB",u.set("tenantServiceCode","CB"),u.set("walletToBeneTransferType","CASHBABA")):"Rocket"==u.get("walletType")?(a="RT",u.set("tenantServiceCode","RKT"),u.set("walletToBeneTransferType","ROCKET")):"bKash"==u.get("walletType")?(a="BK",u.set("tenantServiceCode","BKASH"),u.set("walletToBeneTransferType","BKASH")):"TAP"==u.get("walletType")?(a="TAP",u.set("tenantServiceCode","TAP"),u.set("walletToBeneTransferType","TAP")):("UPAY"==u.get("walletType")||"upay"==u.get("walletType")||"uPay"==u.get("walletType")||"uPAY"==u.get("walletType")||"UPay"==u.get("walletType")||"Upay"==u.get("walletType"))&&(a="UPAY",u.set("tenantServiceCode","UPAY"),u.set("walletToBeneTransferType","UPAY"));var r=function(e){hideSpinner(),t.loadTemplate()},n=function(e){t.errorresponse()};showSpinner(),t.collection=new i,t.collection.fetch({data:e.param({access_token:u.get("access_token"),payeeType:"WALLET",subtype:a}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?r(e):n(e)},error:n})},loadTemplate:function(){this.$el.html(t.template(m)),e("#availBalDiv").hide(),e("#payLater").hide(),e("#repeat").hide(),e("#othersDiv").hide(),u.set("fromAccId",""),u.set("fromAccInd",""),u.set("fromAccCur",""),u.set("fromAccType","")},getAuthMode:function(t){var r=this;t.stopImmediatePropagation(),e("#acntNumErr").html("");var n=new RegExp("^[0-9.,]+$"),l=e("#walletTopaymentAmount").val().replace(/,/g,"");u.set("IsAuthMode","false"),u.set("authModeFlag","false"),e("#transAmountError").html(""),e("#wallet_tobene_transferDiv").html(""),this.model=new d({url:"json/"}),a.Validation.bind(this);var o=this.$("form").serializeObject();if(this.model.set(o,{validate:!0})?(this.model.clear(),a.Validation.unbind(this)):this.$(".has-error").fadeIn(),u.set("transferType","walletToBene"),!isNull(l)){if(!n.test(l))return void e("#transAmountError").html(e.i18n.t("validation.transfer.validamount"));var l=parseFloat(e("#walletTopaymentAmount").val().replace(/,/g,"")),i=parseFloat(u.get("minAmountPerTransaction")),s=parseFloat(u.get("maxAmountPerTransaction"));if(i>l)return void e("#transAmountError").html(e.i18n.t("validation.sadad.amtgreaterthanminamt"));if(l>s)return void e("#transAmountError").html(e.i18n.t("validation.sadad.amtlessthanmaxamt"));var m=function(e){hideSpinner();var a=u.get("securitySettingList");!isNull(a)&&a.length>0?u.set("IsAuthMode","true"):(u.set("alertType",null),u.set("IsAuthMode","false")),r.populateAuthMode(t),r.gotoVerifyPage(t)},p=function(t){hideSpinner(),u.set("authModeFlag","true"),e("#walletTopaymentAmount").val(""),r.errorresponse()};showSpinner(),r.collection=new c,r.collection.fetch({data:e.param({access_token:u.get("access_token"),transactionAmount:l,tenantServiceCode:u.get("tenantServiceCode")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?m(e):p(e)},error:p})}},populateAuthMode:function(t){t.stopImmediatePropagation();var a="",r="",n=u.get("securitySettingList"),l="<label for='username'>"+e.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";l+="<div class='custRadio_pass'>",!isNull(n)&&n.length>0?(e("#wallet_tobene_transferDiv").html(""),e.each(n,function(t,n){"SMS"==n?(a="sms",r=e.i18n.t("app.transfer.managebeneficiary.sms")):"EMAIL"==n?(a="mail",r=e.i18n.t("app.transfer.managebeneficiary.mail")):"TOKEN"==n?(a="fScan",r=e.i18n.t("app.transfer.managebeneficiary.token")):"ESIGN"==n&&(a="esign",r=e.i18n.t("app.transfer.managebeneficiary.esign")),l+='<div class="box"><div class="radio"><label>',l+=0==t?'<input type="radio" name="wallet_tobene_transfer" id="optionsRadios'+t+'" value="'+n+'" checked>':'<input type="radio" name="wallet_tobene_transfer" id="optionsRadios'+t+'" value="'+n+'">',l+='<div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs '+a+'"></span><span class="small">'+r+"</span></div></div></label></div></div>"}),e("#wallet_tobene_transferDiv").html(l)):e("#wallet_tobene_transferDiv").html("")},showPayNowDiv:function(t){t.stopImmediatePropagation(),e("#payLater").hide(),e("#repeat").hide(),e("#pdate").val(""),e("#payDateError").html(""),e("#pdate").attr("disabled",!0),e("#payDateError").attr("disabled",!0),e("#sdate").val(""),e("#fre").val(""),e("#not").val(""),e("#startDateErr").html(""),e("#FreqErr").html(""),e("#NoOfTimesErr").html(""),e("#sdate").attr("disabled",!0),e("#startDateErr").attr("disabled",!0),e("#fre").attr("disabled",!0),e("#FreqErr").attr("disabled",!0),e("#not").attr("disabled",!0),e("#NoOfTimesErr").attr("disabled",!0)},showPayLaterDiv:function(t){t.stopImmediatePropagation(),e("#payLater").show(),e("#repeat").hide(),e("#pdate").attr("disabled",!1),e("#payDateError").attr("disabled",!1),e("#sdate").val(""),e("#fre").val(""),e("#not").val(""),e("#startDateErr").html(""),e("#FreqErr").html(""),e("#NoOfTimesErr").html(""),e("#sdate").attr("disabled",!0),e("#startDateErr").attr("disabled",!0),e("#fre").attr("disabled",!0),e("#FreqErr").attr("disabled",!0),e("#not").attr("disabled",!0),e("#NoOfTimesErr").attr("disabled",!0)},showRepeatDiv:function(t){t.stopImmediatePropagation(),e("#payLater").hide(),e("#repeat").show(),e("#pdate").val(""),e("#payDateError").html(""),e("#pdate").attr("disabled",!0),e("#payDateError").attr("disabled",!0),e("#sdate").attr("disabled",!1),e("#startDateErr").attr("disabled",!1),e("#fre").attr("disabled",!1),e("#FreqErr").attr("disabled",!1),e("#not").attr("disabled",!1),e("#NoOfTimesErr").attr("disabled",!1)},showOthersDiv:function(t){t.stopImmediatePropagation();var a=e("#purposetransfer option:selected").val();"others"==a?e("#othersDiv").show():e("#othersDiv").hide()},openFromAccDropdown:function(t){"object"==typeof t&&(t.preventDefault(),t.stopImmediatePropagation()),e("#card_account").modal("show")},getWalletFromAccountBalance:function(t){"object"==typeof t&&(t.preventDefault(),t.stopImmediatePropagation()),e("#acntNumErr").html("");var a=e(t.target).closest("li.acccardnumtype").attr("Accide");u.set("fromAccId",a);var r=e(t.target).closest("li.acccardnumtype").attr("id");u.set("fromAccInd",r);var n=e(t.target).closest("li.acccardnumtype").attr("acctype"),l=e(t.target).closest("li.acccardnumtype").attr("data");if(u.set("fromAccCur",l),u.set("fromAccType",n),""==a)return e("#availbal").html(""),void e("#availBalDiv").hide();var i=this,s=function(r){hideSpinner(),e("#availBalDiv").hide(),e("#availbal").html("");var n,l,o=u.get("availableBalance"),i=parseFloat(o.slice(0,-2)),s=null==u.get("accountCurrency")||""==u.get("accountCurrency")?"":u.get("accountCurrency"),c=e(t.target).closest("li.acccardnumtype").attr("acctype");u.set("fromAccType",c),"CASA"==c?(n=checkAmount(e.formatNumber(i,{format:"#,###.00",locale:"us"})),l=n+" "+s,u.set("fromAcntAvailBal",i)):"PC"==c?(n=checkAmount(e.formatNumber(o,{format:"#,###.00",locale:"us"})),l=n+" "+s,u.set("fromAcntAvailBal",o)):"CC"==c&&(n=checkAmount(e.formatNumber(o,{format:"#,###.00",locale:"us"})),l=n+" "+s,u.set("fromAcntAvailBal",o)),e("#availbal").html(l),e("#availBalDiv").show(),e('li.acccardnumtype[accide="'+a+'"]').find("input").attr("checked","checked");var d=e(t.target).closest("li.acccardnumtype").find(".row").clone().html(),m='<div class="qr_acc_outer">\n <ul class="list-unstyled m0">\n <li class="list-group-item">\n'+d+"</li>\n </ul>\n </div>";e("#seltpayval").html(m),e("#card_account .close").trigger("click")},c=function(t){i.errorresponse(),e("#card_account .close").trigger("click")};showSpinner(),i.collection=new o,i.collection.fetch({data:e.param({access_token:u.get("access_token"),accountId:a,accountType:u.get("fromAccType"),beneficiaryInstructionId:null}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?s(e):c(e)},error:c})},gotoVerifyPage:function(t){t.stopImmediatePropagation(),e("#tandcErr").html(""),e("#transAmountError").html(""),e("#payDateError").html(""),e("#startDateErr").html(""),e("#FreqErr").html(""),e("#NoOfTimesErr").html(""),e("#transAmountError").html(""),e("#otherRemaksNullError").html(""),e("#acntNumErr").html("");var r=this,n=new RegExp("^[0-9.,]+$"),l=new RegExp("^[A-Za-z0-9 ]+$"),o=e("#walletToBeneOtherRemarks").val(),i=parseFloat(e("#walletTopaymentAmount").val().replace(/,/g,"")),s=e("input[name='wallet_tobene_transfer']:checked").val();u.set("alertType",s),u.set("walletToAccCur","BDT"),this.model=new d({url:"json/"}),a.Validation.bind(this);var c=this.$("form").serializeObject();if(this.model.set(c,{validate:!0})){if(this.model.clear(),a.Validation.unbind(this),isNull(u.get("fromAccId")))return void e("#acntNumErr").html("Please select a From Account/Card");var m=(e("#currency option:selected").val(),parseFloat(e("#walletTopaymentAmount").val().replace(/,/g,""))),p=u.get("fromAcntAvailBal"),h=parseFloat(u.get("minAmountPerTransaction")),f=parseFloat(u.get("maxAmountPerTransaction")),y=parseFloat(u.get("dailyAvailableLimit")),v=u.get("dailyAvailableCount"),g=u.get("monthlyAvailableCount"),m=parseFloat(e("#walletTopaymentAmount").val().replace(/,/g,""));if(!isNull(i)&&!n.test(i))return void e("#transAmountError").html(e.i18n.t("validation.transfer.validamount"));if(!isNull(o)&&o.length>16)return void e("#otherRemaksNullError").html("The Remarks should contain maximum of 16 characters");if(!isNull(o)&&!l.test(o))return void e("#otherRemaksNullError").html(e.i18n.t("validation.managebene.remarksspecialchar"));if(m>p)return void e("#transAmountError").html(e.i18n.t("validation.transfer.nobal"));if(h>m)return e("#transAmountError").html(e.i18n.t("validation.sadad.amtgreaterthanminamt")),!1;if(m>y)return void e("#transAmountError").html(e.i18n.t("Transaction Amount exceeded Daily Limit"));if(m>f)return void e("#transAmountError").html(e.i18n.t("validation.sadad.amtlessthanmaxamt"));if("0"==v)return void e("#transAmountError").html("You have exceeded your daily transaction count.");if("0"==g)return void e("#transAmountError").html("Transaction count exceeded Monthly Available Count.");var T="paynow";"paynow"==T&&u.set("payType","PAYNOW");var w=new Date,A=w.getDate(),b=w.getMonth()+1,E=w.getFullYear(),P=new Date(E,b,A),D=("00"+A.toString()).slice(-2)+"/"+("00"+b.toString()).slice(-2)+"/"+("0000"+E.toString()).slice(-4);if(u.set("payDate",D),"paylater"==T){u.set("payType","LATER");var C=e("#pdate").val();if(""==C)return void e("#payDateError").html("Please enter the Payment Date");var k=C.split("-"),S=k[2],I=k[1],B=k[0],F=new Date(S,I,B);if(F.getTime()<P.getTime())return void e("#payDateError").html(e.i18n.t("validation.transfer.greaterdate"))}else if("schpay"==T){u.set("payType","REPEAT");var N=e("#sdate").val(),O=e("#freoption:selected").val(),L=e("#not option:selected").val();if(""==N)return void e("#startDateErr").html(e.i18n.t("validation.transfer.startdate"));if(""==O)return void e("#FreqErr").html(e.i18n.t("validation.transfer.freqList"));if(""==L)return void e("#NoOfTimesErr").html(e.i18n.t("validation.transfer.not"));if(""!==N){var _=N.split("-"),R=_[2],V=_[1],x=_[0],M=new Date(R,V,x);if(M.getTime()<P.getTime())return void e("#startDateErr").html(e.i18n.t("validation.transfer.greaterdate"))}}var W=e("#termsand").prop("checked");if(!W)return void e("#tandcErr").html("Please check the Terms and Conditions");if("true"==u.get("authModeFlag"))return;r.verifyPage(t)}else this.$(".has-error").fadeIn(),t.preventDefault()},verifyPage:function(t){t.stopImmediatePropagation();var a=u.get("fromAccId"),r=u.get("fromAccType");u.set("walletFromAccId",a);var n=u.get("fromAccCur");u.set("walletFromAccCur",n);var l=e("#currency option:selected").val();u.set("walletCurrency",l);var o=u.get("selectedWalletBeneDTO"),i=u.get("selectedWalletTransferBeneInd"),s=o[i],c=s.beneInstId,d=s.accountNumber,m=s.firstName;u.set("walletToAccId",c),u.set("walletToAccNo",d),u.set("walletToAccName",m);var p=e("#walletToBeneOtherRemarks").val();u.set("walletRemarks",p);var h=u.get("accountTitle");u.set("walletFromAcntName",h);var f=e("#walletTopaymentAmount").val().replace(/,/g,"");u.set("walletTransferAmount",f);var y=this;"CASA"==r?u.set("walletTypeOfTrans","A2A"):"PC"==r?u.set("walletTypeOfTrans","P2A"):"CC"==r&&u.set("walletTypeOfTrans","C2A"),y.Validation(t)},Validation:function(t){t.stopImmediatePropagation();var r=this,n=function(t){if("BDT"!==u.get("walletCurrency")||"BDT"!==u.get("walletToAccCur")){hideSpinner();var r=parseFloat(u.get("minAmountPerTransaction")),n=parseFloat(u.get("maxAmountPerTransaction")),l=parseFloat(u.get("dailyAvailableLimit")),o=parseFloat(u.get("paymentAmount"));if(r>o)return e("#transAmountError").html(e.i18n.t("validation.sadad.amtgreaterthanminamt")),!1;if(o>l)return void e("#transAmountError").html(e.i18n.t("Transaction Amount exceeded Daily Limit"));if(o>n)return void e("#transAmountError").html(e.i18n.t("validation.sadad.amtlessthanmaxamt"));u.set("beneSuccessFlag","true"),a.history.navigate("#/wallettobeneVerify")}else hideSpinner(),u.set("beneSuccessFlag","true"),a.history.navigate("#/wallettobeneVerify")},l=function(e){r.errorresponse()};showSpinner(),r.collection=new s,r.collection.fetch({data:e.param({access_token:u.get("access_token"),fromaccountId:u.get("walletFromAccId"),paydate:u.get("payDate"),transtype:u.get("payType"),validtype:"Validation",beneAcctType:"WALLET",currSelection:"F",transcurrency:u.get("walletCurrency"),toaccountId:u.get("walletToAccId"),remarks:u.get("walletRemarks"),trnasfertype:u.get("walletTypeOfTrans"),transamount:u.get("walletTransferAmount"),uniqueId:null,globalId:null,totalDebitAmount:u.get("walletTransferAmount"),onetimepay:"FALSE",benetype:"WALLET",frmAcctName:u.get("walletFromAcntName"),paymenttype:null,wallettype:u.get("walletType"),benename:u.get("walletToAccName"),toacctno:u.get("walletToAccNo"),benebankname:null,benebranchname:null,beneifsccode:null,limitId:u.get("id")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?n(e):l(e)},error:l})},goBackToViewBeneficiary:function(e){e.stopImmediatePropagation(),a.history.navigate("#/wallettransfertobeneselect")},errorresponse:function(){hideSpinner(),openErrorPopup()},walletToBeneOpenTandCPopup:function(e){e.stopImmediatePropagation(),"iPay"==u.get("walletType")?u.set("tandctype","ipaybene"):"OK Wallet"==u.get("walletType")?u.set("tandctype","okwalletbene"):"Cashbaba"==u.get("walletType")?u.set("tandctype","cashbababene"):"Rocket"==u.get("walletType")?u.set("tandctype","rocketbene"):"bKash"==u.get("walletType")?u.set("tandctype","bkashbene"):"TAP"==u.get("walletType")?u.set("tandctype","tapbene"):("upay"==u.get("walletType")||"uPay"==u.get("walletType")||"uPAY"==u.get("walletType")||"UPay"==u.get("walletType")||"Upay"==u.get("walletType"))&&u.set("tandctype","upaybene"),openTermsAndConditionsPopup()},disposeView:function(e){return a.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return h});