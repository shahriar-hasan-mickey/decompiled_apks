define(["jquery","underscore","Backbone","routers/wealthrouter","routers/transferrouter","collections/bills/cardSummaryCollections","collections/transfer/getAccountBalanceCollections","collections/transfer/walletTransferCollections","collections/transfer/getTransactionLimitCollections","collections/transfer/getAuthModeCollections","collections/manageBeneficiaries/walletAccountNumValidateCollection","models/validation/transfer/walletOneTimePayValidationModel","text!views/transfer/mobileWallet/walletOneTimePayInit.tpl","views/errors/exception"],function(e,t,a,n,l,r,o,i,c,s,m,u,p,d){var f=new EncryptedLocalStorage("secret"),h=a.View.extend({el:"#container",events:{"click #walletToBeneficiary":"gotoWalletToBeneficiary","click #walletOneTimeFromAcc":"openFromAccDropdown","click .acccardtypenum":"getWalletOneTimeFromAccountBalance","click #walletOneTimeInitCancel":"gotoWalletToBeneficiary","click #walletOneTimePayNow":"gotoVerifyPage","change #purposetransfer":"showOthersDiv","blur #walletOnepaymentAmount":"getAuthMode","blur #walletOneTimeAccNum":"getWalletAccHolderName","click #walletOneTimeTandCPopup":"walletOneTimePayOpenTandCPopup","click #walletOnetimephonebookbtn":"walletOnetimeopenPhonebook"},initialize:function(){new n,new l},walletOnetimeopenPhonebook:function(t){t.stopImmediatePropagation(),isNull(e("#availbal").html())||f.set("accountBalance",e.trim(e("#availbal").html())),f.set("thisInputId","walletOneTimeAccNum"),f.set("formDatasInEls",serializeFormDatas()),a.history.navigate("#/contactlist")},render:function(){var t=this;if("false"==f.get("isWalletCCPCData")){var a=function(e){hideSpinner(),t.getTransactionLimit(),f.set("isWalletCCPCData","true")},n=function(e){t.errorresponse()};showSpinner(),t.collection=new r([],{});getDeviceId();t.collection.fetch({data:e.param({newversion:"Y",paytype:"WALLET",ctrycode:"BD",currcode:"BDT",access_token:f.get("access_token")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?a(e):n(e)},error:n})}else hideSpinner(),t.getTransactionLimit()},getTransactionLimit:function(){var t=this,a="";"iPay"==f.get("walletType")?(a="IP",f.set("tenantServiceCode","IPAY_OT"),f.set("walletOneTimeTransferType","IPAY_ONE_OFF")):"OK Wallet"==f.get("walletType")?(a="OK",f.set("tenantServiceCode","OKW_OT"),f.set("walletOneTimeTransferType","OKWALLET_ONE_OFF")):"Cashbaba"==f.get("walletType")?(a="CB",f.set("tenantServiceCode","CB_OT"),f.set("walletOneTimeTransferType","CASHBABA_ONE_OFF")):"Rocket"==f.get("walletType")?(a="RT",f.set("tenantServiceCode","RKT_OT"),f.set("walletOneTimeTransferType","ROCKET_ONE_OFF")):"bKash"==f.get("walletType")?(a="BK",f.set("tenantServiceCode","BKASH_OT"),f.set("walletOneTimeTransferType","BKASH_ONE_OFF")):"TAP"==f.get("walletType")?(a="TAP",f.set("tenantServiceCode","TAP_OT"),f.set("walletOneTimeTransferType","TAP_ONE_OFF")):("UPAY"==f.get("walletType")||"upay"==f.get("walletType")||"uPay"==f.get("walletType")||"uPAY"==f.get("walletType")||"Upay"==f.get("walletType")||"UPay"==f.get("walletType"))&&(a="UPAY",f.set("tenantServiceCode","UPAY_OT"),f.set("walletOneTimeTransferType","UPAY_ONE_OFF"));var n=function(a){hideSpinner(),e("html").removeClass().addClass("app"),t.loadTemplate()},l=function(e){t.errorresponse()};showSpinner(),t.collection=new c,t.collection.fetch({data:e.param({access_token:f.get("access_token"),payeeType:"WALLET",subtype:a}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?n(e):l(e)},error:l})},loadTemplate:function(){var a=this;this.$el.html(t.template(p));var n=f.get("downtimeNotification");if(!isNull(n)&&n.length>0){var l=(n[0].downtimeNotificationDetail,"");e.each(n,function(e,t){if("REGISTERED"==t.subTransactionType){var a=t.downtimeNotificationDetail,n=a[e].messageMobile;isNull(n)||(l+="<p>"+n+"</p>")}}),e("#notificationMessage").html(e.parseHTML(l))}if(e("#availableBalDiv").hide(),e("#othersDiv").hide(),"Rocket"==f.get("walletType")?e("#rocketAccNameDiv").show():e("#rocketAccNameDiv").hide(),fillFormDatas(f.get("formDatasInEls")),!isNull(f.get("selectedFromAccountValue"))){var r='<div class="qr_acc_outer">\n <ul class="list-unstyled m0">\n <li class="list-group-item">\n'+f.get("selectedFromAccountValue")+"</li>\n </ul>\n </div>";e("#seltpayval").html(r)}isNull(e("#walletOneTimeAccNum").val())||e("#walletOneTimeAccNum").blur(),isNull(e("#walletOnepaymentAmount").val())||a.getAuthMode(),isNull(f.get("accountBalance"))||(e("#availbal").html(f.get("accountBalance")),e("#availableBalDiv").show())},getWalletAccHolderName:function(t){t.stopImmediatePropagation(),e("#toAccNumErr").html(""),e("#walletOneTimeAccName").html("");var n=new RegExp("^[0-9]+$"),l=this,n=new RegExp("^[0-9.,]+$");this.model=new u({url:"json/"}),a.Validation.bind(this);var r=this.$("form").serializeObject();this.model.set(r,{validate:!0})?(this.model.clear(),a.Validation.unbind(this)):this.$(".has-error").fadeIn();var o=function(t){hideSpinner(),isValidAccount=!1,e("#walletOneTimeAccName").html(f.get("walletInfoList")[1].value)},i=function(e){isValidAccount=!0,l.errorresponse()},c=e("#walletOneTimeAccNum").val();if(!isNull(c)){if(!n.test(c))return void e("#toAccNumErr").html(e.i18n.t("validation.transfer.validaccount"));if((c.length>12||c.length<12)&&"Rocket"==f.get("walletType"))return void e("#toAccNumErr").html(e.i18n.t("app.transfer.managebeneficiary.rocketacclenerr"));if((c.length>11||c.length<11)&&"Rocket"!=f.get("walletType"))return void e("#toAccNumErr").html(e.i18n.t("app.transfer.managebeneficiary.otherwalletacclenerr"));showSpinner(),l.collection=new m([],{});var s=(getDeviceId(),(new Date).getTime());f.set("salttime",s);var p=EncryptWithDynamicSalt(c,s);l.collection.fetch({data:e.param({access_token:f.get("access_token"),accountNumber:p,walletTransferType:f.get("walletType"),transactionAmount:null,salt:f.get("salttime")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?o(e):i(e)},error:i})}},openFromAccDropdown:function(t){"object"==typeof t&&(t.preventDefault(),t.stopImmediatePropagation()),e("#card_account").modal("show")},getAuthMode:function(t){var n=this;"object"==typeof t&&t.stopImmediatePropagation();var l=e("#walletOnepaymentAmount").val().replace(/,/g,"");f.set("IsAuthMode","false"),f.set("authModeFlag","false"),e("#transAmountError").html(""),e("#wallet_onetime_transferDiv").html("");var r=new RegExp("^[0-9.,]+$");this.model=new u({url:"json/"}),a.Validation.bind(this);var o=this.$("form").serializeObject();if(this.model.set(o,{validate:!0})?(this.model.clear(),a.Validation.unbind(this)):this.$(".has-error").fadeIn(),f.set("transferType","walletOneOff"),!isNull(l)){if(!r.test(l))return void e("#transAmountError").html(e.i18n.t("validation.transfer.validamount"));var l=parseFloat(e("#walletOnepaymentAmount").val().replace(/,/g,"")),i=parseFloat(f.get("minAmountPerTransaction")),c=parseFloat(f.get("maxAmountPerTransaction"));if(i>l)return void e("#transAmountError").html(e.i18n.t("validation.sadad.amtgreaterthanminamt"));if(l>c)return void e("#transAmountError").html(e.i18n.t("validation.sadad.amtlessthanmaxamt"));var m=function(e){hideSpinner();var a=f.get("securitySettingList");!isNull(a)&&a.length>0?f.set("IsAuthMode","true"):(f.set("alertType",null),f.set("IsAuthMode","false")),n.populateAuthMode(t),n.gotoVerifyPage(t)},p=function(t){hideSpinner(),f.set("authModeFlag","true"),e("#walletOnepaymentAmount").val(""),n.errorresponse()};showSpinner(),n.collection=new s,n.collection.fetch({data:e.param({access_token:f.get("access_token"),transactionAmount:l,tenantServiceCode:f.get("tenantServiceCode")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?m(e):p(e)},error:p})}},populateAuthMode:function(t){"object"==typeof t&&t.stopImmediatePropagation();var a="",n="",l=f.get("securitySettingList"),r="<label for='username'>"+e.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";r+="<div class='custRadio_pass'>",!isNull(l)&&l.length>0?(e("#wallet_onetime_transferDiv").html(""),e.each(l,function(t,l){"SMS"==l?(a="sms",n=e.i18n.t("app.transfer.managebeneficiary.sms")):"EMAIL"==l?(a="mail",n=e.i18n.t("app.transfer.managebeneficiary.mail")):"TOKEN"==l?(a="fScan",n=e.i18n.t("app.transfer.managebeneficiary.token")):"ESIGN"==l&&(a="esign",n=e.i18n.t("app.transfer.managebeneficiary.esign")),r+='<div class="box"><div class="radio"><label>',r+=0==t?'<input type="radio" name="wallet_onetime_transfer" id="optionsRadios'+t+'" value="'+l+'" checked>':'<input type="radio" name="wallet_onetime_transfer" id="optionsRadios'+t+'" value="'+l+'">',r+='<div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs '+a+'"></span><span class="small">'+n+"</span></div></div></label></div></div>"}),e("#wallet_onetime_transferDiv").html(r)):e("#wallet_onetime_transferDiv").html("")},gotoWalletToBeneficiary:function(e){e.stopImmediatePropagation();var t=f.get("downtimeNotification");!isNull(t)&&t.length>0?a.history.navigate("#/mobilewallettransfer"):a.history.navigate("#/wallettransfertobeneselect")},getWalletOneTimeFromAccountBalance:function(t){"object"==typeof t&&(t.preventDefault(),t.stopImmediatePropagation()),e("#fromAcntNumErr").html("");var a=e(t.target).closest("li.acccardtypenum").attr("Accide");f.set("oneTimeFromAccId",a);var n=e(t.target).closest("li.acccardtypenum").attr("id");f.set("fromAccInd",n);var l=e(t.target).closest("li.acccardtypenum").attr("acctype");f.set("fromAccType",l);var r=e(t.target).closest("li.acccardtypenum").attr("data");if(f.set("oneTimeFromAccCurr",r),""==a)return e("#availbal").html(""),e("#availableBalDiv").hide(),void f.set("accountBalance",null);var i=this,c=function(n){hideSpinner(),e("#fromAcntNumErr").html("");var l,r,o=f.get("availableBalance"),i=parseFloat(o.slice(0,-2)),c=null==f.get("accountCurrency")||""==f.get("accountCurrency")?"":f.get("accountCurrency"),s=e(t.target).closest("li.acccardtypenum").attr("acctype");"CASA"==s?(l=checkAmount(e.formatNumber(i,{format:"#,###.00",locale:"us"})),r=l+" "+c,f.set("fromAcntAvailBal",i)):"PC"==s?(l=checkAmount(e.formatNumber(o,{format:"#,###.00",locale:"us"})),r=l+" "+c,f.set("fromAcntAvailBal",o)):"CC"==s&&(l=checkAmount(e.formatNumber(o,{format:"#,###.00",locale:"us"})),r=l+" "+c,f.set("fromAcntAvailBal",o)),e("#availbal").html(r),e("#availableBalDiv").show(),e('li.acccardtypenum[accide="'+a+'"]').find("input").attr("checked","checked");var m=e(t.target).closest("li.acccardtypenum").find(".row").clone().html();f.set("selectedFromAccountValue",m);var u='<div class="qr_acc_outer">\n <ul class="list-unstyled m0">\n <li class="list-group-item">\n'+m+"</li>\n </ul>\n </div>";e("#seltpayval").html(u),e("#card_account .close").trigger("click")},s=function(t){i.errorresponse(),e("#card_account .close").trigger("click")};showSpinner(),i.collection=new o,i.collection.fetch({data:e.param({access_token:f.get("access_token"),accountId:a,accountType:f.get("fromAccType"),beneficiaryInstructionId:null}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?c(e):s(e)},error:s})},showOthersDiv:function(t){t.stopImmediatePropagation();var a=e("#purposetransfer option:selected").val();"others"==a?e("#othersDiv").show():e("#othersDiv").hide()},gotoVerifyPage:function(t){"object"==typeof t&&t.stopImmediatePropagation(),e("#toAccNumErr").html(""),e("#tandcErr").html(""),e("#transAmountError").html(""),e("#otherRemaksNullError").html(""),e("#accNameError").html(""),e("#fromAcntNumErr").html("");var n=this,l=new RegExp("^[0-9]+$"),r=e("#walletOneTimeAccNum").val(),o=new RegExp("^[0-9.,]+$"),i=new RegExp("^[A-Za-z0-9 ]+$"),c=e("#walletOneOffOtherRemarks").val(),s=e("#walletOnepaymentAmount").val().replace(/,/g,""),m=e("input[name='wallet_onetime_transfer']:checked").val();f.set("alertType",m),f.set("walletToAccCurr","BDT"),this.model=new u({url:"json/"}),a.Validation.bind(this);var p=this.$("form").serializeObject();if(this.model.set(p,{validate:!0})){if(this.model.clear(),a.Validation.unbind(this),isNull(f.get("oneTimeFromAccId")))return void e("#fromAcntNumErr").html("Please select a From Account/Card");var d=(e("#currency option:selected").val(),parseFloat(e("#walletOnepaymentAmount").val().replace(/,/g,""))),h=f.get("fromAcntAvailBal"),d=parseFloat(e("#walletOnepaymentAmount").val().replace(/,/g,"")),v=parseFloat(f.get("dailyAvailableLimit")),g=parseFloat(f.get("minAmountPerTransaction")),y=parseFloat(f.get("maxAmountPerTransaction")),T=f.get("dailyAvailableCount"),w=f.get("monthlyAvailableCount");if(!isNull(r)&&!l.test(r))return void e("#toAccNumErr").html(e.i18n.t("validation.transfer.validaccount"));if(!isNull(s)&&!o.test(s))return void e("#transAmountError").html(e.i18n.t("validation.transfer.validamount"));if(!isNull(c)&&c.length>16)return void e("#otherRemaksNullError").html("The Remarks should contain maximum of 16 characters");if(!isNull(c)&&!i.test(c))return void e("#otherRemaksNullError").html(e.i18n.t("validation.managebene.remarksspecialchar"));if(d>h)return void e("#transAmountError").html(e.i18n.t("validation.transfer.nobal"));if(g>d)return void e("#transAmountError").html(e.i18n.t("validation.sadad.amtgreaterthanminamt"));if(d>v)return void e("#transAmountError").html(e.i18n.t("Transaction Amount exceeded Daily Limit"));if(d>y)return void e("#transAmountError").html(e.i18n.t("validation.sadad.amtlessthanmaxamt"));if("0"==T)return void e("#transAmountError").html("You have exceeded your daily transaction count.");if("0"==w)return void e("#transAmountError").html("Transaction count exceeded Monthly Available Count.");if("Rocket"==f.get("walletType")){var A=e("#rocketOneTimeAccNAme").val();if(""==A)return void e("#accNameError").html("Please enter the Rocket Account Name")}var O=e("#termsand").prop("checked");if(!O)return void e("#tandcErr").html("Please check the Terms and Conditions");f.set("payType","PAYNOW");var b=new Date,N=b.getDate(),P=b.getMonth()+1,k=b.getFullYear(),E=(new Date(k,P,N),("00"+N.toString()).slice(-2)+"/"+("00"+P.toString()).slice(-2)+"/"+("0000"+k.toString()).slice(-4));if(f.set("payDate",E),"true"==f.get("authModeFlag"))return;n.verifyPage(t)}else this.$(".has-error").fadeIn(),"object"==typeof t&&t.preventDefault()},verifyPage:function(t){t.stopImmediatePropagation();var a=f.get("oneTimeFromAccId");f.set("walletOneTimeFromAcc",a);var n=f.get("oneTimeFromAccCurr");f.set("walletFromAccCurr",n);var l=f.get("fromAccType"),r=e("#currency option:selected").val();f.set("walletCurrency",r);var o=e("#walletOneOffOtherRemarks").val();f.set("walletRemarks",o);var i=f.get("accountTitle");f.set("walletFromAcntName",i);var c=e("#walletOnepaymentAmount").val().replace(/,/g,"");f.set("walletTransferAmount",c);var s=e("#walletOneTimeAccNum").val();if(f.set("walletToAccNum",s),"Rocket"==f.get("walletType")){var m=e("#rocketOneTimeAccNAme").val();f.set("walletToAccName",m)}else{var u=e("#walletOneTimeAccName").html();f.set("walletToAccName",u)}"CASA"==l?f.set("walletOneTimeTypeOfTrans","A2A"):"PC"==l?f.set("walletOneTimeTypeOfTrans","P2A"):"CC"==l&&f.set("walletOneTimeTypeOfTrans","C2A");var p=this;p.Validation(t)},Validation:function(t){t.stopImmediatePropagation(),e("#transAmountError").html("");var n=this,l=function(t){if("BDT"!==f.get("walletCurrency")||"BDT"!==f.get("walletToAccCurr")){hideSpinner();var n=parseFloat(f.get("dailyAvailableLimit")),l=parseFloat(f.get("minAmountPerTransaction")),r=parseFloat(f.get("maxAmountPerTransaction")),o=parseFloat(f.get("paymentAmount"));if(l>o)return void e("#transAmountError").html(e.i18n.t("validation.sadad.amtgreaterthanminamt"));if(o>n)return void e("#transAmountError").html(e.i18n.t("Transaction Amount exceeded Daily Limit"));if(o>r)return void e("#transAmountError").html(e.i18n.t("validation.sadad.amtlessthanmaxamt"));f.set("beneSuccessFlag","true"),f.set("thisInputId",null),f.set("formDatasInEls",null),f.set("accountBalance",null),a.history.navigate("#/walletonetimepayverify")}else hideSpinner(),f.set("beneSuccessFlag","true"),f.set("thisInputId",null),f.set("formDatasInEls",null),f.set("accountBalance",null),a.history.navigate("#/walletonetimepayverify")},r=function(e){n.errorresponse()};showSpinner(),n.collection=new i,n.collection.fetch({data:e.param({access_token:f.get("access_token"),fromaccountId:f.get("walletOneTimeFromAcc"),paydate:f.get("payDate"),transtype:f.get("payType"),validtype:"Validation",beneAcctType:"WALLET",currSelection:"F",transcurrency:f.get("walletCurrency"),toaccountId:null,remarks:f.get("walletRemarks"),trnasfertype:f.get("walletOneTimeTypeOfTrans"),transamount:f.get("walletTransferAmount"),uniqueId:null,globalId:null,totalDebitAmount:f.get("walletTransferAmount"),onetimepay:"TRUE",benetype:"WALLET",frmAcctName:f.get("walletFromAcntName"),paymenttype:null,wallettype:f.get("walletType"),benename:f.get("walletToAccName"),toacctno:f.get("walletToAccNum"),benebankname:null,benebranchname:null,beneifsccode:null,limitId:f.get("id")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?l(e):r(e)},error:r})},errorresponse:function(){hideSpinner(),openErrorPopup()},walletOneTimePayOpenTandCPopup:function(e){e.stopImmediatePropagation(),"iPay"==f.get("walletType")?f.set("tandctype","ipayoneoff"):"OK Wallet"==f.get("walletType")?f.set("tandctype","okwalletoneoff"):"Cashbaba"==f.get("walletType")?f.set("tandctype","cashbabaoneoff"):"Rocket"==f.get("walletType")?f.set("tandctype","rocketoneoff"):"bKash"==f.get("walletType")?f.set("tandctype","bkashoneoff"):"TAP"==f.get("walletType")?f.set("tandctype","taponeoff"):("UPAY"==f.get("walletType")||"upay"==f.get("walletType")||"uPay"==f.get("walletType")||"uPAY"==f.get("walletType"))&&f.set("tandctype","upayoneoff"),openTermsAndConditionsPopup()},disposeView:function(e){return a.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return h});