define(["jquery","underscore","Backbone","collections/manageBeneficiaries/BenebanknameCollections","collections/manageBeneficiaries/BenebranchnameCollections","collections/manageBeneficiaries/BeneroutingCollections","collections/manageBeneficiaries/checkaddedBeneficiaryCollection","models/validation/manageBeneficiaries/otherBankAddBeneValidationModel","collections/transfer/getAuthModeCollections","text!views/transfer/ManageBeneficiaries/otherbankaddbene.tpl"],function(e,a,t,n,r,i,c,o,s,l){var h=new EncryptedLocalStorage("secret"),d=t.View.extend({el:"#container",events:{"click .transBeneType":"toggleBeneInfoDiv","click #nextbtn":"gotoNextPage","click #cancelBtn":"gotoPreviousPage","click #OB_addBene_BankBtn":"gotoPreviousPage","click .type":"toggleLabel","click .popupSearch":"getPopupType","click .selectedvalue":"getSelectedValue"},initialize:function(){},getAuthmode:function(){var a=this;h.set("IsAuthMode","false"),e("#otherbank_add_authmodeDiv").html("");var t=function(e){hideSpinner();var t=h.get("securitySettingList");!isNull(t)&&t.length>0?h.set("IsAuthMode","true"):(h.set("alertType",null),h.set("IsAuthMode","false")),a.populateAuthMode()},n=function(e){hideSpinner(),h.set("IsAuthMode","false"),a.populateAuthMode()};a.collection=new s,a.collection.fetch({data:e.param({access_token:h.get("access_token"),transactionAmount:null,tenantServiceCode:"BI"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?t(e):n(e)},error:n})},populateAuthMode:function(){var t="",n="",r=this;if(e("html").removeClass().addClass("app"),this.$el.html(a.template(l)),"true"==h.get("isOtherOneOffSuccess")){if("CASA"==h.get("otherOneOffSuccessAccType")?(e("#account").prop("checked",!0),e("#benetypelabel").html("Account Number"),e("#beneNameLabel").html("Account Holder Name")):"CC"==h.get("otherOneOffSuccessAccType")&&(e("#card").prop("checked",!0),e("#benetypelabel").html("Card Number"),e("#beneNameLabel").html("Card Holder Name")),"BEFTN"==h.get("otherOneOffSuccessTransChannel")||"RTGS"==h.get("otherOneOffSuccessTransChannel")){e("#beftn").prop("checked",!0);var i=h.get("otherOneOffSuccessBankName");e("#bankName").val(i),h.set("bankName",i),h.set("transferChannel","BEFTN");var c=h.get("otherOneOffSuccessBankCode");h.set("bankCode",c);var o=h.get("otherOneOffSuccessBranchName");e("#branchName").val(o),h.set("benebranch",o);var s=h.get("otherOneOffSuccessBranchCode");h.set("branchCode",s);var r=this;r.getRoutingNumber()}else if("NPSB"==h.get("otherOneOffSuccessTransChannel")){e("#npsb").prop("checked",!0),e("#branchDiv").hide(),e("#RoutingDistDiv").hide();var i=h.get("otherOneOffSuccessBankName");e("#bankName").val(i),h.set("bankName",i),h.set("transferChannel","NPSB");var c=h.get("otherOneOffSuccessBankCode");h.set("bankCode",c)}var d=h.get("otherOneOffSuccessAccNum");e("#accId").val(d);var u=h.get("otherOneOffSuccessAccName");e("#accName").val(u)}else h.set("transferChannel","BEFTN"),h.set("benebank",""),e("#bankBranch").show(),e("#RoutingDistDiv").hide(),e("#account").prop("checked",!0),e("#benetypelabel").html("Account Number"),e("#beneNameLabel").html("Account Holder Name"),e("#beftn").prop("checked",!0);var p=h.get("securitySettingList"),m="<label for='username'>"+e.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";m+="<div class='custRadio_pass'>",!isNull(p)&&p.length>0?(e("#otherbank_add_authmodeDiv").html(""),e.each(p,function(a,r){"SMS"==r?(t="sms",n=e.i18n.t("app.transfer.managebeneficiary.sms")):"EMAIL"==r?(t="mail",n=e.i18n.t("app.transfer.managebeneficiary.mail")):"TOKEN"==r?(t="fScan",n=e.i18n.t("app.transfer.managebeneficiary.token")):"ESIGN"==r&&(t="esign",n=e.i18n.t("app.transfer.managebeneficiary.esign")),m+='<div class="box"><div class="radio"><label>',m+=0==a?'<input type="radio" name="other_add_authmode" id="optionsRadios'+a+'" value="'+r+'" checked>':'<input type="radio" name="other_add_authmode" id="optionsRadios'+a+'" value="'+r+'">',m+='<div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs '+t+'"></span><span class="small">'+n+"</span></div></div></label></div></div>"}),e("#otherbank_add_authmodeDiv").html(m)):e("#otherbank_add_authmodeDiv").html("")},getPopupType:function(a){a.stopImmediatePropagation();var t=this,n=e(a.currentTarget).attr("id");if("bankPopup"==n)h.set("popupType","bank"),t.populatePopup(a);else if("branchPopup"==n){h.set("popupType","branch");var r=h.get("benebank");isNull(r)||t.getBranchList(a)}},getSelectedValue:function(a){if(a.stopImmediatePropagation(),"bank"==h.get("popupType")){var t=e("input[name='banks']:checked").val(),n=e("input[name='banks']:checked").attr("id");h.set("benebank",t),h.set("bankCode",n),e("#branchName").val(""),e("#RoutingDistDiv").hide(),e("#routingNum").html(""),e("#dist").html(""),e("#bankName").val(h.get("benebank"))}else if("branch"==h.get("popupType")){var r=e("input[name='banks']:checked").val(),i=e("input[name='banks']:checked").attr("id");h.set("benebranch",r),h.set("branchCode",i),e("#branchName").val(h.get("benebranch"))}setTimeout(function(){e("#bankBranchPopup").modal("hide")},600);var c=this;"branch"==h.get("popupType")&&c.getRoutingNumber(a)},populatePopup:function(a){a.stopImmediatePropagation(),e("#bankBranchList").html("");var t,n=this;e("#bankBranchPopup").modal("show"),"bank"==h.get("popupType")?(t=getBankListDTO(),e("#myModalHeaderLabel").html(e.i18n.t("app.transfer.managebeneficiary.selectbeneficiarybank")),e("#searchTab").attr("placeholder","Search bank"),e("#searchTab").val("")):(t=getBranchListDTO(),e("#myModalHeaderLabel").html(e.i18n.t("app.transfer.managebeneficiary.selectbeneficiarybranch")),e("#searchTab").attr("placeholder","Search Branch"),e("#searchTab").val(""));var r="";e.each(t,function(e,a){r+="<div class='row searchItems'><div class='col-xs-12'><label class='radio-label'>",r+="bank"==h.get("popupType")?"<input type='radio' name='banks' value='"+a.bankName+"' class='selectedvalue' id='"+a.bankCode+"' maxlenAllowed='"+a.maxCharAllowed+"' hyphenAllowed='"+a.hypenAllowed+"'>"+a.bankName+"<span class='checkmark'></span>":"<input type='radio' name='banks' value='"+a.branchName+"' class='selectedvalue' id='"+a.branchCode+"'>"+a.branchName+"<span class='checkmark'></span>",r+="</label></div></div>"}),e("#bankBranchList").html(r),e(".nodata").hide(),e(document).on("keyup","#searchTab",function(e){n.searchInPopup(e)})},searchInPopup:function(a){a.stopImmediatePropagation();var t=e("#searchTab").val();jQuery.expr[":"].contains=function(e,a,t){return jQuery(e).text().toUpperCase().indexOf(t[3].toUpperCase())>=0},t.length>0?(e(".searchItems").hide(),e('.searchItems:contains("'+t+'")').length>0?(e(".nodata").hide(),e('.searchItems:contains("'+t+'")').show()):e(".nodata").show()):(e(".nodata").hide(),e(".searchItems").show())},gotoPreviousPage:function(e){e.stopImmediatePropagation(),"true"==h.get("isTransfer")?t.history.navigate("#/otherbankselectbeneficiary"):t.history.navigate("#/otherselectbene")},toggleLabel:function(a){a.stopImmediatePropagation();var t=e("input[name='choice']:checked").val();"account"==t?(e("#benetypelabel").html("Account Number"),e("#beneNameLabel").html("Account Holder Name")):"card"==t&&(e("#benetypelabel").html("Card Number"),e("#beneNameLabel").html("Card Holder Name"))},update:function(){var e=this;e.getBankBranchList()},getBankBranchList:function(){var a=this;h.set("transferChannel","BEFTN");var t=function(e){a.getAuthmode()},r=function(e){a.errorresponse()};showSpinner(),a.collection=new n([],{});getDeviceId();a.collection.fetch({data:e.param({access_token:h.get("access_token"),transferChannel:h.get("transferChannel")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?t(e):r(e)},error:r})},getBankList:function(){var a=this,t=function(e){hideSpinner()},r=function(e){a.errorresponse()};showSpinner(),a.collection=new n([],{});getDeviceId();a.collection.fetch({data:e.param({access_token:h.get("access_token"),transferChannel:h.get("transferChannel")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?t(e):r(e)},error:r})},toggleBeneInfoDiv:function(a){a.stopImmediatePropagation();var t=this,n=e("input[name='transfer']:checked").val();h.set("benebank",""),"beftn"==n?(e("#bankBranch").show(),e("#branchDiv").show(),e("#bankName").html(""),e("#branchName").html(""),e("#bankName").val(""),e("#branchName").val(""),h.set("transferChannel","BEFTN"),t.getBankList()):"npsb"==n&&(e("#bankBranch").show(),e("#branchDiv").hide(),e("#RoutingDistDiv").hide(),e("#bankName").val(""),h.set("transferChannel","NPSB"),t.getBankList())},getBranchList:function(a){if(hideSpinner(),a.stopImmediatePropagation(),"NPSB"==h.get("transferChannel"))a.preventDefault(),e("#branchDiv").hide();else{var t=this;showSpinner();var n=function(e){hideSpinner(),t.populatePopup(a)},i=function(e){t.errorresponse()};showSpinner(),t.collection=new r([],{});getDeviceId();t.collection.fetch({data:e.param({newversion:"Y",access_token:h.get("access_token"),bankCode:h.get("bankCode"),transferchannnel:h.get("transferChannel")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?n(e):i(e)},error:i})}},getRoutingNumber:function(a){hideSpinner(),"object"==typeof a&&a.stopImmediatePropagation();var t=h.get("benebranch"),n=h.get("branchCode");h.set("benebranch",t),h.set("branchCode",n);var r=this;showSpinner();var c=function(a){hideSpinner();var t=h.get("domesticBankDTO"),n=t[0].routingNumber,r=t[0].bankDistrict;e("#RoutingDistDiv").show(),e("#routingNum").html(n),e("#dist").html(r)},o=function(e){r.errorresponse()};showSpinner(),r.collection=new i([],{});getDeviceId();r.collection.fetch({data:e.param({access_token:h.get("access_token"),bankCode:h.get("bankCode"),branchName:h.get("branchCode")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?c(e):o(e)},error:o})},gotoNextPage:function(){e("#emailError").html(""),e("#accountNoErr").html(""),e("#bankNullError").html(""),e("#shortnameError").html(""),e("#branchNullError").html(""),e("#accNameError").html("");var a=this,n=new RegExp("^[a-zA-Z0-9 ]+$"),r=new RegExp("^[a-zA-Z0-9]+$"),i=e("#accId").val(),c=e("#shortName").val(),s=e("#accName").val(),l=e("input[name='other_add_authmode']:checked").val();h.set("alertType",l),this.model=new o({url:"json/"}),this.$(".alert").hide(),t.Validation.bind(this);var d=c.charAt(0),u=c.charAt(c.length-1),p=s.charAt(0),m=s.charAt(s.length-1),b=this.$("form").serializeObject();if(this.model.set(b,{validate:!0})){var f=e("input[name='transfer']:checked").val();if(!isNull(i)&&!r.test(i))return void e("#accountNoErr").html(e.i18n.t("validation.managebene.otherbankaccnumberspecialchar"));if(i.length>17)return void e("#accountNoErr").html(e.i18n.t("validation.managebene.accnolength"));if(!n.test(s))return void e("#accNameError").html(e.i18n.t("validation.managebene.accnamespecialchar"));if(!p.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return void e("#accNameError").html(e.i18n.t("validation.newregistration.firstspaceind"));if(!m.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return void e("#accNameError").html(e.i18n.t("validation.newregistration.lastspaceind"));if(s.length>22)return void e("#accNameError").html(e.i18n.t("validation.managebene.accnamelength"));if(!n.test(c))return void e("#shortnameError").html(e.i18n.t("validation.managebene.shortnamespecialchar"));if(!d.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return void e("#shortnameError").html(e.i18n.t("validation.newregistration.firstspaceind"));if(!u.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return void e("#shortnameError").html(e.i18n.t("validation.newregistration.lastspaceind"));if(c.length>20)return void e("#shortnameError").html(e.i18n.t("validation.managebene.shortnamelength"));if("beftn"==f){var g=e("#bankName").val(),v=e("#branchName").val();if(isNull(g))return void e("#bankNullError").html(e.i18n.t("app.transfer.managebeneficiary.plbank"));if(isNull(v))return void e("#branchNullError").html(e.i18n.t("app.transfer.managebeneficiary.plbranch"))}else if("npsb"==f){e("#branchName").attr("disabled"),e("#branchNullError").attr("disabled");var g=e("#bankName").val();if(isNull(g))return void e("#bankNullError").html(e.i18n.t("app.transfer.managebeneficiary.plbank"))}var k=e("#eaddress").val();if(""!==k){var N=/^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/;if(!N.test(k))return void e("#emailError").html(e.i18n.t("validation.managebene.emailnotvalid"))}a.gotoVerifyPage(event)}else event.preventDefault(),this.$(".alert-error").fadeIn(),hideSpinner(),t.Validation.unbind(event)},gotoVerifyPage:function(a){a.stopImmediatePropagation();var n,r=this,i=e("#accName").val(),o=e("#accId").val();n="true"==h.get("isOtherOneOffSuccess")?h.get("otherOneOffSuccessBankName"):h.get("benebank"),h.set("bankName",n);var s=h.get("bankCode"),l=h.get("benebranch"),d=h.get("branchCode"),u=e("input[name='choice']:checked").val(),p=e("input[name='choice']:checked").attr("data"),m=e("#routingNum").html(),b=e("#dist").html(),f=e("#shortName").val(),g=e("#eaddress").val(),v=e("input[name='choice']:checked").val(),k=e("#accId").val(),N=(new Date).getTime();h.set("salttime",N);var y=EncryptWithDynamicSalt(k,N),S=function(e){hideSpinner(),"account"==v?h.set("transBy","account"):"card"==v&&h.set("transBy","cards"),"NPSB"==h.get("transferChannel")?(h.set("otherbankcode",s),h.set("otherbranchcode","")):"BEFTN"==h.get("transferChannel")&&(h.set("otherbankcode",s),h.set("otherbranchcode",d)),h.set("accHolderName",i),h.set("accntNumber",o),h.set("bankName",n),h.set("branchName",l),h.set("beneficiaryType",u),h.set("beneType",p),h.set("routingNumber",m),h.set("districtName",b),h.set("shortName",f),h.set("emailAdd",g),t.history.navigate("#/otherbankaddbeneverify")},B=function(e){hideSpinner(),r.errorresponse()};r.collection=new c,r.collection.fetch({data:e.param({access_token:h.get("access_token"),transfertype:"LOCAL_TRANSFER",salt:h.get("salttime"),accountNumber:y,nickname:f}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?S(e):B(e)},error:B})},errorresponse:function(){hideSpinner(),openErrorPopup()},populateBranchDropDown:function(){var a=getBranchListDTO();e("#benebranch").empty();var t="<option value=''>Select Beneficiary Branch</option>";e.each(a,function(e,a){t+="<option value='"+a.branchCode+"'>"+a.branchName+"</option>"}),e("#benebranch").append(t)},disposeView:function(e){return t.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return d});