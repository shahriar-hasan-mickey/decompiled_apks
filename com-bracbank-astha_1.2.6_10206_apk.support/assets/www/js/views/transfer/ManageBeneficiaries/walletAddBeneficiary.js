define(["jquery","underscore","Backbone","models/validation/manageBeneficiaries/mobilewalletAddBeneValidationModel","collections/transfer/getAuthModeCollections","text!views/transfer/ManageBeneficiaries/walletAddBeneficiary.tpl","collections/manageBeneficiaries/walletAccountNumValidateCollection","collections/manageBeneficiaries/checkaddedBeneficiaryCollection"],function(e,t,a,l,n,i,r,o){var s=!1,c=new EncryptedLocalStorage("secret"),u=a.View.extend({el:"#container",events:{"click #walletCancelBtn":"gotoPreviousPage","click #walletNextBtn":"gotoNextPage","click #walletaddbackbtn":"gotowalletaddUI","blur #walletAccountNumber":"getWalletAccHolderName","click .walletphonebookbtn":"openWalletAccontPhonebook"},initialize:function(){},getAuthmode:function(){var t=this;c.set("IsAuthMode","false"),e("#wallet_add_authmodeDiv").html("");var a=function(e){hideSpinner();var a=c.get("securitySettingList");!isNull(a)&&a.length>0?c.set("IsAuthMode","true"):(c.set("alertType",null),c.set("IsAuthMode","false")),t.populateAuthMode()},l=function(e){hideSpinner(),c.set("IsAuthMode","false"),t.populateAuthMode()};showSpinner(),t.collection=new n,t.collection.fetch({data:e.param({access_token:c.get("access_token"),transactionAmount:null,tenantServiceCode:"WI"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?a(e):l(e)},error:l})},populateAuthMode:function(){var a="",l="",n=this;if(e("html").removeClass().addClass("app"),this.$el.html(t.template(i)),"true"==c.get("isWalletOneOffSuccess")){var r=c.get("walletOneOffSuccessWalletNum");e("#walletAccountNumber").val(r);var o=c.get("waletOneOffSuccessWalletType");c.set("walletType",o)}var s=c.get("securitySettingList"),u="<label for='username'>"+e.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";u+="<div class='custRadio_pass'>",!isNull(s)&&s.length>0?(e("#wallet_add_authmodeDiv").html(""),e.each(s,function(t,n){"SMS"==n?(a="sms",l=e.i18n.t("app.transfer.managebeneficiary.sms")):"EMAIL"==n?(a="mail",l=e.i18n.t("app.transfer.managebeneficiary.mail")):"TOKEN"==n?(a="fScan",l=e.i18n.t("app.transfer.managebeneficiary.token")):"ESIGN"==n&&(a="esign",l=e.i18n.t("app.transfer.managebeneficiary.esign")),u+='<div class="box"><div class="radio"><label>',u+=0==t?'<input type="radio" name="wallet_add_authmode" id="optionsRadios'+t+'" value="'+n+'" checked>':'<input type="radio" name="wallet_add_authmode" id="optionsRadios'+t+'" value="'+n+'">',u+='<div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs '+a+'"></span><span class="small">'+l+"</span></div></div></label></div></div>"}),e("#wallet_add_authmodeDiv").html(u)):e("#wallet_add_authmodeDiv").html(""),n.loadTemplate()},loadTemplate:function(){e("#walletAccountNumber").val(""),e("#walletBeneshortName").val(""),null!=c.get("walletToAccNum")&&""!=c.get("walletToAccNum")&&e("#walletAccountNumber").val(c.get("walletToAccNum")),fillFormDatas(c.get("formDatasInEls")),isNull(e("#walletAccountNumber").val())||e("#walletAccountNumber").blur()},update:function(){var e=this;"addwalletbene"!==c.get("historyBackUrl")&&e.getAuthmode()},gotoPreviousPage:function(e){e.stopImmediatePropagation(),c.set("thisInputId",null),c.set("formDatasInEls",null),"true"==c.get("isWalletTransferSelectBenePage")?a.history.navigate("#/wallettransfertobeneselect"):a.history.navigate("#/walletselectbene")},getWalletAccHolderName:function(t){"object"==typeof t&&t.stopImmediatePropagation(),e("#accountNoErr").html(""),e("#walletHolderName").html("");var n=this;this.model=new l({url:"json/"}),a.Validation.bind(this);var i=this.$("form").serializeObject();this.model.set(i,{validate:!0})?(this.model.clear(),a.Validation.unbind(this)):this.$(".has-error").fadeIn();var o=function(t){hideSpinner(),s=!1,e("#walletHolderName").html(c.get("walletInfoList")[1].value)},u=function(e){s=!0,n.errorresponse()},m=e("#walletAccountNumber").val();if(!isNull(m)){if((m.length>12||m.length<12)&&"Rocket"==c.get("walletType"))return void e("#accountNoErr").html(e.i18n.t("app.transfer.managebeneficiary.rocketacclenerr"));if((m.length>11||m.length<11)&&"Rocket"!=c.get("walletType"))return void e("#accountNoErr").html(e.i18n.t("app.transfer.managebeneficiary.otherwalletacclenerr"));showSpinner(),n.collection=new r([],{});var d=(getDeviceId(),(new Date).getTime());c.set("salttime",d);var h=EncryptWithDynamicSalt(m,d);n.collection.fetch({data:e.param({access_token:c.get("access_token"),accountNumber:h,walletTransferType:c.get("walletType"),transactionAmount:null,salt:c.get("salttime"),modtype:"ADD"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?o(e):u(e)},error:u})}},gotoNextPage:function(t){t.stopImmediatePropagation(),e("#accountNoErr").html(""),e("#emailError").html(""),e("#shortNameNullError").html(""),e("#mobNumNullError").html(""),e("#remarkNullError").html("");var n=this,i=e("#walletBeneshortName").val(),r=new RegExp("^[a-zA-Z0-9 ]+$"),o=e("input[name='wallet_add_authmode']:checked").val();c.set("alertType",o);var u=i.charAt(0),m=i.charAt(i.length-1),d=e("#walletAccountNumber").val();this.model=new l({url:"json/"}),this.$(".alert").hide(),a.Validation.bind(this);var h=this.$("form").serializeObject();if(this.model.set(h,{validate:!0})){if(isNull(d))return"upay"==c.get("walletType")||"uPay"==c.get("walletType")||"uPAY"==c.get("walletType")||"UPay"==c.get("walletType")||"Upay"==c.get("walletType")?void e("#accountNoErr").html("Please enter the UPAY Account Number"):void e("#accountNoErr").html("Please enter the Account number");if(!isNull(d)&&d.length>20)return void e("#accountNoErr").html("The Account Number should contain a minimum of 20 characters");if(s)return void e("#accountNoErr").html(e.i18n.t("app.transfer.managebeneficiary.withinaccounterror"));if(!r.test(i))return void e("#shortNameNullError").html(e.i18n.t("validation.managebene.shortnamespecialchar"));if(!u.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return void e("#shortNameNullError").html(e.i18n.t("validation.newregistration.firstspaceind"));if(!m.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return void e("#shortNameNullError").html(e.i18n.t("validation.newregistration.lastspaceind"));if(i.length>20)return void e("#shortNameNullError").html(e.i18n.t("validation.managebene.shortnamelength"));var p=e("#walletEmailAdd").val();if(""!==p){var g=/^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/;if(!g.test(p))return void e("#emailError").html(e.i18n.t("validation.managebene.emailnotvalid"))}var w=e("#walletMobileNum").val();if("TAP"!==c.get("walletType"))if("UPAY"==c.get("walletType")||"upay"==c.get("walletType")||"uPay"==c.get("walletType")||"uPAY"==c.get("walletType")||"UPay"==c.get("walletType")||"Upay"==c.get("walletType"));else if(isNull(w))return void e("#mobNumNullError").html(e.i18n.t("validation.managebene.mobnumnotnull"));if(!isNull(w)){var f=/(^(\+8801|8801|01|008801))[1|3-9]{1}(\d){8}$/;if(!f.test(w))return void e("#mobNumNullError").html(e.i18n.t("Please enter valid Mobile Number"))}var v=e("#walletRemark").val(),y=v.charAt(0),N=v.charAt(v.length-1);if("TAP"!==c.get("walletType"))if("UPAY"==c.get("walletType")||"upay"==c.get("walletType")||"uPay"==c.get("walletType")||"uPAY"==c.get("walletType")||"UPay"==c.get("walletType")||"Upay"==c.get("walletType"));else if(isNull(v))return void e("#remarkNullError").html(e.i18n.t("validation.managebene.remarknotnull"));if(!isNull(v)&&!r.test(v))return void e("#remarkNullError").html(e.i18n.t("validation.managebene.remarksspecialchar"));if(!isNull(v)){if(!y.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return void e("#remarkNullError").html(e.i18n.t("validation.newregistration.firstspaceind"));if(!N.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return void e("#remarkNullError").html(e.i18n.t("validation.newregistration.lastspaceind"));if("UPAY"==c.get("walletType")||"upay"==c.get("walletType")||"uPay"==c.get("walletType")||"uPAY"==c.get("walletType")||"UPay"==c.get("walletType")||"Upay"==c.get("walletType")){if(v.length>35)return void e("#remarkNullError").html("Remarks should contain maximum of 35 characters")}else if(v.length>20)return void e("#remarkNullError").html("Remarks should contain maximum of 20 characters")}n.gotoVerifyPage(t)}else t.preventDefault(),this.$(".alert-error").fadeIn(),hideSpinner(),a.Validation.unbind(t)},gotoVerifyPage:function(t){t.stopImmediatePropagation(),c.set("thisInputId",null),c.set("formDatasInEls",null),c.set("walletAccNum",e("#walletAccountNumber").val()),c.set("walletHolderName",e("#walletHolderName").html()),c.set("walletBeneshortName",e("#walletBeneshortName").val()),c.set("walletMobileNum",e("#walletMobileNum").val()),c.set("walletEmailAdd",e("#walletEmailAdd").val()),c.set("walletRemark",e("#walletRemark").val()),c.set("walletBeneName",c.get("walletInfoList")[1].value);var l=e("#walletAccountNumber").val(),n=(new Date).getTime();c.set("salttime",n);var i=EncryptWithDynamicSalt(l,n),r=this,s=function(e){hideSpinner(),a.history.navigate("#/addwalletverifybene")},u=function(e){hideSpinner(),r.errorresponse()};r.collection=new o,r.collection.fetch({data:e.param({access_token:c.get("access_token"),transfertype:"WALLET_TRANSFER",salt:c.get("salttime"),accountNumber:i,nickname:c.get("walletBeneshortName"),wallettype:c.get("walletType")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?s(e):u(e)},error:u})},gotowalletaddUI:function(){var e=c.get("isTransfer");c.set("thisInputId",null),c.set("formDatasInEls",null),"true"==e?a.history.navigate("#/wallettransfertobeneselect"):a.history.navigate("#/walletselectbene")},errorresponse:function(){hideSpinner(),openErrorPopup()},openWalletAccontPhonebook:function(t){t.stopImmediatePropagation();var l=e(t.currentTarget).attr("id");"mobNumberPhoneBookBtn"==l?c.set("thisInputId","walletMobileNum"):"accNumberPhoneBookBtn"==l&&c.set("thisInputId","walletAccountNumber"),c.set("formDatasInEls",serializeFormDatas()),a.history.navigate("#/contactlist")},disposeView:function(e){return a.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return u});