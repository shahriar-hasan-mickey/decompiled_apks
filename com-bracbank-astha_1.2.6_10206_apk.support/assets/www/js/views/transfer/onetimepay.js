define(["jquery","underscore","Backbone","text!views/transfer/onetimepay.tpl","models/validation/transfer/withinAccountOnetimepayValidationModel","collections/wealth/prepaidcardCollections","collections/transfer/getTransactionLimitCollections","collections/transfer/getAccountBalanceCollections","collections/manageBeneficiaries/BeneaccnumCollections","collections/transfer/withinBankTransferProcessCollection","collections/transfer/currencyListsCollections","collections/transfer/getAuthModeCollections"],function(e,t,a,n,i,r,o,c,s,l,m,u){var d=!1,p=new EncryptedLocalStorage("secret"),h=a.View.extend({el:"#container",events:{"click #WithinBank_OneTimePay_Confirm":"submitPay","click #WithinBank_ToBeneficiary":"loadTobeneUi","blur #WithinBank_OneTimePay_AccCardNum":"loadaccnumvalidation","change #WB_OneTimePay_FromAcc":"getAccountBalance","click #WB_OneTimePay_CancelBtn":"gotoPreviousPage","change #reason":"showOthersDiv","blur #within_onetime_paymentAmount":"getWithinOneTimeAuthMode","click .withinOneTimetype":"withinToggleLabel","click #withinBankOneTimeTandCPopup":"oneTimePayOpenTandCPopup"},initialize:function(){},update:function(){var t=this;if("false"==p.get("isPrepaidCardData")){var a=function(e){hideSpinner(),t.transactionlimit(),p.set("isPrepaidCardData","true")},n=function(e){t.errorresponse()};showSpinner(),t.collection=new r([],{});getDeviceId();t.collection.fetch({data:e.param({newversion:"Y",access_token:p.get("access_token")}),dataType:"json",type:"POST",cache:!1,success:function(e){if("0000"==ackStatus){var t=p.get("errorcode");a("9999"==t?e:e)}else n(e)},error:n})}else hideSpinner(),t.transactionlimit()},transactionlimit:function(){var t=this,a=function(e){hideSpinner(),t.loadtempUi()},n=function(e){t.errorresponse()};showSpinner(),t.collection=new o,t.collection.fetch({data:e.param({access_token:p.get("access_token"),payeeType:"WITHIN_BANK"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?a(e):n(e)},error:n})},getWithinOneTimeAuthMode:function(t){var n=this;t.stopImmediatePropagation();var r=e("#within_onetime_paymentAmount").val().replace(/,/g,"");p.set("IsAuthMode","false"),p.set("authModeFlag","false"),e("#transfermountError").html(""),e("#within_onetime_transferDiv").html("");var o=new RegExp("^[0-9.,]+$");this.model=new i({url:"json/"}),a.Validation.bind(this);var c=this.$("form").serializeObject();if(this.model.set(c,{validate:!0})?(this.model.clear(),a.Validation.unbind(this)):this.$(".has-error").fadeIn(),p.set("transferType","withinOneOff"),!isNull(r)){if(!isNull(r)&&!o.test(r))return void e("#transfermountError").html(e.i18n.t("validation.transfer.validamount"));var r=parseFloat(e("#within_onetime_paymentAmount").val().replace(/,/g,"")),s=parseFloat(p.get("minAmountPerTransaction")),l=parseFloat(p.get("maxAmountPerTransaction"));if(s>r)return void e("#transfermountError").html(e.i18n.t("validation.sadad.amtgreaterthanminamt"));if(r>l)return void e("#transfermountError").html(e.i18n.t("validation.sadad.amtlessthanmaxamt"));var m=function(e){hideSpinner();var a=p.get("securitySettingList");!isNull(a)&&a.length>0?p.set("IsAuthMode","true"):(p.set("alertType",null),p.set("IsAuthMode","false")),n.populateAuthMode(t),n.submitPay(t)},d=function(t){hideSpinner(),p.set("authModeFlag","true"),e("#within_onetime_paymentAmount").val(""),n.errorresponse()};showSpinner(),n.collection=new u,n.collection.fetch({data:e.param({access_token:p.get("access_token"),transactionAmount:r,tenantServiceCode:"W_OT"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?m(e):d(e)},error:d})}},populateAuthMode:function(t){t.stopImmediatePropagation();var a="",n="",i=p.get("securitySettingList"),r="<label for='username'>"+e.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";r+="<div class='custRadio_pass'>",!isNull(i)&&i.length>0?(e("#within_onetime_transferDiv").html(""),e.each(i,function(t,i){"SMS"==i?(a="sms",n=e.i18n.t("app.transfer.managebeneficiary.sms")):"EMAIL"==i?(a="mail",n=e.i18n.t("app.transfer.managebeneficiary.mail")):"TOKEN"==i?(a="fScan",n=e.i18n.t("app.transfer.managebeneficiary.token")):"ESIGN"==i&&(a="esign",n=e.i18n.t("app.transfer.managebeneficiary.esign")),r+='<div class="box"><div class="radio"><label>',r+=0==t?'<input type="radio" name="within_ontetime_transfer" id="optionsRadios'+t+'" value="'+i+'" checked>':'<input type="radio" name="within_ontetime_transfer" id="optionsRadios'+t+'" value="'+i+'">',r+='<div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs '+a+'"></span><span class="small">'+n+"</span></div></div></label></div></div>"}),e("#within_onetime_transferDiv").html(r)):e("#within_onetime_transferDiv").html("")},loadtempUi:function(){this.$el.html(t.template(n));var a=p.get("downtimeNotification");if(!isNull(a)&&a.length>0){var i=(a[0].downtimeNotificationDetail,"");e.each(a,function(e,t){if("REGISTERED"==t.subTransactionType){var a=t.downtimeNotificationDetail,n=a[e].messageMobile;isNull(n)||(i+="<p>"+n+"</p>")}}),e("#notificationMessage").html(e.parseHTML(i))}e("#withinOneOffShortNotesUIDiv").hide();var r=e.parseJSON(window.localStorage.getItem("shortNotesObj"));isNull(r.WITHINONEOFF)||(e("#withinOneOffShortNotesUIDiv").show(),e("#withinOneOffShortNotesDiv").html(r.WITHINONEOFF)),e("html").removeClass().addClass("app"),e("#availBalDiv").hide(),e("#beneTypeLabel").html("Pay to Account")},loadaccnumvalidation:function(t){t.stopImmediatePropagation();var n=this;e("#accountNoErr").html(""),this.model=new i({url:"json/"}),a.Validation.bind(this);var r=this.$("form").serializeObject();this.model.set(r,{validate:!0})?(this.model.clear(),a.Validation.unbind(this)):this.$(".has-error").fadeIn();var o=new RegExp("^[0-9]+$"),c=function(t){hideSpinner(),d=!1;var a=p.get("beneficiaryBeneficiaryInstructionDTOs"),n=a[0].shortName;p.set("benename_bene1",n),e("#toacc_name").html(n)},l=function(t){d=!0,n.errorresponse(),e("#WithinBank_OneTimePay_AccCardNum").val("")},m=e("#WithinBank_OneTimePay_AccCardNum").val();if(null==m||""==m)t.preventDefault();else if(o.test(m)){showSpinner(),n.collection=new s([],{});var u=(getDeviceId(),(new Date).getTime());p.set("salttime",u);var h=EncryptWithDynamicSalt(m,u),f=e("input[name='avalB']:checked").val();"account"==f?p.set("cardType","A"):"cards"==f&&p.set("cardType","CC"),n.collection.fetch({data:e.param({access_token:p.get("access_token"),accountNumber:h,accountCurrency:"BDT",accountType:p.get("cardType"),salt:p.get("salttime")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?c(e):l(e)},error:l})}else e("#accountNoErr").html(e.i18n.t("validation.transfer.validaccount")),t.preventDefault()},getAccountBalance:function(t){t.stopImmediatePropagation();var a=e("#WB_OneTimePay_FromAcc option:selected").attr("Accide"),n=e("#WB_OneTimePay_FromAcc option:selected").attr("frName");p.set("fromname",n),p.set("accountID1",a);var i=e("#WB_OneTimePay_FromAcc option:selected").attr("acctype");p.set("paymentType12",i);var r=this;if(""==a)return e("#availbalance").html(""),void e("#availBalDiv").hide();var o=function(a){hideSpinner(),e("#availBalDiv").show(),e("#error_acc").html("");var n,o,c=p.get("availableBalance"),s=parseFloat(c.slice(0,-2)),l=p.get("accountCurrency");"CASA"==i?(n=checkAmount(e.formatNumber(s,{format:"#,###.00",locale:"us"})),o=n+" "+l,p.set("fromAcntAvailBal",s)):"PC"==i&&(n=checkAmount(e.formatNumber(c,{format:"#,###.00",locale:"us"})),o=n+" "+l,p.set("fromAcntAvailBal",c)),e("#availbalance").html(o);var l=e("#WB_OneTimePay_FromAcc option:selected").attr("data");"BDT"==l?(r.populateBDT(t),p.set("fromAccCurr","BDT")):(r.getCurrencyList(t),p.set("fromAccCurr",l))},s=function(e){r.errorresponse()};showSpinner(),r.collection=new c,r.collection.fetch({data:e.param({access_token:p.get("access_token"),accountId:a,accountType:i,beneficiaryInstructionId:null}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?o(e):s(e)},error:s})},getCurrencyList:function(t){t.stopImmediatePropagation();var a=this,n=function(e){hideSpinner(),a.populateCurrencyDropDown(t)},i=function(e){a.errorresponse()};showSpinner(),a.collection=new m,a.collection.fetch({data:e.param({access_token:p.get("access_token")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?n(e):i(e)},error:i})},populateCurrencyDropDown:function(t){t.stopImmediatePropagation();var a=p.get("currencyLists");e("#currency").empty();var n="",i=p.get("fromAccCurr");e.each(a,function(e,t){t.code==i&&(n+="<option value='"+t.code+"' selected>"+t.code+"</option>")}),e("#currency").append(n)},populateBDT:function(t){t.stopImmediatePropagation(),e("#currency").empty();var a="";a+="<option value='BDT' selected>BDT</option>",e("#currency").append(a)},submitPay:function(t){t.stopImmediatePropagation(),e("#tandcErr").html(""),e("#transfermountError").html(""),e("#otherRemaksNullError").html(""),e("#accountNoErr").html("");var n=this,r=new RegExp("^[0-9]+$"),o=e("#WithinBank_OneTimePay_AccCardNum").val(),c=new RegExp("^[0-9.,]+$"),s=new RegExp("^[A-Za-z0-9 ]+$"),l=e("#WBOneOff_OtherRemarks").val(),m=e("#within_onetime_paymentAmount").val().replace(/,/g,""),u=e("input[name='within_ontetime_transfer']:checked").val();p.set("alertType",u),p.set("toAccCurr","BDT"),this.model=new i({url:"json/"}),a.Validation.bind(this);var h=this.$("form").serializeObject();if(this.model.set(h,{validate:!0})){this.model.clear(),a.Validation.unbind(this),e("#currency option:selected").val();var f=e("#termsand").prop("checked");if(!f)return void e("#tandcErr").html("Please check the Terms and Conditions");var v=e("#WB_OneTimePay_FromAcc option:selected").text().trim(),y=e("#WithinBank_OneTimePay_AccCardNum").val().trim();if(v==y)return void e("#accountNoErr").html("From and To Accounts Cannot Be Same");if(!isNull(o)&&!r.test(o))return void e("#accountNoErr").html(e.i18n.t("validation.transfer.validaccount"));if(o.length>16)return void e("#accountNoErr").html(e.i18n.t("validation.transfer.accnumlenerr"));if(!isNull(m)&&!c.test(m))return void e("#transfermountError").html(e.i18n.t("validation.transfer.validamount"));if(!isNull(l)&&l.length>16)return void e("#otherRemaksNullError").html("The Remarks should contain maximum of 16 characters");if(!isNull(l)&&!s.test(l))return void e("#otherRemaksNullError").html(e.i18n.t("validation.managebene.remarksspecialchar"));if(p.get("fromAccCurr")==currency){var g=parseFloat(e("#within_onetime_paymentAmount").val().replace(/,/g,"")),T=p.get("fromAcntAvailBal");if(g>T)return e("#transfermountError").html(e.i18n.t("validation.transfer.nobal")),!1}if("BDT"==p.get("fromAccCurr")&&"BDT"==p.get("toAccCurr")){var A=parseFloat(p.get("dailyAvailableLimit")),_=parseFloat(p.get("minAmountPerTransaction")),w=parseFloat(p.get("maxAmountPerTransaction")),P=p.get("dailyAvailableCount"),b=p.get("monthlyAvailableCount"),g=parseFloat(e("#within_onetime_paymentAmount").val().replace(/,/g,""));if(d)return void e("#accountNoErr").html(e.i18n.t("app.transfer.managebeneficiary.withinaccounterror"));if(_>g)return void e("#transfermountError").html(e.i18n.t("validation.sadad.amtgreaterthanminamt"));if(g>A)return e("#transfermountError").html(e.i18n.t("validation.transfer.notra")),!1;if(g>w)return e("#transfermountError").html(e.i18n.t("validation.sadad.amtlessthanmaxamt")),!1;if("0"==P)return void e("#transfermountError").html("You have exceeded your daily transaction count.");if("0"==b)return void e("#transfermountError").html("Transaction count exceeded Monthly Available Count.")}e("#reason option:selected").val();if("true"==p.get("authModeFlag"))return;n.beneconfrom(t)}else this.$(".has-error").fadeIn(),t.preventDefault()},loadTobeneUi:function(e){e.stopImmediatePropagation(),a.history.navigate("#/selectbeneficiary")},gotoPreviousPage:function(e){e.stopImmediatePropagation();var t=p.get("downtimeNotification");!isNull(t)&&t.length>0?a.history.navigate("#/transfer"):a.history.navigate("#/selectbeneficiary")},withinToggleLabel:function(t){t.stopImmediatePropagation();var a=e("input[name='avalB']:checked").val();"account"==a?e("#beneTypeLabel").html("Pay to Account"):"cards"==a&&e("#beneTypeLabel").html("Pay to Card")},showOthersDiv:function(t){t.stopImmediatePropagation();var a=e("#reason option:selected").val();"others"==a?e("#othersDiv").show():e("#othersDiv").hide()},beneconfrom:function(t){t.stopImmediatePropagation();var a=e("input[name='avalB']:checked").val();p.set("paymentTypeToAc",a);var n=(e("#reason option:selected").html(),e("#WBOneOff_OtherRemarks").val());p.set("transferreason",n);var i=e("#within_onetime_paymentAmount").val().replace(/,/g,"");p.set("withinBankPaymentAmount",i);var r=e("#WB_OneTimePay_FromAcc").val();p.set("wonaccno",r);var o=e("#WithinBank_OneTimePay_AccCardNum").val();p.set("Toaccno",o);var c=e("#toacc_name").val();p.set("Toaccname",c);var s=e("#currency option:selected").val();p.set("transCurr",s);var l=this;l.gotoVerifyPage(t)},gotoVerifyPage:function(t){t.stopImmediatePropagation(),e("#transfermountError").html("");var n=p.get("paymentType12"),i=p.get("paymentTypeToAc");"account"==i?p.set("Benetyptrans","CASA"):"cards"==i&&p.set("Benetyptrans","CC");var r=e("#WithinBank_OneTimePay_AccCardNum").val();p.set("withinOneOffToAccNum",r);var o=(new Date).getTime();if(p.set("salttime",o),"CASA"==n&&"account"==i)p.set("tYpeOfTrans","A2A"),p.set("accnum",r);else if("CASA"==n&&"cards"==i){var c=EncryptWithDynamicSalt(r,o);p.set("accnum",c),p.set("tYpeOfTrans","A2C")}else if("PC"==n&&"cards"==i){p.set("tYpeOfTrans","P2C");var c=EncryptWithDynamicSalt(r,o);p.set("accnum",c)}else"PC"==n&&"account"==i&&(p.set("tYpeOfTrans","P2A"),p.set("accnum",r));var s=(p.get("Toaccno"),getDatemonthToday()),m=this,u=function(t){if("BDT"!==p.get("fromAccCurr")||"BDT"!==p.get("toAccCurr")){hideSpinner();var n=parseFloat(p.get("dailyAvailableLimit")),i=parseFloat(p.get("minAmountPerTransaction")),r=parseFloat(p.get("maxAmountPerTransaction")),o=parseFloat(p.get("paymentAmount"));if(i>o)return void e("#transfermountError").html(e.i18n.t("validation.sadad.amtgreaterthanminamt"));if(o>n)return e("#transfermountError").html(e.i18n.t("validation.transfer.notra")),!1;o>r&&e("#transfermountError").html(e.i18n.t("validation.sadad.amtlessthanmaxamt")),p.set("beneSuccessFlag","true"),a.history.navigate("#/onetimepayverify")}else hideSpinner(),p.set("beneSuccessFlag","true"),a.history.navigate("#/onetimepayverify")},d=function(e){m.errorresponse()};showSpinner(),m.collection=new l([],{}),m.collection.fetch({data:e.param({access_token:p.get("access_token"),fromaccountId:p.get("accountID1"),paydate:s,transtype:"PAYNOW",validtype:"Validation",beneAcctType:p.get("Benetyptrans"),currSelection:"F",transcurrency:p.get("transCurr"),toacctno:p.get("accnum"),benename:p.get("benename_bene1"),remarks:p.get("transferreason"),trnasfertype:p.get("tYpeOfTrans"),transamount:p.get("withinBankPaymentAmount"),uniqueId:null,globalId:null,totalDebitAmount:p.get("withinBankPaymentAmount"),onetimepay:"TRUE",benetype:"TENANT",limitId:p.get("id"),salt:p.get("salttime")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?u(e):d(e)},error:d})},errorresponse:function(){hideSpinner(),openErrorPopup()},oneTimePayOpenTandCPopup:function(e){e.stopImmediatePropagation(),p.set("tandctype","withinoneoff"),openTermsAndConditionsPopup()},disposeView:function(e){return a.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return h});