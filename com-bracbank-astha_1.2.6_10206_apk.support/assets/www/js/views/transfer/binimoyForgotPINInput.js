define(["jquery","underscore","Backbone","collections/transfer/getAuthModeCollections","collections/wealth/otpPostLoginGenerationCollections","collections/wealth/otpPostLoginVerificationCollections","text!views/transfer/binimoyForgotPINInput.tpl"],function(t,e,o,i,n,r,a){var l=new EncryptedLocalStorage("secret"),s=!1,p=null,c=o.View.extend({el:"#container",events:{"click #binimoyForgotPINInput_ProceedBtn":"forgotPinOTPGeneration","click #binimoyForgotPINInput_CancelBtn":"gotoPreviousPage","click #verifyOTP":"gotoForgotPINSuccessPage","click #popup_cancel_btn":"revokeOTPSpinner","click #close_btn":"revokeOTPSpinner"},initialize:function(){},update:function(){var e=this;l.set("IsAuthMode","false"),t("#binimoyForgotPINAuthModeDiv").html("");var o=function(t){hideSpinner();var o=l.get("securitySettingList");!isNull(o)&&o.length>0?l.set("IsAuthMode","true"):(l.set("AlertType",null),l.set("IsAuthMode","false")),e.loadBinimoyForgotPINInputTemplate()},n=function(t){l.set("IsAuthMode","false"),e.loadBinimoyForgotPINInputTemplate()};showSpinner(),e.collection=new i,e.collection.fetch({data:t.param({access_token:l.get("access_token"),transactionAmount:null,tenantServiceCode:"IDTP_REG"}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?o(t):n(t)},error:n})},loadBinimoyForgotPINInputTemplate:function(){this.$el.html(e.template(a)),t("html").removeClass().addClass("app"),p=null;var o=this;o.populateAuthMode()},populateAuthMode:function(e){"object"==typeof e&&e.stopImmediatePropagation();var o="",i="",n=l.get("securitySettingList"),r="<label for='username'>"+t.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";r+="<div class='custRadio_pass'>",!isNull(n)&&n.length>0?(t("#binimoyForgotPINAuthModeDiv").html(""),t.each(n,function(e,n){"SMS"==n?(o="sms",i=t.i18n.t("app.transfer.managebeneficiary.sms")):"EMAIL"==n?(o="mail",i=t.i18n.t("app.transfer.managebeneficiary.mail")):"TOKEN"==n?(o="fScan",i=t.i18n.t("app.transfer.managebeneficiary.token")):"ESIGN"==n&&(o="esign",i=t.i18n.t("app.transfer.managebeneficiary.esign")),r+='<div class="box"><div class="radio"><label>',r+=0==e?'<input type="radio" name="binimoyForgotPIN_AuthMode" id="optionsRadios'+e+'" value="'+n+'" checked>':'<input type="radio" name="binimoyForgotPIN_AuthMode" id="optionsRadios'+e+'" value="'+n+'">',r+='<div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs '+o+'"></span><span class="small">'+i+"</span></div></div></label></div></div>"}),t("#binimoyForgotPINAuthModeDiv").html(r)):t("#binimoyForgotPINAuthModeDiv").html("")},gotoPreviousPage:function(t){t.stopImmediatePropagation(),o.history.navigate("#/binimoyforgotpininfo")},forgotPinOTPGeneration:function(e){e.stopImmediatePropagation();var o=this;t("#binimoyForgotPIN_NewPINErr").html(""),t("#binimoyForgotPIN_ConfirmPINErr").html("");var i=t("#binimoyForgotPIN_NewPIN").val(),n=t("#binimoyForgotPIN_ConfirmPIN").val();s=!1,isNull(i)&&(s=!0,t("#binimoyForgotPIN_NewPINErr").html("Please enter a new PIN")),isNull(n)&&(s=!0,t("#binimoyForgotPIN_ConfirmPINErr").html("Please enter confirm PIN")),isNull(i)||isNull(n)||i!=n&&(s=!0,t("#binimoyForgotPIN_ConfirmPINErr").html("New PIN and Confirm PIN should be same")),s||(l.set("binimoyForgotPIN_NewPIN",i),o.gotoAuthModeVerification(e))},gotoAuthModeVerification:function(e){e.stopImmediatePropagation();var o=t("input[name='binimoyForgotPIN_AuthMode']:checked").val();l.set("AlertType",o);var i=this;i.loadOTP()},loadOTP:function(){var e=this,i=l.get("AlertType");"false"==l.get("IsAuthMode")?o.history.navigate("#/binimoynewregistration"):"SMS"==i||"EMAIL"==i||"ESIGN"==i?e.validateotpgeneration("N"):(l.set("otpCode",""),t("#verify").modal("show"),t("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").removeAttr("data"),t("#myModalLabel").html(t.i18n.t("app.registration.otptokenheadertext")),t("#otpHelpText").html(t.i18n.t("app.registration.opthelptokentext")),t("#challengeText").html(""),t("#otpContainerDiv").html(""),t("#otpNullError").html(""),t("#otpNullErrorDiv").hide(),t(".inputs").on("input",function(e){var o=e.currentTarget.id,i=t("#"+o).val();t("#"+o).attr("data",i),t("#"+o).val(i.replace(/[^\*]/,"."))}),t("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""))},validateotpgeneration:function(e){var o=this,i=function(i){hideSpinner(),"Y"==e&&(t("#OTPcontainer1").slideDown("slow"),p.set(1),p.animate(0,function(){t("#OTPcontainer1").slideUp("slow")})),t("#verify").modal("show"),setTimeout(function(){t("#otp1").focus()},500),t("#otpNullError").html(""),t("#otpNullErrorDiv").hide(),t(".inputs").on("input",function(e){e.stopImmediatePropagation();var o=e.currentTarget.id,i=t("#"+o).val();t("#"+o).attr("data",i),t("#"+o).val(i.replace(/[^\*]/,"."))}),t("#otpHelpText").html(""),t("#challengeText").html(""),"SMS"==l.get("AlertType")?(t("#myModalLabel").html(t.i18n.t("app.registration.otpothersheadertext")),t("#otpHelpText").html("Please enter the OTP from your registered mobile number "+maskMobile(l.get("contactNumber")))):"EMAIL"==l.get("AlertType")?(t("#myModalLabel").html(t.i18n.t("app.registration.otpothersheadertext")),t("#otpHelpText").html("Please enter the OTP from your registered email ID"+maskMobile(l.get("emailId")))):"TOKEN"==l.get("AlertType")?(t("#myModalLabel").html(t.i18n.t("app.registration.otptokenheadertext")),t("#otpHelpText").html(t.i18n.t("app.registration.opthelptokentext"))):"ESIGN"==l.get("AlertType")&&(t("#myModalLabel").html(t.i18n.t("app.registration.otpothersheadertext")),t("#otpHelpText").html("Please enter the ESIGN Validation"),t("#challengeText").html(t.i18n.t("app.transferss.genratedTocn")+""+l.get("otpCode"))),t("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""),"SMS"==l.get("AlertType")||"EMAIL"==l.get("AlertType")?o.appendOTPContainer():t("#otpContainerDiv").html(""),("SMS"==l.get("AlertType")||"EMAIL"==l.get("AlertType"))&&(p=null,t("#otpNullError").html(""),o.invokeOTPSpinner())},r=function(t){o.errorresponse()};showSpinner(),o.collection=new n;getDeviceId(),(new Date).getTime();o.collection.fetch({data:t.param({access_token:l.get("access_token"),transactionType:"IDTP_REG",resendflag:e,authMode:l.get("AlertType")}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?i(t):r(t)},error:r})},appendOTPContainer:function(){t("#otpContainerDiv").html("");var e="";e+="<div class='form-group'><div id='OTPcontainer1'></div><p class='text-center small'><a href='javascript:void(0);'class='resend_button' id='resend_btn6'>Resend OTP</a></p></div>",t("#otpContainerDiv").append(e)},invokeOTPSpinner:function(){var e=this;return t("#resend_btn6").hide(),e.appendOTPContainer(),t("#OTPcontainer1").show(),t("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""),null!=p?(p.set(1),void p.animate(0,function(){t("#OTPcontainer1").slideUp("slow")})):(p=new ProgressBar.Circle(OTPcontainer1,{color:"#333",strokeWidth:8,trailWidth:8,easing:"linear",duration:6e4*parseInt(l.get("otpExpiryPeriod")),text:{autoStyleContainer:!1},from:{color:"#ec5f59",width:8},to:{color:"#ec5f59",width:8},step:function(e,o){o.path.setAttribute("stroke",e.color),o.path.setAttribute("stroke-width",e.width);var i=Math.round(o.value()*(60*l.get("otpExpiryPeriod")));"0"==i?(o.setText(""),t("#resend_btn6").show()):(t("#resend_btn6").hide(),o.setText(i+"s"))}}),p.text.style.fontFamily='"Raleway", Helvetica, sans-serif',p.text.style.fontSize="12px",p.text.style.fontWeight="bold",p.set(1),p.animate(0,function(){t("#OTPcontainer1").slideUp("slow")}),void t("#resend_btn6").click(function(){e.validateotpgeneration("Y")}))},revokeOTPSpinner:function(){null!=p&&p.stop()},gotoForgotPINSuccessPage:function(e){e.stopImmediatePropagation(),t("#otpNullError").html(""),t("#otpNullErrorDiv").hide();var i=this,n=t("#otp1").attr("data"),a=t("#otp2").attr("data"),s=t("#otp3").attr("data"),p=t("#otp4").attr("data"),c=t("#otp5").attr("data"),d=t("#otp6").attr("data"),u=n+""+a+s+p+c+d;if(isNull(n)||isNull(a)||isNull(s)||isNull(p)||isNull(c)||isNull(d))return t("#otpNullErrorDiv").show(),void t("#otpNullError").html(t.i18n.t("validation.newregistration.otpnotnull"));var h=function(e){i.revokeOTPSpinner(),t("#verify").modal("hide"),hideSpinner(),o.history.navigate("#/binimoyforgotpinsuccess")},m=function(e){hideSpinner(),i.revokeOTPSpinner(),isNull(l.get("errordesc"))||(t("#otpNullErrorDiv").show(),t("#otpNullError").html(l.get("errordesc")))};showSpinner(),i.collection=new r;getDeviceId(),(new Date).getTime();i.collection.fetch({data:t.param({access_token:l.get("access_token"),transactionType:"IDTP_REG",activationno:u,uniqueId:l.get("otpCode"),twoFAType:l.get("AlertType")}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?h(t):m(t)},error:m})},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(t){return o.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=t,this.currentView.delegateEvents(),this.currentView}});return c});