define(["jquery","underscore","Backbone","collections/transfer/getAccountBalanceCollections","collections/transfer/getTransactionLimitCollections","collections/transfer/getAuthModeCollections","text!views/transfer/bkashAddMoney/bkashAddMoneyInit.tpl","collections/transfer/bKashValidationCollections"],function(a,t,e,n,r,s,o,c){var i=new EncryptedLocalStorage("secret"),l=!1,u=e.View.extend({el:"#container",events:{"click .acccardnum_bkash":"bkashSelectedFromAcc","click #bkashFromAcc":"bkashFromAccDropdown","click #bKashInitProceedBtn":"gotobkashVerifyPage","click #bkashInitCancelBtn":"toTransferSelectPage","keyup #bkashAmount":"validatebkashAmount","click #bKashPullMoneyTandCPopup":"OpenTermsAndConditions","click #bKashViewHistory":"gotobKashViewHistory"},initialize:function(){},update:function(){var a=this;a.getbkashTransactionLimit()},getbkashTransactionLimit:function(){var t=this,n=function(a){hideSpinner(),i.set("downtimeTransType","bKashPullMoney"),i.set("isDowntimeTransfer","N");var n=i.get("bKashPullMoneydowntimeNotification");if(!isNull(n)&&n.length>0){var r=n[0].subTransactionType;i.set("subTransType",r),("BOTH"==r||"ONE-OFF"==r||"REGISTERED"==r)&&(hideSpinner(),e.history.navigate("#/downtimeboth"))}else hideSpinner(),t.loadTemplate()},s=function(a){t.errorresponse()};showSpinner(),t.collection=new r,t.collection.fetch({data:a.param({access_token:i.get("access_token"),payeeType:"WALLET_BKASH_PULL_MONEY"}),dataType:"json",type:"POST",cache:!1,success:function(a){"0000"==ackStatus?n(a):s(a)},error:s})},loadTemplate:function(){this.$el.html(t.template(o)),"false"==i.get("isFromViewHistoryPage")&&(i.set("bkashFromAccId",""),i.set("bkashFromAccInd",""),i.set("bkashFromAccType",""),i.set("bkashFromAccNum",""),i.set("bkashFromAccCur",""),i.set("bkashTransferAmount",""),i.set("bkashTransferRemarks","")),a("html").removeClass().addClass("app"),a("#availBalDiv").hide();var e=this;if(!isNull(i.get("bkashFromAccId"))){var n=i.get("bkashFromAccId");i.set("bkashFromAccId",n);var r="CASA";i.set("bkashFromAccType",r);var s=i.get("bkashFromAccNum");i.set("bkashFromAccNum",s);var c='<div class="qr_acc_outer">\n <ul class="list-unstyled m0">\n <li class="list-group-item">\n <div class="col-xs-2 first-col">\n<span class="menu_icon account"></span>\n</div>\n <div class="col-xs-10">\n<p class="acc_txt"> '+i.get("bkashFromAccName")+'</p>\n<p class="acc_cat"> <span class="selectAccNumber"> '+i.get("bkashFromAccNum")+" </span></p>\n</div>\n </li>\n </ul>\n </div>";a("#bkashseltpayval").html(c),a('li.acccardnum_bkash[accide="'+n+'"]').find("input").attr("checked","checked"),e.getFromAccountBalacne()}if(!isNull(i.get("bkashTransferAmount"))){var l=i.get("bkashTransferAmount");a("#bkashAmount").val(l)}isNull(i.get("bkashTransferRemarks"))||a("#bkashRemarks").val(i.get("bkashTransferRemarks"))},getbKashPullMoneyAuthMode:function(){var t=this;i.set("IsAuthMode","false"),a("#bkash_authmodeDiv").html(""),i.set("transferType","bKashPullMoney");var e=a("#bkashAmount").val().replace(/,/g,""),n=function(a){hideSpinner();var e=i.get("securitySettingList");!isNull(e)&&e.length>0?i.set("IsAuthMode","true"):(i.set("alertType",null),i.set("IsAuthMode","false")),t.populateAuthMode()},r=function(e){hideSpinner(),i.set("IsAuthMode","false"),a("#bkashAmount").val(""),t.populateAuthMode()};showSpinner(),t.collection=new s,t.collection.fetch({data:a.param({access_token:i.get("access_token"),transactionAmount:e,tenantServiceCode:"WALLET_BKASH_PULL_MONEY"}),dataType:"json",type:"POST",cache:!1,success:function(a){"0000"==ackStatus?n(a):r(a)},error:r})},populateAuthMode:function(t){var e="",n="",r=i.get("securitySettingList"),s="<label for='username'>"+a.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";s+="<div class='custRadio_pass'>",!isNull(r)&&r.length>0?(a("#bkash_authmodeDiv").html(""),a.each(r,function(t,r){"SMS"==r?(e="sms",n=a.i18n.t("app.transfer.managebeneficiary.sms")):"EMAIL"==r?(e="mail",n=a.i18n.t("app.transfer.managebeneficiary.mail")):"TOKEN"==r?(e="fScan",n=a.i18n.t("app.transfer.managebeneficiary.token")):"ESIGN"==r&&(e="esign",n=a.i18n.t("app.transfer.managebeneficiary.esign")),s+='<div class="box"><div class="radio"><label>',s+=0==t?'<input type="radio" name="bkash_authmode" id="optionsRadios'+t+'" value="'+r+'" checked>':'<input type="radio" name="bkash_authmode" id="optionsRadios'+t+'" value="'+r+'">',s+='<div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs '+e+'"></span><span class="small">'+n+"</span></div></div></label></div></div>"}),a("#bkash_authmodeDiv").html(s)):a("#bkash_authmodeDiv").html("")},OpenTermsAndConditions:function(a){a.stopImmediatePropagation(),i.set("tandctype","bkashAccount"),openTermsAndConditionsPopup()},gotobKashViewHistory:function(t){"object"==typeof t&&(t.preventDefault(),t.stopImmediatePropagation()),a("#acntNumErr").html("");var n=i.get("bkashFromAccId");if(isNull(n))return void a("#acntNumErr").html("Please Select To Account");var r=i.get("bkashFromAccId");i.set("bkashFromAccId",r);var s=a("#bkashAmount").val();i.set("bkashTransferAmount",s);var o=a("#bkashRemarks").val();i.set("bkashTransferRemarks",o),e.history.navigate("#/bkashHistoryUI")},bkashFromAccDropdown:function(t){"object"==typeof t&&(t.preventDefault(),t.stopImmediatePropagation()),a("#card_account").modal("show")},bkashSelectedFromAcc:function(t){"object"==typeof t&&(t.preventDefault(),t.stopImmediatePropagation()),i.set("isFromDropdownSelect","true");var e=this,n=a(t.target).closest("li.acccardnum_bkash").attr("Accide");i.set("bkashFromAccId",n);var r=a(t.target).closest("li.acccardnum_bkash").attr("id");i.set("bkashFromAccInd",r);var s=a(t.target).closest("li.acccardnum_bkash").attr("acctype");i.set("bkashFromAccType",s);var o=a(t.target).closest("li.acccardnum_bkash").attr("accNum");i.set("bkashFromAccNum",o);var c=a(t.target).closest("li.acccardnum_bkash").attr("data");i.set("bkashFromAccCur",c);var l=a(t.target).closest("li.acccardnum_bkash").attr("frName");i.set("bkashFromAccName",l),e.getFromAccountBalacne(t),a('li.acccardnum_bkash[accide="'+n+'"]').find("input").attr("checked","checked");var u=a(t.target).closest("li.acccardnum_bkash").find(".row").clone().html(),m='<div class="qr_acc_outer">\n <ul class="list-unstyled m0">\n <li class="list-group-item">\n'+u+"</li>\n </ul>\n </div>";a("#bkashseltpayval").html(m),a("#card_account .close").trigger("click")},getFromAccountBalacne:function(t){"object"==typeof t&&(t.preventDefault(),t.stopImmediatePropagation()),a("#acntNumErr").html("");var e=i.get("bkashFromAccId");if(""==e)return a("#availbal").html(""),void a("#availBalDiv").hide();var r=this,s=function(t){hideSpinner(),a("#availBalDiv").hide(),a("#availbal").html("");var e,n,r=i.get("availableBalance"),s=parseFloat(r.slice(0,-2)),o=null==i.get("accountCurrency")||""==i.get("accountCurrency")?"":i.get("accountCurrency"),c=i.get("bkashFromAccType");i.set("bkashFromAccType",c),"CASA"==c&&(e=checkAmount(a.formatNumber(s,{format:"#,###.00",locale:"us"})),n=e+" "+o,i.set("bkashFromAcntAvailBal",s)),a("#availbal").html(n),a("#availBalDiv").show(),a("#acntNumErr").html("")},o=function(t){r.errorresponse(),a("#card_account .close").trigger("click")};showSpinner(),r.collection=new n,r.collection.fetch({data:a.param({access_token:i.get("access_token"),accountId:e,accountType:i.get("bkashFromAccType"),beneficiaryInstructionId:null}),dataType:"json",type:"POST",cache:!1,success:function(a){"0000"==ackStatus?s(a):o(a)},error:o})},validatebkashAmount:function(t){t.stopImmediatePropagation(),a("#acntNumErr").html(""),a("#amountNullErr").html("");var e=i.get("bkashFromAccId"),n=a("#bkashAmount").val().replace(/,/g,"");if(!isNull(n)){if(isNull(e))return void a("#acntNumErr").html("Please Select To Account");if(!isNull(n)){var r=parseFloat(i.get("minAmountPerTransaction")),s=parseFloat(i.get("maxAmountPerTransaction")),o=parseFloat(i.get("dailyAvailableLimit")),c=i.get("dailyAvailableCount"),l=i.get("monthlyAvailableCount");if(r>n)return void a("#amountNullErr").html(a.i18n.t("validation.sadad.amtgreaterthanminamt"));if(n>s)return void a("#amountNullErr").html("Amount must be less than or equal to maximum amount per transaction");if(n>o)return void a("#amountNullErr").html(a.i18n.t("validation.transfer.notra"));if("0"==c)return void a("#amountNullErr").html("You have exceeded your daily transaction count.");if("0"==l)return void a("#amountNullErr").html("Transaction count exceeded Monthly Available Count.")}}},gotobkashVerifyPage:function(t){t.stopImmediatePropagation(),a("#amountNullErr").html(""),a("#remarksNullErr").html(""),a("#acntNumErr").html(""),l=!1;var e=a("#bkashAmount").val().replace(/,/g,""),n=a("#bkashRemarks").val();if(isNull(i.get("bkashFromAccId"))&&(l=!0,a("#acntNumErr").html("Please Select To Account")),isNull(e)&&(l=!0,a("#amountNullErr").html("Please enter amount")),!isNull(e)){var r=parseFloat(i.get("minAmountPerTransaction")),s=parseFloat(i.get("maxAmountPerTransaction")),o=parseFloat(i.get("dailyAvailableLimit")),c=i.get("dailyAvailableCount"),u=i.get("monthlyAvailableCount");if(r>e)return void a("#amountNullErr").html(a.i18n.t("validation.sadad.amtgreaterthanminamt"));if(e>s)return void a("#amountNullErr").html("Amount must be less than or equal to maximum amount per transaction");if(e>o)return void a("#amountNullErr").html(a.i18n.t("validation.transfer.notra"));if("0"==c)return void a("#amountNullErr").html("You have exceeded your daily transaction count.");if("0"==u)return void a("#amountNullErr").html("Transaction count exceeded Monthly Available Count.")}if(!isNull(n)){var m=n.charAt(0),h=n.charAt(n.length-1);n.length>16&&(l=!0,a("#remarksNullErr").html("The Remarks should contain maximum of 16 characters")),m.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i)||(l=!0,a("#remarksNullErr").html(a.i18n.t("validation.newregistration.firstspaceind"))),h.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i)||(l=!0,a("#remarksNullErr").html(a.i18n.t("validation.newregistration.lastspaceind")))}var d=a("#termsand").prop("checked");if(a("#tandcErr").html(""),d||(a("#tandcErr").html("Please check the Terms and Conditions"),l=!0),!l){var p=a("input[name='bkash_authmode']:checked").val();i.set("bkashTransferAmount",e),i.set("bkashTransferRemarks",n),i.set("bkashAuthMode",p);var b=this;b.validateBkashPayment(t)}},validateBkashPayment:function(t){var n=this;showSpinner();var n=this,r=function(a){hideSpinner(),e.history.navigate("#/bkashMoneyVerify")},s=function(a){hideSpinner(),n.errorresponse()};showSpinner(),n.collection=new c,n.collection.fetch({data:a.param({access_token:i.get("access_token"),creditAccountNumber:i.get("bkashFromAccNum"),principalAmount:i.get("bkashTransferAmount")}),dataType:"json",type:"POST",cache:!1,success:function(a){"0000"==ackStatus?r(a):s(a)},error:s})},toTransferSelectPage:function(a){a.stopImmediatePropagation(),e.history.navigate("#/transfer")},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(a){return e.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},UI,void 0!==this.currentView&&this.currentView.close(),this.currentView=a,this.currentView.delegateEvents(),this.currentView}});return u});