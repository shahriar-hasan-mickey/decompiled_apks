define(["jquery","underscore","Backbone","collections/transfer/validateVIDCollections","collections/transfer/getAuthModeCollections","collections/transfer/getExpiryDateCollections","collections/transfer/getAmountInWordsCollections","collections/transfer/getIDTPLimitCollections","text!views/transfer/binimoyRTPCreateNewRequest.tpl"],function(e,t,r,a,n,i,o,s,l){var c=new EncryptedLocalStorage("secret"),u=!1,p=r.View.extend({el:"#container",events:{"click #rtp_SendNewReqCancelBtn":"gotoPreviousPage","click #rtp_SendNewReqProceedBtn":"gotoVerifyPage","blur #rtp_requestToVID":"validateRTPToVID","blur .rtpCreateClass":"getRTPCreateExpiryTime","keyup #rtp_requestAmount":"validateRTPReqAmount","click #binimoyRTPCreateTAndCPopup":"openBinimoyRTPcreateTandCPopup","click #gotoSentRTPList":"gotoSentRTPList"},initialize:function(){},update:function(){var t=this,r=function(e){hideSpinner(),t.getAuthMode()},a=function(e){t.errorresponse()};showSpinner(),t.collection=new s,t.collection.fetch({data:e.param({access_token:c.get("access_token")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?r(e):a(e)},error:a})},getAuthMode:function(){var t=this;c.set("IsAuthMode","false"),e("#rtpSendReqAuthModeDIV").html("");var r=function(e){hideSpinner();var r=c.get("securitySettingList");!isNull(r)&&r.length>0?c.set("IsAuthMode","true"):(c.set("AlertType",null),c.set("IsAuthMode","false")),t.loadRTPCreateNewReqTemplate()},a=function(e){c.set("IsAuthMode","false"),t.loadRTPCreateNewReqTemplate()};showSpinner(),t.collection=new n,t.collection.fetch({data:e.param({access_token:c.get("access_token"),transactionAmount:null,tenantServiceCode:"IDTP_REG"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?r(e):a(e)},error:a})},loadRTPCreateNewReqTemplate:function(){this.$el.html(t.template(l)),e("html").removeClass().addClass("app"),c.set("isRTPRequestValidVID","false"),c.set("isExpiryShow","false"),e("#rtpCreateExpiryTimeDiv").hide();var r=this;r.populateAuthMode()},populateAuthMode:function(t){"object"==typeof t&&t.stopImmediatePropagation();var r="",a="",n=c.get("securitySettingList"),i="<label for='username'>"+e.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";i+="<div class='custRadio_pass'>",!isNull(n)&&n.length>0?(e("#rtpSendReqAuthModeDIV").html(""),e.each(n,function(t,n){"SMS"==n?(r="sms",a=e.i18n.t("app.transfer.managebeneficiary.sms")):"EMAIL"==n?(r="mail",a=e.i18n.t("app.transfer.managebeneficiary.mail")):"TOKEN"==n?(r="fScan",a=e.i18n.t("app.transfer.managebeneficiary.token")):"ESIGN"==n&&(r="esign",a=e.i18n.t("app.transfer.managebeneficiary.esign")),i+='<div class="box"><div class="radio"><label>',i+=0==t?'<input type="radio" name="rtp_SendReqAuthMode" id="optionsRadios'+t+'" value="'+n+'" checked>':'<input type="radio" name="rtp_SendReqAuthMode" id="optionsRadios'+t+'" value="'+n+'">',i+='<div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs '+r+'"></span><span class="small">'+a+"</span></div></div></label></div></div>"}),e("#rtpSendReqAuthModeDIV").html(i)):e("#rtpSendReqAuthModeDIV").html("")},gotoPreviousPage:function(e){e.stopImmediatePropagation(),r.history.navigate("#/binimoyrtpsentlist")},gotoVerifyPage:function(t){t.stopImmediatePropagation(),e("#reqToVIDNullErr").html(""),e("#rtpReqAmtErr").html(""),e("#rtpSendReqRemarksNullErr").html(""),e("#rtpSendReqReefIDNullErr").html(""),e("#binimoyRTPCreateTandCErr").html(""),u=!1;var r=e("#rtp_requestToVID").val(),a=c.get("registerdDevice"),n=(e("#rtp_requestAmount").val(),e("#rtp_requestAmount").val().replace(/,/g,"")),i=e("#retp_sendReqRemarks").val(),o=e("#rtp_sendReqRefID").val(),s=e("input[name='rtp_SendReqAuthMode']:checked").val(),l=e("#binimoyRTPCreateTandC").prop("checked");if(isNull(r)&&(u=!0,e("#reqToVIDNullErr").html("Please enter a Request To VID")),isNull(r)||(r.length>24&&(u=!0,e("#reqToVIDNullErr").html("The Request To VID should contain maximum of 24 characters")),"false"==c.get("isRTPRequestValidVID")&&(u=!0,e("#reqToVIDNullErr").html("Please enter a valid Request To VID")),r==a&&(u=!0,e("#reqToVIDNullErr").html("The Sender VID and the Receiver VID cannot be the same"))),isNull(n)&&(u=!0,e("#rtpReqAmtErr").html("Please enter a Requested Amount")),!isNull(n)){var p=parseFloat(c.get("idtpMin")),d=parseFloat(c.get("idtpMax"));if(p>n)return void e("#rtpReqAmtErr").html(e.i18n.t("validation.sadad.amtgreaterthanminamt"));if(n>d)return void e("#rtpReqAmtErr").html(e.i18n.t("validation.sadad.amtlessthanmaxamt"))}if(isNull(i)&&(u=!0,e("#rtpSendReqRemarksNullErr").html("Please enter the remarks")),!isNull(i)){var m=i.charAt(0),h=i.charAt(i.length-1);if(i.length>24&&(u=!0,e("#rtpSendReqRemarksNullErr").html("The Remarks should contain maximum of 24 characters")),!m.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return e("#rtpSendReqRemarksNullErr").html(e.i18n.t("validation.newregistration.firstspaceind")),!1;if(!h.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return e("#rtpSendReqRemarksNullErr").html(e.i18n.t("validation.newregistration.lastspaceind")),!1}if(isNull(o)||o.length>24&&(u=!0,e("#rtpSendReqReefIDNullErr").html("The Reference ID should contain maximum of 24 characters")),l||(u=!0,e("#binimoyRTPCreateTandCErr").html("Please check the Terms and Conditions")),!u){c.set("rtpSendReqToVID",r),c.set("rtpSendReqAmount",n),c.set("retpSendReqRemarks",i),c.set("rtpSendReqRefID",o),c.set("rtpSendReqAuthMode",s);var f=this;f.getAmountInWords(t)}},getAmountInWords:function(t){t.stopImmediatePropagation();var a=this;showSpinner();var a=this,n=function(e){hideSpinner(),r.history.navigate("#/binimoyrtpsendreqverify")},i=function(e){hideSpinner(),a.errorresponse()};showSpinner(),a.collection=new o,a.collection.fetch({data:e.param({access_token:c.get("access_token"),amount:c.get("rtpSendReqAmount")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?n(e):i(e)},error:i})},validateRTPToVID:function(t){"object"==typeof t&&t.stopImmediatePropagation(),e("#reqToVIDNullErr").html("");var r=e("#rtp_requestToVID").val(),n=c.get("registerdDevice");if(isNull(r))return void e("#reqToVIDNullErr").html("Please enter a Request To VID");if(!isNull(r)){var i=r.charAt(0),o=r.charAt(r.length-1);if(r==n)return void e("#reqToVIDNullErr").html("The Sender VID and the Receiver VID cannot be the same");if(!i.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return void e("#reqToVIDNullErr").html(e.i18n.t("validation.newregistration.firstspaceind"));if(!o.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return void e("#reqToVIDNullErr").html(e.i18n.t("validation.newregistration.lastspaceind"))}showSpinner();var s=this,l=function(r){hideSpinner(),e("#vidName").html(c.get("virtualIdName")),c.set("isRTPRequestValidVID","true"),s.getRTPCreateExpiryTime(t)},u=function(t){hideSpinner(),e("#vidName").html(""),c.set("isRTPRequestValidVID","false"),s.errorresponse()};showSpinner(),s.collection=new a,s.collection.fetch({data:e.param({access_token:c.get("access_token"),virtual_id:r,service_flag:"DP"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?l(e):u(e)},error:u})},getRTPCreateExpiryTime:function(t){t.stopImmediatePropagation();var r=e("#rtp_requestToVID").val(),a=e("#rtp_requestAmount").val().replace(/,/g,""),n=e("#retp_sendReqRemarks").val();if(!(isNull(r)||isNull(a)||isNull(n))&&"true"!=c.get("isExpiryShow")){showSpinner();var o=this,s=function(t){hideSpinner(),c.set("isExpiryShow","true"),e("#rtpCreateExpiryTimeDiv").show(),e("#rtpcreateExpTime").html(c.get("rtpExpiryDate"))},l=function(t){hideSpinner(),c.set("isExpiryShow","false"),e("#rtpCreateExpiryTimeDiv").hide(),e("#rtpcreateExpTime").html(""),o.errorresponse()};showSpinner(),o.collection=new i,o.collection.fetch({data:e.param({access_token:c.get("access_token")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?s(e):l(e)},error:l})}},openBinimoyRTPcreateTandCPopup:function(e){e.stopImmediatePropagation(),c.set("tandctype","binimoyRTP"),openTermsAndConditionsPopup()},gotoSentRTPList:function(e){e.stopImmediatePropagation(),r.history.navigate("#/binimoyrtpsentlist")},validateRTPReqAmount:function(t){t.stopImmediatePropagation(),e("#rtpReqAmtErr").html("");var r=e("#rtp_requestAmount").val().replace(/,/g,""),a=parseFloat(c.get("minAmountPerTransaction")),n=parseFloat(c.get("maxAmountPerTransaction")),i=parseFloat(c.get("dailyAvailableLimit")),o=c.get("dailyAvailableCount"),s=c.get("monthlyAvailableCount");if(!isNull(r)&&!isNull(r)){if(a>r)return void e("#rtpReqAmtErr").html(e.i18n.t("validation.sadad.amtgreaterthanminamt"));if(r>n)return void e("#rtpReqAmtErr").html(e.i18n.t("validation.sadad.amtlessthanmaxamt"));if(r>i)return void e("#rtpReqAmtErr").html(e.i18n.t("validation.transfer.notra"));if("0"==o)return void e("#rtpReqAmtErr").html("You have exceeded your daily transaction count.");if("0"==s)return void e("#rtpReqAmtErr").html("Transaction count exceeded Monthly Available Count.")}},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(e){return r.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return p});