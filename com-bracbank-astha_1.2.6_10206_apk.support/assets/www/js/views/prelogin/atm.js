define(["jquery","underscore","Backbone","jqmapservice","text!views/prelogin/atm.tpl"],function(e,t,a,i,o){var n=a.View.extend({events:{pageinit:"mapfunc","click #backtoLogin":"backtoLogin"},initialize:function(){},render:function(){return this.$el.html(t.template(o)),this},mapfunc:function(){function t(t){onGeoLocationError(t),e("#spinner").hide()}function a(t){hideSpinner();var a=t.coords;e("#directions").empty(),gURL="https://maps.googleapis.com/maps/api/place/search/json?types=atm&radius=2000&location="+a.latitude+","+a.longitude+"&sensor=true&name=HDFC&key=AIzaSyAZAniWiChy6FAjTGNpXhTL2y-AY0bwGZo",e.getJSON(gURL,{format:"json"},function(t){""!=t.results?(e("#atmresult ul li").remove(),e.each(t.results,function(i){function o(t,a){if(a!=google.maps.DistanceMatrixStatus.OK)alert("Error was: "+a);else{var i=t.rows[0].elements,o=i[0].distance.text,l='<li><a href="http://maps.google.com/?q='+n.geometry.location.lat+","+n.geometry.location.lng+'" data-lat="'+n.geometry.location.lat+'" data-lng="'+n.geometry.location.lng+'"><p><b>'+n.name+"</b></p><p>"+n.vicinity+'</p><p class="ui-li-aside">'+o+"</p></a></li>";e("#atmresult ul").append(l).listview("refresh")}}var n=t.results[i],l=new google.maps.LatLng(a.latitude,a.longitude),r=new google.maps.LatLng(n.geometry.location.lat,n.geometry.location.lng),s=new google.maps.DistanceMatrixService;s.getDistanceMatrix({origins:[l],destinations:[r],travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.METRIC,avoidHighways:!1,avoidTolls:!1},o)})):e("#atmresult").remove();var i=new google.maps.LatLng(a.latitude,a.longitude);cachedData=t;var o="css/images/pin_green.png";try{e("#map_canvas").gmap({center:i,zoom:12,callback:function(t){var a=this;a.refresh(),e(cachedData.results).each(function(e,t){a.addMarker({position:new google.maps.LatLng(t.geometry.location.lat,t.geometry.location.lng),bounds:!0,icon:o}).click(function(e,i){a.openInfoWindow({content:t.name},this)})}),e("#atmresult ul li a.ui-link-inherit").live("tap",function(t){return t.preventDefault(),e("#mappanel").popup("open",{transition:"slide"}),e("#directions").empty(),a.refresh(),a.clear("markers"),a.displayDirections({origin:i,destination:new google.maps.LatLng(e(this).data("lat"),e(this).data("lng")),travelMode:google.maps.DirectionsTravelMode.DRIVING},{panel:document.getElementById("directions")},function(t,a){"OK"===a?e("#directions").show():e("#directions").hide(),e("[data-iscroll]").iscrollview(),e("[data-iscroll]").iscrollview("refresh"),e("#mappanel").iscrollview(),e("#mappanel").iscrollview("refresh")}),!1})}})}catch(n){}}).success(function(){e("#spinner").hide(),e("#atmresult ul").listview("refresh"),e("[data-iscroll]").iscrollview(),e("[data-iscroll]").iscrollview("refresh")})}navigator.geolocation?(showSpinner(),navigator.geolocation.getCurrentPosition(a,t,{enableHighAccuracy:!0,timeout:1e4,maximumAge:1e4})):alert("Please Enable your GPS and try again"),e("#viewmap").on("tap",function(t){t.preventDefault();var a=(e("#mappanel-popup"),e(this).attr("href"));e(a).popup("open",{transition:"slide"})}),e("#mappanel").on({popupbeforeposition:function(){var t=e(window).height();e("#mappanel").css({height:t+"px",overflowX:"auto","-webkit-overflow-scrolling":"touch"})},popupafteropen:function(){var t=e(window).height();e("#mappanel-popup").animate({top:"0px"},50,function(){e("#mappanel-popup").hasClass("ui-popup-active")&&e(".ui-page").css({height:t-80+"px","overflow-y":"hidden"}),e("#mappanel-popup").hasClass(".ui-selectmenu-hidden")&&e(".ui-page").css({height:"auto","overflow-y":"visible"})})},popupafterclose:function(){e(".ui-page").css({height:"auto","overflow-y":"visible"})}})},backtoLogin:function(t){t.preventDefault(),e.mobile.jqmNavigator.popView()}});return n});