define(["jquery","underscore","Backbone","collections/bills/cardSummaryCollections","collections/transfer/getAccountBalanceCollections","collections/bills/getBillAmountCollections","collections/transfer/getTransactionLimitCollections","collections/bills/billPaymentCollections","collections/transfer/getAuthModeCollections","models/validation/billsandFees/billsAndFeesValidationModel","text!views/billsAndFees/billPayToBillerInit.tpl"],function(e,t,l,i,a,r,o,n,s,c,m){var u=new EncryptedLocalStorage("secret"),d=l.View.extend({el:"#container",events:{"change #toBillerFromAccount":"getToBillerFromAccountBalance","click #billPayInitConfirmBtn":"gotoToBillerVerifyPage","click #billPayInitBackBtn":"backToListUI","click #billpaytobiller_historypage":"loadtranshistoryUi","click #billPayToBillerTandCPopup":"billPayToBillerOpenTandCPopup","change #toBillerBillerType":"getBillerTypeList","blur #toBillerBillNumber":"getBillAmount"},initialize:function(){},render:function(){var t=this;if("false"==u.get("isCreditPrepaidCardData")){var l=function(e){hideSpinner(),u.set("isCreditPrepaidCardData","true"),t.transactionlimit()},a=function(e){t.errorresponse()};showSpinner(),t.collection=new i([],{});getDeviceId();t.collection.fetch({data:e.param({newversion:"Y",access_token:u.get("access_token")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?l(e):a(e)},error:a})}else hideSpinner(),t.transactionlimit()},transactionlimit:function(){var t=this,l="";"Teletalk"==u.get("selectedBillerListName")?(l="TT",u.set("tenantServiceCode","MB"),u.set("billPayToBeneTransferType","MOBILE_BILLER")):"Grameenphone"==u.get("selectedBillerListName")?(l="GP",u.set("tenantServiceCode","MB"),u.set("billPayToBeneTransferType","MOBILE_BILLER")):"Robi"==u.get("selectedBillerListName")?(l="RI",u.set("tenantServiceCode","MB"),u.set("billPayToBeneTransferType","MOBILE_BILLER")):"Banglalink"==u.get("selectedBillerListName")?(l="BL",u.set("tenantServiceCode","MB"),u.set("billPayToBeneTransferType","MOBILE_BILLER")):"Airtel"==u.get("selectedBillerListName")?(l="AL",u.set("tenantServiceCode","MB"),u.set("billPayToBeneTransferType","MOBILE_BILLER")):"WASA"==u.get("selectedBillerListName")?(l="BW",u.set("tenantServiceCode","WASA"),u.set("billPayToBeneTransferType","WASA")):"Carnival"==u.get("selectedBillerListName")?(l="CL",u.set("tenantServiceCode","CL"),u.set("billPayToBeneTransferType","CARNIVAL")):"MetLife"==u.get("selectedBillerListName")?(l="ML",u.set("tenantServiceCode","ML"),u.set("billPayToBeneTransferType","METLIFE")):"Guardian Life"==u.get("selectedBillerListName")?(l="GL",u.set("tenantServiceCode","GL"),u.set("billPayToBeneTransferType","GUARDIANLIFE")):"BRAC University"==u.get("selectedBillerListName")?(l="BU",u.set("tenantServiceCode","BU"),u.set("billPayToBeneTransferType","BRAC_UNIVERSITY")):"DPDC"==u.get("selectedBillerListName")?(l="DPDC",u.set("tenantServiceCode","DPDC"),u.set("billPayToBeneTransferType","DPDC")):"DESCO"==u.get("selectedBillerListName")?(l="DESCO",u.set("tenantServiceCode","DESCO"),u.set("billPayToBeneTransferType","DESCO")):"NESCO"==u.get("selectedBillerListName")?(l="NESCO",u.set("tenantServiceCode","NESCO"),u.set("billPayToBeneTransferType","NESCO")):"Jalalabad Gas"==u.get("selectedBillerListName")?(l="JALALABAD_GAS",u.set("tenantServiceCode","JALALABAD_GAS"),u.set("billPayToBeneTransferType","JALALABAD_GAS")):"WZPDCL"==u.get("selectedBillerListName")&&(l="WZPDCL",u.set("tenantServiceCode","WZPDCL"),u.set("billPayToBeneTransferType","WZPDCL"));var i=function(l){hideSpinner(),"Mobile / Telephone"==u.get("selectedBillerTypeName")||"MetLife"==u.get("selectedBillerListName")||("DPDC"==u.get("selectedBillerListName")||"DESCO"==u.get("selectedBillerListName"))&&"PREPAID"==u.get("selectBillConnectionType")?(t.loadBillPayToBillerInitTemplate(),e("#toBillerBillAmount").blur(function(){e("#transfermountError").html(""),"DPDC"==u.get("selectedBillerListName")?t.getDPDCAuthMode():t.getAuthMode()})):"DESCO"!=u.get("selectedBillerListName")&&"NESCO"!=u.get("selectedBillerListName")&&"DPDC"!=u.get("selectedBillerListName")||"POSTPAID"!=u.get("selectBillConnectionType")?(t.loadBillPayToBillerInitTemplate(),t.getAuthMode()):t.loadBillPayToBillerInitTemplate()},a=function(e){t.errorresponse()};showSpinner(),t.collection=new o,t.collection.fetch({data:e.param({access_token:u.get("access_token"),payeeType:"BILLPAY",subtype:l}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?i(e):a(e)},error:a})},getDPDCAuthMode:function(t){"object"==typeof t&&t.stopImmediatePropagation();var i=this,a="",r=new RegExp("^[0-9.,]+$");u.set("IsAuthMode","false"),u.set("authModeFlag","false"),e("#biller_tobene_transferDiv").html(""),e("#transfermountError").html("");var o=u.get("selectBillIndex"),n=billerInstruction[o];this.model=new c({url:"json/"}),l.Validation.bind(this);var m=this.$("form").serializeObject();if(this.model.set(m,{validate:!0})?(this.model.clear(),l.Validation.unbind(this)):this.$(".has-error").fadeIn(),a="PREPAID"==u.get("selectBillConnectionType")?e("#toBillerBillAmount").val().replace(/,/g,""):u.get("transactionAmount"),u.set("transferType","billPayToBiller"),!isNull(a)||"PREPAID"!=u.get("selectBillConnectionType")){if(!r.test(a))return void e("#transfermountError").html(e.i18n.t("validation.transfer.validamount"));var d=function(t){hideSpinner();var l=u.get("securitySettingList");if(!isNull(l)&&l.length>0?u.set("IsAuthMode","true"):(u.set("alertType",null),u.set("IsAuthMode","false")),i.populateAuthMode(),"DPDC"==u.get("selectedBillerListName")&&"PREPAID"==u.get("selectBillConnectionType")){e("#toBeneDPDC").css("display","block");var a=(u.get("billBreakDown"),u.get("additionalInfo"));e("#beneCustName").html(a.CustomerName),e("#beneCustNum").html(a.CustomerNo),e("#beneMeterNum").html(a.MeterNo),e("#beneMeterType").html(a.MeterType),e("#beneTraiff").html(a.TariffProgram),e("#beneMobNum").html(a.Mobile),u.set("DPDCPostpaidBillNumber",null),u.set("DPDCPostpaidLocationCode",null),u.set("DPDCPostpaidTotalDPDCAmt",null),u.set("DPDCPostpaidVATAmt",null),u.set("DPDCPostpaidMobileNumber",null),u.set("DPDCPostpaidbillBreakdown",null),u.set("DPDCPostpaidbillAdditionalInfo",null)}},B=function(t){hideSpinner(),e("#toBillerBillAmount").val(""),e("#toBeneDPDC").css("display","none"),u.set("authModeFlag","true"),i.populateAuthMode(),i.errorresponse()};showSpinner(),i.collection=new s,i.collection.fetch({data:e.param({dpdcflag:"DPDC",transactionAmount:a,source:"",billerId:n.billerId,customerNo:n.mobileNumber,access_token:u.get("access_token"),tenantServiceCode:u.get("tenantServiceCode"),connectiontype:u.get("selectBillConnectionType")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?d(e):B(e)},error:B})}},getAuthMode:function(t){"objcet"==typeof t&&t.stopImmediatePropagation();var i=this;u.set("IsAuthMode","false"),u.set("authModeFlag","false"),e("#transfermountError").html("");var a=new RegExp("^[0-9.,]+$");e("#biller_tobene_transferDiv").html(""),this.model=new c({url:"json/"}),l.Validation.bind(this);var r=this.$("form").serializeObject();this.model.set(r,{validate:!0})?(this.model.clear(),l.Validation.unbind(this)):this.$(".has-error").fadeIn();var o="";if("Mobile / Telephone"==u.get("selectedBillerTypeName")||"MetLife"==u.get("selectedBillerListName")||"PREPAID"==u.get("selectBillConnectionType")?o=e("#toBillerBillAmount").val().replace(/,/g,""):"WASA"==u.get("selectedBillerListName")||"Jalalabad Gas"==u.get("selectedBillerListName")||"WZPDCL"==u.get("selectedBillerListName")||"Guardian Life"==u.get("selectedBillerListName")||"BRAC University"==u.get("selectedBillerListName")||"DPDC"==u.get("selectedBillerListName")&&"POSTPAID"==u.get("selectBillConnectionType")||"DESCO"==u.get("selectedBillerListName")&&"POSTPAID"==u.get("selectBillConnectionType")||"NESCO"==u.get("selectedBillerListName")&&"POSTPAID"==u.get("selectBillConnectionType")?(o=u.get("transactionAmount"),-1!=o.indexOf(",")&&(o=o.replace(/,/g,""))):u.set("getBillAmt",null),u.set("transferType","billPayToBiller"),!isNull(o)){if(!a.test(o))return void e("#transfermountError").html(e.i18n.t("validation.transfer.validamount"));var n=parseFloat(o),m=parseFloat(u.get("minAmountPerTransaction")),d=parseFloat(u.get("maxAmountPerTransaction"));if(m>n)return void e("#transfermountError").html(e.i18n.t("validation.sadad.amtgreaterthanminamt"));if(n>d)return void e("#transfermountError").html(e.i18n.t("validation.sadad.amtlessthanmaxamt"));var B=function(l){hideSpinner();var a=u.get("securitySettingList");if(!isNull(a)&&a.length>0?u.set("IsAuthMode","true"):(u.set("alertType",null),u.set("IsAuthMode","false")),i.populateAuthMode(),"DESCO"==u.get("selectedBillerListName")&&"PREPAID"==u.get("selectBillConnectionType")){var r=e("#toBillerBillAmount").val().replace(/,/g,"");u.set("getBillAmt",r),i.getBillAmount(t)}else u.set("getBillAmt",null)},p=function(e){hideSpinner(),u.set("authModeFlag","true"),i.populateAuthMode(),i.errorresponse()};showSpinner(),i.collection=new s,i.collection.fetch({data:e.param({access_token:u.get("access_token"),transactionAmount:o,tenantServiceCode:u.get("tenantServiceCode")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?B(e):p(e)},error:p})}},populateAuthMode:function(){var t="",l="",i=this,a=u.get("securitySettingList");"Mobile / Telephone"==u.get("selectedBillerTypeName")||"MetLife"==u.get("selectedBillerListName")||"PREPAID"==u.get("selectBillConnectionType")||("DESCO"==u.get("selectedBillerListName")||"NESCO"==u.get("selectedBillerListName")||"DPDC"==u.get("selectedBillerListName"))&&"POSTPAID"==u.get("selectBillConnectionType")||i.loadBillPayToBillerInitTemplate();var r="<label for='username'>"+e.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";r+="<div class='custRadio_pass'>",!isNull(a)&&a.length>0?(e("#biller_tobene_transferDiv").html(""),e.each(a,function(i,a){"SMS"==a?(t="sms",l=e.i18n.t("app.transfer.managebeneficiary.sms")):"EMAIL"==a?(t="mail",l=e.i18n.t("app.transfer.managebeneficiary.mail")):"TOKEN"==a?(t="fScan",l=e.i18n.t("app.transfer.managebeneficiary.token")):"ESIGN"==a&&(t="esign",l=e.i18n.t("app.transfer.managebeneficiary.esign")),r+='<div class="box"><div class="radio"><label>',r+=0==i?'<input type="radio" name="biller_tobene_transfer" id="optionsRadios'+i+'" value="'+a+'" checked>':'<input type="radio" name="biller_tobene_transfer" id="optionsRadios'+i+'" value="'+a+'">',r+='<div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs '+t+'"></span><span class="small">'+l+"</span></div></div></label></div></div>"}),e("#biller_tobene_transferDiv").html(r)):e("#biller_tobene_transferDiv").html("")},loadBillPayToBillerInitTemplate:function(){if(u.set("toBillerIsValid","true"),this.$el.html(t.template(m)),u.set("toBillerBillMonth",null),e("#billPayToBillerShortNotesUIDiv").hide(),"Mobile / Telephone"==u.get("selectedBillerTypeName")){var l=e.parseJSON(window.localStorage.getItem("shortNotesObj"));isNull(l.MOBILEBENE)||(e("#billPayToBillerShortNotesUIDiv").show(),e("#billPayToBillerShortNotesDiv").html(l.MOBILEBENE))}e("#toBillerBillAmount").val(""),e("#availBalDiv").hide(),e("#beneWZPDCLAddress,#beneWZPDCLBillNumber,#beneWZPDCLLocationCode,#beneWZPDCLBillDueDate,#beneWZPDCLVat,#beneWZPDCLFee,#beneWZPDCLBillAmount").html(""),e("#beneWaterBill, #beneSurcharge, #beneVAT, #sewerbill, #beneConFee, #studentID, #studentName").html(""),e("#beneJalalabadConnectionType,#beneJalalabadMobileNumber,#beneJalalabadVat,#beneJalalabadLateFee,#beneJalalabadTotalBillAmount").html(""),e("#beneCustName, #beneCustNum, #beneMeterNum, #beneMeterType, #beneTariffProg, #beneTraiff, #beneContactPerson, #beneMobNum, #beneAmtValidFlag, #beneMessage, #beneDue").html(""),e("#benePostCustName, #benePostConnType, #benePostLocName, #benePostBillNum, #benePostCusNum,#benePostBillDue, #benePostTotalDPDCAmt, #benePostVATAmnt, #benePostBillMonth").html(""),e("#beneDescoBillStatus, #beneDescoName, #beneDescoAccNum, #beneDescoVAT, #beneDescoDeptDetails, #beneDescoTariff, #beneDescoDueDate, #beneDescoEnergyCost, #beneDescoLPC, #beneDescoAddress").html(""),e("#beneDescoPreCusNum, #beneDescoPreCusName, #beneDescoPreMeterNum, #beneDescoPreMeterType, #beneDescoPreTariff, #beneDescoPreEnergyCost, #beneDescoPreVAT, #beneDescoPreTotalAmt, #beneDescoPreTransId").html("");var i=this;if(u.set("studentID",null),"Mobile / Telephone"==u.get("selectedBillerTypeName")||"MetLife"==u.get("selectedBillerListName")||"PREPAID"==u.get("selectBillConnectionType")?e("#toBillerBillAmount").attr("disabled",!1):"DESCO"==u.get("selectedBillerListName")&&"POSTPAID"==u.get("selectBillConnectionType")||"NESCO"==u.get("selectedBillerListName")&&"POSTPAID"==u.get("selectBillConnectionType")||"DPDC"==u.get("selectedBillerListName")&&"POSTPAID"==u.get("selectBillConnectionType")?e("#toBillerBillAmount").attr("disabled",!0):(e("#toBillerBillAmount").attr("disabled",!0),i.populateBillAmountFiled()),"WASA"==u.get("selectedBillerListName")){var a=u.get("billBreakDown");e("#beneWaterBill").html(checkAmount(e.formatNumber(a[4].value,{format:"#,###.00",locale:"us"}))+" <span class='cur'>BDT</span>"),e("#beneSurcharge").html(checkAmount(e.formatNumber(a[1].value,{format:"#,###.00",locale:"us"}))+" <span class='cur'>BDT</span>"),e("#beneVAT").html(checkAmount(e.formatNumber(a[0].value,{format:"#,###.00",locale:"us"}))+" <span class='cur'>BDT</span>"),e("#sewerbill").html(checkAmount(e.formatNumber(a[5].value,{format:"#,###.00",locale:"us"}))+" <span class='cur'>BDT</span>"),e("#beneConFee").html(checkAmount(e.formatNumber(u.get("convenienceFee"),{format:"#,###.00",locale:"us"}))+" <span class='cur'>BDT</span>")}if("Tuition Fees"==u.get("selectedBillerTypeName")){e("#tobebetuition").css("display","block");var r=u.get("additionalInfo");e("#studentID").html(r.studentId),u.set("studentID",r.studentId),e("#studentName").html(r.studentName)}if("Jalalabad Gas"==u.get("selectedBillerListName")){var a=u.get("billBreakDown"),r=u.get("additionalInfo");e("#beneJalalabadConnectionType").html("POSTPAID"),e("#beneJalalabadMobileNumber").html(r.bll_mobno),e("#beneJalalabadVat").html(checkAmount(e.formatNumber(a[1].value,{format:"#,###.00",locale:"us"}))),e("#beneJalalabadLateFee").html(checkAmount(e.formatNumber(a[2].value,{format:"#,###.00",locale:"us"}))),e("#beneJalalabadBillAmount").html(checkAmount(e.formatNumber(a[0].value,{format:"#,###.00",locale:"us"})))}if("WZPDCL"==u.get("selectedBillerListName")){var a=u.get("billBreakDown"),r=u.get("additionalInfo");e("#beneWZPDCLAddress").html(r.bll_add),e("#beneWZPDCLBillNumber").html(r.bll_no),e("#beneWZPDCLLocationCode").html(r.bll_loc_cd),e("#beneWZPDCLBillDueDate").html(r.bll_dt_due),e("#beneWZPDCLVat").html(checkAmount(e.formatNumber(a[1].value,{format:"#,###.00",locale:"us"}))),e("#beneWZPDCLFee").html(checkAmount(e.formatNumber(a[2].value,{format:"#,###.00",locale:"us"}))),e("#beneWZPDCLBillAmount").html(checkAmount(e.formatNumber(a[0].value,{format:"#,###.00",locale:"us"})))}"DPDC"==u.get("selectedBillerListName")&&"POSTPAID"==u.get("selectBillConnectionType")&&i.getBillerTypeList(),"DESCO"==u.get("selectedBillerListName")&&"POSTPAID"==u.get("selectBillConnectionType")&&e("#billNumberDiv").hide(),"NESCO"==u.get("selectedBillerListName")&&i.populateBillPeriod()},populateBillAmountFiled:function(t){"object"==typeof t&&t.stopImmediatePropagation();var l=this;e("#toBillerBillAmount").val(u.get("transactionAmount"));var i=u.get("billBreakDown"),a=u.get("additionalInfo");if("DPDC"==u.get("selectedBillerListName")&&("POSTPAID"==u.get("selectBillConnectionType")&&(e("#toBeneDPDC").css("display","block"),e("#benePostCustName").html(a.CUSTOMER_NAME),e("#benePostConnType").html("POSTPAID"),e("#benePostCusNum").html(a.CUSTOMER_NO),e("#benePostBillNum").html(a.BILL_NUMBER),e("#benePostBillDue").html(a.LAST_PAY_DATE),e.each(i,function(t,l){"total_dpdc_amount"==l.key.toLowerCase()?(e("#benePostTotalDPDCAmt").html(checkAmount(e.formatNumber(l.value,{format:"#,###.00",locale:"us"}))+" <span class='cur'>BDT</span>"),u.set("DPDCPostpaidTotalDPDCAmt",l.value)):"vat_amount"==l.key.toLowerCase()&&(e("#benePostVATAmnt").html(checkAmount(e.formatNumber(l.value,{format:"#,###.00",locale:"us"}))+" <span class='cur'>BDT</span>"),u.set("DPDCPostpaidVATAmt",l.value))}),e("#benePostBillMonth").html(a.BILL_MONTH),u.set("DPDCPostpaidCustomerNumber",a.CUSTOMER_NO),u.set("DPDCPostpaidBillNumber",a.BILL_NUMBER),u.set("DPDCPostpaidLocationCode",a.location_code),u.set("DPDCPostpaidMobileNumber",a.MOBILE_NO),u.set("DPDCPostpaidbillBreakdown",JSON.stringify(i)),u.set("DPDCPostpaidbillAdditionalInfo",JSON.stringify(a))),l.getAuthMode(t)),"DESCO"==u.get("selectedBillerListName")){if("POSTPAID"==u.get("selectBillConnectionType")){e("#toBeneDESCOPostpaid").css("display","block"),e("#beneDescoBillStatus").html(a.BILL_STATUS),e("#beneDescoName").html(a.NAME),e("#beneDescoAccNum").html(a.ACCOUNT_NO);var r=e("#toBillerBillerType option:selected").val();if("Monthly"==r){e("#descoPostpaidBillNum").html("");var o="";o+='<div class="form-group"><label>Bill Number</label><p>'+u.get("toBillerBillNumber")+"</p></div>",e("#descoPostpaidBillNum").html(o)}else"Others"==r&&e("#descoPostpaidBillNum").html("");e("#beneDescoDeptDetails").html(a.DEPT_ID),e("#beneDescoTariff").html(a.TARIFF),e("#beneDescoDueDate").html(a.DUE_DATE),e("#beneDescoAddress").html(a.STREET_ADDRESS),u.set("DESCOBillStatus",a.BILL_STATUS),u.set("DESCOBillName",a.NAME),u.set("DESCPAccNum",a.ACCOUNT_NO),u.set("DESCOBillVAT",i[0].value),u.set("DESCOEnergyCost",i[2].value),u.set("DESCOLatePayCharge",i[1].value),u.set("DESCOBillDeptDetails",a.DEPT_ID),u.set("DESCOBillTariff",a.TARIFF),u.set("DESCOBillDueDate",a.DUE_DATE),u.set("DESCOBillAddress",a.STREET_ADDRESS),u.set("DESCOBillTotalBillAmount",i[3].value),u.set("DESCOPostpaidbillBreakdown",JSON.stringify(i)),u.set("DESCOPostpaidbillAdditionalInfo",JSON.stringify(a)),l.getAuthMode(t)}else if("PREPAID"==u.get("selectBillConnectionType")){var n=u.get("getBillAmt");e("#toBeneDESCOPrepaid").css("display","block"),e("#descoPrepaidAddtionalInfoDiv").html(""),e("#beneDescoPreCusNum").html(a.accountNo),e("#beneDescoPreCusName").html(a.customerName),e("#beneDescoPreMeterNum").html(a.meterNo),e("#beneDescoPreMeterType").html(a.meterType),e("#beneDescoPreTariff").html(a.tariff),e.each(i,function(t,l){"vat"==l.key.toLowerCase()?(e("#beneDescoPreVAT").html(checkAmount(e.formatNumber(l.value,{format:"#,###.00",locale:"us"}))+" <span class='cur'>BDT</span>"),u.set("DESCOPreVAT",l.value)):"energyamount"==l.key.toLowerCase()&&(e("#beneDescoPreEnergyCost").html(checkAmount(e.formatNumber(l.value,{format:"#,###.00",locale:"us"}))+" <span class='cur'>BDT</span>"),u.set("DESCOPreEnergyCost",l.value))});var o="";e.each(i,function(e,t){if(!isNull(t.key)&&t.key.includes("charges_")){var l=t.key.replace("charges_","");o+='<div class="form-group"><label>'+l+"</label><p>"+t.value+'<span class="cur"> BDT</span></p></div>'}}),e("#descoPrepaidAddtionalInfoDiv").html(o),e("#beneDescoPreTotalAmt").html(checkAmount(e.formatNumber(n,{format:"#,###.00",locale:"us"}))+" <span class='cur'>BDT</span>"),e("#beneDescoPreTransId").html(a.transId),u.set("DESCOPreCusNumber",a.accountNo),u.set("DESCOPreCusaName",a.customerName),u.set("DESCOPreMeterNumber",a.meterNo),u.set("DESCOPreMeterType",a.meterType),u.set("DESCOPreTariff",a.tariff),u.set("DESCOPreTransId",a.transId),u.set("DESCOPreTotalAmt",n),u.set("DESCOPrepaidbillBreakdown",JSON.stringify(i)),u.set("DESCOPrepaidbillAdditionalInfo",JSON.stringify(a)),u.set("DPDCPostpaidbillBreakdown",null),u.set("DPDCPostpaidbillAdditionalInfo",null)}}else"NESCO"==u.get("selectedBillerListName")&&(u.set("IsAuthMode","false"),"POSTPAID"==u.get("selectBillConnectionType")&&(e("#toBeneNESCOPostpaid").css("display","block"),e("#beneNescoCusName").html(a.customer_name),e("#beneNescoCusNumber").html(a.account_number),e("#beneNescoBillNumber").html(a.bill_number),e("#beneNescoIssueBillDate").html(a.issue_date),e("#beneNescoBillDueDate").html(a.due_date),e("#beneNescoBillPaymentStatus").html(a.status_title),e.each(i,function(t,l){"bill_amount"==l.key.toLowerCase()?(e("#beneNescoEnergyCost").html(checkAmount(e.formatNumber(l.value,{format:"#,###.00",locale:"us"}))+" <span class='cur'>BDT</span>"),u.set("NESCOEnergyCost",l.value)):"vat_amount"==l.key.toLowerCase()?(e("#beneNescoVat").html(checkAmount(e.formatNumber(l.value,{format:"#,###.00",locale:"us"}))+" <span class='cur'>BDT</span>"),u.set("NESCOVat",l.value)):"lpc_amount"==l.key.toLowerCase()&&(isNull(l.value)||"0"==l.value?(e("#NescoLPCDiv").hide(),u.set("NESCOLatePayCharges",null)):(e("#beneNescoLatePayCharges").html(checkAmount(e.formatNumber(l.value,{format:"#,###.00",locale:"us"}))+" <span class='cur'>BDT</span>"),u.set("NESCOLatePayCharges",l.value)))}),e("#beneNescoTotalNescoAmt").html(checkAmount(e.formatNumber(u.get("transactionAmount"),{format:"#,###.00",locale:"us"}))+" <span class='cur'>BDT</span>"),u.set("NESCOCusName",a.customer_name),u.set("NESCOCusNumber",a.account_number),u.set("NESCOIssueBillDate",a.issue_date),u.set("NESCOBillDueDate",a.due_date),u.set("NESCOBillPayStatus",a.status_title),u.set("NESCOTotalNescoAmt",a.DUE_DATE),u.set("NESCOTotalBillAmt",a.accountNo),u.set("NESCOPostpaidbillBreakdown",JSON.stringify(i)),u.set("NESCOPostpaidbillAdditionalInfo",JSON.stringify(a))),l.getAuthMode(t))},getToBillerFromAccountBalance:function(t){t.stopImmediatePropagation();var l=e("#toBillerFromAccount option:selected").val();u.set("toBillerFrmAccId",l);var i=e("#toBillerFromAccount option:selected").attr("id");u.set("toBillerFrmAccInd",i);var r=e("#toBillerFromAccount option:selected").attr("acctype");u.set("toBillerFrmAccType",r);var o=e("#toBillerFromAccount option:selected").attr("data");if(u.set("toBillerFromCurrency",o),""==l)return e("#availbal").html(""),void e("#availBalDiv").hide();var n=this,s=function(t){hideSpinner();var l,i,a=u.get("availableBalance"),o=parseFloat(a.slice(0,-2)),n=null==u.get("accountCurrency")||""==u.get("accountCurrency")?"":u.get("accountCurrency");"CASA"==r?(l=checkAmount(e.formatNumber(o,{format:"#,###.00",locale:"us"})),i=l+" "+n,u.set("toBillerFromAccBal",o)):"PC"==r?(l=checkAmount(e.formatNumber(a,{format:"#,###.00",locale:"us"})),i=l+" "+n,u.set("toBillerFromAccBal",a)):"CC"==r&&(l=checkAmount(e.formatNumber(a,{format:"#,###.00",locale:"us"})),i=l+" "+n,u.set("toBillerFromAccBal",a)),e("#availbal").html(i),e("#availBalDiv").show(),e("acntNumErr").html("")},c=function(e){n.errorresponse()};showSpinner(),n.collection=new a,n.collection.fetch({data:e.param({access_token:u.get("access_token"),accountId:l,accountType:u.get("toBillerFrmAccType"),beneficiaryInstructionId:null}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?s(e):c(e)},error:c})},gotoToBillerVerifyPage:function(t){t.stopImmediatePropagation();var i=this;e("#transfermountError").html(""),e("#toBillerBillerTypeError").html(""),e("#billPeriodError").html(""),e("#purposeError").html(""),e("#toBillerBillNumberErr").html(""),e("#tandcErr").html(""),e("#mobileremarkError").html("");var a=new RegExp("^[A-Za-z0-9 ]+$"),r=e("#mobileremark").val(),o=r.charAt(0),n=r.charAt(r.length-1);u.set("RemarkS",r);var s=e("input[name='biller_tobene_transfer']:checked").val();u.set("alertType",s),this.model=new c({url:"json/"}),l.Validation.bind(this);var m=this.$("form").serializeObject();if(this.model.set(m,{validate:!0})){this.model.clear(),l.Validation.unbind(this);var d=u.get("toBillerFromAccBal"),B=u.get("billerInstruction"),p=u.get("selectBillIndex"),b=B[p],g=b.mobileNumber;u.set("toBiller_BillerId",g);var h=b.shortName;u.set("toBiller_BillerName",h);var P=b.id;u.set("toBiller_BillerInsId",P);var f=b.serviceType;u.set("toBiller_BillerConnectionType",f);var D=e("#toBillerFromAccount option:selected").val();u.set("toBillerFromAccId",D);var N=u.get("accountTitle");u.set("toBillerFromAccName",N);var T=e("#toBillerFromAccount option:selected").html();u.set("toBillerFromAccNumber",T);var C=isNull(e("#toBillerBillAmount").val())?"":parseFloat(e("#toBillerBillAmount").val().replace(/,/g,"")),y=e("#toBillerBillAmount").val().replace(/,/g,"");if(isNull(C))return void("POSTPAID"==u.get("selectBillConnectionType")?e("#transfermountError").html("Please enter Bill Amount"):"PREPAID"==u.get("selectBillConnectionType")&&e("#transfermountError").html("Please enter Pay Amount"));var v=e("#currency option:selected").val();if(u.set("toBiller_BillCurrency",v),u.set("toBillerToCurrency","BDT"),"Insurance"==u.get("selectedBillerTypeName")){var A=e("#toBillerPurposeOfPayment option:selected").text(),S=e("#toBillerPurposeOfPayment option:selected").val();if(isNull(S))return void e("#purposeError").html("Please select a purpose of payment");u.set("toBiller_BillPurpose",A),u.set("toBiller_BillPurposeVal",S)}if(!isNull(r)){if(r.length>16)return void e("#mobileremarkError").html("The Remarks should contain maximum of 16 characters");if(!o.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return void e("#mobileremarkError").html(e.i18n.t("validation.newregistration.firstspaceind"));if(!n.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return void e("#mobileremarkError").html(e.i18n.t("validation.newregistration.lastspaceind"))}if(!isNull(r)&&!a.test(r))return void e("#mobileremarkError").html(e.i18n.t("validation.managebene.remarksspecialchar"));var L="";"Mobile / Telephone"==u.get("selectedBillerTypeName")||"MetLife"==u.get("selectedBillerListName")||"PREPAID"==u.get("selectBillConnectionType")?L=e("#toBillerBillAmount").val().replace(/,/g,""):(L=u.get("transactionAmount"),-1!=L.indexOf(",")&&(L=L.replace(/,/g,"")));var E=new RegExp("^[0-9.,]+$");if(!E.test(L))return void e("#transfermountError").html(e.i18n.t("validation.transfer.validamount"));if("DESCO"==u.get("selectedBillerListName")&&"POSTPAID"==u.get("selectBillConnectionType")||"DPDC"==u.get("selectedBillerListName")&&"POSTPAID"==u.get("selectBillConnectionType")){var I=e("#toBillerBillerType option:selected").val();e("#toBillerBillerType option:selected").text();if(isNull(I))return void e("#toBillerBillerTypeError").html("Please select a biller type");if("Monthly"==I||"Energy"==I){var O=e("#billPeriod option:selected").val();e("#billPeriod option:selected").text();if(isNull(O))return void e("#billPeriodError").html("Please select a bill period");if("DESCO"==u.get("selectedBillerListName")&&"Others"==I){var M=e("#toBillerBillNumber").val();if(isNull(M))return void e("#toBillerBillNumberErr").html("Please enter a bill number")}}}else if("NESCO"==u.get("selectedBillerListName")){var O=e("#billPeriod option:selected").val();e("#billPeriod option:selected").text();if(isNull(O))return void e("#billPeriodError").html("Please select a bill period")}var _=parseFloat(u.get("dailyAvailableLimit")),k=parseFloat(u.get("minAmountPerTransaction")),F=parseFloat(u.get("maxAmountPerTransaction")),w=u.get("dailyAvailableCount"),V=u.get("monthlyAvailableCount");if(k>C)return void e("#transfermountError").html(e.i18n.t("validation.sadad.amtgreaterthanminamt"));if(C>d)return void e("#transfermountError").html(e.i18n.t("validation.transfer.nobal"));if(C>_)return void e("#transfermountError").html("Limit has been exhausted. Please try again later or contact the bank");if(C>F)return void e("#transfermountError").html(e.i18n.t("validation.sadad.amtlessthanmaxamt"));if("0"==w)return void e("#transfermountError").html("You have exceeded your daily transaction count.");if("0"==V)return void e("#transfermountError").html("Transaction count exceeded Monthly Available Count.");u.set("transactionAmount",y),"Mobile / Telephone"==u.get("selectedBillerTypeName")||"DPDC"==u.get("selectedBillerListName")?u.set("selectBillServiceId",u.get("selectBillServiceId")):u.set("selectBillServiceId",null);var R=e("#termsand").prop("checked");if(!R)return void e("#tandcErr").html("Please check the Terms and Conditions");if("true"==u.get("authModeFlag"))return;i.gotoVerifyPage(t)}else this.$(".has-error").fadeIn(),t.preventDefault()},gotoVerifyPage:function(t){if(t.stopImmediatePropagation(),"false"!=u.get("toBillerIsValid")){var l=this,i=null;"Mobile / Telephone"!=u.get("selectedBillerTypeName")&&"MetLife"!=u.get("selectedBillerListName")&&("DPDC"==u.get("selectedBillerListName")?"PREPAID"==u.get("selectBillConnectionType")?i=null:"POSTPAID"==u.get("selectBillConnectionType")&&(i=u.get("uniqueId")):i=u.get("uniqueId"));var a;if("DPDC"==u.get("selectedBillerListName"))a=u.get("toBiller_BillerId");else if("DESCO"==u.get("selectedBillerListName")){a=u.get("toBillerBillNumber");e("#toBillerBillerType option:selected").val()}else"NESCO"==u.get("selectedBillerListName")&&(a=u.get("toBillerBillNumber"));var r,o,s=function(i){if("BDT"!==u.get("toBillerFromCurrency")){hideSpinner();var a=parseFloat(u.get("totalDebitAmount")),r=parseFloat(u.get("dailyAvailableLimit")),o=parseFloat(u.get("minAmountPerTransaction")),n=parseFloat(u.get("maxAmountPerTransaction"));if(o>a)return void e("#transfermountError").html(e.i18n.t("validation.sadad.amtgreaterthanminamt"));if(a>r)return void e("#transfermountError").html("Limit has been exhausted. Please try again later or contact the bank");if(a>n)return void e("#transfermountError").html(e.i18n.t("validation.sadad.amtlessthanmaxamt"));l.loadVerifyPage(t)}else hideSpinner(),l.loadVerifyPage(t)},c=function(e){l.errorresponse()};"DESCO"==u.get("selectedBillerListName")?("POSTPAID"==u.get("selectBillConnectionType")&&(r=""),o=additionalInfo.bll_no):"WZPDCL"==u.get("selectedBillerListName")||"Jalalabad Gas"==u.get("selectedBillerListName")||"Land Tax"==u.get("selectedBillerListName")?(r=additionalInfo.bllr_accno,o=""):(r="",o=""),showSpinner(),l.collection=new n;var m=parseFloat(u.get("transactionAmount").replace(/,/g,""));l.collection.fetch({data:e.param({access_token:u.get("access_token"),remarks:u.get("RemarkS"),billerId:u.get("selectBillerId"),transactionCurrency:u.get("toBiller_BillCurrency"),fromAccountId:u.get("toBillerFromAccId"),fromAcountbalance:u.get("toBillerFromAccBal"),fromAccountOwnerName:u.get("toBillerFromAccName"),billername:u.get("toBiller_BillerName"),shortname:u.get("toBiller_BillerName"),billInstId:u.get("toBiller_BillerInsId"),paymentMode:"regPayment",validtype:"Validation",amount:m,billerserviceId:u.get("selectBillServiceId"),globalid:null,uniqueid:i,purpose:u.get("toBiller_BillPurposeVal"),studentId:u.get("studentID"),connType:u.get("selectBillConnectionType"),bill_number:a,billMonth:u.get("toBillerBillMonth"),bllr_accno:r,bll_no:o}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?s(e):c(e)},error:c})}},loadVerifyPage:function(e){e.stopImmediatePropagation(),u.set("beneSuccessFlag","true"),l.history.navigate("#/billpaytobillerverify")},backToListUI:function(e){e.stopImmediatePropagation(),l.history.navigate("#/selectbillpayPage")},billPayToBillerOpenTandCPopup:function(e){e.stopImmediatePropagation(),"Mobile / Telephone"==u.get("selectedBillerTypeName")?u.set("tandctype","mobile"):"Electricity"==u.get("selectedBillerTypeName")?"DESCO"==u.get("selectedBillerListName")?u.set("tandctype","desco"):"NESCO"==u.get("selectedBillerListName")?u.set("tandctype","nesco"):"DPDC"==u.get("selectedBillerListName")?u.set("tandctype","dpdc"):"WZPDCL"==u.get("selectedBillerListName")&&u.set("tandctype","wzpdcl"):"Internet"==u.get("selectedBillerTypeName")?u.set("tandctype","internet"):"Insurance"==u.get("selectedBillerTypeName")?u.set("tandctype","insurance"):"Tuition Fees"==u.get("selectedBillerTypeName")?u.set("tandctype","tuitionfee"):"Water"==u.get("selectedBillerTypeName")?u.set("tandctype","utility"):"Government E-Services"==u.get("selectedBillerTypeName")?u.set("tandctype","landTax"):"Gas"==u.get("selectedBillerTypeName")?u.set("tandctype","gas"):"Land Tax"==u.get("selectedBillerTypeName")&&u.set("tandctype","landtax"),openTermsAndConditionsPopup()},getBillerTypeList:function(t){"object"==typeof t&&t.stopImmediatePropagation();var l=e("#toBillerBillerType option:selected").val(),i=(e("#toBillerBillerType option:selected").text(),
this);"Monthly"==l||"Energy"==l?(e("#billNumberDiv").hide(),i.populateBillPeriod(t)):(e("#billNumberDiv").show(),e("#monthlyBillerType").html(""))},populateBillPeriod:function(t){"object"==typeof t&&t.stopImmediatePropagation();var l=this;e("#monthlyBillerType").html("");var i=u.get("periodList"),a=["January","February","March","April","May","June","July","August","September","October","November","December"],r=new Date,o=r.getMonth()-1,n=a[o],s="";s+='<label> Bill Period </label><select id="billPeriod" class="form-control"><option value="">Select Bill Period</option>',e.each(i,function(e,t){var l=t.values.split(" "),i=l[0];s+=i==n?'<option value="'+t.code+'" selected>'+t.values+"</option>":'<option value="'+t.code+'">'+t.values+"</option>"}),s+='</select><div class="form-group has-error"><p class="help-block error-message has-error" style="color:#a94442" id="billPeriodError"></p></div>',e("#monthlyBillerType").html(s),"DESCO"==u.get("selectedBillerListName")||"NESCO"==u.get("selectedBillerListName")?l.populateBillNumber(t):"DPDC"==u.get("selectedBillerListName")&&l.getBillAmount(t),e("#billPeriod").on("change",function(e){"DESCO"==u.get("selectedBillerListName")?l.populateBillNumber(e):"DPDC"==u.get("selectedBillerListName")?l.getBillAmount(e):"NESCO"==u.get("selectedBillerListName")&&l.populateBillNumber(e)})},populateBillNumber:function(t){"object"==typeof t&&t.stopImmediatePropagation();var l=this,i=e("#toBillerBillerType option:selected").val(),a=e("#billPeriod option:selected").val();if("Monthly"!=i&&"Energy"!=i||isNull(a)){if("Others"==i)"DESCO"==u.get("selectedBillerListName")&&e("#toBillerBillNumber").val(""),u.set("toBillerBillMonth",null);else if("NESCO"==u.get("selectedBillerListName")){var r=u.get("billerInstruction"),o=u.get("selectBillIndex"),n=r[o],s=n.mobileNumber,c=a.slice(0,4),m=a.slice(-2),d=s+m+c,B=a;u.set("toBillerBillNumber",d),u.set("toBillerBillMonth",B)}}else if("DESCO"==u.get("selectedBillerListName")||"DPDC"==u.get("selectedBillerListName")){var p=a.slice(2,4),m=a.slice(-2),r=u.get("billerInstruction"),o=u.get("selectBillIndex"),n=r[o],s=n.mobileNumber;if("DESCO"==u.get("selectedBillerListName"))var d=m+p+s;else if("DPDC"==u.get("selectedBillerListName"))var d=s;var B=a;u.set("toBillerBillNumber",d),u.set("toBillerBillMonth",B)}if("DESCO"==u.get("selectedBillerListName")||"DPDC"==u.get("selectedBillerListName"))var d=u.get("toBillerBillNumber");else if("NESCO"==u.get("selectedBillerListName"))var d=u.get("toBillerBillNumber");isNull(d)||l.getBillAmount(t)},getBillAmount:function(t){"object"==typeof t&&t.stopImmediatePropagation();var l,i;if("DESCO"==u.get("selectedBillerListName")&&"PREPAID"==u.get("selectBillConnectionType")){var a=u.get("billerInstruction"),o=u.get("selectBillIndex"),n=a[o];l=n.mobileNumber}else if("DESCO"==u.get("selectedBillerListName")&&"POSTPAID"==u.get("selectBillConnectionType")){var s=e("#toBillerBillerType option:selected").val();"Monthly"==s?l=u.get("toBillerBillNumber"):"Others"==s&&(l=e("#toBillerBillNumber").val())}else if("DPDC"==u.get("selectedBillerListName")&&"POSTPAID"==u.get("selectBillConnectionType")){var s=e("#toBillerBillerType option:selected").val(),c=e("#billPeriod option:selected").val();if(isNull(s)||isNull(c))return;var a=u.get("billerInstruction"),o=u.get("selectBillIndex"),n=a[o];l=n.mobileNumber,i=c,u.set("toBillerBillMonth",i)}else if("NESCO"==u.get("selectedBillerListName")&&"POSTPAID"==u.get("selectBillConnectionType")){var c=e("#billPeriod option:selected").val();if(isNull(c))return;l=u.get("toBillerBillNumber"),i=c,u.set("toBillerBillMonth",i)}if(!isNull(l)){var m=this;u.set("billBreakDown","");var d=function(e){hideSpinner(),u.set("toBillerIsValid","true"),m.populateBillAmountFiled(t)},B=function(e){u.set("toBillerIsValid","false"),m.errorresponse()};showSpinner(),m.collection=new r([],{}),m.collection.fetch({data:e.param({access_token:u.get("access_token"),toAccountNumber:l,conntype:u.get("selectBillConnectionType"),billerServiceId:u.get("selectBillServiceId"),billerId:u.get("selectBillerId"),amount:u.get("getBillAmt"),billMonth:i}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?d(e):B(e)},error:B})}},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(e){return l.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return d});