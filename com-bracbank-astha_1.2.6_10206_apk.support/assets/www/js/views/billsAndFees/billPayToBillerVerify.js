define(["jquery","underscore","Backbone","collections/bills/billPaymentCollections","collections/wealth/otpPostLoginGenerationCollections","collections/wealth/otpPostLoginVerificationCollections","text!views/billsAndFees/billPayToBillerVerify.tpl"],function(e,t,l,o,i,n,a){var r=null,s=new EncryptedLocalStorage("secret"),c=l.View.extend({el:"#container",events:{"click #toBillerVerifyConfirmBtn":"openToBillerVerifyOTPPopup","click #toBillerVerifyCancelBtn":"gotoToBillerInitiatePage","click #toBillerOTPVerify":"gotoToBillerSuccessPage","click #walletToBeneOTPCancel":"toBillerRevokeOTPSpinner","click #walletToBeneOTPCloseBtn":"toBillerRevokeOTPSpinner","click #btn_to_billpayment_info":"closeBillPaymentPopup"},initialize:function(){},render:function(){if(r=null,"true"==s.get("beneSuccessFlag")){this.$el.html(t.template(a));var o=s.get("billBreakDown");s.get("additionalInfo");if(e("#descoPrepaidAdditionalInfoDIV").html(""),"DESCO"==s.get("selectedBillerListName")&&"PREPAID"==s.get("selectBillConnectionType")){var i="";e.each(o,function(e,t){if(!isNull(t.key)&&t.key.includes("charges_")){var l=t.key.replace("charges_","");i+='<li class="list-group-item"><label>'+l+"</label><p>"+t.value+'<span class="cur"> BDT</span></p></li>'}}),e("#descoPrepaidAdditionalInfoDIV").html(i)}s.set("beneSuccessFlag","false")}else l.history.navigate("#/billpaytobillerinit")},closeBillPaymentPopup:function(t){t.stopImmediatePropagation(),e("#billPaymentInfo").modal("hide"),window.history.go(-1)},openToBillerVerifyOTPPopup:function(t){t.stopImmediatePropagation();var l=this;"false"==s.get("IsAuthMode")?l.toBillerPosting(t):"SMS"==s.get("alertType")||"EMAIL"==s.get("alertType")||"ESIGN"==s.get("alertType")?l.validateCard("N"):(s.set("otpCode",""),e("#verify").modal("show"),e("#otpNullError").html(""),e("#otpNullErrorDiv").hide(),e(".inputs").on("input",function(t){t.stopImmediatePropagation();var l=t.currentTarget.id,o=e("#"+l).val();e("#"+l).attr("data",o),e("#"+l).val(o.replace(/[^\*]/,"."))}),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""))},validateCard:function(t){var l=this,o=function(o){hideSpinner(),"Y"==t&&(e("#OTPcontainer1").slideDown("slow"),r.set(1),r.animate(0,function(){e("#OTPcontainer1").slideUp("slow")})),e("#verify").modal("show"),setTimeout(function(){e("#otp1").focus()},500),e("#otpNullError").html(""),e("#otpNullErrorDiv").hide(),"ESIGN"==s.get("alertType")&&e("#challengeText").html(e.i18n.t("app.transferss.genratedTocn")+""+s.get("otpCode")),e(".inputs").on("input",function(t){t.stopImmediatePropagation();var l=t.currentTarget.id,o=e("#"+l).val();e("#"+l).attr("data",o),e("#"+l).val(o.replace(/[^\*]/,"."))}),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""),("SMS"==s.get("alertType")||"EMAIL"==s.get("alertType"))&&l.invokeOTPSpinner()},n=function(e){l.errorresponse()};showSpinner(),l.collection=new i;getDeviceId(),(new Date).getTime();l.collection.fetch({data:e.param({access_token:s.get("access_token"),transactionType:s.get("billPayToBeneTransferType"),resendflag:t,authMode:s.get("alertType")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?o(e):n(e)},error:n})},invokeOTPSpinner:function(){var t=this;return e("#resend_btn14").hide(),e("#OTPcontainer1").show(),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""),null!=r?(r.set(1),void r.animate(0,function(){e("#OTPcontainer1").slideUp("slow"),e("#resend_btn14").prop("disabled",!1)})):(r=new ProgressBar.Circle(OTPcontainer1,{color:"#333",strokeWidth:8,trailWidth:8,easing:"linear",duration:6e4*parseInt(s.get("otpExpiryPeriod")),text:{autoStyleContainer:!1},from:{color:"#ec5f59",width:8},to:{color:"#ec5f59",width:8},step:function(t,l){l.path.setAttribute("stroke",t.color),l.path.setAttribute("stroke-width",t.width);var o=Math.round(l.value()*(60*s.get("otpExpiryPeriod")));0===o?(l.setText(""),e("#resend_btn14").show()):(e("#resend_btn14").hide(),l.setText(o+"s"))}}),r.text.style.fontFamily='"Raleway", Helvetica, sans-serif',r.text.style.fontSize="12px",r.text.style.fontWeight="bold",r.set(1),r.animate(0,function(){e("#OTPcontainer1").slideUp("slow"),e("#resend_btn14").prop("disabled",!1)}),void e("#resend_btn14").click(function(){t.validateCard("Y")}))},gotoToBillerInitiatePage:function(e){e.stopImmediatePropagation(),l.history.navigate("#/billpaytobillerinit")},gotoToBillerSuccessPage:function(t){t.stopImmediatePropagation();var l=this;e("#otpNullError").html(""),e("#otpNullErrorDiv").hide();var o=e("#otp1").attr("data"),i=e("#otp2").attr("data"),a=e("#otp3").attr("data"),r=e("#otp4").attr("data"),c=e("#otp5").attr("data"),d=e("#otp6").attr("data"),p=o+""+i+a+r+c+d;if(isNull(o)||isNull(i)||isNull(a)||isNull(r)||isNull(c)||isNull(d))return e("#otpNullErrorDiv").show(),void e("#otpNullError").html(e.i18n.t("validation.newregistration.otpnotnull"));var u=function(e){l.toBillerRevokeOTPSpinner(),l.toBillerPosting(t)},g=function(t){hideSpinner(),isNull(s.get("errordesc"))||(e("#otpNullErrorDiv").show(),e("#otpNullError").html(s.get("errordesc")))};showSpinner(),l.collection=new n;getDeviceId(),(new Date).getTime();l.collection.fetch({data:e.param({access_token:s.get("access_token"),transactionType:s.get("billPayToBeneTransferType"),activationno:p,uniqueId:s.get("otpCode"),twoFAType:s.get("alertType")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?u(e):g(e)},error:g})},toBillerPosting:function(t){t.stopImmediatePropagation();var l="",i="",l="",i="",n="",a="",r="",c="",d="";if("Internet"==s.get("selectedBillerTypeName"))if(i=s.get("additionalInfoPair"),i.length>=5){var p=i[4].value;s.set("bill_id",p)}else s.set("bill_id",null);else s.set("bill_id",null);if("Insurance"==s.get("selectedBillerTypeName")?(i=s.get("additionalInfoPair"),i.length>=3?(s.set("commencementDate",i[1].value),s.set("dueDate",i[2].value)):(s.set("commencementDate",""),s.set("dueDate",""))):(s.set("commencementDate",""),s.set("dueDate","")),"DPDC"==s.get("selectedBillerListName"))l="POSTPAID"==s.get("selectBillConnectionType")?s.get("DPDCPostpaidBillNumber"):s.get("toBiller_BillerId"),i=s.get("DPDCPostpaidbillAdditionalInfo"),billBreakDown=s.get("DPDCPostpaidbillBreakdown");else if("DESCO"==s.get("selectedBillerListName")){l=s.get("toBillerBillNumber");e("#toBillerBillerType option:selected").val();"POSTPAID"==s.get("selectBillConnectionType")?(i=s.get("DESCOPostpaidbillAdditionalInfo"),billBreakDown=s.get("DESCOPostpaidbillBreakdown")):"PREPAID"==s.get("selectBillConnectionType")&&(i=s.get("DESCOPrepaidbillAdditionalInfo"),billBreakDown=s.get("DESCOPrepaidbillBreakdown"))}else"NESCO"==s.get("selectedBillerListName")?(l=s.get("toBillerBillNumber"),i=s.get("NESCOPostpaidbillAdditionalInfo"),billBreakDown=s.get("NESCOPostpaidbillBreakdown")):(i=JSON.stringify(s.get("additionalInfo")),billBreakDown=JSON.stringify(s.get("billBreakDown")));e.each(JSON.parse(billBreakDown),function(e,t){"bll_amnt"==t.key.toLowerCase()&&(n=t.value),"bll_vat"==t.key.toLowerCase()&&(a=t.value),"bll_late_fee"==t.key.toLowerCase()&&(r=t.value),"ekpay_fee"==t.key.toLowerCase()&&(d=t.value),"bll_amnt_ttl"==t.key.toLowerCase()&&(c=t.value)});var u="",g="",b="",f="",m="",y="";e.each(s.get("additionalInfoPair"),function(e,t){isNull(t.key)||("biller_sub_type"==t.key.toLowerCase()&&(u=t.value),"bill_mobno"==t.key.toLowerCase()&&(g=t.value),"bll_dt_frm"==t.key.toLowerCase()&&(b=t.value),"bll_dt_to"==t.key.toLowerCase()&&(f=t.value),"bll_dt_gnrt"==t.key.toLowerCase()&&(m=t.value),"bll_dt_due"==t.key.toLowerCase()&&(y=t.value))});var P="",_="",v="",h="",B="",T="",y="",w="",k="",D=s.get("additionalInfo");if(isNull(D))P="",_="",v="",h="",B="",T="",y="",w="",k="";else{P=D.bllr_accno,_=D.ref_id,v=D.refno_ack,h=D.bll_no,B=D.bll_typ,T=D.bll_add,y=D.bll_dt_due,w=D.bll_loc_cd;var I=D.bll_mobno;k=isNull(I)?g:I}var C=this,S=function(l){hideSpinner(),e("#verify").modal("hide"),C.loadSuccessPage(t)},N=function(e){C.errorresponse()};showSpinner(),C.collection=new o,C.collection.fetch({data:e.param({access_token:s.get("access_token"),remarks:s.get("RemarkS"),billerId:s.get("selectBillerId"),transactionCurrency:s.get("toBiller_BillCurrency"),fromAccountId:s.get("toBillerFromAccId"),fromAcountbalance:s.get("toBillerFromAccBal"),fromAccountOwnerName:s.get("toBillerFromAccName"),billername:s.get("toBiller_BillerName"),shortname:s.get("toBiller_BillerName"),billInstId:s.get("toBiller_BillerInsId"),paymentMode:"regPayment",validtype:"Posting",amount:s.get("transactionAmount"),globalid:s.get("globalTranValidationId"),uniqueid:s.get("uniqueId"),totalDebitAmount:s.get("totalDebitAmount"),bill_id:s.get("bill_id"),billerserviceId:s.get("selectBillServiceId"),fee:s.get("fee"),purpose:s.get("toBiller_BillPurposeVal"),exchangerate:s.get("exchangeRate1"),studentId:s.get("studentID"),connType:s.get("selectBillConnectionType"),bill_number:l,location_code:s.get("DPDCPostpaidLocationCode"),total_dpdc_amount:s.get("DPDCPostpaidTotalDPDCAmt"),vat_amount:s.get("DPDCPostpaidVATAmt"),mobile_no:s.get("DPDCPostpaidMobileNumber"),additionalInfoPair:i,billBreakDown:billBreakDown,billMonth:s.get("toBillerBillMonth"),bllr_accno:P,biller_sub_type:u,ref_id:_,refno_ack:v,bll_no:h,bll_type:B,bll_add:T,bll_dt_due:y,bll_loc_cd:w,bll_amnt:n,bll_vat:a,bll_late_fee:r,ekpay_fee:d,bll_amnt_ttl:c,bll_mobno:k,bll_dt_frm:b,bll_dt_to:f,bll_dt_gnrt:m,bll_dt_due:y}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?"MW-000-99999"==s.get("errorcode")?(hideSpinner(),e("#verify").modal("hide"),e("#billPaymentInfo").modal("show")):S(t):N(t)},error:N})},loadSuccessPage:function(t){t.stopImmediatePropagation(),e("#verify").modal("hide"),l.history.navigate("#/billpaytobillerpaying")},toBillerRevokeOTPSpinner:function(){null!=r&&r.stop()},errorresponse:function(){hideSpinner(),e("#verify").modal("hide"),openErrorPopup()},disposeView:function(e){return l.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return c});