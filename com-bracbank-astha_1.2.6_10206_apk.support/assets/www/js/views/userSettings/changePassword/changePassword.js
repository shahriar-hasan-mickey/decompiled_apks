define(["jquery","underscore","Backbone","routers/wealthrouter","routers/settingsRouter","collections/userSettings/changepasswordCollections","models/validation/login/forgotPasswordValidationModel","collections/wealth/otpPostLoginGenerationCollections","collections/wealth/otpPostLoginVerificationCollections","collections/transfer/getAuthModeCollections","text!views/userSettings/changePassword/changePassword.tpl"],function(r,t,e,o,a,n,i,s,l,p,d){var c=null,h=new EncryptedLocalStorage("secret"),u=e.View.extend({el:"#container",events:{"click #backBtn":"gotoPreviousPage","click #cancel":"gotoPreviousPage","click #popup_cancel_btn":"revokeOTPSpinner","click #close_btn":"revokeOTPSpinner","click #submit":"validateThepsw","keyup #confpassword":"ConfirmPasswordChange","keyup #oldpassword":"OldPassword","keyup #password":"newpassword","click #verifyOTP":"gotoPasswordChangeSuccessPopUp","click #login":"gotoLoginPage"},initialize:function(){new o,new a},render:function(){c=null,hideSpinner();var r=this;r.getAuthmode()},getAuthmode:function(){var t=this;h.set("IsAuthMode","false"),r("#changepassword_authmodeDiv").html("");var e=function(r){hideSpinner();var e=h.get("securitySettingList");!isNull(e)&&e.length>0?h.set("IsAuthMode","true"):(h.set("AlertType",null),h.set("IsAuthMode","false")),t.populateAuthMode()},o=function(r){hideSpinner(),h.set("IsAuthMode","false"),t.populateAuthMode()};showSpinner(),t.collection=new p,t.collection.fetch({data:r.param({access_token:h.get("access_token"),transactionAmount:null,tenantServiceCode:"CP"}),dataType:"json",type:"POST",cache:!1,success:function(r){"0000"==ackStatus?e(r):o(r)},error:o})},populateAuthMode:function(){var e="",o="";this.$el.html(t.template(d)),r("html").removeClass("primarybg hasBoth").addClass("app");var a=h.get("securitySettingList"),n="<label for='username'>"+r.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";n+="<div class='custRadio_pass'>",!isNull(a)&&a.length>0?(r("#changepassword_authmodeDiv").html(""),r.each(a,function(t,a){"SMS"==a?(e="sms",o=r.i18n.t("app.transfer.managebeneficiary.sms")):"EMAIL"==a?(e="mail",o=r.i18n.t("app.transfer.managebeneficiary.mail")):"TOKEN"==a?(e="fScan",o=r.i18n.t("app.transfer.managebeneficiary.token")):"ESIGN"==a&&(e="esign",o=r.i18n.t("app.transfer.managebeneficiary.esign")),n+='<div class="box"><div class="radio"><label>',n+=0==t?'<input type="radio" name="changepassword_authmode" id="optionsRadios'+t+'" value="'+a+'" checked>':'<input type="radio" name="changepassword_authmode" id="optionsRadios'+t+'" value="'+a+'">',n+='<div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs '+e+'"></span><span class="small">'+o+"</span></div></div></label></div></div>"}),r("#changepassword_authmodeDiv").html(n)):r("#changepassword_authmodeDiv").html("")},gotoPreviousPage:function(r){r.stopImmediatePropagation(),e.history.navigate("#/usersettings")},ConfirmPasswordChange:function(){r("#confirmPasswordError").html("");var t=r("#confpassword").val();return""==t||null==t?(r("#confirmPasswordError").html(r.i18n.t("validation.newregistration.confpwdnotnull")),!1):void 0},OldPassword:function(){r("#confirmPasswordError").html("");var t=r("#oldpassword").val();return""==t||null==t?(r("#oldpasswordError").html(r.i18n.t("Please Enter Old Password")),!1):void 0},newpassword:function(){r("#oldpasswordError").html(""),r("#passwordError").html(""),r("#confirmPasswordError").html("");var t=/[0-9]/g,e=r("#password").val(),o=r("#confpassword").val(),a=r("#oldpassword").val(),n=h.get("pwdpolicy"),i=/[a-z\u0600-\u06FF]/g,s=/[A-Z\u0600-\u06FF]/g,l=/^[A-Z]/,p=/^[a-z]/,d=/^[0-9]/,c=/^[!@#$%^&*()-_+~.]/,u=/^[a-zA-Z]/;if(""==a||null==a?(isError=!0,r("#oldpasswordError").html(r.i18n.t("Please Enter Old Password"))):r("#confirmPasswordError").html(""),""==e||null==e)return r("#passwordError").html(r.i18n.t("validation.newregistration.pwdnotnull")),!1;if("U"===n.firstCharacterValue){if(!l.test(e))return r("#passwordError").html(r.i18n.t("app.login.errUP")),!1}else if("L"===n.firstCharacterValue){if(p.test(e))return r("#passwordError").html(r.i18n.t("app.login.errLOW")),!1}else if("N"===n.firstCharacterValue){if(d.test(e))return r("#passwordError").html(r.i18n.t("app.login.errNUM")),!1}else if("S"===n.firstCharacterValue){if(c.test(e))return r("#passwordError").html(r.i18n.t("app.login.errSpecl")),!1}else if("A"===n.firstCharacterValue&&!u.test(e))return r("#passwordError").html(r.i18n.t("First Character should be an alphabet")),!1;if(e.length<n.minimumLength)return r("#passwordError").html(r.i18n.t("app.login.pwderrlength1")+" "+n.minimumLength+" "+r.i18n.t("app.login.pwderrlength2")+" "+n.maximumLength+" "+r.i18n.t("app.login.pwderrlength3")),!1;if(e.length>n.maximumLength)return r("#passwordError").html(r.i18n.t("app.login.pwderrmaxlen")+" "+n.maximumLength+" "+r.i18n.t("app.login.pwderrlength3")),!1;var m=e.search(t);if("Y"===n.numeralsMandatory&&"-1"==m)return r("#passwordError").html(r.i18n.t("app.login.errnumber")),!1;var g=e.search(i);if("Y"===n.lowercaseMandatory&&"-1"==g)return r("#passwordError").html(r.i18n.t("app.login.errlwr")),!1;var w=e.search(s);if("Y"===n.uppercaseMandatory)if("U"===n.firstCharacterValue){if(-1==w||0!==w)return r("#passwordError").html(r.i18n.t("app.login.errupr")),!1}else if(-1==w)return r("#passwordError").html(r.i18n.t("app.login.errupr")),!1;if("Y"===n.specialCharactersMandatory)if(isNull(n.disallowedCharacters)){var f=!1,v=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;if(v.test(e)||(f=!0),f)return isError=!0,void r("#passwordError").html(r.i18n.t("app.login.errspc"))}else{for(var E=n.disallowedCharacters,P=!1,y=0;y<e.length;y++){var T=e[y];-1!=E.indexOf(T)&&(P=!0)}if(P)return isError=!0,void r("#passwordError").html("Entered password does not match with password policy "+n.disallowedCharacters+" are not allowed");var f=!1,v=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;if(v.test(e)||(f=!0),f)return isError=!0,void r("#passwordError").html(r.i18n.t("app.login.errspc"))}var S=e.toLowerCase();if("N"===n.repeatingValueAllowedInPwd)for(var y=0;y<S.length;y++){var T=S[y],C=S[y+1];if(T===C&&T===S[y+2])return r("#passwordError").html(r.i18n.t("app.login.errcon")),!1}if("N"===n.seqValueAllowedInPwd){if(S.match(/([a-zA-Z0-9])\1\1+|(abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|jkl|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz|ABC|BCD|CDE|DEF|EFG|FGH|GHI|HIJ|IJK|JKL|KLM|LMN|MNO|NOP|OPQ|PQR|QRS|RST|STU|TUV|UVW|VWX|WXY|XYZ|012|123|234|345|456|567|678|789)+/g))return r("#passwordError").html(r.i18n.t("app.login.errconseq")),!1;for(var A=0,y=0;y<S.length-1;y++){var k=parseInt(S[y])+1;S[y+1]==k&&S[y]!=S[y+1]&&A++}if(4==A)return r("#passwordError").html(r.i18n.t("app.login.errconseq")),!1}return(""!=e||null!=e)&&""==o||null==o?(r("#confirmPasswordError").html(r.i18n.t("validation.newregistration.confpwdnotnull")),!1):""!=e&&""!=o&&e!=o?(r("#confirmPasswordError").html(r.i18n.t("validation.newregistration.pwdmismatch")),!1):void 0},validateThepsw:function(t){t.stopImmediatePropagation();var e=r("input[name='changepassword_authmode']:checked").val();h.set("AlertType",e),r("#passwordError").html(""),r("#confirmPasswordError").html(""),r("#oldpasswordError").html("");var o=/[0-9]/g,a=this,n=!1,i=r("#password").val(),s=r("#confpassword").val(),l=r("#oldpassword").val(),p=h.get("pwdpolicy"),d=/[a-z\u0600-\u06FF]/g,c=/[A-Z\u0600-\u06FF]/g,u=/^[A-Z]/,m=/^[a-z]/,g=/^[0-9]/,w=/^[!@#$%^&*()-_+~.]/,f=/^[a-zA-Z]/;if((""==i||null==i)&&(n=!0,r("#passwordError").html(r.i18n.t("validation.newregistration.pwdnotnull"))),(""==s||null==s)&&(n=!0,r("#confirmPasswordError").html(r.i18n.t("validation.newregistration.confpwdnotnull"))),(""==l||null==l)&&(n=!0,r("#oldpasswordError").html(r.i18n.t("Please Enter Old Password"))),""==i||null==i)return n=!0,void r("#passwordError").html(r.i18n.t("validation.newregistration.pwdnotnull"));if("U"===p.firstCharacterValue){if(!u.test(i))return n=!0,void r("#passwordError").html(r.i18n.t("app.login.errUP"))}else if("L"===p.firstCharacterValue){if(m.test(i))return n=!0,void r("#passwordError").html(r.i18n.t("app.login.errLOW"))}else if("N"===p.firstCharacterValue){if(g.test(i))return n=!0,void r("#passwordError").html(r.i18n.t("app.login.errNUM"))}else if("S"===p.firstCharacterValue){if(w.test(i))return n=!0,void r("#passwordError").html(r.i18n.t("app.login.errSpecl"))}else if("A"===p.firstCharacterValue&&!f.test(i))return r("#passwordError").html(r.i18n.t("First Character should be an alphabet")),!1;if(i.length<p.minimumLength)return n=!0,void r("#passwordError").html(r.i18n.t("app.login.pwderrlength1")+" "+p.minimumLength+" "+r.i18n.t("app.login.pwderrlength2")+" "+p.maximumLength+" "+r.i18n.t("app.login.pwderrlength3"));if(i.length>p.maximumLength)return n=!0,void r("#passwordError").html(r.i18n.t("app.login.pwderrmaxlen")+" "+p.maximumLength+" "+r.i18n.t("app.login.pwderrlength3"));var v=i.search(o);if("Y"===p.numeralsMandatory&&"-1"==v)return n=!0,void r("#passwordError").html(r.i18n.t("app.login.errnumber"));var E=i.search(d);if("Y"===p.lowercaseMandatory&&"-1"==E)return n=!0,void r("#passwordError").html(r.i18n.t("app.login.errlwr"));var P=i.search(c);if("Y"===p.uppercaseMandatory)if("U"===p.firstCharacterValue){if(-1==P||0!==P)return r("#passwordError").html(r.i18n.t("app.login.errupr")),!1}else if(-1==P)return r("#passwordError").html(r.i18n.t("app.login.errupr")),!1;if("Y"===p.specialCharactersMandatory)if(isNull(p.disallowedCharacters)){var y=!1,T=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;if(T.test(i)||(y=!0),y)return n=!0,void r("#passwordError").html(r.i18n.t("app.login.errspc"))}else{for(var S=p.disallowedCharacters,C=!1,A=0;A<i.length;A++){var k=i[A];-1!=S.indexOf(k)&&(C=!0)}if(C)return n=!0,void r("#passwordError").html("Entered password does not match with password policy "+p.disallowedCharacters+" are not allowed");var y=!1,T=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;if(T.test(i)||(y=!0),y)return n=!0,void r("#passwordError").html(r.i18n.t("app.login.errspc"))}var b=i.toLowerCase();if("N"===p.repeatingValueAllowedInPwd)for(var A=0;A<b.length;A++){var k=b[A],N=b[A+1];if(k===N&&k===b[A+2])return n=!0,void r("#passwordError").html(r.i18n.t("app.login.errcon"))}if(b.match(/([a-zA-Z0-9])\1\1+|(abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|jkl|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz|ABC|BCD|CDE|DEF|EFG|FGH|GHI|HIJ|IJK|JKL|KLM|LMN|MNO|NOP|OPQ|PQR|QRS|RST|STU|TUV|UVW|VWX|WXY|XYZ|012|123|234|345|456|567|678|789)+/g))return n=!0,void r("#passwordError").html(r.i18n.t("app.login.errconseq"));for(var x=0,A=0;A<b.length-1;A++){var O=parseInt(b[A])+1;b[A+1]==O&&b[A]!=b[A+1]&&x++}return 4==x?(n=!0,void r("#passwordError").html(r.i18n.t("app.login.errconseq"))):(""!=i||null!=i)&&""==s||null==s?(n=!0,void r("#confirmPasswordError").html(r.i18n.t("validation.newregistration.confpwdnotnull"))):""!=i&&""!=s&&i!=s?(n=!0,void r("#confirmPasswordError").html(r.i18n.t("validation.newregistration.pwdmismatch"))):void(n||a.sucesspaswordchange("Y"))},loadOtp:function(){var t=this,e=h.get("AlertType");"false"==h.get("IsAuthMode")?t.sucesspaswordchange("N"):"SMS"==e||"EMAIL"==e||"ESIGN"==e?t.validateotpgeneration("N"):(h.set("otpCode",""),r("#verify").modal("show"),r("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").removeAttr("data"),r("#myModalLabel").html(r.i18n.t("app.registration.otptokenheadertext")),r("#otpHelpText").html(r.i18n.t("app.registration.opthelptokentext")),r("#challengeText").html(""),r("#otpContainerDiv").html(""),r("#otpNullError").html(""),r("#otpNullErrorDiv").hide(),r(".inputs").on("input",function(t){var e=t.currentTarget.id,o=r("#"+e).val();r("#"+e).attr("data",o),r("#"+e).val(o.replace(/[^\*]/,"."))}),r("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""))},validateotpgeneration:function(t){var e=this,o=function(o){hideSpinner(),"Y"==t&&(r("#OTPcontainer1").slideDown("slow"),c.set(1),c.animate(0,function(){r("#OTPcontainer1").slideUp("slow")})),r("#verify").modal("show"),setTimeout(function(){r("#otp1").focus()},500),r("#otpNullError").html(""),r("#otpNullErrorDiv").hide(),r(".inputs").on("input",function(t){t.stopImmediatePropagation();var e=t.currentTarget.id,o=r("#"+e).val();r("#"+e).attr("data",o),r("#"+e).val(o.replace(/[^\*]/,"."))}),r("#otpHelpText").html(""),r("#challengeText").html(""),"SMS"==h.get("AlertType")?(r("#myModalLabel").html(r.i18n.t("app.registration.otpothersheadertext")),r("#otpHelpText").html("Please enter the OTP from your registered mobile number "+maskMobile(h.get("contactNumber")))):"EMAIL"==h.get("AlertType")?(r("#myModalLabel").html(r.i18n.t("app.registration.otpothersheadertext")),r("#otpHelpText").html("Please enter the OTP from your registered email ID"+maskMobile(h.get("emailId")))):"TOKEN"==h.get("AlertType")?(r("#myModalLabel").html(r.i18n.t("app.registration.otptokenheadertext")),r("#otpHelpText").html(r.i18n.t("app.registration.opthelptokentext"))):"ESIGN"==h.get("AlertType")&&(r("#myModalLabel").html(r.i18n.t("app.registration.otpothersheadertext")),r("#otpHelpText").html("Please enter the ESIGN Validation"),r("#challengeText").html(r.i18n.t("app.transferss.genratedTocn")+""+h.get("otpCode"))),r("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""),"SMS"==h.get("AlertType")||"EMAIL"==h.get("AlertType")?e.appendOTPContainer():r("#otpContainerDiv").html(""),("SMS"==h.get("AlertType")||"EMAIL"==h.get("AlertType"))&&(c=null,r("#otpNullError").html(""),e.invokeOTPSpinner())},a=function(r){e.errorresponse()};showSpinner(),e.collection=new s;getDeviceId(),(new Date).getTime();e.collection.fetch({data:r.param({access_token:h.get("access_token"),transactionType:"CHANGE_PASSWORD",resendflag:t,authMode:h.get("AlertType")}),dataType:"json",type:"POST",cache:!1,success:function(r){"0000"==ackStatus?o(r):a(r)},error:a})},appendOTPContainer:function(){r("#otpContainerDiv").html("");var t="";t+="<div class='form-group'><div id='OTPcontainer1'></div><p class='text-center small'><a href='javascript:void(0);'class='resend_button' id='resend_btn6'>Resend OTP</a></p></div>",r("#otpContainerDiv").append(t)},gotoPasswordChangeSuccessPopUp:function(t){t.stopImmediatePropagation(),r("#otpNullError").html(""),r("#otpNullErrorDiv").hide();var e=this,o=r("#otp1").attr("data"),a=r("#otp2").attr("data"),n=r("#otp3").attr("data"),i=r("#otp4").attr("data"),s=r("#otp5").attr("data"),p=r("#otp6").attr("data"),d=o+""+a+n+i+s+p;if(isNull(o)||isNull(a)||isNull(n)||isNull(i)||isNull(s)||isNull(p))return r("#otpNullErrorDiv").show(),void r("#otpNullError").html(r.i18n.t("validation.newregistration.otpnotnull"));var c=function(t){hideSpinner(),e.revokeOTPSpinner(),r("#verify").modal("hide"),e.sucesspaswordchange("N")},u=function(t){hideSpinner(),e.revokeOTPSpinner(),isNull(h.get("errordesc"))||(r("#otpNullErrorDiv").show(),r("#otpNullError").html(h.get("errordesc")))};showSpinner(),e.collection=new l;getDeviceId(),(new Date).getTime();e.collection.fetch({data:r.param({access_token:h.get("access_token"),transactionType:"CHANGE_PASSWORD",activationno:d,uniqueId:h.get("otpCode"),twoFAType:h.get("AlertType")}),dataType:"json",type:"POST",cache:!1,success:function(r){"0000"==ackStatus?c(r):u(r)},error:u})},sucesspaswordchange:function(t){var e=this,o=function(o){hideSpinner(),"N"==t?r("#successPopup").modal("show"):e.loadOtp()},a=function(r){e.errorresponse()};showSpinner(),e.collection=new n;var i=r("#oldpassword").val(),s=r("#password").val(),l=(getDeviceId(),(new Date).getTime());pwd=EncryptWithDynamicSalt(s,l),oldpsw=EncryptWithDynamicSalt(i,l),e.collection.fetch({data:r.param({access_token:h.get("access_token"),salt:l,Validation:t,newpassword:pwd,oldpassword:oldpsw}),dataType:"json",type:"POST",cache:!1,success:function(r){"0000"==ackStatus?o(r):a(r)},error:a})},gotoLoginPage:function(t){t.stopImmediatePropagation(),r("#successPopup").modal("hide"),r("div").removeClass("modal-backdrop fade in"),e.history.navigate("#/applogin")},invokeOTPSpinner:function(){var t=this;return r("#resend_btn6").hide(),t.appendOTPContainer(),r("#OTPcontainer1").show(),r("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""),null!=c?(c.set(1),void c.animate(0,function(){r("#OTPcontainer1").slideUp("slow")})):(c=new ProgressBar.Circle(OTPcontainer1,{color:"#333",strokeWidth:8,trailWidth:8,easing:"linear",duration:6e4*parseInt(h.get("otpExpiryPeriod")),text:{autoStyleContainer:!1},from:{color:"#ec5f59",width:8},to:{color:"#ec5f59",width:8},step:function(t,e){e.path.setAttribute("stroke",t.color),e.path.setAttribute("stroke-width",t.width);var o=Math.round(e.value()*(60*h.get("otpExpiryPeriod")));"0"==o?(e.setText(""),r("#resend_btn6").show()):(r("#resend_btn6").hide(),e.setText(o+"s"))}}),c.text.style.fontFamily='"Raleway", Helvetica, sans-serif',c.text.style.fontSize="12px",c.text.style.fontWeight="bold",c.set(1),c.animate(0,function(){r("#OTPcontainer1").slideUp("slow")}),void r("#resend_btn6").click(function(){t.validateotpgeneration("Y")}))},revokeOTPSpinner:function(){null!=c&&c.stop()},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(r){return e.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=r,this.currentView.delegateEvents(),this.currentView}});return u});