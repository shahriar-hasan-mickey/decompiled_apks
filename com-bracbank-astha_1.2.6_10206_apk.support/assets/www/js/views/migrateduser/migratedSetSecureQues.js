define(["jquery","underscore","Backbone","text!views/migrateduser/migratedSetSecureQues.tpl","collections/login/getMigratedSecureQuestionCollections","collections/applanding/Registration/otpGenerationCollections","collections/applanding/Registration/otpVerificationCollections","collections/applanding/Registration/registerUserCollections","collections/applanding/Registration/getAuthModeCollections","models/validation/login/setSecureQuesValidationModel"],function(e,t,i,o,n,r,a,s,l,c){var u=null,p=new EncryptedLocalStorage("secret"),d=i.View.extend({el:"#container",events:{"click #migrated_ques_continue":"gotoRequestAccess","click #migrated_ques_cancel":"gotoLoginPage","click #migrated_gotoLogin":"gotoLoginPage","click #MigSetSecQuesOTPCancel_btn":"revokeOTPSpinner","click #MigSetSecQuesOTPClose_btn":"revokeOTPSpinner","click #MigSetSecQuesOTP_VerifyOTPBtn":"gotoSecQuesSuccessPopup"},initialize:function(){},render:function(e){u=null;var t=this;t.getSecureQuestionList()},getSecureQuestionList:function(t){showSpinner();var i=this,o=function(e){i.getAuthmode()},r=function(e){i.errorresponse()};i.collection=new n([],{}),i.collection.fetch({data:e.param({access_token:p.get("access_token")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?o(e):r(e)},error:r})},getAuthmode:function(){var t=this;e("#migFrequentUserAuthModeDiv").html("");var i=function(e){hideSpinner(),t.viewSecureQuestionUI()},o=function(e){hideSpinner(),t.viewSecureQuestionUI()};t.collection=new l,t.collection.fetch({data:e.param({access_token:p.get("access_token"),transactionAmount:null,tenantServiceCode:"SELF_REGISTRATION",miguser:"Y",ulpId:p.get("ulpID")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?i(e):o(e)},error:o})},viewSecureQuestionUI:function(){var i=this;i.$el.html(t.template(o)),e("html").removeClass().addClass("loginbg");var n=p.get("userstatus");"OTP"==n&&i.populateAuthModeDiv()},populateAuthModeDiv:function(){var t="",i="",o=p.get("securitySettingList"),n="<label for='username'>"+e.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";n+="<div class='custRadio_pass'>",!isNull(o)&&o.length>0?(e("#migFrequentUserAuthModeDiv").html(""),e.each(o,function(o,r){"SMS"==r?(t="sms",i=e.i18n.t("app.transfer.managebeneficiary.sms")):"EMAIL"==r?(t="mail",i=e.i18n.t("app.transfer.managebeneficiary.mail")):"TOKEN"==r?(t="fScan",i=e.i18n.t("app.transfer.managebeneficiary.token")):"ESIGN"==r&&(t="esign",i=e.i18n.t("app.transfer.managebeneficiary.esign")),n+='<div class="box"><div class="radio"><label>',n+=0==o?'<input type="radio" name="migSetSecureQues_AuthMode" id="migrateUserFrequent'+o+'" value="'+r+'" checked>':'<input type="radio" name="migSetSecureQues_AuthMode" id="migrateUserFrequent'+o+'" value="'+r+'">',n+='<div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs '+t+'"></span><span class="small">'+i+"</span></div></div></label></div></div>"}),e("#migFrequentUserAuthModeDiv").html(n)):e("#migFrequentUserAuthModeDiv").html("")},gotoRequestAccess:function(o){o.stopImmediatePropagation();var n=e("input[name='migSetSecureQues_AuthMode']:checked").val();p.set("migSetSecQuesAuthMode",n);var r=!1;e("#secQuesError").html(""),e("#tandcError").html(""),e("#errorcon1, #errorcon2").hide(),e("#errorconseq1, #errorconseq2").hide(),e("#commonerror1, #commonerror2").html("");var a=e("input[name=ques1]:checked").val(),s=e("input[name=ques2]:checked").val(),l=e("#ans1").val(),u=e("#ans2").val(),d=(e("input[type='checkbox']").prop("checked"),l.charAt(0)),g=l.charAt(l.length-1),m=u.charAt(0),h=u.charAt(u.length-1);if((null==a||void 0==a)&&(r=!0,e("#commonerror1").html(e.i18n.t("validation.login.secquesnotnull"))),(null==s||void 0==s)&&(r=!0,e("#commonerror2").html(e.i18n.t("validation.login.secquesnotnull"))),!r){var v=this;this.model=new c({url:"json/"}),i.Validation.bind(this);var S=this.$("form").serializeObject();if(this.model.set(S,{validate:!0})){if(this.model.clear(),i.Validation.unbind(this),null!=a&&null!=s&&a==s)return void e("#secQuesError").html(e.i18n.t("validation.login.secquessameerr"));if(!d.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return void e("#commonerror1").html(e.i18n.t("validation.newregistration.firstspaceind"));if(!g.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return void e("#commonerror1").html(e.i18n.t("validation.newregistration.lastspaceind"));if(l.length>20)return void e("#commonerror1").html(e.i18n.t("validation.login.answermaxlength"));if(!m.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return void e("#commonerror2").html(e.i18n.t("validation.newregistration.firstspaceind"));if(!h.match(/^[a-zA-Z0-9\u0600-\u06FF]+$/i))return void e("#commonerror2").html(e.i18n.t("validation.newregistration.lastspaceind"));if(u.length>20)return void e("#commonerror2").html(e.i18n.t("validation.login.answermaxlength"));if(null!=l&&null!=u&&l==u)return void e("#secQuesError").html(e.i18n.t("validation.login.answernotsame"));var f=[],T=[],P=[],M="",w="",A=p.get("questionBasketList");0!=t.size(A)&&t.each(A,function(t,i){var o=e("input[name=ques"+(i+1)+"]:checked").val(),n=o.split("~"),r=n[0],a=n[1];f.push(r),M=JSON.stringify(f),T.push(a);var s=(JSON.stringify(a),e("#ans"+(i+1)).val().trim());P.push(s),w=JSON.stringify(P)});var O=(M.replace(/"/g,""),w.replace(/"/g,""),[]);f.forEach(function(e,t){O.push(e+":"+P[t])});var y=JSON.stringify(O);y=y.replace(/"/g,""),p.set("getQuesAns",y);var b=!1,E=[];if(0!=t.size(A)){var I=1;t.each(A,function(t,i){E.push(e("#ans"+I).val().toLowerCase()),I++})}if(t.each(E,function(t,i){for(var o=0;o<t.length;o++){var n=t[o],r=t[o+1];if(n===r&&n===t[o+2])return e("#errorcon"+(i+1)).show(),void(b=!0)}if(t.match(/([a-zA-Z0-9])\1\1+|(abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|jkl|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz|ABC|BCD|CDE|DEF|EFG|FGH|GHI|HIJ|IJK|JKL|KLM|LMN|MNO|NOP|OPQ|PQR|QRS|RST|STU|TUV|UVW|VWX|WXY|XYZ|012|123|234|345|456|567|678|789)+/g))return e("#errorconseq"+(i+1)).show(),void(b=!0);for(var a=0,o=0;o<t.length-1;o++){var s=parseInt(t[o])+1;t[o+1]==s&&t[o]!=t[o+1]&&a++}return 4==a?(e("#errorconseq"+(i+1)).show(),void(b=!0)):void 0}),b)this.$(".has-error").fadeIn(),o.preventDefault();else{var N,k=/iPad|iPhone|iPod/.test(navigator.userAgent);N=k?"IOSMOBILE":"ANDROIDMOBILE";var v=this,Q=p.get("userstatus");"CARDPIN"==Q?v.setMigratedSecureQuestion(o):"true"==p.get("isMigUserForgotpassword")?v.setMigratedSecureQuestion(o):v.openMigSetSecQuesOTPPopup(o)}}}},openMigSetSecQuesOTPPopup:function(t){t.stopImmediatePropagation();var i=this,o=p.get("migSetSecQuesAuthMode");"SMS"==o||"EMAIL"==o||"ESIGN"==o?i.validateOTPGeneration("N"):(p.set("otpCode",""),e("#verify").modal("show"),"TOKEN"==p.get("migSetSecQuesAuthMode")&&(e("#challengeText").html(""),e("#myModalLabel").html(e.i18n.t("app.registration.otptokenheadertext")),e("#otpHelpText").html(e.i18n.t("app.registration.opthelptokentext"))),e("#OTPcontainer1").hide(),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").removeAttr("data"),e("#otpNullError").html(""),e("#otpNullErrorDiv").hide(),e(".inputs").on("input",function(t){t.stopImmediatePropagation();var i=t.currentTarget.id,o=e("#"+i).val();e("#"+i).attr("data",o),e("#"+i).val(o.replace(/[^\*]/,"."))}),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""))},validateOTPGeneration:function(t){var i=this,o=function(o){hideSpinner(),"Y"==t&&(e("#OTPcontainer1").slideDown("slow"),u.set(1),u.animate(0,function(){e("#OTPcontainer1").slideUp("slow")})),e("#verify").modal("show"),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").removeAttr("data"),setTimeout(function(){e("#otp1").focus()},500),e("#otpNullError").html(""),e("#otpNullErrorDiv").hide(),e(".inputs").on("input",function(t){t.stopImmediatePropagation();var i=t.currentTarget.id,o=e("#"+i).val();e("#"+i).attr("data",o),e("#"+i).val(o.replace(/[^\*]/,"."))}),"SMS"==p.get("migSetSecQuesAuthMode")?(e("#challengeText").html(""),e("#myModalLabel").html(e.i18n.t("app.registration.verificationlabel")),e("#otpHelpText").html(e.i18n.t("app.registration.opthelptext")+" "+maskMobile(p.get("contactNumber")))):"EMAIL"==p.get("migSetSecQuesAuthMode")?(e("#challengeText").html(""),e("#myModalLabel").html(e.i18n.t("app.registration.verificationlabel")),e("#otpHelpText").html(e.i18n.t("app.registration.opthelpemailtext")+" "+maskEmailID(p.get("emailId")))):"ESIGN"==p.get("migSetSecQuesAuthMode")&&(e("#otpHelpText").html(e.i18n.t("app.registration.otphelpesigntext")),e("#myModalLabel").html(e.i18n.t("app.registration.verificationlabel")),e("#challengeText").html(e.i18n.t("app.transferss.genratedTocn")+" "+p.get("otpCode"))),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""),"SMS"==p.get("migSetSecQuesAuthMode")||"EMAIL"==p.get("migSetSecQuesAuthMode")?i.appendOTPContainer():e("#OTPcontainer1").hide(),("SMS"==p.get("migSetSecQuesAuthMode")||"EMAIL"==p.get("migSetSecQuesAuthMode"))&&(u=null,e("#otpNullError").html(""),i.invokeOTPSpinner())},n=function(e){i.errorresponse()};showSpinner(),i.collection=new r;getDeviceId(),(new Date).getTime();i.collection.fetch({data:e.param({ibUserName:p.get("loginuser_id"),mobileNumber:p.get("contactNumber"),resendflag:t,alerttype:p.get("migSetSecQuesAuthMode"),servicecode:"SELF_REGISTRATION"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?o(e):n(e)},error:n})},appendOTPContainer:function(){var t=this,i="";e("#otpContainerDiv").html(""),i+="<div class='form-group'><div id='OTPcontainer1'></div><p class='text-center small'><a href='javascript:void(0);'class='resend_button' id='miguser_resend_btn'>Resend OTP</a></p></div>",e("#otpContainerDiv").append(i),e("#miguser_resend_btn").click(function(){t.validateOTPGeneration("Y")})},invokeOTPSpinner:function(){var t=this;return e("#miguser_resend_btn").hide(),t.appendOTPContainer(),e("#OTPcontainer1").show(),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""),null!=u?(u.set(1),void u.animate(0,function(){e("#OTPcontainer1").slideUp("slow")})):(u=new ProgressBar.Circle(OTPcontainer1,{color:"#333",strokeWidth:8,trailWidth:8,easing:"linear",duration:6e4*parseInt(p.get("otpExpiryPeriod")),text:{autoStyleContainer:!1},from:{color:"#ec5f59",width:8},to:{color:"#ec5f59",width:8},step:function(t,i){i.path.setAttribute("stroke",t.color),i.path.setAttribute("stroke-width",t.width);var o=Math.round(i.value()*(60*p.get("otpExpiryPeriod")));"0"==o?(i.setText(""),e("#miguser_resend_btn").show()):(e("#miguser_resend_btn").hide(),i.setText(o+"s"))}}),u.text.style.fontFamily='"Raleway", Helvetica, sans-serif',u.text.style.fontSize="12px",u.text.style.fontWeight="bold",u.set(1),void u.animate(0,function(){e("#OTPcontainer1").slideUp("slow")}))},revokeOTPSpinner:function(){null!=u&&u.stop()},gotoSecQuesSuccessPopup:function(t){t.stopImmediatePropagation(),e("#otpNullError").html(""),e("#otpNullErrorDiv").hide();var i=this,o=e("#otp1").attr("data"),n=e("#otp2").attr("data"),r=e("#otp3").attr("data"),s=e("#otp4").attr("data"),l=e("#otp5").attr("data"),c=e("#otp6").attr("data"),u=o+""+n+r+s+l+c;if(isNull(o)||isNull(n)||isNull(r)||isNull(s)||isNull(l)||isNull(c))return e("#otpNullErrorDiv").show(),void e("#otpNullError").html(e.i18n.t("validation.newregistration.otpnotnull"));var d=function(o){hideSpinner(),i.revokeOTPSpinner(),e("#verify").modal("hide"),i.setMigratedSecureQuestion(t)},g=function(t){hideSpinner(),isNull(p.get("errordesc"))||(e("#otpNullErrorDiv").show(),e("#otpNullError").html(p.get("errordesc")))};showSpinner(),i.collection=new a;getDeviceId(),(new Date).getTime();i.collection.fetch({data:e.param({activationno:u,mobileNumber:p.get("contactNumber"),ibUserName:p.get("loginuser_id"),twoFAType:p.get("migSetSecQuesAuthMode"),servicecode:"SELF_REGISTRATION"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?d(e):g(e)},error:g})},setMigratedSecureQuestion:function(t){t.stopImmediatePropagation();var i,o=this,n=(new Date).getTime(),r=p.get("customerIDs"),a=p.get("migratedPassword"),l=/iPad|iPhone|iPod/.test(navigator.userAgent);i=l?"IOSMOBILE":"ANDROIDMOBILE";var c=DEcryptWithDynamicSalt(r,n),u=EncryptWithDynamicSalt(c,n),d=EncryptWithDynamicSalt(a,n),g=function(t){hideSpinner(),e("#success").modal("show")},m=function(e){o.errorresponse()};showSpinner(),o.collection=new s;getDeviceId(),(new Date).getTime();o.collection.fetch({data:e.param({qnsans:p.get("getQuesAns"),salt:n,cifNo:u,ibUserName:p.get("preloginUsername"),passcode:d,email:p.get("migratedEmailID"),miguser:"Y",appVersion:p.get("app.versionCode"),appVersionHashing:p.get("appVersionHashing"),deviceModel:p.get("device.model"),osVersion:p.get("device.version"),platform:i}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?g(e):m(e)},error:m})},gotoLoginPage:function(e){e.stopImmediatePropagation(),i.history.navigate("#/login")},errorresponse:function(e){hideSpinner(),openErrorPopup()}});return d});