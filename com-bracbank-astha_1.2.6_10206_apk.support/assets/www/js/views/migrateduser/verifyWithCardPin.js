define(["jquery","underscore","Backbone","collections/login/forgotPasswordOTPCollections","collections/applanding/Registration/cardPinValidationCollections","collections/login/generateSoftTokenCollections","collections/applanding/Registration/otpGenerationCollections","collections/applanding/Registration/otpVerificationCollections","collections/applanding/Registration/getAuthModeCollections","text!views/migrateduser/verifyWithCardPin.tpl"],function(e,t,i,n,r,o,a,l,c,s){var d=null,p=new EncryptedLocalStorage("secret"),u=i.View.extend({el:"#container",events:{"click #migrated_verify_btn":"gotoVerifySuccessPopUp","click #migrated_next_btn":"verifyOTP","click #migrated_cancel_btn":"backToLogin","click #migrated_popup_cancel_btn":"revokeOTPSpinner","click #migrated_close_btn":"revokeOTPSpinner"},initialize:function(){},update:function(){d=null;var e=this;e.getAuthmode()},getAuthmode:function(){var t=this;e("#migNonFrequentUserAuthModeDiv").html("");var i=function(e){hideSpinner(),t.populateAuthModeDiv()},n=function(e){hideSpinner(),t.populateAuthModeDiv()};t.collection=new c,t.collection.fetch({data:e.param({access_token:p.get("access_token"),transactionAmount:null,tenantServiceCode:"SELF_REGISTRATION",miguser:"Y",ulpId:p.get("ulpID")}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?i(e):n(e)},error:n})},populateAuthModeDiv:function(){var i="",n="",r=this;r.$el.html(t.template(s));var o=p.get("securitySettingList"),a="<label for='username'>"+e.i18n.t("app.transfer.managebeneficiary.selectauthorisationmode")+"</label>";a+="<div class='custRadio_pass'>",!isNull(o)&&o.length>0?(e("#migNonFrequentUserAuthModeDiv").html(""),e.each(o,function(t,r){"SMS"==r?(i="sms",n=e.i18n.t("app.transfer.managebeneficiary.sms")):"EMAIL"==r?(i="mail",n=e.i18n.t("app.transfer.managebeneficiary.mail")):"TOKEN"==r?(i="fScan",n=e.i18n.t("app.transfer.managebeneficiary.token")):"ESIGN"==r&&(i="esign",n=e.i18n.t("app.transfer.managebeneficiary.esign")),a+='<div class="box"><div class="radio"><label>',a+=0==t?'<input type="radio" name="migVerifyCard_AuthMode" id="migrateNonUserFrequent'+t+'" value="'+r+'" checked>':'<input type="radio" name="migVerifyCard_AuthMode" id="migrateNonUserFrequent'+t+'" value="'+r+'">',a+='<div class="row bg"><div class="col-xs-12 p0"><span class="menu_icon ico-xs '+i+'"></span><span class="small">'+n+"</span></div></div></label></div></div>"}),e("#migNonFrequentUserAuthModeDiv").html(a)):e("#migNonFrequentUserAuthModeDiv").html("")},verifyOTP:function(){e("#error_card").html(""),e("#error_pin").html(""),e("#otpNullError").html(""),e("#otpNullErrorDiv").hide();var t=this,i=/[0-9]/g,n=e("#card_number").val(),r=e("#mpininput").val();return""==n?("DC"==p.get("cardType")&&(2==p.get("isInputVisible")?e("#error_card").html(e.i18n.t("Please enter the second 4 digit of your debit card number")):e("#error_card").html(e.i18n.t("Please enter the third 4 digit of your debit card number"))),void("CC"==p.get("cardType")&&(2==p.get("isInputVisible")?e("#error_card").html(e.i18n.t("Please enter the second 4 digit of your credit card number")):e("#error_card").html(e.i18n.t("Please enter the third 4 digit of your credit card number"))))):n.length<4?("DC"==p.get("cardType")&&(2==p.get("isInputVisible")?e("#error_card").html(e.i18n.t("Please enter the second 4 digit of your debit card number")):e("#error_card").html(e.i18n.t("Please enter the third 4 digit of your debit card number"))),void("CC"==p.get("cardType")&&(2==p.get("isInputVisible")?e("#error_card").html(e.i18n.t("Please enter the second 4 digit of your credit card number")):e("#error_card").html(e.i18n.t("Please enter the third 4 digit of your credit card number"))))):n.match(i)?r.length<4?void e(".pincode-input-error").html(e.i18n.t("app.forgotpassword.errvalpin")):r.match(i)?void t.cardPinValidation():void e(".pincode-input-error").html(e.i18n.t("validation.newregistration.pinnumberonly")):void e("#error_card").html(e.i18n.t("validation.newregistration.cardnumberonly"))},cardPinValidation:function(){for(var t=e("#card_number").val(),i=e("#mpininput").val(),n=[],o=p.get("cardnumber"),a=0,l=o.length;l>a;a+=4)n.push(o.substring(a,a+4));var c=p.get("isInputVisible");2==c?cardnum=n[0]+t+"****"+n[3]:cardnum=n[0]+"****"+t+n[3];var s=this,d=p.get("shadowAccountNumber"),u=(new Date).getTime();p.set("saltreg",u),ccnum=EncryptWithDynamicSalt(cardnum,u),ccpinnum=EncryptWithDynamicSalt(i,u),shadowacntnum=EncryptWithDynamicSalt(d,u);var h=function(e){hideSpinner(),s.validateCardPin("N")},m=function(e){s.errorresponse()};showSpinner(),s.collection=new r;getDeviceId(),(new Date).getTime();s.collection.fetch({data:e.param({ccno:ccnum,ccpinno:ccpinnum,shadowAccountNumber:shadowacntnum,salt:u,cardtype:p.get("cardtype"),flag:"FP"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?h(e):m(e)},error:m})},validateCard:function(t){var i="",n=p.get("authmode");if(p.set("alertType",n),"SMS"==n)var r=p.get("mobileNo"),o=null;else if("EMAIL"==n)var r=null,o=p.get("emailID");p.set("mobilenum",r),p.set("eMailId",o);var l=this,c=function(n){hideSpinner(),"Y"==t&&(e("#OTPcontainer1").slideDown("slow"),d.set(1),d.animate(0,function(){e("#OTPcontainer1").slideUp("slow")})),e("#verify").modal("show"),setTimeout(function(){e("#otp1").focus()},500),e("#otpNullError").html(""),e("#otpNullErrorDiv").hide(),e(".inputs").on("input",function(t){t.stopImmediatePropagation();var i=t.currentTarget.id,n=e("#"+i).val();e("#"+i).attr("data",n),e("#"+i).val(n.replace(/[^\*]/,"."))}),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").removeAttr("data"),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""),"SMS"==p.get("alertType")?(e("#challengeText").html(""),i=e.i18n.t("app.registration.opthelptext")+" "+maskMobile(p.get("mobileNo"))):"EMAIL"==p.get("alertType")?(e("#challengeText").html(""),i=e.i18n.t("app.registration.opthelpemailtext")+" "+maskEmailID(p.get("emailID"))):"ESIGN"==p.get("alertType")&&(i=e.i18n.t("app.registration.otphelpesigntext"),e("#challengeText").html(e.i18n.t("app.transferss.genratedTocn")+" "+p.get("otpCode"))),e("#otpHelpText").html(i),l.invokeOTPSpinner()},s=function(e){l.errorresponse()},u=p.get("customerIDs"),h=p.get("saltreg"),m=DEcryptWithDynamicSalt(u,h);cusId=EncryptWithDynamicSalt(m,h);var l=this;showSpinner(),l.collection=new a;getDeviceId(),(new Date).getTime();l.collection.fetch({data:e.param({salt:h,cifId:cusId,mobileNumber:p.get("mobileNo"),email:p.get("emailID"),serviceProvider:null,resendflag:t,alerttype:p.get("alertType"),servicecode:"SELF_REGISTRATION"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?c(e):s(e)},error:s})},invokeOTPSpinner:function(){var t=this;return e("#resend_btn2").hide(),e("#OTPcontainer1").show(),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""),null!=d?(d.set(1),void d.animate(0,function(){e("#OTPcontainer1").slideUp("slow")})):(d=new ProgressBar.Circle(OTPcontainer1,{color:"#333",strokeWidth:8,trailWidth:8,easing:"linear",duration:6e4*parseInt(p.get("otpExpiryPeriod")),text:{autoStyleContainer:!1},from:{color:"#ec5f59",width:8},to:{color:"#ec5f59",width:8},step:function(t,i){i.path.setAttribute("stroke",t.color),i.path.setAttribute("stroke-width",t.width);var n=Math.round(i.value()*(60*p.get("otpExpiryPeriod")));"0"==n?(i.setText(""),e("#resend_btn2").show()):(e("#resend_btn2").hide(),i.setText(n+"s"))}}),d.text.style.fontFamily='"Raleway", Helvetica, sans-serif',d.text.style.fontSize="12px",d.text.style.fontWeight="bold",d.set(1),d.animate(0,function(){e("#OTPcontainer1").slideUp("slow")}),void e("#resend_btn2").click(function(){t.validateCard("Y")}))},revokeOTPSpinner:function(){null!=d&&d.stop()},validateCardPin:function(){var t=this,i=e("input[name='migVerifyCard_AuthMode']:checked").val();p.set("authmode",i),"SMS"==i||"EMAIL"==i||"ESIGN"==i?(t.validateCard("N"),e("#myModalLabel").html(e.i18n.t("app.registration.verificationlabel"))):(p.set("otpCode",""),e("#verify").modal("show"),"TOKEN"==p.get("authmode")&&(e("#challengeText").html(""),e("#myModalLabel").html(e.i18n.t("app.registration.otptokenheadertext")),e("#otpHelpText").html(e.i18n.t("app.registration.opthelptokentext"))),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").removeAttr("data"),e("#resend_btn2").hide(),e("#OTPcontainer1").hide(),e("#otpNullError").html(""),e("#otpNullErrorDiv").hide(),e(".inputs").on("input",function(t){t.stopImmediatePropagation();var i=t.currentTarget.id,n=e("#"+i).val();e("#"+i).attr("data",n),e("#"+i).val(n.replace(/[^\*]/,"."))}),e("#otp1, #otp2, #otp3, #otp4, #otp5, #otp6").val(""))},gotoVerifySuccessPopUp:function(){e("#otpNullError").html(""),e("#otpNullErrorDiv").hide();var t=e("#otp1").attr("data"),n=e("#otp2").attr("data"),r=e("#otp3").attr("data"),o=e("#otp4").attr("data"),a=e("#otp5").attr("data"),c=e("#otp6").attr("data");if(isNull(t)||isNull(n)||isNull(r)||isNull(o)||isNull(a)||isNull(c))return e("#otpNullErrorDiv").show(),void e("#otpNullError").html(e.i18n.t("validation.newregistration.otpnotnull"));var s=t+n+r+o+a+c,d=this,u=function(t){hideSpinner(),e("#verify").modal("hide"),i.history.navigate("#/migratedsetpassword")},h=function(t){hideSpinner(),isNull(p.get("errordesc"))||(e("#otpNullErrorDiv").show(),e("#otpNullError").html(p.get("errordesc")))},m=p.get("customerIDs"),g=p.get("saltreg"),v=DEcryptWithDynamicSalt(m,g);cusId=EncryptWithDynamicSalt(v,g);var d=this;showSpinner(),d.revokeOTPSpinner(),d.collection=new l;getDeviceId(),(new Date).getTime();d.collection.fetch({data:e.param({activationno:s,salt:g,cifId:cusId,mobileNumber:p.get("mobileNo"),email:p.get("emailID"),serviceProvider:null,twoFAType:p.get("authmode"),servicecode:"SELF_REGISTRATION"}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?u(e):h(e)},error:h})},backToLogin:function(){i.history.navigate("#/login")},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(e){return i.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return u});