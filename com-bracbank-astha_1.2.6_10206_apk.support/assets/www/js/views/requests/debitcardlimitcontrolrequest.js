define(["jquery","underscore","Backbone","collections/requests/blockDebitCardRequestCollections","collections/requests/DebitCardLimitControlRequestCollections","collections/requests/DebitCardLimitControlSegmentRequestCollections","models/validation/tedallal/tedallalValidationModel","text!views/requests/debitcardlimitcontrolrequest.tpl"],function($,_,Backbone,blockDebitCardRequestCollections,debitCardLimitControlRequestCollections,debitCardLimitControlSegmentRequestCollections,tedallalValidationModel,debitcardlimitcontrolrequest){var els=new EncryptedLocalStorage("secret"),debitcardPOS=Backbone.View.extend({el:"#mobcontent",events:{"click #validatePoints":"validatePoints","change #serviceType":"convertedamount","click #newposlimit":"openNumPad"},openNumPad:function(){id="newposlimit";var e=/iPad|iPhone|iPod/.test(navigator.userAgent),t=els.get("isKeyPadNeed");e&&t&&navigator.notification.keypadOpen($("#"+id).val(),9,function(e){$("#"+id).val(convertNumbers2English(e))},function(e){$("#"+id).val(convertNumbers2English(e))})},update:function(){var e=this;timestamp=(new Date).getTime();var t=function(t){e.currentlimitcompile()},i=function(t){e.errorresponse()};e.collection=new blockDebitCardRequestCollections([],{});els.get("custno");showSpinner(),timestamp=(new Date).getTime();e.collection.fetch({data:$.param({status:"ACTIVE",requestid:timestamp}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(e){"0000"==ackStatus?t(e):i(e)},error:i})},currentlimitcompile:function(){var e=this;timestamp=(new Date).getTime();var t=function(t){e.requestcompile()},i=function(t){e.errorresponse()};e.collection=new debitCardLimitControlSegmentRequestCollections([],{});els.get("custno");showSpinner(),timestamp=(new Date).getTime();var a=(els.get("custno"),els.get("upsegment"));e.collection.fetch({data:$.param({serviceid:"25",segment:a,requestid:timestamp}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(els.get("calltimeout")),success:function(e){"0000"==ackStatus?t(e):i(e)},error:i})},requestcompile:function(){return hideSpinner(),this.$el.html(_.template(debitcardlimitcontrolrequest,{})).i18n(),this.$el.trigger("create"),this},convertedamount:function(){$("#convDivId").hide();var e=$("#serviceType option:selected").text();els.set("maskActno",e);var t=$("#serviceType option:selected").val(),i=t.split("~"),a=i[0];els.set("accnumval",a);var n=i[1];els.set("formatedexpirydate",n);var o=i[3];if(els.set("cardSeqnbr",o),""!=t){showSpinner();var r=this,l=function(e){r.errorresponse()};r.collection=new debitCardLimitControlRequestCollections([],{});var s=(new Date).getTime();r.collection.fetch({data:$.param({debitCardNumber:a,expdate:n,cardseq:o,requestid:s}),dataType:"json",type:"POST",timeout:parseInt(els.get("calltimeout")),cache:!1,success:function(e){if("0000"==ackStatus){var t="KWD",i=els.get("currentlimit"),a=checkAmount($.formatNumber(i,{format:"#,###.000",locale:"us"}));$("#displayamt").html("<span class='cur'>"+t+"</span>&nbsp;"+a),document.getElementById("convDivId").style.display="block",hideSpinner()}else l(e)},error:l})}hideSpinner()},validatePoints:function(){$("#errorlimitamtcheck").hide(),$("#errorMinAmount").hide(),$("#errorlimitsamecheck").hide(),$("#erroratmCardDTO").hide(),this.model=new tedallalValidationModel({url:"json/"}),Backbone.Validation.bind(this);var data=this.$("form").serializeObject();if(this.model.set(data,{validate:!0})){this.model.clear(),Backbone.Validation.unbind(this);var that=this,newposlimit=$("#newposlimit").val();els.set("newposlimit",newposlimit);var currentposlimit=$("#currentposlimit").val();els.set("currentposlimit",currentposlimit),els.set("displayamt",displayamt);var currentposlimitval=$("#currentposlimit").val(),newposlimitval=$("#newposlimit").val(),displayamtval=els.get("currentlimit");if(eval(newposlimitval)>eval(currentposlimitval))return $("#errorlimitamtcheck").show(),!1;if(2>newposlimitval)return $("#errorMinAmount").show(),!1;if(eval(newposlimitval)==eval(displayamtval))return $("#errorlimitsamecheck").show(),!1;var atmCardDTO=els.get("atmCardDTO");if(!(atmCardDTO.length>0))return $("#erroratmCardDTO").show(),!1;atmCardDTO.forEach(function(e){return"1"==e.atmstatus||"9"==e.atmstatus&&"FALSE"==e.block?(showSpinner(),void that.verificationcompile()):($("#erroratmCardDTO").show(),!1)})}},verificationcompile:function(){hideSpinner(),Backbone.history.navigate("#/debitcardlimitcontrolconfirmrequest")},errorresponse:function(){hideSpinner(),Backbone.history.navigate("#/exception")}});return debitcardPOS});