define(["jquery","underscore","Backbone","collections/accounts/casaDetailStatementCollections","collections/wealth/ccsummeryCollections","models/validation/statementFilterValidationModel","text!views/accounts/statementDwldDetailStatement.tpl"],function(t,e,a,r,o,l,i){var n=new EncryptedLocalStorage("secret"),c=a.View.extend({el:"#container",events:{"click #getstatement":"getstatement","change #periodFilter":"getPeriodRange","click #detailStatementSelAcc":"openSelectAccDropDown","click .stmtdwld_acccardtypenum":"getSelectedAccountInfo"},initialize:function(){},update:function(){var t=this;t.getCardSumamry()},getCardSumamry:function(){var e=this,a=function(t){hideSpinner(),e.loadTemplate()},r=function(t){e.errorresponse()};showSpinner(),e.collection=new o([],{});getDeviceId();e.collection.fetch({data:t.param({newversion:"Y",access_token:n.get("access_token")}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?a(t):r(t)},error:r})},loadTemplate:function(){this.$el.html(e.template(i)),t("html").removeClass().addClass("app"),t("#stmtDwldFilterDiv").show()},getPeriodRange:function(){var e=this,a=t("#periodFilter option:selected").val();if(""==a)return t("#fromDate").val(""),void t("#toDate").val("");if("twoWeeks"==a){n.set("periodType","twoWeeks");var r=e.calculateFromDate();t("#fromDate").val(r),n.set("fromDate",r)}else if("oneMonth"==a){n.set("periodType","oneMonth");var r=e.calculateFromDate();t("#fromDate").val(r),n.set("fromDate",r)}else if("threeMonths"==a){n.set("periodType","threeMonths");var r=e.calculateFromDate();t("#fromDate").val(r),n.set("fromDate",r)}else if("sixMonths"==a){n.set("periodType","sixMonths");var r=e.calculateFromDate();t("#fromDate").val(r),n.set("fromDate",r)}else if("oneYear"==a){n.set("periodType","oneYear");var r=e.calculateFromDate();t("#fromDate").val(r),n.set("fromDate",r)}else if("lastFinYear"==a){n.set("periodType","lastFinYear");var e=this;return void e.calculateFinancialYear()}var o=new Date,l=o.getDate(),i=o.getMonth()+1,c=o.getFullYear(),s=("00"+l.toString()).slice(-2)+"-"+("00"+i.toString()).slice(-2)+"-"+("0000"+c.toString()).slice(-4);t("#toDate").val(s),n.set("toDate",s)},calculateFromDate:function(){var t=this,e=t.dateFunction(),a=e.getMonth()+1,r=e.getDate(),o=e.getFullYear(),l=("00"+r.toString()).slice(-2)+"-"+("00"+a.toString()).slice(-2)+"-"+("0000"+o.toString()).slice(-4);return l},dateFunction:function(){var t=n.get("periodType"),e=new Date;if("twoWeeks"==t){n.set("filterBy","L2W");var a=new Date(e.getFullYear(),e.getMonth(),e.getDate()-14)}else if("oneMonth"==t){n.set("filterBy","L1M");var a=new Date(e.getFullYear(),e.getMonth()-1,e.getDate())}else if("threeMonths"==t){n.set("filterBy","L3M");var a=new Date(e.getFullYear(),e.getMonth()-3,e.getDate())}else if("sixMonths"==t){n.set("filterBy","L6M");var a=new Date(e.getFullYear(),e.getMonth()-6,e.getDate())}else if("oneYear"==t){n.set("filterBy","L1Y");var a=new Date(e.getFullYear()-1,e.getMonth(),e.getDate())}return a},getstatement:function(e){e.stopImmediatePropagation(),t("#fromAmtErr").html(""),t("#toAmtErr").html(""),t("#filterTypeError").html(""),t("#filterPeriodError").html(""),t("#fromDateError").html(""),t("#toDateError").html(""),t("#selectAccErr").html("");var r=this;if("CASA"==n.get("selAccType")){this.model=new l({url:"json/"}),a.Validation.bind(this);var o=this.$("form").serializeObject();if(this.model.set(o,{validate:!0})){this.model.clear(),a.Validation.unbind(this);var i=t("#fromAmt").val(),c=t("#toAmt").val(),s=t("#typeFilter option:selected").val();n.set("Stype",s);var m=t("#periodFilter option:selected").val(),d=t("#fromDate").val();n.set("stmtFromDate",d);var u=t("#toDate").val();if(n.set("stmtToDate",u),isNull(n.get("selAccID")))return void t("#selectAccErr").html("Please select an account/card");if(parseFloat(i)>parseFloat(c))return void t("#fromAmtErr").html(t.i18n.t("validation.statementfilter.fromamt"));if(parseFloat(c)<parseFloat(i))return void t("#toAmtErr").html(t.i18n.t("validation.statementfilter.toamt"));if("specificDate"==m){var d=t("#fromDate").val(),u=t("#toDate").val(),g=d.split("-"),f=g[2],v=g[1],p=g[0],D=new Date(p,v,f),h=f+"-"+v+"-"+p;n.set("stmtFromDate",h);var y=u.split("-"),w=y[2],S=y[1],F=y[0],A=new Date(F,S,w),T=w+"-"+S+"-"+F;n.set("stmtToDate",T);var C=new Date,M=C.getDate(),E=C.getMonth()+1,_=C.getFullYear(),I=new Date(_,E,M),Y=12*F-12*p,k=S-v,P=w-f;if((Y>0||0===Y||P>0)&&(k=k+Y+P/30),D.getTime()>I.getTime())return void t("#fromDateError").html(t.i18n.t("validation.statementfilter.frmdat"));if(A.getTime()>I.getTime())return void t("#toDateError").html(t.i18n.t("validation.statementfilter.todat"));if(D.getTime()>A.getTime())return void t("#fromDateError").html(t.i18n.t("validation.statementfilter.frmdate1"));if(k>6)return void t("#toDateError").html(t.i18n.t("validation.statementfilter.fromsix"))}r.getDetailedStatement(e)}else this.$(".has-error").fadeIn(),e.preventDefault()}else"CC"==n.get("selAccType")&&r.gotoCCStatementPage(e)},gotoCCStatementPage:function(t){t.stopImmediatePropagation(),n.set("isFromStatementDwld","true"),n.set("statementType","all");var e=n.get("selAccInd");a.history.navigate("#/ccsummaryview/"+e)},calculateFinancialYear:function(){n.set("filterBy","LFY");var e=new Date,a=(e.getDate(),e.getMonth()+1),r=e.getFullYear(),o="01",l="07",i="30",c="06";if(7>a)var s=r-2,m=r-1;else if(a>=7)var s=r-1,m=r;var d=("00"+o.toString()).slice(-2)+"-"+("00"+l.toString()).slice(-2)+"-"+("0000"+s.toString()).slice(-4),u=("00"+i.toString()).slice(-2)+"-"+("00"+c.toString()).slice(-2)+"-"+("0000"+m.toString()).slice(-4);t("#fromDate").val(d),t("#toDate").val(u),n.set("fromDate",d)},getDetailedStatement:function(e){e.stopImmediatePropagation();var o=t("#fromAmt").val(),l=t("#toAmt").val();isNull(o)?n.set("frmAmt",""):n.set("frmAmt",o),isNull(l)?n.set("toamt",""):n.set("toamt",l);var i=t("#typeFilter option:selected").val(),c=(t("#periodFilter option:selected").val(),n.get("accountId")),s=n.get("stmtFromDate"),m=n.get("stmtToDate"),d=c+s+m,u=null==d?"":d;checkSumEncrypt(u);var g=localStorage.getItem("FINALCHECKSUM"),f=this,v=function(t){hideSpinner(),n.set("isFromStatementDwld","true"),a.history.navigate("#/accdetailstatement")},p=function(t){f.errorresponse()};showSpinner(),f.collection=new r,f.collection.fetch({data:t.param({access_token:n.get("access_token"),acctCategory:n.get("selAccCategory"),accountID:n.get("selAccID"),debitCreditFlag:i,appchecksum:g,fromAmount:o,toAmount:l,lastnTxn:null,branch:n.get("selAccBranchDesc"),toDate:n.get("stmtToDate"),fromDate:n.get("stmtFromDate"),module:"FILTERED",filterby:n.get("filterBy"),sortBy:null,sortOrder:"ASC"}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?v(t):p(t)},error:p})},openSelectAccDropDown:function(e){"object"==typeof e&&(e.preventDefault(),e.stopImmediatePropagation()),t("#card_account").modal("show")},getSelectedAccountInfo:function(e){"object"==typeof e&&(e.preventDefault(),e.stopImmediatePropagation());var a=t(e.target).closest("li.stmtdwld_acccardtypenum").attr("Accide");n.set("selAccID",a);var r=t(e.target).closest("li.stmtdwld_acccardtypenum").attr("id");n.set("selAccInd",r);var o=t(e.target).closest("li.stmtdwld_acccardtypenum").attr("acctype");n.set("selAccType",o);var l=t(e.target).closest("li.stmtdwld_acccardtypenum").attr("data");n.set("selAccCurr",l),n.set("creditcardCurrency",l);var i=t(e.target).closest("li.stmtdwld_acccardtypenum").attr("accCategory");n.set("selAccCategory",i);var c=t(e.target).closest("li.stmtdwld_acccardtypenum").attr("branchDesc");n.set("selAccBranchDesc",c);var s=t(e.target).closest("li.stmtdwld_acccardtypenum").attr("productCode");n.set("productCode",s);var m=t(e.target).closest("li.stmtdwld_acccardtypenum").attr("availBalance");n.set("avlBalance",m);var d=t(e.target).closest("li.stmtdwld_acccardtypenum").attr("cardName");n.set("cardName",d);var u=t(e.target).closest("li.stmtdwld_acccardtypenum").attr("outStandingAmount");n.set("outStandingAmount",u),t('li.stmtdwld_acccardtypenum[accide="'+a+'"]').find("input").attr("checked","checked");var g=t(e.target).closest("li.stmtdwld_acccardtypenum").find(".row").clone().html();n.set("selectedFromAccountValue",g);var f='<div class="qr_acc_outer">\n <ul class="list-unstyled m0">\n <li class="list-group-item">\n'+g+"</li>\n </ul>\n </div>";t("#seltpayval").html(f),t("#card_account .close").trigger("click"),"CASA"==o?t("#stmtDwldFilterDiv").show():"CC"==o&&t("#stmtDwldFilterDiv").hide()},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(t){return a.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=t,this.currentView.delegateEvents(),this.currentView}});return c});