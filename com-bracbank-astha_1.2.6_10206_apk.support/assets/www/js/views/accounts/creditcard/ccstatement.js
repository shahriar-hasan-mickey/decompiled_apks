define(["jquery","underscore","Backbone","collections/wealth/carddetailsCollections","collections/wealth/creditcardDetailStatementCollections","collections/accounts/casaEmailStmtShareCollections","collections/wealth/getSixmonthStatementCollections","models/validation/emailShareValidationModel","text!views/accounts/creditcard/ccstatement.tpl","text!views/accounts/creditcard/unBilledStatement.tpl","text!views/accounts/creditcard/ccBilledStatement.tpl","text!views/accounts/creditcard/ccPslm.tpl","text!views/accounts/creditcard/ccLastSixMonthStatement.tpl","views/errors/exception"],function(t,e,a,n,s,i,o,l,c,r,d,m,p,h){var u=new EncryptedLocalStorage("secret"),S=a.View.extend({el:"#container",events:{"click #goto_creditcardlist":"gotoCreditCardList","click #goto_ccstmt":"getcardstatementList","click #financialsummary":"openFinancialSummaryPopUp","click #rewardpoints":"gotoRewardPoints","click #unbilled":"getUnBilledStatement","click #billed":"getBilledStatement","click #paysincelaststmt":"getPaymentSinceLastStatement","click #lastsixmonth":"getLastSixMonthStatement","click #dwldUnbilledPDF":"PDFDownload","click #shareBtn":"showSharePopUp","click #usernametip":"showPasswordTipPopUp","click #sendBtnUB":"showMailSentSuccessPopUp","click #ok":"backToSharePopUp","click #otherMail":"showOtherMailDiv","click .dwdPDF":"PDFDownload1","click #myMail":"showMyMailDiv"},initialize:function(){},render:function(e){t("body #expenseSum").removeClass("").addClass("modal-open");var a=this;u.set("creditCardId",e),"all"==u.get("statementType")?(u.set("isCreditCardUnBilledList","false"),a.getUnBilledStatement()):"unbilled"==u.get("statementType")?a.getUnBilledStatement():"billed"==u.get("statementType")?a.getBilledStatement():"pslm"==u.get("statementType")?a.getPaymentSinceLastStatement():"lastsixmonths"==u.get("statementType")&&a.getLastSixMonthStatement()},PDFDownload1:function(e){e.stopImmediatePropagation();var a=t(e.target).attr("value");u.set("statementDate",a);var n="",s=u.get("app.context.path");n=s+"account/ministatement/download.pdf";var i="access_token="+u.get("access_token")+"&emailRequired=&accountID="+u.get("ccardId")+"&fromAmount=&toAmount=&lastnTxn=&type=CARDS&toDate=&fromDate=&debitCreditFlag=B&cardtype=CC&authtype=&statementType=LAST6STATEMENTS&statementDate="+u.get("statementDate")+"&module=FILTERED&filterby=&sortBy=&sortOrder=ASC",o=encodeURI(i);fileDownLoadAndViewer(n,o,1,u.get("access_token"))},getUnBilledStatement:function(e){var a=this;"object"==typeof e&&(u.set("isCreditCardUnBilledList","false"),e.stopImmediatePropagation());var n=u.get("creditCardAccountList");isNull(n)||(n=n.filter(function(t){return"Y"==t.casaflag}));var i=n[u.get("creditCardId")].id;u.set("ccardId",i);var o=u.get("isCreditCardUnBilledList");if("false"==o){showSpinner();var l=function(t){hideSpinner(),a.loadUnBilledStatement()},c=function(t){a.errorresponse()};a.collection=new s,a.collection.fetch({data:t.param({access_token:u.get("access_token"),accountId:u.get("ccardId"),newversion:"Y",type:"NORMAL",flag:"CC",statementType:"UNBILLED",txnType:"Data"}),dataType:"json",type:"POST",cache:!1,success:function(t){if("0000"==ackStatus){var e=u.get("errorcode");"9999"==e?c(t):l(t)}else c(t)},error:c})}else a.loadUnBilledStatement()},loadUnBilledStatement:function(){u.set("statementType","unbilled"),u.set("isCreditCardUnBilledList","true"),t("html").removeClass().addClass("app state"),t("div").removeClass("modal-backdrop fade in"),this.$el.html(e.template(c)),t("#statementType").html(t.i18n.t("app.ccstatement.unbilledstatement")+' <span class="caret"></span>'),t("#creditcard_detail_list").html(e.template(r))},getBilledStatement:function(a){"object"==typeof a&&(u.set("isCreditCardBilledList","false"),a.stopImmediatePropagation());var n=this;this.$el.html(e.template(c));var i=u.get("isCreditCardBilledList");if("false"==i){showSpinner(),t("#statementType").html(t.i18n.t("app.ccstatement.billedstatement")+' <span class="caret"></span>');var o=function(t){hideSpinner(),n.loadBilledStatement()};n.collection=new s;var l=function(t){n.errorresponse()};n.collection.fetch({data:t.param({access_token:u.get("access_token"),accountId:u.get("ccardId"),type:"PENDING",flag:"CC",newversion:"Y",statementType:"BILLED",txnType:"Data"}),dataType:"json",type:"POST",cache:!1,success:function(t){if("0000"==ackStatus){var e=u.get("errorcode");"9999"==e?l(t):o(t)}else l(t)},error:l})}else n.loadBilledStatement()},loadBilledStatement:function(){u.set("statementType","billed"),u.set("isCreditCardBilledList","true"),t("html").removeClass().addClass("app state"),t("#statementType").html(t.i18n.t("app.ccstatement.billedstatement")+' <span class="caret"></span>'),t("#creditcard_detail_list").html(e.template(d))},getPaymentSinceLastStatement:function(a){"object"==typeof a&&(u.set("isCreditPaymentLast","false"),a.stopImmediatePropagation());var n=this;this.$el.html(e.template(c));var i=u.get("isCreditPaymentLast");if("false"==i){showSpinner(),t("#statementType").html(t.i18n.t("app.ccstatement.paymentsincelaststatement")+' <span class="caret"></span>');var o=function(t){hideSpinner(),n.loadPaymentSinceLastStatement()};n.collection=new s;var l=function(t){n.errorresponse()};n.collection.fetch({data:t.param({access_token:u.get("access_token"),accountId:u.get("ccardId"),type:null,flag:"CC",newversion:"Y",statementType:"PSLM",txnType:"Data"}),dataType:"json",type:"POST",cache:!1,success:function(t){if("0000"==ackStatus){var e=u.get("errorcode");"9999"==e?l(t):o(t)}else l(t)},error:l})}else n.loadPaymentSinceLastStatement()},loadPaymentSinceLastStatement:function(){u.set("statementType","pslm"),u.set("isCreditPaymentLast","true"),t("html").removeClass().addClass("app state"),t("#statementType").html(t.i18n.t("app.ccstatement.paymentsincelaststatement")+' <span class="caret"></span>'),t("#creditcard_detail_list").html(e.template(m))},getLastSixMonthStatement:function(a){"object"==typeof a&&(u.set("isCreditCardPaymentLastSix","false"),a.stopImmediatePropagation());var n=this;this.$el.html(e.template(c));var s=u.get("isCreditCardPaymentLastSix");if("false"==s){showSpinner(),t("#statementType").html(t.i18n.t("app.ccstatement.laststatement")+' <span class="caret"></span>');var i=function(t){hideSpinner(),n.loadLastSixMonthStatement()};n.collection=new o;var l=function(t){n.errorresponse()};n.collection.fetch({data:t.param({newversion:"Y",access_token:u.get("access_token"),accountID:u.get("ccardId")}),dataType:"json",type:"POST",cache:!1,success:function(t){if("0000"==ackStatus){var e=u.get("errorcode");"9999"==e?l(t):i(t)}else l(t)},error:l})}else n.loadLastSixMonthStatement()},loadLastSixMonthStatement:function(){u.set("statementType","lastsixmonths"),u.set("isCreditCardPaymentLastSix","true"),t("html").removeClass().addClass("app state"),t("#statementType").html(t.i18n.t("app.ccstatement.laststatement")+' <span class="caret"></span>'),t("#creditcard_detail_list").html(e.template(p))},gotoCreditCardList:function(){"true"==u.get("isFromStatementDwld")?a.history.navigate("#/stmtdwlddetailstatement"):"true"==u.get("isLeftMenu")?a.history.navigate("#/creditcardtype"):a.history.navigate("#/creditcardsummary")},openFinancialSummaryPopUp:function(){},PDFDownload:function(t){var e="";t.stopImmediatePropagation();var a=u.get("app.context.path");e=a+"account/ministatement/download.pdf";var n="access_token="+u.get("access_token")+"&emailRequired=&accountID="+u.get("ccardId")+"&fromAmount=&toAmount=&lastnTxn=&type=CARDS&toDate=&fromDate=&debitCreditFlag=B&cardtype=CC&authtype=NORMAL&statementType=UNBILLED&module=FILTERED&filterby=&sortBy=&sortOrder=ASC",s=encodeURI(n);fileDownLoadAndViewer(e,s,1,u.get("access_token"))},showSharePopUp:function(){t("#sharePopUp").modal("show"),t("#otherMailDiv").hide()},showOtherMailDiv:function(){t("#otherMailDiv").show(),t("#myMailDiv").hide()},showMyMailDiv:function(){t("#otherMailDiv").hide(),t("#myMailDiv").show()},showPasswordTipPopUp:function(){t("#sharePopUp").modal("hide"),t("#usernameTips").modal("show")},showMailSentSuccessPopUp:function(){t("#emailNullError").html(""),t("#PwdNullError").html("");var e=this,n=t("input[name='mailOptions']:checked").val();if("myMail"==n)u.set("emailadd",null),u.set("emailpwd",null),u.set("salttime",null),e.gotoEmailSharing();else if("otherMail"==n){var s=t("#emailId").val(),i=t("#passwd").val();this.model=new l({url:"json/"}),a.Validation.bind(this);var o=this.$("form").serializeObject();if(this.model.set(o,{validate:!0})){this.model.clear(),a.Validation.unbind(this),u.set("emailadd",s);var c=(new Date).getTime();u.set("salttime",c),mailpassword=EncryptWithDynamicSalt(i,c),u.set("emailpwd",mailpassword),e.gotoEmailSharing()}else this.$(".has-error").fadeIn(),event.preventDefault()}},gotoEmailSharing:function(){var e=this,a=function(t){hideSpinner(),e.openMailSentSuccessPopUp()},n=function(t){e.errorresponse()};showSpinner(),e.collection=new i,e.collection.fetch({data:t.param({access_token:u.get("access_token"),accountID:u.get("ccardId"),cardtype:"CC",statementType:"UNBILLED",statementDate:null,emailValue:u.get("emailadd"),emailPassValue:u.get("emailpwd"),salt:u.get("salttime"),module:"CARD_STATEMENT"}),dataType:"json",type:"POST",cache:!1,success:function(t){"0000"==ackStatus?a(t):n(t)},error:n})},openMailSentSuccessPopUp:function(){t("#sharePopUp").modal("hide"),t("#mailSent").modal("show")},backToSharePopUp:function(){t("#usernameTips").modal("hide"),t("#sharePopUp").modal("show")},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(t){return a.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=t,this.currentView.delegateEvents(),this.currentView}});return S});