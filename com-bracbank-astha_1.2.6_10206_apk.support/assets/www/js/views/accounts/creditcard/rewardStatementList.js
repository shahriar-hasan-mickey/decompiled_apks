define(["jquery","underscore","Backbone","collections/wealth/cardRewardPointInquiryCollections","collections/wealth/cardRewardPointRedeemCollections","text!views/accounts/creditcard/rewardStatementList.tpl","views/errors/exception"],function(e,t,a,r,n,i,o){var s=new EncryptedLocalStorage("secret"),c=a.View.extend({el:"#container",events:{"click .rewardStatementList":"getSelectedRewardStatementInfo","click #rewardPointsPopupCancelBtn":"gotoCCStatementPage","click #rewardPointsPopupConfirmBtn":"gotocardRewardPointRedeemAPI"},initialize:function(){},render:function(){var t=this;showSpinner();var n=function(e){hideSpinner(),s.set("downtimeTransType","RewardPoints_Transaction"),s.set("isDowntimeTransfer","N");var r=s.get("downtimeNotification");if(!isNull(r)&&r.length>0){var n=r[0].subTransactionType;s.set("subTransType",n),("BOTH"==n||"ONE-OFF"==n||"REGISTERED"==n)&&(hideSpinner(),a.history.navigate("#/downtimeboth"))}else hideSpinner(),t.gotoRewardStatementListTemplate()},i=function(e){t.errorresponse()};t.collection=new r,t.collection.fetch({data:e.param({access_token:s.get("access_token"),accountId:s.get("ccardId"),transactionType:"others"}),dataType:"json",type:"POST",cache:!1,success:function(e){if("0000"==ackStatus){var t=s.get("errorcode");"9999"==t?i(e):n(e)}else i(e)},error:i})},gotoRewardStatementListTemplate:function(){var a=this;a.$el.html(t.template(i)),e("html").removeClass().addClass("app"),s.set("isEligibleRedemption","false")},getSelectedRewardStatementInfo:function(t){"object"==typeof t&&t.stopImmediatePropagation();var a=e(t.currentTarget).attr("postingDate");s.set("postingDate",a);var r=e(t.currentTarget).attr("transactionSeqNo");s.set("transactionSeqNo",r);var n=e(t.currentTarget).attr("transactionCode");s.set("transactionCode",n);var i=e(t.currentTarget).attr("transactionCurrencyCode");s.set("transactionCurrencyCode",i);var o=e(t.currentTarget).attr("billingCurrencyCode");s.set("billingCurrencyCode",o);var c=e(t.currentTarget).attr("billingAmount");s.set("billingAmount",c);var d=e(t.currentTarget).attr("mcc");s.set("mcc",d);var l=e(t.currentTarget).attr("rewardPointRedeemIndicator");s.set("rewardPointRedeemIndicator",l);var p=e(t.currentTarget).attr("transactionDate");s.set("transactionDate",p);var u=e(t.currentTarget).attr("schemeCode");s.set("schemeCode",u);var m=e(t.currentTarget).attr("requiredRewardPoints");s.set("requiredRewardPoints",m);var g=e(t.currentTarget).attr("transactionDescription");s.set("transactionDescription",g);var v=e(t.currentTarget).attr("transactionAmount");s.set("transactionAmount",v);var w=e(t.currentTarget).attr("cardNumber");s.set("cardNumber",w);var b=e(t.currentTarget).attr("rewardFlag");s.set("rewardFlag",b);var h=this;h.populateTransactionRewardPopup(t)},populateTransactionRewardPopup:function(t){"object"==typeof t&&t.stopImmediatePropagation(),e("#transactionRewardPopup").html("");var a="";a+='<div class="modal fade rewardPopup" id="reward_popup" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"><div class="modal-dialog" role="document"><form><div class="modal-content"> <div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="myModalLabel">Transaction Reward</h4></div><div class="modal-body clearfix"><ul class="list-unstyled list-nobrd"> <li class="list-group-item"> <p class="text-muted small">Transaction Billed Amount</p><div class="amt"><span class="num">'+checkAmount(e.formatNumber(s.get("billingAmount"),{format:"#,###.00",locale:"us"}))+'</span><span class="cur"> '+s.get("billingCurrencyCode")+'</span></div></li><li class="list-group-item"><p class="text-muted small">Required Reward Points</p><p>'+s.get("requiredRewardPoints")+'</p></li><li class="list-group-item"><p class="text-muted small">Available Reward Points</p> <p>'+s.get("rewardPointsRedeemClosingBalance")+'</p></li></ul><div class="clearfix"></div>',"Y"==s.get("rewardFlag")?(s.set("isEligibleRedemption","true"),a+='<div class="alert alert-info small"><p>Please click “CONFIRM” to adjust this bill amount through redeeming required Reward points.</p><p>Per reward point redemption cost 0.30. i.e. 100 reward point redemption value 30 TAKA</p></div><div class="clearfix"></div><div class="row"><div class="col-xs-6 pr5"><a href="javascript:void(0);" id="rewardPointsPopupCancelBtn" class="btn btn-default btn-block">Cancel</a></div><div class="col-xs-6 pl5"><a href="javascript:void(0);" id="rewardPointsPopupConfirmBtn" type="button" class="btn btn-primary btn-block">Confirm</a></div></div>'):"N"==s.get("rewardFlag")&&(s.set("isEligibleRedemption","false"),a+='<div class="alert alert-danger small"><p>You don\'t have enough required reward points available to redeem.</p></div><div class="clearfix"></div><div class="row"><div class="col-xs-12"><button type="button" class="btn btn-default btn-block" id="rewardPointsPopupCancelBtn">Cancel</button></div></div>'),e("#transactionRewardPopup").html(a),e("#reward_popup").modal("show")},gotoCCStatementPage:function(t){t.stopImmediatePropagation(),"true"==s.get("isEligibleRedemption")?e("#reward_popup").modal("hide"):e("#reward_popup").modal("hide")},gotocardRewardPointRedeemAPI:function(t){"object"==typeof t&&t.stopImmediatePropagation();var r=this;showSpinner();var i=function(t){hideSpinner(),e("#reward_popup").modal("hide"),s.set("redeemStatmntType","Transaction"),a.history.navigate("#/rewardstatementtxnconfirm")},o=function(t){e("#reward_popup").modal("hide"),r.errorresponse()};r.collection=new n,r.collection.fetch({data:e.param({access_token:s.get("access_token"),accountId:s.get("ccardId"),transactionDate:s.get("transactionDate"),postingDate:s.get("postingDate"),transactionSeqNo:s.get("transactionSeqNo"),transactionCode:s.get("transactionCode"),transactionDescription:s.get("transactionDescription"),transactionCurrencyCode:s.get("transactionCurrencyCode"),transactionAmount:s.get("transactionAmount"),billingCurrencyCode:s.get("billingCurrencyCode"),billingAmount:s.get("billingAmount"),mcc:s.get("mcc"),rewardPointRedeemIndicator:s.get("rewardPointRedeemIndicator"),redeemPoint:s.get("requiredRewardPoints"),waiverPercentage:null,isAnnualFlag:null}),dataType:"json",type:"POST",cache:!1,success:function(e){if("0000"==ackStatus){var t=s.get("errorcode");"9999"==t?o(e):i(e)}else o(e)},error:o})},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(e){return a.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return c});