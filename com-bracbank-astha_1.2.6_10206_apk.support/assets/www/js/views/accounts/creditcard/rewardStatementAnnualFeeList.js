define(["jquery","underscore","Backbone","collections/wealth/cardRewardPointInquiryCollections","collections/wealth/getAnnualFeeWaiverDetailsCollections","collections/wealth/cardRewardPointRedeemCollections","text!views/accounts/creditcard/rewardStatementAnnualFeeList.tpl","views/errors/exception"],function(e,t,a,r,i,n,s,o){var l=new EncryptedLocalStorage("secret"),c=a.View.extend({el:"#container",events:{"click .rewardStatementAnnualFeeList":"getSelectedRewardStatementInfo","click #rewardPointsAnnualFeePopupCancelBtn":"gotoCCStatementPage","click #rewardPointsAnnualFeePopupConfirmBtn":"gotoRewardRedemptionAnnualFeeAPI","click .waiverPercentClass":"toggleWaiverPercentage"},initialize:function(){},render:function(){var t=this;showSpinner();var i=function(e){hideSpinner(),l.set("downtimeTransType","RewardPoints_AnnualFee"),l.set("isDowntimeTransfer","N");var r=l.get("downtimeNotification");if(!isNull(r)&&r.length>0){var i=r[0].subTransactionType;l.set("subTransType",i),("BOTH"==i||"ONE-OFF"==i||"REGISTERED"==i)&&(hideSpinner(),a.history.navigate("#/downtimeboth"))}else hideSpinner(),t.gotorewardStatementAnnualFeeListTemplate()},n=function(e){t.errorresponse()};t.collection=new r,t.collection.fetch({data:e.param({access_token:l.get("access_token"),accountId:l.get("ccardId"),transactionType:"annual_fees"}),dataType:"json",type:"POST",cache:!1,success:function(e){if("0000"==ackStatus){var t=l.get("errorcode");"9999"==t?n(e):i(e)}else n(e)},error:n})},gotorewardStatementAnnualFeeListTemplate:function(){var a=this;a.$el.html(t.template(s)),e("html").removeClass().addClass("app"),l.set("isEligibleRedemption","false")},getSelectedRewardStatementInfo:function(t){"object"==typeof t&&t.stopImmediatePropagation();var a=e(t.currentTarget).attr("postingDate");l.set("postingDate",a);var r=e(t.currentTarget).attr("transactionSeqNo");l.set("transactionSeqNo",r);var i=e(t.currentTarget).attr("transactionCode");l.set("transactionCode",i);var n=e(t.currentTarget).attr("transactionCurrencyCode");l.set("transactionCurrencyCode",n);var s=e(t.currentTarget).attr("billingCurrencyCode");l.set("billingCurrencyCode",s);var o=e(t.currentTarget).attr("billingAmount");l.set("billingAmount",o);var c=e(t.currentTarget).attr("mcc");l.set("mcc",c);var d=e(t.currentTarget).attr("rewardPointRedeemIndicator");l.set("rewardPointRedeemIndicator",d);var u=e(t.currentTarget).attr("transactionDate");l.set("transactionDate",u);var g=e(t.currentTarget).attr("transactionDescription");l.set("transactionDescription",g);var p=e(t.currentTarget).attr("transactionAmount");l.set("transactionAmount",p);var v=e(t.currentTarget).attr("cardNumber");l.set("cardNumber",v);var m=e(t.currentTarget).attr("schemeCode");l.set("schemeCode",m);var w=e(t.currentTarget).attr("requiredRewardPoints");l.set("requiredRewardPoints",w);var P=e(t.currentTarget).attr("rewardFlag");l.set("rewardFlag",P);var b=this;b.getAnnualFeeWaiverDetails(t)},getAnnualFeeWaiverDetails:function(t){"object"==typeof t&&t.stopImmediatePropagation();var a=this;showSpinner();var r=function(e){hideSpinner(),a.populateTransactionRewardPopup(t)},n=function(e){hideSpinner(),a.errorresponse()};a.collection=new i,a.collection.fetch({data:e.param({access_token:l.get("access_token"),availableRewardPoints:l.get("rewardPointsRedeemClosingBalance"),cardType:"B",schemeCode:l.get("schemeCode"),billingAmount:l.get("billingAmount")}),dataType:"json",type:"POST",cache:!1,success:function(e){if("0000"==ackStatus){var t=l.get("errorcode");"9999"==t?n(e):r(e)}else n(e)},error:n})},gotoCCStatementPage:function(t){t.stopImmediatePropagation(),"true"==l.get("isEligibleRedemption")?e("#reward_popup").modal("hide"):e("#reward_popup").modal("hide")},gotoRewardRedemptionAnnualFeeAPI:function(t){"object"==typeof t&&t.stopImmediatePropagation();var r=this;showSpinner();var i,s;"true"==l.get("isHunderedPercentEligible")?(s=l.get("selectedWaiverPercent"),i="100"==s?l.get("waiverAmount_100"):l.get("waiverAmount_50")):"false"==l.get("isHunderedPercentEligible")&&"true"==l.get("isFiftyPercentEligible")?(i=l.get("waiverAmount_50"),s="50"):"false"==l.get("isHunderedPercentEligible")&&"true"==l.get("isFiftyPercentEligible")&&(i=l.get("waiverAmount_50"),s="50");var o=function(t){hideSpinner(),e("#reward_popup").modal("hide"),l.set("redeemStatmntType","AnnualFee"),a.history.navigate("#/rewardstatementtxnconfirm")},c=function(t){e("#reward_popup").modal("hide"),r.errorresponse()};r.collection=new n,r.collection.fetch({data:e.param({access_token:l.get("access_token"),accountId:l.get("ccardId"),transactionDate:l.get("transactionDate"),postingDate:l.get("postingDate"),transactionSeqNo:l.get("transactionSeqNo"),transactionCode:l.get("transactionCode"),transactionDescription:l.get("transactionDescription"),transactionCurrencyCode:l.get("transactionCurrencyCode"),transactionAmount:i,billingCurrencyCode:l.get("billingCurrencyCode"),billingAmount:i,mcc:l.get("mcc"),rewardPointRedeemIndicator:l.get("rewardPointRedeemIndicator"),redeemPoint:l.get("reqRewardPoints"),waiverPercentage:s,isAnnualFlag:"Y"}),dataType:"json",type:"POST",cache:!1,success:function(e){if("0000"==ackStatus){var t=l.get("errorcode");"9999"==t?c(e):o(e)}else c(e)},error:c})},populateTransactionRewardPopup:function(t){"object"==typeof t&&t.stopImmediatePropagation();var a=this;e("#transactionRewardPopup").html("");var r="";r+='<div class="modal fade rewardPopup" id="reward_popup" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"><div class="modal-dialog" role="document"><form><div class="modal-content"> <div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="myModalLabel">Transaction Reward</h4></div><div class="modal-body clearfix"><ul class="list-unstyled list-nobrd"> <li class="list-group-item"> <p class="text-muted small">Annual Fee Amount</p><div class="amt"><span class="num">'+checkAmount(e.formatNumber(l.get("waiverAmount_100"),{format:"#,###.00",locale:"us"}))+'</span><span class="cur">'+l.get("billingCurrencyCode")+'</span></div></li><li class="list-group-item"><p class="text-muted small">Waiver Percentage</p><div id="waiverPercentDiv"></div>',r+='</li><li class="list-group-item"><p class="text-muted small">Waiver Amount</p><div id="waiverAmountDiv"></div></li><li class="list-group-item"><p class="text-muted small">Required Reward Points</p><div id="reqRewardPointsDiv"></div>',r+='</li><li class="list-group-item"><p class="text-muted small">Available Reward Points</p> <p>'+l.get("rewardPointsRedeemClosingBalance")+'</p></li></ul><div class="clearfix"></div>',"true"==l.get("isHunderedPercentEligible")||"false"==l.get("isHunderedPercentEligible")&&"true"==l.get("isFiftyPercentEligible")?(l.set("isEligibleRedemption","true"),r+='<div class="alert alert-info small"><p>Please click “CONFIRM” to adjust this bill amount through redeeming required Reward points.</p><p>Per reward point redemption cost 0.30. i.e. 100 reward point redemption value 30 TAKA</p></div><div class="clearfix"></div><div class="row"><div class="col-xs-6 pr5"><a href="javascript:void(0);" id="rewardPointsAnnualFeePopupCancelBtn" class="btn btn-default btn-block">Cancel</a></div><div class="col-xs-6 pl5"><a href="javascript:void(0);" id="rewardPointsAnnualFeePopupConfirmBtn" type="button" class="btn btn-primary btn-block">Confirm</a></div></div>'):"false"==l.get("isHunderedPercentEligible")&&"false"==l.get("isFiftyPercentEligible")&&(l.set("isEligibleRedemption","false"),r+='<div class="alert alert-danger small"><p>You don\'t have enough required reward points available to redeem.</p></div><div class="clearfix"></div><div class="row"><div class="col-xs-12"><button type="button" class="btn btn-default btn-block" id="rewardPointsAnnualFeePopupCancelBtn">Cancel</button></div></div>'),e("#transactionRewardPopup").html(r),a.populateWaiverPercentageRadioBtnDiv(t),e("#reward_popup").modal("show")},populateWaiverPercentageRadioBtnDiv:function(t){"object"==typeof t&&t.stopImmediatePropagation();var a=this;e("#waiverPercentDiv").html("");var r="";"true"==l.get("isHunderedPercentEligible")?r+='<div class="form-group"><div class="row"><div class="col-xs-6"><label class="radio-label trans_label"><input type="radio" name="waiverPercent" class="waiverPercentClass" id="hundred" value="100" checked>100%<span class="checkmark"></span></label></div><div class="col-xs-6"><label class="radio-label trans_label"><input type="radio" name="waiverPercent" class="waiverPercentClass" id="fifty" value="50">50%<span class="checkmark"></span></label></div></div></div>':"false"==l.get("isHunderedPercentEligible")&&"true"==l.get("isFiftyPercentEligible")&&(r+='<div class="form-group"><div class="row"><div class="col-xs-6"><label class="radio-label trans_label"><input type="radio" name="waiverPercent" class="waiverPercentClass" id="fifty" value="50" checked>50%<span class="checkmark"></span></label></div></div></div>'),"true"==l.get("isHunderedPercentEligible")||"false"==l.get("isHunderedPercentEligible")&&"true"==l.get("isFiftyPercentEligible")?e("#waiverPercentDiv").html(r):"false"==l.get("isHunderedPercentEligible")&&"false"==l.get("isFiftyPercentEligible")&&e("#waiverPercentDiv").html(""),"true"==l.get("isHunderedPercentEligible")?l.set("selectedWaiverPercent","100"):"false"==l.get("isHunderedPercentEligible")&&"true"==l.get("isFiftyPercentEligible")?l.set("selectedWaiverPercent","50"):"false"==l.get("isHunderedPercentEligible")&&"false"==l.get("isFiftyPercentEligible")&&l.set("selectedWaiverPercent","50"),a.setDisplayReqRewardPoints(t)},setDisplayReqRewardPoints:function(t){"object"==typeof t&&t.stopImmediatePropagation(),e("#reqRewardPointsDiv").html(""),e("#waiverAmountDiv").html("");var a;l.set("reqRewardPoints",""),"true"==l.get("isHunderedPercentEligible")?("100"==l.get("selectedWaiverPercent")?(a=l.get("requiredRewardPoints_100"),waiverAmount=l.get("waiverAmount_100")):"50"==l.get("selectedWaiverPercent")&&(a=l.get("requiredRewardPoints_50"),waiverAmount=l.get("waiverAmount_50")),l.set("reqRewardPoints",a),l.set("waiverAmount",waiverAmount)):"false"==l.get("isHunderedPercentEligible")&&"true"==l.get("isFiftyPercentEligible")?(a=l.get("requiredRewardPoints_50"),waiverAmount=l.get("waiverAmount_50"),l.set("reqRewardPoints",a),l.set("waiverAmount",waiverAmount)):"false"==l.get("isHunderedPercentEligible")&&"false"==l.get("isFiftyPercentEligible")&&(a=l.get("requiredRewardPoints_50"),waiverAmount=l.get("waiverAmount_50"),l.set("reqRewardPoints",a),l.set("waiverAmount",waiverAmount)),e("#reqRewardPointsDiv").html(l.get("reqRewardPoints")),e("#waiverAmountDiv").html(checkAmount(e.formatNumber(l.get("waiverAmount"),{format:"#,###.00",locale:"us"})))},toggleWaiverPercentage:function(t){"object"==typeof t&&t.stopImmediatePropagation();var a=this,r=e("input[name='waiverPercent']:checked").val();"100"==r?l.set("selectedWaiverPercent","100"):"50"==r&&l.set("selectedWaiverPercent","50"),a.setDisplayReqRewardPoints(t)},errorresponse:function(){hideSpinner(),openErrorPopup()},disposeView:function(e){return a.View.prototype.close=function(){this.unbind(),this.undelegateEvents()},void 0!==this.currentView&&this.currentView.close(),this.currentView=e,this.currentView.delegateEvents(),this.currentView}});return c});