define(["jquery","underscore","Backbone","text!views/touchid/touchregOTP.tpl","collections/common/otpGenerateCollections","collections/common/otpValidateCollections","collections/common/mobileNumberUpdateCollection","models/validation/OTPValidationModel","collections/logout/logoutCollections","collections/wealth/kycInputCollections","models/validation/softOTPValidationModel"],function(e,t,i,o,n,r,a,s,c,l,p){var g="",d=new EncryptedLocalStorage("secret"),u=i.View.extend({el:"#container",e1:"#preloginmobcontent",events:{"click .smsotp":"OTPOption1","click .softToken":"OTPOption2","click #loginotpclick":"submitOTP","click #resendclick":"ResendClick","click #cancel":"Cancel"},update:function(){var t=d.get("touchIdReg"),o=d.get("is_mobilenumber_confirmed"),n=d.get("MaskMobile"),r=this;"NO"==o&&"A"==t?navigator.notification.confirm(e.i18n.t("app.login.confirmmobileno1")+n+e.i18n.t("app.login.confirmmobileno2"),function(e){1==e?r.updateMobileNumber():2==e&&i.history.navigate("#/login",{trigger:!0,replace:!0})},"",[e.i18n.t("app.mpin.yes"),e.i18n.t("app.mpin.no")]):this.otpflagcheck()},updateMobileNumber:function(){showSpinner();var t=this,i=function(e){t.otpflagcheck()},o=function(e){t.errorresponse()};t.collection=new a([],{});var n=(new Date).getTime(),r=d.get("actual_mob_no"),s=d.get("custnoenc"),s=d.get("custnoenc"),c=d.get("timeStampharse"),l=DEcryptuser(s,c),p=getDeviceId(),g=s+""+p,u=CryptoJS.MD5(g);g=u+"";var m=l,h=Encryptuser(l,n),f=h,v=Encryptuser(m,n);t.collection.fetch({data:e.param({custno:f,mobilenumber:r,timeenv:v,timephrase:n,requestid:n}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(d.get("calltimeout")),success:function(e){"0000"==ackStatus?i(e):o(e)},error:o})},OTPOption1:function(t){e("#hidotp").val("otp"),e(".smsotp_block").show(),e(".softTock").hide(),e(".smsotp").addClass("active"),e(".softToken").removeClass("active"),document.getElementById("softTockId").style.display="none",document.getElementById("smsDivId").style.display="inline",this.generateOTP(),t.preventDefault()},OTPOption2:function(){e("#hidotp").val("softotp"),e(".smsotp_block").hide(),e(".softTock").show(),e(".softToken").addClass("active"),e(".smsotp").removeClass("active"),e("#hiddotpvalue").val("Y"),document.getElementById("softTockId").style.display="inline"},otpflagcheck:function(){hideSpinner();var e=d.get("touchIdReg");if("A"!=e){var t=d.get("BiometricType");if("TID"==t){var i=d.get("touch_reg_login");g="touch_id_reg_otp"}else{var i=d.get("face_reg_login");g="face_id_reg_otp"}}else{var t=d.get("BiometricType");if("TID"==t){var i=d.get("touch_login");g="biometric_otp"}else{var i=d.get("face_id_login");g="face_id_login_otp"}}if("Y"==i){var o=d.get("soft_token");"Y"==o?this.loginotpcompiler():this.generateOTP()}else this.loginaskverify()},generateOTP:function(){e("#resenddiv").hide(),showSpinner();var t=this,i=function(e){t.loginotpcompiler()},o=function(e){t.errorresponse()};t.collection=new n([],{});var r=(new Date).getTime();"en-US"==e.i18n.lng()?language="EN":"en-AR"==e.i18n.lng()&&(language="AR");var a=d.get("custnoenc"),s="9004",c="",a=d.get("custnoenc"),l=d.get("timeStampharse"),p=DEcryptuser(a,l),u=getDeviceId(),m=a+""+u,h=CryptoJS.MD5(m);m=h+"";var f=p,v=Encryptuser(p,r),y=v,T=Encryptuser(f,r);t.collection.fetch({data:e.param({servicetype:s,otpModule:g,language:language,custno:y,ipaddress:c,timeenv:T,timephrase:r,requestid:r,biometriclogintype:d.get("BiometricType")}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(d.get("calltimeout")),success:function(t){if("0000"==ackStatus){var n=e("#isformloaded").val();"Y"==n?(e(".smsotp_block").show(),document.getElementById("smsDivId").style.display="inline",e(".softTock").hide(),hideSpinner()):i(t)}else o(t)},error:o})},ResendClick:function(){hideSpinner(),e("#resendclick").parents(".form-group").find(".optwrap").removeClass("input-group"),e("#resendclick").parent(".input-group-btn").addClass("hidden"),e("#secError").hide(),this.generateOTP()},loginotpcompiler:function(){return hideSpinner(),this.$el.html(t.template(o)),this},securityadvicecheck:function(t){"TWOFA"==e("#securityFlag").val()?this.loginotpverification(t,e("#securityFlag").val()):"TPIN"==e("#securityFlag").val()?this.loginotpverification(t,e("#securityFlag").val()):"SQ"==e("#securityFlag").val()&&this.loginotpverification(t,e("#securityFlag").val())},submitOTP:function(t){var i=e("#hidotp").val(),o=d.get("device.platform");"Android"==o&&"true"==d.get("isOtpReceived")&&stopSMSListening(),"softotp"==i?this.verifySoftToken():this.verifyOTP()},verifyOTP:function(){e("#secError").hide(),e("#resenddiv").hide(),this.model=new s({url:"json/"}),i.Validation.bind(this);var t=this.$("form").serializeObject();if(this.model.set(t,{validate:!0})){this.model.clear(),i.Validation.unbind(this),showSpinner();var o=this,n=function(e){o.loginaskverify()},a=function(e){o.errorresponse()};o.collection=new r([],{}),timestamp=(new Date).getTime();var c="SMS",l="0",p=e("#otp").val(),u=(d.get("custnoenc"),d.get("custnoenc")),m=d.get("timeStampharse"),h=DEcryptuser(u,m),f=getDeviceId(),v=u+""+f,y=CryptoJS.MD5(v);v=y+"";var T=h,S=Encryptuser(h,timestamp),k=S,b=Encryptuser(T,timestamp);o.collection.fetch({data:e.param({opttype:c,otpModule:g,refno:l,activationno:p,customerno:k,timeenv:b,timephrase:timestamp,requestid:timestamp,biometriclogintype:d.get("BiometricType")}),dataType:"json",type:"POST",cache:!1,timeout:parseInt(d.get("calltimeout")),success:function(t){var i=d.get("errorcod");if("0000"==ackStatus){var o=d.get("touchIdReg"),r=d.get("BiometricType");"A"==o&&("FID"==r?pushLocalNotification(e.i18n.t("app.faceid.notifaceLoginSuccess")+" "+d.get("device_name")):pushLocalNotification(e.i18n.t("app.touchid.notiTouchLoginSuccess")+" "+d.get("device_name"))),n(t)}else if(-1!=i.indexOf("MSI-ENT-5011")){hideSpinner();var a=d.get("errordesc");e("#resendclick").parents(".form-group").find(".optwrap").addClass("input-group"),e("#resendclick").parent(".input-group-btn").removeClass("hidden"),e("#showError").text(a),e("#secError").show(),e("#loginform")[0].reset(),document.getElementById("otp").value=""}else if(-1!=i.indexOf("MSI-ENT-5005")){hideSpinner(),e("#loginform")[0].reset(),e("#loginotpclick").attr("disabled","disabled");var a=d.get("errordesc");e("#showError").text(a),e("#secError").show()}else{hideSpinner();var a=d.get("errordesc");e("#showError").text(a),e("#loginform")[0].reset(),e("#secError").show(),e("#resenddiv").show()}},error:a})}else this.$(".alert-error").fadeIn(),hideSpinner()},verifySoftToken:function(){this.model=new p({url:"json/"}),i.Validation.bind(this);var t=this.$("form").serializeObject();if(this.model.set(t,{validate:!0})){showSpinner(),this.model.clear(),i.Validation.unbind(this);var o=this,n=function(e){o.loginaskverify()},a=function(e){o.errorresponse()};o.collection=new r([],{});var s=(new Date).getTime(),c="SOFTOTP",l=e("#softotp").val(),g=(d.get("custnoenc"),d.get("custnoenc")),u=d.get("timeStampharse"),m=DEcryptuser(g,u),h=getDeviceId(),f=g+""+h,v=CryptoJS.MD5(f);f=v+"";var y=m,T=Encryptuser(m,s),S=T,k=Encryptuser(y,s);o.collection.fetch({data:e.param({opttype:c,refno:d.get("token_serno"),activationno:l,customerno:S,timeenv:k,timephrase:s,requestid:s,biometriclogintype:d.get("BiometricType")}),dataType:"json",type:"POST",timeout:parseInt(d.get("calltimeout")),cache:!1,success:function(t){if("0000"==ackStatus){var i=d.get("BiometricType"),o=d.get("touchIdReg");"A"==o&&("FID"==i?pushLocalNotification(e.i18n.t("app.faceid.notifaceLoginSuccess")+" "+d.get("device_name")):pushLocalNotification(e.i18n.t("app.touchid.notiTouchLoginSuccess")+" "+d.get("device_name"))),n(t)}else a(t)},error:a})}else this.$(".alert-error").fadeIn()},loginaskverify:function(){hideSpinner();var t=this,o=d.get("touchIdReg");if("A"!=o)d.set("isFirstTimeForTouch","false"),i.history.navigate("#/showdevicelist",{trigger:!0,replace:!0});else{var t=this,n=function(e){t.onWealthResponse()},r=function(e){t.errorresponse()};t.collection=new l([],{});var a,s=(new Date).getTime(),c=d.get("iqama_number"),p=(d.get("iqama_id"),d.get("iqama_id"),d.get("iqnumid")),g=d.get("dateChanged");g=g.substring(3,10),a=2==p?d.get("birthmonthyear"):d.get("birthdateyear");var u=d.get("idexpdate"),m=d.get("custno");d.get("kyconetimeprocess");showSpinner(),t.collection.fetch({data:e.param({iqamaNumber:c,id:p,dateOfBirth:a,username:"",custId:m,expDate:u,requestid:s}),dataType:"json",type:"POST",timeout:parseInt(d.get("calltimeout")),cache:!1,success:function(e){if("0000"==ackStatus){var t=d.get("usrlogincount"),o=d.get("noOfDays"),a=new Date,s=a.getDate(),c=a.getMonth()+1,l=a.getFullYear();10>s&&(s="0"+s),10>c&&(c="0"+c);var a=s+"/"+c+"/"+l,p=d.get("idexpdate"),g=p.substring(0,4),u=p.substring(4,6),m=p.substring(6,8);p=m+"/"+u+"/"+g,a==p&&o>90&&o>=0?(d.set("kyconetimeprocess",""),d.set("KYCUpdated",""),i.history.navigate("#/kyc")):n(""!=t||void 0!=t||null!=t||"null"!=t||""!=o||void 0!=o||null!=o?e:e)}else r(e)},error:r})}},onWealthResponse:function(){var e=(d.get("kyconetimeprocess"),d.get("usrlogincount")),t=d.get("noOfDays"),o=d.get("iqnumid");o>=3?i.history.navigate("#/landing",{trigger:!0,replace:!0}):t>90?(hideSpinner(),i.history.navigate("#/landing",{trigger:!0,replace:!0})):!(""==e&&void 0==e&&null==e&&"null"==e||"1"!=e&&"2"!=e)?(hideSpinner(),i.history.navigate("#/landing",{trigger:!0,replace:!0})):(hideSpinner(),i.history.navigate("#/kyc"))},Cancel:function(){showSpinner(),d.set("isTouchLogin",null);var t=d.get("device.platform");"Android"==t&&stopSMSListening();var i=this,o=function(e){i.cancelcompile()},n=function(e){i.errorresponse()};i.collection=new c([],{});var r=(new Date).getTime();i.collection.fetch({data:e.param({usersession:d.get("access_token"),access_token:d.get("access_token"),requestid:r}),dataType:"json",type:"POST",cache:!1,success:function(e){"0000"==ackStatus?o(e):n(e)},error:n})},cancelcompile:function(){hideSpinner(),i.history.fragment=null,i.history.navigate("#/login",{trigger:!0,replace:!0})},errorresponse:function(e){hideSpinner(),openErrorPopup()}});return u});